<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>View List - the library sale</title>
    <!-- Google Fonts Import -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=B612+Mono&family=Dokdo&family=Kirang+Haerang&family=M+PLUS+2&family=Syne+Mono&display=swap" rel="stylesheet">
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-auth-compat.js"></script>
    <!-- App Scripts -->
    <script src="utils.js" defer></script>
    <link rel="stylesheet" href="styles/variables.css">
    <link rel="stylesheet" href="styles/base.css">  
    <link rel="stylesheet" href="styles/components.css">
    <link rel="stylesheet" href="styles/pages.css">
    <script src="main.js" defer></script>
</head>
<body>
    <header id="navbar-placeholder"></header>

    <main class="main-container view-list-container">
        <div id="list-content">
            <div class="list-header">
                <h1 id="listName">Loading List...</h1>
            </div>
            
            <div class="list-meta-container">
                <p id="creatorName"></p>
                <a id="editListBtn" class="btn btn-md btn-secondary" style="display: none;" title="Edit List">
                    <span class="icon icon-edit icon-md"></span>
                </a>
            </div>
            
            <p id="listDescription"></p>
            
            <hr class="list-divider">
            
            <div id="media-list-container">
                <!-- Initial loading state -->
                <div class="loading-container">
                    <div class="loading-content">
                        <div class="loading-spinner"></div>
                        <p class="loading-text">Loading list items...</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="flex-center" style="margin-top: var(--space-4xl);">
            <button onclick="history.back()" class="btn btn-lg btn-secondary" title="Go Back">
                <span class="icon icon-back icon-lg"></span>
            </button>
        </div>
    </main>

    <script>
        const firebaseConfig = {
          apiKey: "AIzaSyDDW8LtwpYevdkD7Q-_CxJ23mMfi00P21M",
          authDomain: "tiny-lizard.firebaseapp.com",
          projectId: "tiny-lizard",
          storageBucket: "tiny-lizard.firebasestorage.app",
          messagingSenderId: "250872474692",
          appId: "1:250872474692:web:969e0b1302ae3cb4666011"
        };
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        let currentUser = null;

        // Enhanced skeleton utilities using CSS component classes
        const SkeletonUI = {
            showListSkeleton: () => {
                document.getElementById('listName').innerHTML = '<div class="skeleton" style="height: 2.5em; width: 60%;"></div>';
                document.getElementById('creatorName').innerHTML = '<div class="skeleton" style="width: 120px; height: 1em;"></div>';
                document.getElementById('listDescription').innerHTML = '<div class="skeleton" style="width: 80%; height: 1.2em; margin: var(--space-lg) 0;"></div>';
                
                const container = document.getElementById('media-list-container');
                const skeletonHTML = Array(8).fill(0).map((_, index) => `
                    <div class="list-media-item">
                        <span class="list-item-number">${index + 1}.</span>
                        <div class="skeleton list-item-poster"></div>
                        <div class="list-item-info">
                            <div class="skeleton" style="height: 1.2em; width: 70%; margin-bottom: var(--space-xs);"></div>
                            <div class="skeleton" style="height: 1em; width: 40%;"></div>
                        </div>
                    </div>
                `).join('');
                container.innerHTML = skeletonHTML;
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const listId = urlParams.get('id');

            if (!listId) {
                document.getElementById('list-content').innerHTML = `
                    <div class="error-state">
                        <span class="icon icon-close icon-3xl"></span>
                        <h3>Error: No List ID provided</h3>
                        <p>Please check the URL and try again.</p>
                        <a href="lists.html" class="btn btn-lg btn-primary">
                            <span class="icon icon-back icon-lg"></span>
                            Back to Lists
                        </a>
                    </div>
                `;
                return;
            }
            
            auth.onAuthStateChanged(user => {
                currentUser = user;
                loadListData(listId);
            });
        });

        async function loadListData(listId) {
            SkeletonUI.showListSkeleton();

            try {
                const [listDoc] = await Promise.all([
                    db.collection('lists').doc(listId).get(),
                    new Promise(resolve => setTimeout(resolve, 600))
                ]);
                
                if (!listDoc.exists) {
                    throw new Error("List not found.");
                }
                const listData = listDoc.data();

                // Populate list header details
                document.getElementById('listName').textContent = listData.listName;
                document.getElementById('creatorName').innerHTML = `by <a href="profile.html?id=${listData.creatorId}">${listData.creatorDisplayName || 'Anonymous'}</a>`;
                document.getElementById('listDescription').textContent = listData.description || '';

                // Show edit button only if the current user is the owner
                const editButton = document.getElementById('editListBtn');
                if (currentUser && currentUser.uid === listData.creatorId) {
                    editButton.style.display = 'inline-flex';
                    editButton.href = `edit-list.html?id=${listId}`;
                }

                // Fetch all media items in the list
                const mediaIds = listData.mediaIds;
                if (!mediaIds || mediaIds.length === 0) {
                    document.getElementById('media-list-container').innerHTML = `
                        <div class="empty-state">
                            <span class="icon icon-list icon-3xl"></span>
                            <h3>This list is empty</h3>
                            <p>No media items have been added to this list yet.</p>
                        </div>
                    `;
                    return;
                }

                const mediaDataMap = new Map();
                const moviePromises = [];
                for (let i = 0; i < mediaIds.length; i += 10) {
                    const chunk = mediaIds.slice(i, i + 10);
                    moviePromises.push(db.collection('movies').where(firebase.firestore.FieldPath.documentId(), 'in', chunk).get());
                }

                const movieSnapshots = await Promise.all(moviePromises);
                movieSnapshots.forEach(snapshot => {
                    snapshot.forEach(doc => {
                        mediaDataMap.set(doc.id, doc.data());
                    });
                });
                
                // Render the media items in the correct order
                const container = document.getElementById('media-list-container');
                const validItems = mediaIds
                    .map((id, index) => ({ id, media: mediaDataMap.get(id), index }))
                    .filter(item => item.media); // Filter out deleted/missing movies

                if (validItems.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <span class="icon icon-close icon-3xl"></span>
                            <h3>Media not found</h3>
                            <p>The media items in this list may have been removed.</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = validItems.map(({ id, media, index }) => `
                    <a href="library.html?id=${id}" class="list-media-item">
                        <span class="list-item-number">${index + 1}.</span>
                        <img src="${media.posterUrl || 'https://placehold.co/50x75/2D194D/DEF0F7?text=N/A'}" 
                             class="list-item-poster" 
                             alt="Poster for ${media.title}"
                             loading="lazy">
                        <div class="list-item-info">
                            <span class="list-item-title">${media.title}</span>
                            <span class="list-item-year">(${media.year || 'N/A'})</span>
                        </div>
                    </a>
                `).join('');

            } catch (error) {
                console.error("Error loading list data:", error);
                document.getElementById('list-content').innerHTML = `
                    <div class="error-state">
                        <span class="icon icon-close icon-3xl"></span>
                        <h3>Error: ${error.message}</h3>
                        <p>Please try refreshing the page or check your connection.</p>
                        <a href="lists.html" class="btn btn-lg btn-primary">
                            <span class="icon icon-back icon-lg"></span>
                            Back to Lists
                        </a>
                    </div>
                `;
            }
        }
    </script>
    <footer id="footer-placeholder"></footer>
</body>
</html>