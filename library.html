<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Movie Details - The Library Sale</title>
    <!-- Google Fonts & Styles -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=B612+Mono&family=Dokdo&family=Kirang+Haerang&family=M+PLUS+2&family=Syne+Mono&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-auth-compat.js"></script>   
    <!-- App Utilities & Main Script -->
    <script src="utils.js" defer></script>
    <script src="main.js" defer></script>
</head>
<body>
    <header id="navbar-placeholder"></header>

    <!-- Replace your detailsContainer div with this updated structure: -->
    <div id="detailsContainer" class="details-page-container" style="display: none;">
        
        <!-- Centered Title, Year, and Ratings (Ticket Style) -->
        <div class="details-ticket">
            <h1 id="movieTitle" class="details-title"></h1>
            <p id="movieYear" class="details-year"></p>
            
            <!-- Ratings Section - NOW INSIDE THE TICKET -->
            <div class="details-ratings">
                <div class="rating-box">
                    <h3>Average Rating</h3>
                    <div id="averageRating" class="media-rating"></div>
                </div>
                <div class="rating-box">
                    <h3>My Rating</h3>
                    <div id="myRating" class="media-rating"></div>
                </div>
            </div>
        </div>

        <!-- Main Content Grid (Poster + Info) -->
        <div class="details-main-content">
            <div class="details-poster">
                <img id="moviePoster" src="" alt="Movie Poster">
            </div>
            <div class="details-info">
                <div class="details-info-group">
                    <h3>Director</h3>
                    <p id="movieDirector"></p>
                </div>
                <div class="details-info-group">
                    <h3>Top Cast</h3>
                    <p id="movieCast"></p>
                </div>
                <div class="details-info-group">
                    <h3>Genre</h3>
                    <p id="movieGenre"></p>
                </div>
                <div class="details-info-group">
                    <h3>Summary</h3>
                    <p id="movieOverview"></p>
                </div>
            </div>
        </div>

        <!-- Comments Section -->
        <div class="details-comments-section">
            <h2 class="comments-header">
                <span class="icon"></span>
                Comments
            </h2>
            <div id="commentsContainer" class="comments-list">
                <!-- Comments will be injected by JS -->
            </div>
        </div>

        <!-- Footer with Back Button -->
        <footer class="details-footer">
            <a href="index.html" class="btn-back"></a>
        </footer>
    </div>

    <!-- Loading and Error States -->
    <div id="loadingState" class="main-container" style="text-align: center; padding: 50px;">
        <h2>Loading...</h2>
    </div>
    <div id="errorState" class="main-container" style="display: none; text-align: center; padding: 50px;">
        <h2 id="errorMessage"></h2>
        <a href="index.html" class="btn-back" style="margin-top: 20px;"></a>
    </div>

<script>
    // --- FIREBASE INITIALIZATION ---
    const firebaseConfig = {
        apiKey: "AIzaSyDDW8LtwpYevdkD7Q-_CxJ23mMfi00P21M",
        authDomain: "tiny-lizard.firebaseapp.com",
        projectId: "tiny-lizard",
        storageBucket: "tiny-lizard.firebasestorage.app",
        messagingSenderId: "250872474692",
        appId: "1:250872474692:web:969e0b1302ae3cb4666011"
    };
    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore(); 
    const auth = firebase.auth();

    async function loadMoviePage(user, movieId) {
        try {
            console.log('=== DEBUG: Loading movie page ===');
            console.log('User:', user?.uid);
            console.log('Movie ID:', movieId);

            // Get the main movie document
            const movieDocRef = db.collection('movies').doc(movieId);
            const movieDoc = await movieDocRef.get();

            if (!movieDoc.exists) {
                throw new Error("This movie could not be found in the main library.");
            }
            const movieData = { id: movieDoc.id, ...movieDoc.data() };
            console.log('Movie data loaded:', movieData.title);

            // Debug: Check if there are ANY movieInteractions in the database
            console.log('=== DEBUG: Checking all movieInteractions ===');
            const allInteractionsTest = await db.collectionGroup('movieInteractions').limit(5).get();
            console.log('Total movieInteractions in database:', allInteractionsTest.size);
            allInteractionsTest.forEach(doc => {
                console.log('Sample interaction:', doc.data());
            });

            // Debug: Check interactions for this specific movie
            console.log('=== DEBUG: Querying for this movie ===');
            const interactionsSnapshot = await db.collectionGroup('movieInteractions')
                .where('movieId', '==', movieId)
                .get();
            
            console.log('Found interactions for this movie:', interactionsSnapshot.size);
            
            if (interactionsSnapshot.empty) {
                console.log('=== DEBUG: No interactions found. Checking possible issues ===');
                
                // Check if the movieId field exists in any interactions
                const allInteractionsForDebug = await db.collectionGroup('movieInteractions').get();
                let hasMovieIdField = false;
                let sampleInteraction = null;
                
                allInteractionsForDebug.forEach(doc => {
                    const data = doc.data();
                    if (data.movieId) {
                        hasMovieIdField = true;
                        sampleInteraction = data;
                    }
                });
                
                console.log('Any interactions have movieId field?', hasMovieIdField);
                console.log('Sample interaction with movieId:', sampleInteraction);
                
                // REMOVED THE PROBLEMATIC FieldPath.documentId() QUERY
                // This was causing the error - we don't need it since we're using movieId field
            }
            
            const allInteractions = interactionsSnapshot.docs.map(doc => {
                const pathParts = doc.ref.path.split('/');
                const userId = pathParts[1]; 
                const data = doc.data();
                console.log('Processing interaction:', { userId, movieId: data.movieId, hasReview: !!data.review });
                return { userId: userId, ...data };
            });
            
            // Find the current user's specific interaction
            const myInteraction = allInteractions.find(interaction => interaction.userId === user.uid);
            console.log('My interaction:', myInteraction);

            // Populate page content
            populateMovieDetails(movieData, myInteraction, allInteractions);
            await loadCommentsWithUserData(allInteractions);

            // Show the content
            const loadingState = document.getElementById('loadingState');
            const detailsContainer = document.getElementById('detailsContainer');
            
            if (loadingState) loadingState.style.display = 'none';
            if (detailsContainer) detailsContainer.style.display = 'block';

        } catch (error) {
            console.error("Error loading movie page:", error);
            displayError(error.message || "An unknown error occurred.");
        }
    }

    function populateMovieDetails(movieData, myInteraction, allInteractions) {
        document.getElementById('movieTitle').textContent = movieData.title || 'Untitled';
        document.getElementById('movieYear').textContent = movieData.year || 'N/A';
        document.getElementById('moviePoster').src = movieData.posterUrl || 'https://placehold.co/300x450/1a1a1a/4a4a4a?text=No+Poster';
        document.getElementById('moviePoster').alt = `Poster for ${movieData.title}`;
        document.getElementById('movieDirector').textContent = movieData.director || 'N/A';
        document.getElementById('movieCast').textContent = Array.isArray(movieData.cast) ? movieData.cast.join(', ') : 'N/A';
        document.getElementById('movieGenre').textContent = movieData.genre || 'N/A';
        document.getElementById('movieOverview').textContent = movieData.overview || 'No description available.';

        // Calculate average rating from all fetched interactions
        const ratings = allInteractions.map(i => i.rating).filter(r => r > 0);
        const avgRating = ratings.length > 0 ? ratings.reduce((a, b) => a + b, 0) / ratings.length : null;

        renderStars(document.getElementById('averageRating'), avgRating); 
        renderStars(document.getElementById('myRating'), myInteraction ? myInteraction.rating : 0);
    }

    async function loadCommentsWithUserData(interactions) {
        console.log('=== DEBUG: Loading comments ===');
        console.log('All interactions:', interactions);
        
        const commentsContainer = document.getElementById('commentsContainer');
        if (!commentsContainer) {
            console.error('Comments container not found');
            return;
        }
        
        commentsContainer.innerHTML = '';

        // Filter for interactions that have reviews
        const commentsWithReviews = interactions.filter(i => {
            const hasReview = i.review && i.review.trim() !== '';
            console.log('Checking review for user', i.userId, ':', hasReview, i.review);
            return hasReview;
        });
        
        console.log('Comments with reviews:', commentsWithReviews);

        if (commentsWithReviews.length === 0) {
            commentsContainer.innerHTML = `<p class="review-text-empty">No comments yet. Be the first to leave a review!</p>`;
            return;
        }

        // Get unique user IDs to fetch display names
        const userIds = [...new Set(commentsWithReviews.map(c => c.userId))];
        console.log('Fetching user data for:', userIds);
        
        // Fetch user profiles
        const userPromises = userIds.map(async id => {
            try {
                const userDoc = await db.collection('users').doc(id).get();
                const userData = {
                    id: id,
                    displayName: userDoc.exists ? userDoc.data().displayName : 'Anonymous'
                };
                console.log('User data fetched:', userData);
                return userData;
            } catch (error) {
                console.error(`Error fetching user ${id}:`, error);
                return { id: id, displayName: 'Anonymous' };
            }
        });
        
        const userData = await Promise.all(userPromises);
        
        // Create a map for easy lookup
        const userMap = new Map();
        userData.forEach(user => {
            userMap.set(user.id, user.displayName);
        });

        // Render comments
        commentsWithReviews.forEach(comment => {
            const username = userMap.get(comment.userId) || 'Anonymous';
            const commentEl = document.createElement('div');
            commentEl.className = 'comment-item';
            commentEl.innerHTML = `
                <p class="review-text">"${comment.review}"</p>
                <p class="comment-author">by <a href="profile.html?id=${comment.userId}">${username}</a></p>
            `;
            commentsContainer.appendChild(commentEl);
        });
        
        console.log('=== DEBUG: Comments rendered ===');
    }

    function renderStars(container, rating) {
        if (!container) return;
        
        container.innerHTML = '';
        if (typeof rating !== 'number' || rating <= 0) {
            container.innerHTML = `<span class="not-rated">Not Rated</span>`;
            return;
        }
        let starsHTML = '';
        for (let i = 1; i <= 5; i++) {
            if (i <= rating) starsHTML += `<span class="star star-full"></span>`;
            else if (i - 0.5 <= rating) starsHTML += `<span class="star star-half"></span>`;
            else starsHTML += `<span class="star star-empty"></span>`;
        }
        starsHTML += `<span class="rating-text">${rating.toFixed(1)} / 5.0</span>`;
        container.innerHTML = starsHTML;
    }

    function displayError(message) {
        const loadingState = document.getElementById('loadingState');
        const errorState = document.getElementById('errorState');
        const errorMessage = document.getElementById('errorMessage');
        
        if (loadingState) loadingState.style.display = 'none';
        if (errorState) errorState.style.display = 'block';
        if (errorMessage) errorMessage.textContent = message;
    }

    // Set up event listeners after DOM is loaded
    document.addEventListener('DOMContentLoaded', () => {
        auth.onAuthStateChanged(user => {
            if (user) {
                const movieId = new URLSearchParams(window.location.search).get('id');
                if (movieId) {
                    loadMoviePage(user, movieId);
                } else {
                    displayError("No movie was selected. Please return to the library.");
                }
            } else {
                window.location.href = 'auth.html';
            }
        });
    });
</script>
</body>
</html>