<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Movie Details - The Library Sale</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="style.css">

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <!-- App Scripts (deferred to prevent race conditions) -->
    <script src="main.js"></script>
    <script src="utils.js"></script>
</head>
<body class="bg-gray-900">

    <!-- Navbar is loaded dynamically -->
    <div id="navbar-container"></div>

    <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <!-- Loading Spinner -->
        <div id="loading" class="flex justify-center items-center h-64">
            <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-cyan-500"></div>
        </div>

        <!-- Main Movie Details Container -->
        <div id="movie-details-container" class="hidden max-w-4xl mx-auto">

            <!-- Movie Title and Year -->
            <div class="text-center mb-8">
                <h1 id="movie-title" class="text-3xl md:text-5xl font-bold tracking-tight text-white"></h1>
                <p id="movie-year" class="text-lg md:text-xl text-gray-400 mt-1"></p>
            </div>

            <!-- Poster and Core Info Section -->
            <div class="flex flex-col md:flex-row gap-8 md:gap-10 mb-8">
                <!-- Left: Poster -->
                <div class="flex-shrink-0 mx-auto md:mx-0">
                    <img id="movie-poster" src="https://placehold.co/300x450/1f2937/9ca3af?text=Loading..." alt="Movie Poster" class="rounded-lg shadow-lg w-64 md:w-72 object-cover">
                </div>

                <!-- Right: Details -->
                <div class="flex-1 flex flex-col min-w-0">
                    <div class="space-y-5">
                        <div>
                            <h3 class="font-semibold text-lg text-cyan-400 mb-1">Director</h3>
                            <p id="movie-director" class="text-gray-300"></p>
                        </div>
                        <div>
                            <h3 class="font-semibold text-lg text-cyan-400 mb-1">Top Cast</h3>
                            <p id="movie-cast" class="text-gray-300 leading-relaxed"></p>
                        </div>
                        <div>
                            <h3 class="font-semibold text-lg text-cyan-400 mb-1">Genre</h3>
                            <p id="movie-genres" class="text-gray-300"></p>
                        </div>
                        <div>
                            <h3 class="font-semibold text-lg text-cyan-400 mb-1">Description</h3>
                            <p id="movie-overview" class="text-gray-300 leading-relaxed max-h-48 overflow-y-auto"></p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Ratings Section -->
            <div class="border-t border-b border-gray-700/50 my-8 py-6 grid grid-cols-1 md:grid-cols-2 gap-6 text-center">
                <div>
                    <h3 class="font-semibold text-lg text-white mb-2">Average Rating</h3>
                    <div id="avg-rating" class="flex justify-center items-center space-x-1">
                        <!-- Stars will be injected by JS -->
                    </div>
                </div>
                <div>
                    <h3 class="font-semibold text-lg text-white mb-2">My Rating</h3>
                    <div id="my-rating" class="flex justify-center items-center space-x-1">
                        <!-- Stars will be injected by JS -->
                    </div>
                </div>
            </div>

            <!-- Comments Section -->
            <div class="mb-8">
                <h2 class="flex items-center text-2xl font-bold mb-5 text-white">
                    <img src="icons/comment.svg" class="w-6 h-6 mr-3" alt="Comments">
                    Comments
                </h2>
                <div id="comments-section" class="space-y-4">
                    <!-- Comments will be injected by JS -->
                </div>
            </div>

            <!-- Back Button -->
            <div class="text-center mt-12">
                <a href="javascript:history.back()" class="inline-flex items-center bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-5 rounded-lg transition-colors duration-200">
                    <img src="icons/back.svg" class="w-5 h-5 mr-2" alt="Back">
                    <span>Back</span>
                </a>
            </div>
        </div>
    </main>

    <script>
        // This listener will now correctly run AFTER all deferred scripts have executed.
        document.addEventListener('DOMContentLoaded', () => {
            // Dynamically load the navbar
            loadNavbar();
            
            // Check user authentication status
            checkAuth(user => {
                if (user) {
                    // Get the movie ID from the URL (e.g., library.html?id=someMovieId)
                    const movieId = new URLSearchParams(window.location.search).get('id');
                    if (movieId) {
                        loadMoviePage(user.uid, movieId);
                    } else {
                        // Handle case where no movie ID is in the URL
                        displayError("No movie specified. Please go back and select a movie.");
                    }
                } else {
                    // If not authenticated, redirect to the login page
                    window.location.href = 'auth.html';
                }
            });
        });

        /**
         * Fetches movie details via the Vercel proxy.
         * @param {string} tmdbId - The movie ID from The Movie Database.
         * @returns {Promise<object>} A promise that resolves to the movie details object.
         */
        async function getMovieDetails(tmdbId) {
            // The URL points to our own serverless function which acts as a proxy.
            const url = `/api/tmdb?id=${tmdbId}&append_to_response=credits`;

            const response = await fetch(url);
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ message: 'An unknown error occurred.' }));
                throw new Error(`Failed to fetch movie details: ${errorData.message}`);
            }
            return await response.json();
        }

        /**
         * Fetches all movie data and populates the page.
         * @param {string} userId - The current user's ID from Firebase Auth.
         * @param {string} movieId - The Firestore document ID for the movie.
         */
 // Replace your loadMoviePage function in library.html with this fixed version

async function loadMoviePage(user, movieId) {
    try {
        // Get the main movie document
        const movieDocRef = db.collection('movies').doc(movieId);
        const movieDoc = await movieDocRef.get();

        if (!movieDoc.exists) {
            throw new Error("This movie could not be found in the main library.");
        }
        const movieData = { id: movieDoc.id, ...movieDoc.data() };

        // ✅ FIXED: Use collectionGroup query with movieId field
        console.log('Searching for interactions with movieId:', movieId);
        
        const interactionsSnapshot = await db.collectionGroup('movieInteractions')
            .where('movieId', '==', movieId)
            .get();
        
        console.log('Found interactions:', interactionsSnapshot.size);
        
        const allInteractions = interactionsSnapshot.docs.map(doc => {
            // Extract the userId from the document's path
            const pathParts = doc.ref.path.split('/');
            const userId = pathParts[1]; 
            const data = doc.data();
            console.log('Interaction data:', { userId, data });
            return { userId: userId, ...data };
        });
        
        // Find the current user's specific interaction from the aggregated list
        const myInteraction = allInteractions.find(interaction => interaction.userId === user.uid);

        // Populate page content
        populateMovieDetails(movieData, myInteraction, allInteractions);
        await loadCommentsWithUserData(allInteractions);

        // Show the content
        document.getElementById('loadingState').style.display = 'none';
        document.getElementById('detailsContainer').style.display = 'block';

    } catch (error) {
        console.error("Error loading movie page:", error);
        displayError(error.message || "An unknown error occurred.");
    }
}

// ✅ NEW: Separate function to load comments with proper user data fetching
async function loadCommentsWithUserData(interactions) {
    const commentsContainer = document.getElementById('commentsContainer');
    commentsContainer.innerHTML = ''; // Clear previous comments

    // Filter for interactions that have reviews
    const commentsWithReviews = interactions.filter(i => i.review && i.review.trim() !== '');
    
    console.log('Comments with reviews:', commentsWithReviews);

    if (commentsWithReviews.length === 0) {
        commentsContainer.innerHTML = `<p class="review-text-empty">No comments yet. Be the first to leave a review!</p>`;
        return;
    }

    // Get unique user IDs to fetch display names
    const userIds = [...new Set(commentsWithReviews.map(c => c.userId))];
    console.log('Fetching user data for:', userIds);
    
    // Fetch user profiles in parallel
    const userPromises = userIds.map(async id => {
        try {
            const userDoc = await db.collection('users').doc(id).get();
            return {
                id: id,
                displayName: userDoc.exists ? userDoc.data().displayName : 'Anonymous'
            };
        } catch (error) {
            console.error(`Error fetching user ${id}:`, error);
            return { id: id, displayName: 'Anonymous' };
        }
    });
    
    const userData = await Promise.all(userPromises);
    console.log('User data fetched:', userData);
    
    // Create a map for easy lookup: userId -> displayName
    const userMap = new Map();
    userData.forEach(user => {
        userMap.set(user.id, user.displayName);
    });

    // Render comments
    commentsWithReviews.forEach(comment => {
        const username = userMap.get(comment.userId) || 'Anonymous';
        const commentEl = document.createElement('div');
        commentEl.className = 'comment-item';
        commentEl.innerHTML = `
            <p class="review-text">"${comment.review}"</p>
            <p class="comment-author">by <a href="profile.html?id=${comment.userId}">${username}</a></p>
        `;
        commentsContainer.appendChild(commentEl);
    });
}

// ✅ UPDATED: Simplified populateMovieDetails function
function populateMovieDetails(movieData, myInteraction, allInteractions) {
    document.getElementById('movieTitle').textContent = movieData.title || 'Untitled';
    document.getElementById('movieYear').textContent = movieData.year || 'N/A';
    document.getElementById('moviePoster').src = movieData.posterUrl || 'https://placehold.co/300x450/1a1a1a/4a4a4a?text=No+Poster';
    document.getElementById('moviePoster').alt = `Poster for ${movieData.title}`;
    document.getElementById('movieDirector').textContent = movieData.director || 'N/A';
    document.getElementById('movieCast').textContent = Array.isArray(movieData.cast) ? movieData.cast.join(', ') : 'N/A';
    document.getElementById('movieGenre').textContent = movieData.genre || 'N/A';
    document.getElementById('movieOverview').textContent = movieData.overview || 'No description available.';

    // Calculate average rating from all fetched interactions
    const ratings = allInteractions.map(i => i.rating).filter(r => r > 0);
    const avgRating = ratings.length > 0 ? ratings.reduce((a, b) => a + b, 0) / ratings.length : null;

    renderStars(document.getElementById('averageRating'), avgRating); 
    renderStars(document.getElementById('myRating'), myInteraction ? myInteraction.rating : 0);
}
        /**
         * Renders a 5-star rating based on a given score.
         * @param {HTMLElement} container - The element to inject the stars into.
         * @param {number} rating - The rating score (e.g., 3.5).
         */
        function renderStars(container, rating) {
            container.innerHTML = ''; // Clear existing stars
            if (typeof rating !== 'number' || rating <= 0) {
                container.innerHTML = `<span class="text-gray-400">Not rated</span>`;
                return;
            }

            let starsHTML = '';
            const fullStars = Math.floor(rating);
            const halfStar = rating % 1 >= 0.4;
            const emptyStars = 5 - fullStars - (halfStar ? 1 : 0);

            for (let i = 0; i < fullStars; i++) {
                starsHTML += `<img src="icons/star-full.svg" class="star-icon" alt="Full Star">`;
            }
            if (halfStar) {
                starsHTML += `<img src="icons/star-half.svg" class="star-icon" alt="Half Star">`;
            }
            for (let i = 0; i < emptyStars; i++) {
                starsHTML += `<img src="icons/star-empty.svg" class="star-icon" alt="Empty Star">`;
            }
            starsHTML += `<span class="ml-2 text-gray-300 font-medium">${rating.toFixed(1)} / 5.0</span>`;
            container.innerHTML = starsHTML;
        }

        /**
         * Displays an error message on the page.
         * @param {string} message - The error message to display.
         */
        function displayError(message) {
            const detailsContainer = document.getElementById('movie-details-container');
            detailsContainer.innerHTML = `
                <div class="text-center text-red-400 bg-red-900/50 p-8 rounded-lg">
                    <h1 class="text-2xl font-bold mb-2">An Error Occurred</h1>
                    <p>${message}</p>
                    <a href="/index.html" class="mt-6 inline-block bg-cyan-500 text-white font-bold py-2 px-4 rounded hover:bg-cyan-600 transition-colors">Go Home</a>
                </div>
            `;
            document.getElementById('loading').classList.add('hidden');
            detailsContainer.classList.remove('hidden');
        }

    </script>
</body>
</html>
