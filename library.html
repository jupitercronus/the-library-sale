<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Movie Details - The Library Sale</title>
    <!-- Google Fonts & Styles -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=B612+Mono&family=Dokdo&family=Kirang+Haerang&family=M+PLUS+2&family=Syne+Mono&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-auth-compat.js"></script>   
    <!-- App Utilities & Main Script -->
    <script src="utils.js" defer></script>
    <script src="main.js" defer></script>
</head>
<body>
    <header id="navbar-placeholder"></header>

    <!-- Replace your detailsContainer div with this updated structure: -->
    <div id="detailsContainer" class="details-page-container" style="display: none;">
        
        <!-- Centered Title, Year, and Ratings (Ticket Style) -->
        <div class="details-ticket">
            <h1 id="movieTitle" class="details-title"></h1>
            <p id="movieYear" class="details-year"></p>
            
            <!-- Ratings Section - NOW INSIDE THE TICKET -->
            <div class="details-ratings">
                <div class="rating-box">
                    <h3>Average Rating</h3>
                    <div id="averageRating" class="media-rating"></div>
                </div>
                <div class="rating-box">
                    <h3>My Rating</h3>
                    <div id="myRating" class="media-rating"></div>
                </div>
            </div>
        </div>

        <!-- Main Content Grid (Poster + Info) -->
        <div class="details-main-content">
            <div class="details-poster">
                <img id="moviePoster" src="" alt="Movie Poster">
            </div>
            <div class="details-info">
                <div class="details-info-group">
                    <h3>Director</h3>
                    <p id="movieDirector"></p>
                </div>
                <div class="details-info-group">
                    <h3>Top Cast</h3>
                    <p id="movieCast"></p>
                </div>
                <div class="details-info-group">
                    <h3>Genre</h3>
                    <p id="movieGenre"></p>
                </div>
                <div class="details-info-group">
                    <h3>Summary</h3>
                    <p id="movieOverview"></p>
                </div>
            </div>
        </div>

        <!-- Comments Section -->
        <div class="details-comments-section">
            <h2 class="comments-header">
                <span class="icon"></span>
                Comments
            </h2>
            <div id="commentsContainer" class="comments-list">
                <!-- Comments will be injected by JS -->
            </div>
        </div>

        <!-- Footer with Back Button -->
        <footer class="details-footer">
            <a href="index.html" class="btn-back"></a>
        </footer>
    </div>

    <!-- Loading and Error States -->
    <div id="loadingState" class="main-container" style="text-align: center; padding: 50px;">
        <h2>Loading...</h2>
    </div>
    <div id="errorState" class="main-container" style="display: none; text-align: center; padding: 50px;">
        <h2 id="errorMessage"></h2>
        <a href="index.html" class="btn-back" style="margin-top: 20px;"></a>
    </div>

<script>
                // Replace your entire script section in library.html with this fixed version:

                // --- FIREBASE INITIALIZATION ---
                    const firebaseConfig = {
                    apiKey: "AIzaSyDDW8LtwpYevdkD7Q-_CxJ23mMfi00P21M",
                    authDomain: "tiny-lizard.firebaseapp.com",
                    projectId: "tiny-lizard",
                    storageBucket: "tiny-lizard.firebasestorage.app",
                    messagingSenderId: "250872474692",
                    appId: "1:250872474692:web:969e0b1302ae3cb4666011"
                    };
                    const app = firebase.initializeApp(firebaseConfig);
                    const db = firebase.firestore(); 
                    const auth = firebase.auth();

                // Define all functions first, then set up event listeners
                function populateMovieDetails(movieData, myInteraction, allInteractions) {
                    document.getElementById('movieTitle').textContent = movieData.title || 'Untitled';
                    document.getElementById('movieYear').textContent = movieData.year || 'N/A';
                    document.getElementById('moviePoster').src = movieData.posterUrl || 'https://placehold.co/300x450/1a1a1a/4a4a4a?text=No+Poster';
                    document.getElementById('moviePoster').alt = `Poster for ${movieData.title}`;
                    document.getElementById('movieDirector').textContent = movieData.director || 'N/A';
                    document.getElementById('movieCast').textContent = Array.isArray(movieData.cast) ? movieData.cast.join(', ') : 'N/A';
                    document.getElementById('movieGenre').textContent = movieData.genre || 'N/A';
                    document.getElementById('movieOverview').textContent = movieData.overview || 'No description available.';

                    // Calculate average rating from all fetched interactions
                    const ratings = allInteractions.map(i => i.rating).filter(r => r > 0);
                    const avgRating = ratings.length > 0 ? ratings.reduce((a, b) => a + b, 0) / ratings.length : null;

                    renderStars(document.getElementById('averageRating'), avgRating); 
                    renderStars(document.getElementById('myRating'), myInteraction ? myInteraction.rating : 0);
                }

                async function commentsContainer(interactions) {
                    const commentsContainer = document.getElementById('commentsContainer');
                    commentsContainer.innerHTML = ''; // Clear previous comments

                    const comments = interactions.filter(i => i.review && i.review.trim() !== '');

                    if (comments.length === 0) {
                        commentsContainer.innerHTML = `<p class="review-text-empty">No comments yet. Be the first to leave a review!</p>`;
                        return;
                    }

                    // Fetch user profiles to get display names, avoiding duplicate fetches
                    const userIds = [...new Set(comments.map(c => c.userId))];
                    const userPromises = userIds.map(id => db.collection('users').doc(id).get());
                    
                    // Await all profile fetches
                    const userDocs = await Promise.all(userPromises);
                    
                    // Create a map for easy lookup: userId -> username
                    const userMap = new Map();
                    userDocs.forEach(doc => {
                        if (doc.exists) {
                            userMap.set(doc.id, doc.data().displayName || 'Anonymous');
                        }
                    });

                    comments.forEach(comment => {
                        const username = userMap.get(comment.userId) || 'Anonymous';
                        const commentEl = document.createElement('div');
                        commentEl.className = 'comment-item';
                        commentEl.innerHTML = `
                            <p class="review-text">"${comment.review}"</p>
                            <p class="comment-author">by <a href="profile.html?id=${comment.userId}">${username}</a></p>
                        `;
                        commentsContainer.appendChild(commentEl);
                    });
                }

                function renderStars(container, rating) {
                    container.innerHTML = '';
                    if (typeof rating !== 'number' || rating <= 0) {
                        container.innerHTML = `<span class="not-rated">Not Rated</span>`;
                        return;
                    }
                    let starsHTML = '';
                    for (let i = 1; i <= 5; i++) {
                        if (i <= rating) starsHTML += `<span class="star star-full"></span>`;
                        else if (i - 0.5 <= rating) starsHTML += `<span class="star star-half"></span>`;
                        else starsHTML += `<span class="star star-empty"></span>`;
                    }
                    starsHTML += `<span class="rating-text">${rating.toFixed(1)} / 5.0</span>`;
                    container.innerHTML = starsHTML;
                }

                function displayError(message) {
                    const loadingState = document.getElementById('loadingState');
                    const errorState = document.getElementById('errorState');
                    const errorMessage = document.getElementById('errorMessage');
                    
                    if (loadingState) loadingState.style.display = 'none';
                    if (errorState) errorState.style.display = 'block';
                    if (errorMessage) errorMessage.textContent = message;
                }

                async function loadMoviePage(user, movieId) {
                    try {
                        // Get the main movie document
                        const movieDocRef = db.collection('movies').doc(movieId);
                        const movieDoc = await movieDocRef.get();

                        if (!movieDoc.exists) {
                            throw new Error("This movie could not be found in the main library.");
                        }
                        const movieData = { id: movieDoc.id, ...movieDoc.data() };

                        // FIXED: Use movieId field instead of documentId()
                        const interactionsSnapshot = await db.collectionGroup('movieInteractions')
                            .where('movieId', '==', movieId)
                            .get();
                        
                        const allInteractions = interactionsSnapshot.docs.map(doc => {
                            // Extract the userId from the document's path
                            const pathParts = doc.ref.path.split('/');
                            const userId = pathParts[1]; 
                            return { userId: userId, ...doc.data() };
                        });
                        
                        // Find the current user's specific interaction from the aggregated list
                        const myInteraction = allInteractions.find(interaction => interaction.userId === user.uid);

                        // Populate page content
                        populateMovieDetails(movieData, myInteraction, allInteractions);
                        commentsContainer(allInteractions);

                        // Show the content (with null checks)
                        const loadingState = document.getElementById('loadingState');
                        const detailsContainer = document.getElementById('detailsContainer');
                        
                        if (loadingState) loadingState.style.display = 'none';
                        if (detailsContainer) detailsContainer.style.display = 'block';

                    } catch (error) {
                        console.error("Error loading movie page:", error);
                        displayError(error.message || "An unknown error occurred.");
                    }
                }

                // Set up event listeners after DOM is loaded
                document.addEventListener('DOMContentLoaded', () => {
                    auth.onAuthStateChanged(user => {
                        if (user) {
                            const movieId = new URLSearchParams(window.location.search).get('id');
                            if (movieId) {
                                loadMoviePage(user, movieId);
                            } else {
                                displayError("No movie was selected. Please return to the library.");
                            }
                        } else {
                            window.location.href = 'auth.html';
                        }
                    });
                });

            async function loadMoviePage(user, movieId) {
            try {
                // Get the main movie document
                const movieDocRef = db.collection('movies').doc(movieId);
                const movieDoc = await movieDocRef.get();

                if (!movieDoc.exists) {
                    throw new Error("This movie could not be found in the main library.");
                }
                const movieData = { id: movieDoc.id, ...movieDoc.data() };

                // ✅ FIXED: Use movieId field instead of documentId()
                const interactionsSnapshot = await db.collectionGroup('movieInteractions')
                    .where('movieId', '==', movieId)
                    .get();
                
                const allInteractions = interactionsSnapshot.docs.map(doc => {
                    // Extract the userId from the document's path
                    const pathParts = doc.ref.path.split('/');
                    const userId = pathParts[1]; 
                    return { userId: userId, ...doc.data() };
                });
                
                // Find the current user's specific interaction from the aggregated list
                const myInteraction = allInteractions.find(interaction => interaction.userId === user.uid);

                // Populate page content
                populateMovieDetails(movieData, myInteraction, allInteractions);
                commentsContainer(allInteractions);

                // Show the content
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('detailsContainer').style.display = 'block';

            } catch (error) {
                console.error("Error loading movie page:", error);
                displayError(error.message || "An unknown error occurred.");
            }
        }
        
        function populatePage(movieData, myInteraction, allInteractions) {
            document.getElementById('movieTitle').textContent = movieData.title || 'N/A';
            document.getElementById('movieYear').textContent = movieData.year || 'N/A';
            document.getElementById('moviePoster').src = movieData.posterUrl || '';
            document.getElementById('movieDirector').textContent = movieData.director || 'N/A';
            document.getElementById('movieCast').textContent = Array.isArray(movieData.cast) ? movieData.cast.join(', ') : 'N/A';
            document.getElementById('movieGenre').textContent = movieData.genre || 'N/A';
            document.getElementById('movieOverview').textContent = movieData.overview || 'No summary available.';

            const ratings = allInteractions.map(i => i.rating).filter(r => r > 0);
            const avgRating = ratings.length > 0 ? ratings.reduce((a, b) => a + b, 0) / ratings.length : 0;

            renderStars(document.getElementById('averageRating'), avgRating); 
            renderStars(document.getElementById('myRating'), myInteraction ? myInteraction.rating : 0);
            
            commentsContainer(allInteractions);
        }

        async function commentsContainer(interactions) {
            const commentsContainer = document.getElementById('commentsList');
            commentsContainer.innerHTML = '';

            const comments = interactions.filter(i => i.review && i.review.trim() !== '');
            if (comments.length === 0) {
                commentsContainer.innerHTML = `<p class="no-comments">No comments yet.</p>`;
                return;
            }

            const userIds = [...new Set(comments.map(c => c.userId))];
            const userPromises = userIds.map(id => db.collection('users').doc(id).get());
            const userDocs = await Promise.all(userPromises);
            
            const userMap = new Map();
            userDocs.forEach(doc => {
                if (doc.exists) userMap.set(doc.id, doc.data().displayName || 'Anonymous');
            });

            comments.forEach(comment => {
                const username = userMap.get(comment.userId) || 'Anonymous';
                const commentEl = document.createElement('div');
                commentEl.className = 'comment-item';
                commentEl.innerHTML = `
                    <p class="comment-text">"${comment.review}"</p>
                    <p class="comment-author">by <a href="profile.html?id=${comment.userId}">${username}</a></p>
                `;
                commentsContainer.appendChild(commentEl);
            });
        }

        function renderStars(container, rating) {
            container.innerHTML = '';
            if (typeof rating !== 'number' || rating <= 0) {
                container.innerHTML = `<span class="not-rated">Not Rated</span>`;
                return;
            }
            let starsHTML = '';
            for (let i = 1; i <= 5; i++) {
                if (i <= rating) starsHTML += `<span class="star star-full"></span>`;
                else if (i - 0.5 <= rating) starsHTML += `<span class="star star-half"></span>`;
                else starsHTML += `<span class="star star-empty"></span>`;
            }
            starsHTML += `<span class="rating-text">${rating.toFixed(1)} / 5.0</span>`;
            container.innerHTML = starsHTML;
        }

        function displayError(message) {
            document.getElementById('loadingState').style.display = 'none';
            const errorState = document.getElementById('errorState');
            errorState.style.display = 'block';
            document.getElementById('errorMessage').textContent = `Error: ${message}`;
        }
    </script>
</body>
</html>
