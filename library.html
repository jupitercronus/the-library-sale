<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Movie Details - The Library Sale</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=B612+Mono&family=Dokdo&family=Kirang+Haerang&family=M+PLUS+2&family=Syne+Mono&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-auth-compat.js"></script>
    <script src="utils.js" defer></script>
    <link rel="stylesheet" href="style.css">
    <script src="main.js" defer></script>
</head>
<body>
    <div>
        <header id="navbar-placeholder"></header>
        <!-- The rest of your page content -->
    </div>
    <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <!-- Loading Spinner -->
        <div id="loading" class="flex justify-center items-center h-64">
            <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-cyan-500"></div>
        </div>

        <!-- Main Movie Details Container -->
        <div id="movie-details-container" class="hidden max-w-4xl mx-auto">

            <!-- Movie Title and Year -->
            <div class="text-center mb-8">
                <h1 id="movie-title" class="text-3xl md:text-5xl font-bold tracking-tight text-white"></h1>
                <p id="movie-year" class="text-lg md:text-xl text-gray-400 mt-1"></p>
            </div>

            <!-- Poster and Core Info Section -->
            <div class="flex flex-col md:flex-row gap-8 md:gap-10 mb-8">
                <!-- Left: Poster -->
                <div class="flex-shrink-0 mx-auto md:mx-0">
                    <img id="movie-poster" src="https://placehold.co/300x450/1f2937/9ca3af?text=Loading..." alt="Movie Poster" class="rounded-lg shadow-lg w-64 md:w-72 object-cover">
                </div>

                <!-- Right: Details -->
                <div class="flex-1 flex flex-col min-w-0">
                    <div class="space-y-5">
                        <div>
                            <h3 class="font-semibold text-lg text-cyan-400 mb-1">Director</h3>
                            <p id="movie-director" class="text-gray-300"></p>
                        </div>
                        <div>
                            <h3 class="font-semibold text-lg text-cyan-400 mb-1">Top Cast</h3>
                            <p id="movie-cast" class="text-gray-300 leading-relaxed"></p>
                        </div>
                        <div>
                            <h3 class="font-semibold text-lg text-cyan-400 mb-1">Genre</h3>
                            <p id="movie-genres" class="text-gray-300"></p>
                        </div>
                        <div>
                            <h3 class="font-semibold text-lg text-cyan-400 mb-1">Description</h3>
                            <p id="movie-overview" class="text-gray-300 leading-relaxed max-h-48 overflow-y-auto"></p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Ratings Section -->
            <div class="border-t border-b border-gray-700/50 my-8 py-6 grid grid-cols-1 md:grid-cols-2 gap-6 text-center">
                <div>
                    <h3 class="font-semibold text-lg text-white mb-2">Average Rating</h3>
                    <div id="avg-rating" class="flex justify-center items-center space-x-1">
                        <!-- Stars will be injected by JS -->
                    </div>
                </div>
                <div>
                    <h3 class="font-semibold text-lg text-white mb-2">My Rating</h3>
                    <div id="my-rating" class="flex justify-center items-center space-x-1">
                        <!-- Stars will be injected by JS -->
                    </div>
                </div>
            </div>

            <!-- Comments Section -->
            <div class="mb-8">
                <h2 class="flex items-center text-2xl font-bold mb-5 text-white">
                    <img src="icons/comment.svg" class="w-6 h-6 mr-3" alt="Comments">
                    Comments
                </h2>
                <div id="comments-section" class="space-y-4">
                    <!-- Comments will be injected by JS -->
                </div>
            </div>

            <!-- Back Button -->
            <div class="text-center mt-12">
                <a href="javascript:history.back()" class="inline-flex items-center bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-5 rounded-lg transition-colors duration-200">
                    <img src="icons/back.svg" class="w-5 h-5 mr-2" alt="Back">
                    <span>Back</span>
                </a>
            </div>
        </div>
    </main>

    <script>
        // This listener will now correctly run AFTER all deferred scripts have executed.
        document.addEventListener('DOMContentLoaded', () => {
            
            // Check user authentication status
            checkAuth(user => {
                if (user) {
                    // Get the movie ID from the URL (e.g., library.html?id=someMovieId)
                    const movieId = new URLSearchParams(window.location.search).get('id');
                    if (movieId) {
                        loadMoviePage(user.uid, movieId);
                    } else {
                        // Handle case where no movie ID is in the URL
                        displayError("No movie specified. Please go back and select a movie.");
                    }
                } else {
                    // If not authenticated, redirect to the login page
                    window.location.href = 'auth.html';
                }
            });
        });

        /**
         * Fetches movie details via the Vercel proxy.
         * @param {string} tmdbId - The movie ID from The Movie Database.
         * @returns {Promise<object>} A promise that resolves to the movie details object.
         */
        async function getMovieDetails(tmdbId) {
            // The URL points to our own serverless function which acts as a proxy.
            const url = `/api/tmdb?id=${tmdbId}&append_to_response=credits`;

            const response = await fetch(url);
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ message: 'An unknown error occurred.' }));
                throw new Error(`Failed to fetch movie details: ${errorData.message}`);
            }
            return await response.json();
        }

        /**
         * Fetches all movie data and populates the page.
         * @param {string} userId - The current user's ID from Firebase Auth.
         * @param {string} movieId - The Firestore document ID for the movie.
         */
        async function loadMoviePage(userId, movieId) {
            const detailsContainer = document.getElementById('movie-details-container');
            const loading = document.getElementById('loading');
            
            try {
                // 1. Get movie data from our Firestore database
                const movieDocRef = db.collection('users').doc(userId).collection('movies').doc(movieId);
                const movieDoc = await movieDocRef.get();

                if (!movieDoc.exists) {
                    throw new Error("Movie not found in your library.");
                }
                const movieData = movieDoc.data();
                const tmdbId = movieData.tmdb_id;
                const myRating = movieData.rating;

                // 2. Get rich movie details from the TMDB API via our Vercel proxy
                const tmdbDetails = await getMovieDetails(tmdbId);

                // 3. Populate the main movie details
                document.getElementById('movie-title').textContent = tmdbDetails.title;
                document.getElementById('movie-year').textContent = tmdbDetails.release_date ? new Date(tmdbDetails.release_date).getFullYear() : 'N/A';
                document.getElementById('movie-poster').src = tmdbDetails.poster_path ? `https://image.tmdb.org/t/p/w500${tmdbDetails.poster_path}` : 'https://placehold.co/300x450/1f2937/9ca3af?text=No+Image';
                document.getElementById('movie-poster').alt = `Poster for ${tmdbDetails.title}`;
                document.getElementById('movie-overview').textContent = tmdbDetails.overview || 'No description available.';
                document.getElementById('movie-genres').textContent = tmdbDetails.genres.map(g => g.name).join(', ') || 'N/A';

                // 4. Populate credits (Director and Cast)
                const director = tmdbDetails.credits.crew.find(person => person.job === 'Director');
                document.getElementById('movie-director').textContent = director ? director.name : 'N/A';
                const cast = tmdbDetails.credits.cast.slice(0, 5).map(person => person.name).join(', ');
                document.getElementById('movie-cast').textContent = cast || 'N/A';

                // 5. Render star ratings
                renderStars(document.getElementById('avg-rating'), tmdbDetails.vote_average / 2); // Convert /10 to /5 scale
                renderStars(document.getElementById('my-rating'), myRating);

                // 6. Fetch and render comments from the 'comments' subcollection
                const commentsSection = document.getElementById('comments-section');
                commentsSection.innerHTML = ''; // Clear placeholder
                const commentsSnapshot = await movieDocRef.collection('comments').orderBy('timestamp', 'desc').get();

                if (commentsSnapshot.empty) {
                    commentsSection.innerHTML = '<p class="text-gray-400 italic">No comments yet.</p>';
                } else {
                    commentsSnapshot.forEach(doc => {
                        const comment = doc.data();
                        const commentEl = document.createElement('div');
                        commentEl.className = 'bg-gray-800/50 p-4 rounded-lg';
                        // Note: In a real app, sanitize user-generated content before rendering.
                        commentEl.innerHTML = `
                            <p class="italic">"${comment.text}"</p>
                            <p class="text-right text-sm text-gray-400 mt-2">- by <a href="/profile.html?user=${comment.userId}" class="text-cyan-400 hover:underline">${comment.username || 'user'}</a></p>
                        `;
                        commentsSection.appendChild(commentEl);
                    });
                }

            } catch (error) {
                console.error("Error loading movie page:", error);
                displayError(error.message);
            } finally {
                // Hide loading spinner and show the content
                loading.classList.add('hidden');
                detailsContainer.classList.remove('hidden');
            }
        }

        /**
         * Renders a 5-star rating based on a given score.
         * @param {HTMLElement} container - The element to inject the stars into.
         * @param {number} rating - The rating score (e.g., 3.5).
         */
        function renderStars(container, rating) {
            container.innerHTML = ''; // Clear existing stars
            if (typeof rating !== 'number' || rating <= 0) {
                container.innerHTML = `<span class="text-gray-400">Not rated</span>`;
                return;
            }

            let starsHTML = '';
            const fullStars = Math.floor(rating);
            const halfStar = rating % 1 >= 0.4;
            const emptyStars = 5 - fullStars - (halfStar ? 1 : 0);

            for (let i = 0; i < fullStars; i++) {
                starsHTML += `<img src="icons/star-full.svg" class="star-icon" alt="Full Star">`;
            }
            if (halfStar) {
                starsHTML += `<img src="icons/star-half.svg" class="star-icon" alt="Half Star">`;
            }
            for (let i = 0; i < emptyStars; i++) {
                starsHTML += `<img src="icons/star-empty.svg" class="star-icon" alt="Empty Star">`;
            }
            starsHTML += `<span class="ml-2 text-gray-300 font-medium">${rating.toFixed(1)} / 5.0</span>`;
            container.innerHTML = starsHTML;
        }

        /**
         * Displays an error message on the page.
         * @param {string} message - The error message to display.
         */
        function displayError(message) {
            const detailsContainer = document.getElementById('movie-details-container');
            detailsContainer.innerHTML = `
                <div class="text-center text-red-400 bg-red-900/50 p-8 rounded-lg">
                    <h1 class="text-2xl font-bold mb-2">An Error Occurred</h1>
                    <p>${message}</p>
                    <a href="/index.html" class="mt-6 inline-block bg-cyan-500 text-white font-bold py-2 px-4 rounded hover:bg-cyan-600 transition-colors">Go Home</a>
                </div>
            `;
            document.getElementById('loading').classList.add('hidden');
            detailsContainer.classList.remove('hidden');
        }

    </script>
</body>
</html>
