<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Physical Copies Migration - ADMIN ONLY</title>
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-auth-compat.js"></script>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .warning { background: #ffebee; border: 1px solid #f44336; padding: 15px; margin: 20px 0; border-radius: 4px; }
        .log-info { color: #2e7d32; margin: 5px 0; }
        .log-error { color: #d32f2f; margin: 5px 0; font-weight: bold; }
        #progress { height: 400px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; background: #f9f9f9; }
        .btn { padding: 10px 20px; margin: 10px 5px; border: none; border-radius: 4px; cursor: pointer; }
        .btn-primary { background: #1976d2; color: white; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        .access-denied { text-align: center; color: #d32f2f; }
        .loading { text-align: center; margin: 50px 0; }
    </style>
</head>
<body>
    <div id="loadingState" class="loading">
        <h2>Checking permissions...</h2>
    </div>

    <div id="accessDenied" class="access-denied" style="display: none;">
        <h1>üö´ Access Denied</h1>
        <p>This migration tool is restricted to administrators only.</p>
        <p>Contact system administrator if you need access.</p>
        <a href="index.html">‚Üê Back to Library</a>
    </div>

    <div id="migrationInterface" style="display: none;">
        <h1>üîÑ Physical Copies Migration</h1>
        
        <div class="warning">
            <strong>‚ö†Ô∏è IMPORTANT - READ BEFORE PROCEEDING</strong>
            <ul>
                <li>This migration will modify ALL user data in the database</li>
                <li>The process is NOT reversible - make sure you have a database backup</li>
                <li>Users may experience temporary issues during migration</li>
                <li>Migration should be run during low-traffic hours</li>
                <li>Do NOT run this multiple times</li>
            </ul>
        </div>

        <div style="background: #e3f2fd; padding: 15px; margin: 20px 0; border-radius: 4px;">
            <h3>What this migration does:</h3>
            <ol>
                <li>Scans all user movie interactions with physical data</li>
                <li>Creates new physicalCopies documents for unique items</li>
                <li>Updates user interactions to reference the new physical copies</li>
                <li>Preserves all existing data for backward compatibility</li>
                <li>Logs detailed statistics for monitoring</li>
            </ol>
        </div>

        <div>
            <h3>Pre-Migration Checklist:</h3>
            <label><input type="checkbox" id="backupCheck"> ‚úÖ Database backup completed</label><br>
            <label><input type="checkbox" id="timingCheck"> ‚úÖ Running during low-traffic period</label><br>
            <label><input type="checkbox" id="alertCheck"> ‚úÖ Users notified of potential temporary issues</label><br>
            <label><input type="checkbox" id="confirmCheck"> ‚úÖ I understand this process is irreversible</label><br>
        </div>

        <div style="margin: 20px 0;">
            <h3>Migration Progress:</h3>
            <div id="migrationStatus">Ready to start migration...</div>
            <div id="progress">
                <div style="color: #666; font-style: italic;">Migration logs will appear here...</div>
            </div>
        </div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDDW8LtwpYevdkD7Q-_CxJ23mMfi00P21M",
            authDomain: "tiny-lizard.firebaseapp.com",
            projectId: "tiny-lizard",
            storageBucket: "tiny-lizard.firebasestorage.app",
            messagingSenderId: "250872474692",
            appId: "1:250872474692:web:969e0b1302ae3cb4666011",
        };
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // Check admin permissions
        async function checkAdminAccess(user) {
            try {
                const adminDoc = await db.collection('admins').doc(user.uid).get();
                return adminDoc.exists && adminDoc.data().isActive === true;
            } catch (error) {
                console.error('Error checking admin status:', error);
                return false;
            }
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', () => {
            auth.onAuthStateChanged(async (user) => {
                const loadingState = document.getElementById('loadingState');
                const accessDenied = document.getElementById('accessDenied');
                const migrationInterface = document.getElementById('migrationInterface');

                if (!user) {
                    // Redirect to auth page
                    window.location.href = 'auth.html';
                    return;
                }

                const isAdmin = await checkAdminAccess(user);
                loadingState.style.display = 'none';

                if (!isAdmin) {
                    accessDenied.style.display = 'block';
                    return;
                }

                // User is admin, show migration interface
                migrationInterface.style.display = 'block';
                setupMigrationInterface();
            });
        });

        function setupMigrationInterface() {
            const checkboxes = ['backupCheck', 'timingCheck', 'alertCheck', 'confirmCheck'];
            const startButton = document.createElement('button');
            startButton.textContent = 'Start Migration';
            startButton.className = 'btn btn-primary';
            startButton.disabled = true;
            startButton.id = 'startMigrationBtn';

            // Add button after progress div
            document.getElementById('progress').parentNode.appendChild(startButton);

            // Enable button only when all checkboxes are checked
            function updateButtonState() {
                const allChecked = checkboxes.every(id => document.getElementById(id).checked);
                startButton.disabled = !allChecked;
            }

            checkboxes.forEach(id => {
                document.getElementById(id).addEventListener('change', updateButtonState);
            });

            startButton.addEventListener('click', () => {
                if (confirm('Are you absolutely sure you want to start the migration? This cannot be undone.')) {
                    startMigration();
                }
            });
        }

        function startMigration() {
            const startButton = document.getElementById('startMigrationBtn');
            startButton.disabled = true;
            startButton.textContent = 'Migration Running...';

            // Load and execute the migration script
            const script = document.createElement('script');
            script.src = 'migration-physical-copies.js';
            script.onload = () => {
                console.log('Migration script loaded');
            };
            script.onerror = () => {
                document.getElementById('migrationStatus').innerHTML = 
                    '<div class="log-error">Failed to load migration script</div>';
            };
            document.head.appendChild(script);
        }
    </script>
</body>
</html>