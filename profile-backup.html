<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile - the library sale</title>
    <!-- Google Fonts Import -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=B612+Mono&family=Dokdo&family=Kirang+Haerang&family=M+PLUS+2&family=Syne+Mono&display=swap" rel="stylesheet">
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-auth-compat.js"></script>
    <!-- App Scripts -->
    <script src="utils.js" defer></script>
    <link rel="stylesheet" href="styles/variables.css">
    <link rel="stylesheet" href="styles/base.css">  
    <link rel="stylesheet" href="styles/components.css">
    <link rel="stylesheet" href="styles/pages.css">
    <script src="main.js" defer></script>
</head>
<body>
    <header id="navbar-placeholder"></header>

    <div class="profile-page-container">
        <!-- Left Sidebar -->
        <aside class="profile-sidebar">
            <div class="sidebar-block">
                <div class="sidebar-search">
                    <div class="search-bar">
                        <input type="text" id="userSearchInput" placeholder="find user..." autocomplete="off">
                    </div>
                    <button id="userSearchBtn" class="btn btn-rectangular btn-primary" title="Search Users">
                        <span class="icon icon-search icon-md"></span>
                    </button>
                    <div id="userSearchResultsContainer" class="search-results-dropdown"></div>
                </div>
            </div>

            <div class="sidebar-block">
                <div id="sidebarUserInfo">
                    <!-- Loading skeleton initially -->
                    <div class="skeleton" style="width: 150px; height: 2em; margin-bottom: var(--space-sm);"></div>
                    <div class="skeleton" style="width: 120px; height: 1em; margin-bottom: var(--space-lg);"></div>
                </div>
                <a href="#" id="myListsLink" class="sidebar-link">
                    <span class="icon icon-list icon-md"></span>
                    My Lists
                </a>
            </div>

            <div class="sidebar-block">
                <h3>Stats</h3>
                <ul class="sidebar-stats" id="statsList">
                    <!-- Loading skeleton initially -->
                    <li class="flex-between">
                        <div class="skeleton" style="width: 80px; height: 1em;"></div>
                        <div class="skeleton" style="width: 40px; height: 1em;"></div>
                    </li>
                    <li class="flex-between">
                        <div class="skeleton" style="width: 90px; height: 1em;"></div>
                        <div class="skeleton" style="width: 30px; height: 1em;"></div>
                    </li>
                    <li class="flex-between">
                        <div class="skeleton" style="width: 100px; height: 1em;"></div>
                        <div class="skeleton" style="width: 50px; height: 1em;"></div>
                    </li>
                    <li class="flex-between">
                        <div class="skeleton" style="width: 70px; height: 1em;"></div>
                        <div class="skeleton" style="width: 60px; height: 1em;"></div>
                    </li>
                    <li class="flex-between">
                        <div class="skeleton" style="width: 110px; height: 1em;"></div>
                        <div class="skeleton" style="width: 20px; height: 1em;"></div>
                    </li>
                </ul>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="profile-main-content">
            <!-- Owned Media Section -->
            <section id="owned-section">
                <div class="media-section-header">
                    <h2>
                        <span class="icon icon-dvds icon-xl"></span>
                        Owned
                    </h2>
                    <div class="media-section-controls">
                        <div class="search-bar">
                            <input type="text" id="ownedSearchInput" class="media-search-input" placeholder="Search owned media...">
                        </div>
                        <select id="ownedSortDropdown" class="filter-dropdown">
                            <option value="dateAddedDesc">Recently Added (Newest)</option>
                            <option value="dateAddedAsc">Recently Added (Oldest)</option>
                            <option value="titleAsc">Title (A-Z)</option>
                            <option value="titleDesc">Title (Z-A)</option>
                        </select>
                    </div>
                </div>
                <div id="ownedMediaGrid" class="profile-media-grid">
                    <!-- Initial loading state -->
                    <div class="loading-container">
                        <div class="loading-content">
                            <div class="loading-spinner"></div>
                            <p class="loading-text">Loading owned media...</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Watched Media Section -->
            <section id="watched-section">
                <div class="media-section-header">
                    <h2>
                        <span class="icon icon-watched icon-xl"></span>
                        Watched
                    </h2>
                    <div class="media-section-controls">
                        <div class="search-bar">
                            <input type="text" id="watchedSearchInput" class="media-search-input" placeholder="Search watched media...">
                        </div>
                        <select id="watchedSortDropdown" class="filter-dropdown">
                            <option value="dateWatchedDesc">Recently Watched</option>
                            <option value="titleAsc">Title (A-Z)</option>
                            <option value="titleDesc">Title (Z-A)</option>
                            <option value="ratingDesc">Rating (High-Low)</option>
                            <option value="ratingAsc">Rating (Low-High)</option>
                        </select>
                    </div>
                </div>
                <div id="watchedMediaGrid" class="profile-media-grid">
                    <!-- Initial loading state -->
                    <div class="loading-container">
                        <div class="loading-content">
                            <div class="loading-spinner"></div>
                            <p class="loading-text">Loading watched media...</p>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script>
        const firebaseConfig = {
          apiKey: "AIzaSyDDW8LtwpYevdkD7Q-_CxJ23mMfi00P21M",
          authDomain: "tiny-lizard.firebaseapp.com",
          projectId: "tiny-lizard",
          storageBucket: "tiny-lizard.firebasestorage.app",
          messagingSenderId: "250872474692",
          appId: "1:250872474692:web:969e0b1302ae3cb4666011"
        };
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore(); 
        const auth = firebase.auth(); 

        let currentUser = null;
        let viewedUserId = null;
        let allOwnedMedia = [];
        let allWatchedMedia = [];
        let allUsersCache = [];

        // Enhanced skeleton UI utilities using CSS component classes
        const ProfileSkeletonUI = {
            showSidebarSkeleton() {
                document.getElementById('sidebarUserInfo').innerHTML = `
                    <div class="skeleton" style="width: 150px; height: 2em; margin-bottom: var(--space-sm);"></div>
                    <div class="skeleton" style="width: 120px; height: 1em; margin-bottom: var(--space-lg);"></div>
                `;
                
                document.getElementById('statsList').innerHTML = Array(9).fill(0).map(() => `
                    <li class="flex-between">
                        <div class="skeleton" style="width: 80px; height: 1em;"></div>
                        <div class="skeleton" style="width: 40px; height: 1em;"></div>
                    </li>
                `).join('');
            },

            showMediaGridSkeleton(containerId, count = 12) {
                const container = document.getElementById(containerId);
                container.innerHTML = Array(count).fill(0).map(() => `
                    <div class="profile-media-item">
                        <div class="skeleton" style="width: 100%; aspect-ratio: var(--media-poster-aspect); border-radius: var(--radius-md);"></div>
                        <div class="skeleton" style="width: 80%; height: 1em; margin-top: var(--space-sm); margin: 0 auto;"></div>
                    </div>
                `).join('');
            },

            showSectionSkeleton(sectionId) {
                const gridId = sectionId === 'owned-section' ? 'ownedMediaGrid' : 'watchedMediaGrid';
                this.showMediaGridSkeleton(gridId, 8);
            },

            showFullPageSkeleton() {
                this.showSidebarSkeleton();
                this.showSectionSkeleton('owned-section');
                this.showSectionSkeleton('watched-section');
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            viewedUserId = urlParams.get('id');

            auth.onAuthStateChanged(user => {
                currentUser = user;
                if (!viewedUserId && user) {
                    viewedUserId = user.uid;
                }
                
                if (viewedUserId) {
                    loadProfileData(viewedUserId);
                } else {
                    window.location.href = 'auth.html';
                }

                fetchAllUsers();
                setupEventListeners();
            });
        });

        function setupEventListeners() {
            const userSearchInput = document.getElementById('userSearchInput');
            const userSearchBtn = document.getElementById('userSearchBtn');
            const userResultsContainer = document.getElementById('userSearchResultsContainer');

            const performUserSearch = (query) => {
                const lowerCaseQuery = query.toLowerCase();
                userResultsContainer.classList.add('active');

                const filteredUsers = allUsersCache.filter(user =>
                    user.displayName && user.displayName.toLowerCase().includes(lowerCaseQuery)
                ).slice(0, 10);

                if (filteredUsers.length === 0) {
                    userResultsContainer.innerHTML = `
                        <div class="user-search-result">
                            <span class="icon icon-search icon-sm"></span>
                            No users found
                        </div>
                    `;
                    return;
                }

                userResultsContainer.innerHTML = filteredUsers.map(user => `
                    <div class="user-search-result" onclick="window.location.href='profile.html?id=${user.id}'">
                        <span class="icon icon-details icon-sm"></span>
                        ${user.displayName}
                    </div>
                `).join('');
            };
            
            const debouncedUserSearch = debounce(performUserSearch, 300);

            userSearchInput.addEventListener('input', () => debouncedUserSearch(userSearchInput.value.trim()));
            userSearchInput.addEventListener('focus', () => performUserSearch(userSearchInput.value.trim()));
            userSearchBtn.addEventListener('click', () => userSearchInput.focus());

            document.addEventListener('click', (e) => {
                if (!document.querySelector('.sidebar-search').contains(e.target)) {
                    userResultsContainer.classList.remove('active');
                }
            });

            // Media search listeners
            document.getElementById('ownedSearchInput').addEventListener('input', () => renderMediaGrid('owned'));
            document.getElementById('ownedSortDropdown').addEventListener('change', () => renderMediaGrid('owned'));
            
            document.getElementById('watchedSearchInput').addEventListener('input', () => renderMediaGrid('watched'));
            document.getElementById('watchedSortDropdown').addEventListener('change', () => renderMediaGrid('watched'));
        }

        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), delay);
            };
        }

        async function fetchAllUsers() {
            try {
                const usersSnapshot = await db.collection('users').get();
                allUsersCache = usersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            } catch (error) {
                console.error("Error fetching all users:", error);
            }
        }

        async function loadProfileData(userId) {
            // Show skeleton immediately for the sections that will load data
            ProfileSkeletonUI.showSidebarSkeleton();
            ProfileSkeletonUI.showSectionSkeleton('owned-section');
            ProfileSkeletonUI.showSectionSkeleton('watched-section');
            
            try {
                // Add minimum loading time for smooth UX
                const [userDoc] = await Promise.all([
                    db.collection('users').doc(userId).get(),
                    new Promise(resolve => setTimeout(resolve, 600))
                ]);
                
                if (!userDoc.exists) {
                    document.querySelector('.profile-main-content').innerHTML = `
                        <div class="error-state">
                            <span class="icon icon-close icon-3xl"></span>
                            <h3>User not found</h3>
                            <p>The requested user profile could not be found.</p>
                            <a href="index.html" class="btn btn-lg btn-primary">
                                <span class="icon icon-back icon-lg"></span>
                                Back to Library
                            </a>
                        </div>
                    `;
                    return;
                }
                
                const profileData = userDoc.data();
                populateSidebar(profileData);

                const interactionsSnapshot = await db.collection('users').doc(userId).collection('movieInteractions').get();
                const interactions = interactionsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                if (interactions.length > 0) {
                    const mediaIds = interactions.map(i => i.id);
                    const mediaChunks = [];
                    for (let i = 0; i < mediaIds.length; i += 10) {
                        mediaChunks.push(mediaIds.slice(i, i + 10));
                    }

                    const allMoviesData = {};
                    for (const chunk of mediaChunks) {
                        const mediaSnapshot = await db.collection('movies').where(firebase.firestore.FieldPath.documentId(), 'in', chunk).get();
                        mediaSnapshot.forEach(doc => {
                            allMoviesData[doc.id] = doc.data();
                        });
                    }
                    
                    const fullMediaDetails = interactions.map(interaction => {
                        const mediaData = allMoviesData[interaction.id];
                        return mediaData ? { ...interaction, ...mediaData } : null;
                    }).filter(Boolean);

                    allOwnedMedia = fullMediaDetails.filter(m => m.owned);
                    allWatchedMedia = fullMediaDetails.filter(m => m.watched);
                    
                    calculateAndDisplayStats(fullMediaDetails);
                } else {
                    calculateAndDisplayStats([]);
                }
                
                // Add small delay for smooth transition from skeleton
                await new Promise(resolve => setTimeout(resolve, 300));
                
                renderMediaGrid('owned');
                renderMediaGrid('watched');

            } catch (error) {
                console.error("Error loading profile data:", error);
                
                // Show error states
                document.getElementById('sidebarUserInfo').innerHTML = `
                    <div class="error-state" style="text-align: center; padding: var(--space-lg);">
                        <span class="icon icon-close icon-lg"></span>
                        <p>Error loading profile</p>
                    </div>
                `;
                
                document.getElementById('ownedMediaGrid').innerHTML = `
                    <div class="error-state">
                        <span class="icon icon-close icon-3xl"></span>
                        <h3>Error loading media</h3>
                        <p>Please try refreshing the page.</p>
                    </div>
                `;
                
                document.getElementById('watchedMediaGrid').innerHTML = `
                    <div class="error-state">
                        <span class="icon icon-close icon-3xl"></span>
                        <h3>Error loading media</h3>
                        <p>Please try refreshing the page.</p>
                    </div>
                `;
            }
        }

        function populateSidebar(profileData) {
            const userInfoContainer = document.getElementById('sidebarUserInfo');
            const isMyProfile = currentUser && currentUser.uid === viewedUserId;
            
            userInfoContainer.innerHTML = `
                <h2 class="sidebar-username">${profileData.displayName || 'Anonymous'}</h2>
                ${isMyProfile ? `<p class="sidebar-email">${profileData.email}</p>` : ''}
            `;
            
            document.getElementById('myListsLink').href = `lists.html?userId=${viewedUserId}`;
        }
        
        function getTopItems(items, threshold = 3) {
            if (!items || items.length === 0) return 'N/A';
            const counts = items.reduce((acc, item) => {
                if (item) {
                    acc[item] = (acc[item] || 0) + 1;
                }
                return acc;
            }, {});

            const filteredItems = Object.entries(counts).filter(([key, value]) => value > threshold);

            if (filteredItems.length === 0) return 'N/A';

            return filteredItems
                .sort((a, b) => b[1] - a[1])
                .slice(0, 3)
                .map(entry => entry[0])
                .join(', ');
        }

        function getFavoriteDecades(watchedItems) {
            if (!watchedItems || watchedItems.length === 0) return 'N/A';
            
            const decadeCounts = watchedItems
                .filter(item => item.year)
                .reduce((acc, item) => {
                    const decade = `${Math.floor(item.year / 10) * 10}s`;
                    acc[decade] = (acc[decade] || 0) + 1;
                    return acc;
                }, {});

            const filteredDecades = Object.entries(decadeCounts)
                .filter(([decade, count]) => count >= 10); // Lower threshold for decades

            if (filteredDecades.length === 0) return 'N/A';

            return filteredDecades
                .sort((a, b) => b[1] - a[1])
                .slice(0, 3)
                .map(entry => entry[0])
                .join(', ');
        }
        
        function generateStarDisplay(rating) {
            if (!rating || rating <= 0) return '<div class="star-rating star-rating-sm"></div>'; 

            const totalStars = 5;
            let starsHTML = '';
            
            for (let i = 1; i <= totalStars; i++) {
                if (i <= rating) {
                    starsHTML += `<span class="star star-full"></span>`;
                } else if (i - 0.5 <= rating) {
                    starsHTML += `<span class="star star-half"></span>`;
                } else {
                    starsHTML += `<span class="star star-empty"></span>`;
                }
            }
            
            return `<div class="star-rating star-rating-sm">${starsHTML}</div>`;
        }

        function calculateAndDisplayStats(mediaItems) {
            const statsList = document.getElementById('statsList');
            const watchedItems = mediaItems.filter(item => item.watched);

            const watchedCount = watchedItems.length;
            const ownedCount = mediaItems.filter(item => item.owned).length;
            
            const ratedItems = mediaItems.filter(item => item.rating && item.rating > 0);
            const avgRatingValue = ratedItems.length > 0
                ? (ratedItems.reduce((sum, item) => sum + item.rating, 0) / ratedItems.length)
                : 0;
            const avgRatingStars = generateStarDisplay(avgRatingValue);
            
            const hoursWatched = Math.round(
                watchedItems
                    .filter(item => item.runtime)
                    .reduce((sum, item) => sum + parseInt(item.runtime), 0) / 60
            );

            const reviewsWritten = mediaItems.filter(item => item.review && item.review.trim() !== '').length;
            
            const topGenre = getTopItems(watchedItems.flatMap(item => (item.genre || '').split(',').map(g => g.trim()).filter(Boolean)), 0);
            const favoriteDecade = getFavoriteDecades(watchedItems);
            const topDirectors = getTopItems(watchedItems.flatMap(item => (item.director || '').split(',').map(d => d.trim()).filter(Boolean)));
            const topCast = getTopItems(watchedItems.flatMap(item => Array.isArray(item.cast) ? item.cast.map(c => c.trim()).filter(Boolean) : []));

            statsList.innerHTML = `
                <li class="flex-between"><strong>Avg. Rating:</strong> <span>${avgRatingStars}</span></li>
                <li class="flex-between"><strong>Media Owned:</strong> <span>${ownedCount}</span></li>
                <li class="flex-between"><strong>Media Watched:</strong> <span>${watchedCount}</span></li>
                <li class="flex-between"><strong>Hours Watched:</strong> <span>${hoursWatched}</span></li>
                <li class="flex-between"><strong>Reviews Written:</strong> <span>${reviewsWritten}</span></li>
                <li class="flex-between"><strong>Top Genre:</strong> <span>${topGenre}</span></li>
                <li class="flex-between"><strong>Favorite Decade:</strong> <span>${favoriteDecade}</span></li>
                <li class="flex-between"><strong>Top Directors:</strong> <span>${topDirectors}</span></li>
                <li class="flex-between"><strong>Top Cast:</strong> <span>${topCast}</span></li>
            `;
        }
        
        function renderMediaGrid(type) {
            const isOwned = type === 'owned';
            const sourceData = isOwned ? allOwnedMedia : allWatchedMedia;
            const gridContainer = document.getElementById(isOwned ? 'ownedMediaGrid' : 'watchedMediaGrid');
            const searchInput = document.getElementById(isOwned ? 'ownedSearchInput' : 'watchedSearchInput').value.toLowerCase();
            const sortValue = document.getElementById(isOwned ? 'ownedSortDropdown' : 'watchedSortDropdown').value;

            let mediaToDisplay = [...sourceData];

            if (searchInput) {
                mediaToDisplay = mediaToDisplay.filter(item => 
                    (item.title || '').toLowerCase().includes(searchInput)
                );
            }

            mediaToDisplay.sort((a, b) => {
                switch (sortValue) {
                    case 'titleAsc': return (a.title || '').localeCompare(b.title || '');
                    case 'titleDesc': return (b.title || '').localeCompare(a.title || '');
                    case 'dateAddedDesc': return (b.interactionDate?.seconds || 0) - (a.interactionDate?.seconds || 0);
                    case 'dateAddedAsc': return (a.interactionDate?.seconds || 0) - (b.interactionDate?.seconds || 0);
                    case 'dateWatchedDesc': return (b.interactionDate?.seconds || 0) - (a.interactionDate?.seconds || 0);
                    case 'ratingDesc': return (b.rating || 0) - (a.rating || 0);
                    case 'ratingAsc': return (a.rating || 0) - (b.rating || 0);
                    default: return 0;
                }
            });

            if (mediaToDisplay.length === 0) {
                gridContainer.innerHTML = `
                    <div class="empty-state">
                        <span class="icon icon-${isOwned ? 'dvds' : 'watched'} icon-3xl"></span>
                        <h3>No ${isOwned ? 'owned' : 'watched'} media found</h3>
                        <p>${searchInput ? 'Try adjusting your search terms.' : `No ${isOwned ? 'owned' : 'watched'} media yet.`}</p>
                        ${!searchInput ? `<a href="add-movie.html" class="btn btn-lg btn-primary">
                            <span class="icon icon-add icon-lg"></span>
                            Add Media
                        </a>` : ''}
                    </div>
                `;
                return;
            }

            gridContainer.innerHTML = mediaToDisplay.map(item => {
                const badgeHTML = item.contentType === 'tv' 
                    ? `<span class="badge badge-tv" title="TV Show"><span class="icon icon-tv icon-sm"></span></span>` 
                    : `<span class="badge badge-movie" title="Movie"><span class="icon icon-movie icon-sm"></span></span>`;
                
                return `
                    <div class="profile-media-item fade-in">
                        <a href="movie-details.html?id=${item.id}">
                            ${badgeHTML}
                            <img src="${item.posterUrl || 'https://placehold.co/300x450/2D194D/DEF0F7?text=No+Poster'}" 
                                 alt="${item.title || 'Untitled'}" 
                                 loading="lazy" 
                                 onerror="this.onerror=null;this.src='https://placehold.co/300x450/2D194D/DEF0F7?text=Error';">
                            <div class="profile-media-title">${item.title || 'Untitled'}</div>
                        </a>
                    </div>
                `;
            }).join('');

            // Add fade-in animation
            setTimeout(() => {
                gridContainer.querySelectorAll('.profile-media-item').forEach((item, index) => {
                    setTimeout(() => {
                        item.classList.add('visible');
                    }, index * 20);
                });
            }, 50);
        }
    </script>
    <footer id="footer-placeholder"></footer>
</body>
</html>