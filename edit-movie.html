<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, maximum-scale=5.0">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#24143E">
    <meta name="format-detection" content="telephone=no">
    <title>add your thots and rating - the library sale</title>
    <!-- Google Fonts Import -->
     <link rel="preconnect" href="https://fonts.googleapis.com">
     <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
     <link href="https://fonts.googleapis.com/css2?family=B612+Mono&family=Dokdo&family=Kirang+Haerang&family=M+PLUS+2&family=Syne+Mono&display=swap" rel="stylesheet">
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-auth-compat.js"></script>
    <!-- ZXing Barcode Scanner Library -->
    <script type="text/javascript" src="https://unpkg.com/@zxing/library@0.20.0/umd/index.min.js"></script>
    <!-- App Utilities -->
    <script src="utils.js"></script>
    <script src="cache.js"></script>
    <script src="scanner-utils.js"></script>
    <!-- Styles -->
    <link rel="stylesheet" href="styles/variables.css">
    <link rel="stylesheet" href="styles/base.css">  
    <link rel="stylesheet" href="styles/components.css">
    <link rel="stylesheet" href="styles/pages.css">
    <!-- Main utilities -->
    <script src="main.js" defer></script>
</head>
<body>
    <header id="navbar-placeholder"></header>

    <main class="edit-movie-container">
        <!-- Loading Skeleton (initially visible) -->
        <div id="editLoadingState">
            <section class="details-ticket skeleton">
                <div class="skeleton" style="height: 36px; width: 60%; margin: 0 auto 8px;"></div>
                <div class="skeleton" style="height: 24px; width: 20%; margin: 0 auto;"></div>
            </section>
            <section class="details-main-content">
                <div class="details-poster skeleton"></div>
                <div class="details-info">
                    <div class="skeleton" style="height: 20px; width: 80px; margin-bottom: 8px;"></div>
                    <div class="skeleton" style="height: 16px; width: 90%;"></div>
                    <div class="skeleton" style="height: 20px; width: 80px; margin-top: 16px; margin-bottom: 8px;"></div>
                    <div class="skeleton" style="height: 16px; width: 70%;"></div>
                </div>
            </section>
            <section class="details-section skeleton" style="margin-top: 40px;">
                <div class="skeleton" style="height: 28px; width: 150px; margin-bottom: 16px;"></div>
                <div class="skeleton" style="height: 16px; width: 100%; margin-bottom: 8px;"></div>
                <div class="skeleton" style="height: 16px; width: 100%; margin-bottom: 8px;"></div>
                <div class="skeleton" style="height: 16px; width: 40%;"></div>
            </section>
        </div>

        <!-- Main Content and Form (initially hidden) -->
        <div id="mainContent" style="display: none;">
            <!-- Ticket-style header -->
            <section class="details-ticket">
                <h1 id="movie-title" class="details-title">loading...</h1>
                <p id="movie-year" class="details-year">----</p>
                <p class="hero-subtitle">add your thots and rating</p>
            </section>

            <!-- Main Content Grid (Poster + Info) -->
            <section class="details-main-content">
                <div class="details-poster">
                    <img id="movie-poster-img" src="" alt="Movie Poster" loading="lazy">
                </div>
                <div class="details-info">
                    <div class="details-info-group">
                        <h3>director</h3>
                        <p id="movie-director">Loading...</p>
                    </div>
                    <div class="details-info-group">
                        <h3>top cast</h3>
                        <p id="movie-cast">Loading...</p>
                    </div>
                    <div class="details-info-group">
                        <h3>genre</h3>
                        <p id="movie-genre">Loading...</p>
                    </div>
                </div>
            </section>

            <!-- Summary Section -->
            <section class="details-section">
                <h2 class="details-section-header">
                    <i class="icon icon-details"></i>
                    <span>summary</span>
                </h2>
                <div class="details-summary" id="summaryGroup">
                    <p id="movieOverview" class="summary-text">loading summary...</p>
                    <button id="readMoreBtn" class="read-more-btn" style="display: none;">
                        read more
                    </button>
                </div>
            </section>
            <!-- Movie Details Form (only show for full edit mode) -->
            <section id="movieDetailsForm" class="details-section" style="display: none;">
                <h2 class="details-section-header">
                    <i class="icon icon-edit"></i>
                    <span>Movie Details</span>
                </h2>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="edit-title">title *</label>
                        <input type="text" id="edit-title" required readonly>
                    </div>
                    <div class="form-group">
                        <label for="edit-year">year</label>
                        <input type="number" id="edit-year" min="1900" max="2030" readonly>
                    </div>
                </div>

                <div class="form-group">
                    <label for="edit-director">director</label>
                    <input type="text" id="edit-director" readonly>
                </div>

                <div class="form-group">
                    <label for="edit-genre">genre</label>
                    <input type="text" id="edit-genre" readonly>
                </div>

                <div class="form-group">
                    <label for="edit-cast">cast</label>
                    <input type="text" id="edit-cast" readonly>
                </div>

                <div class="form-group">
                    <label for="edit-summary">summary</label>
                    <textarea id="edit-summary" rows="6" readonly></textarea>
                </div>

                <div class="form-group" id="contentTypeSection" style="display: none;">
                    <label for="edit-content-type">content type</label>
                    <div id="contentTypeToggle" class="content-type-toggle">
                        <button type="button" class="content-type-btn active" data-value="movie">
                            <span class="icon icon-movie"></span> 
                        </button>
                        <button type="button" class="content-type-btn" data-value="tv">
                            <span class="icon icon-tv"></span> 
                        </button>
                    </div>
                </div>
            </section>

            <!-- User Data Form -->
            <form id="edit-movie-form" class="details-section">
                <h2 class="heading-with-icon">
                    <i class="icon icon-comment"></i>
                    <span>comments</span>
                </h2>
                <!-- Rating and Status Toggles -->
                <div class="rating-and-status-container">
                    <div class="form-group">
                        <label>Your Rating</label>
                        <div id="star-rating" class="star-rating-interactive star-rating-xlg">
                            <span class="star star-empty" data-value="1"></span>
                            <span class="star star-empty" data-value="2"></span>
                            <span class="star star-empty" data-value="3"></span>
                            <span class="star star-empty" data-value="4"></span>
                            <span class="star star-empty" data-value="5"></span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <div class="toggle-group gap-md">
                            <button type="button" id="watched-toggle" class="toggle-btn" data-active="false" title="Toggle Watched Status">
                                <i class="icon icon-watched"></i>
                            </button>
                            <button type="button" id="owned-toggle" class="toggle-btn" data-active="false" title="Toggle Owned Status">
                                <i class="icon icon-dvds"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="form-group" id="watched-date-group" style="display: none;">
                    <label for="watched-date">watched Date</label>
                    <input type="date" id="watched-date">
                </div>
                    <br>
                <div class="form-group">
                <textarea id="comments" name="comments" rows="4" placeholder="your notes, thoughts, or review..."></textarea>
                </div>
                <br>

                <!-- TMDB Search Section (only show for full edit mode) -->
                <section id="tmdbSearchSection" class="details-section" style="display: none;">
                    <h2 class="details-section-header">
                        <i class="icon icon-search"></i>
                        <span>Search & Replace from TMDB</span>
                    </h2>
                    
                    <div class="tmdb-search-container">
                        <div class="search-controls">
                            <div class="search-bar">
                                <input type="text" id="tmdb-search" placeholder="Search TMDB for better movie data...">
                            </div>
                            <button type="button" id="tmdb-search-btn" class="btn btn-rectangular btn-primary">
                                <span class="icon icon-search"></span>
                                Search TMDB
                            </button>
                        </div>
                        
                        <div id="tmdb-results" class="tmdb-search-results" style="display: none;">
                            <!-- Results will be populated here -->
                        </div>
                        <div id="tmdb-search-footer" class="search-footer" style="display: none;">
                            <span id="tmdb-result-count"></span>
                            <button type="button" id="tmdb-load-more-btn" class="btn btn-rectangular btn-primary">Load More</button>
                        </div>
                    </div>
                </section>
            <!-- Enhanced Physical Edition Details -->
            <div class="form-group" id="physical-edition-details" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-md);">
                    <label>physical edition details</label>
                    <button type="button" id="scan-barcode-btn" class="btn btn-barcode btn-rectangular btn-primary">
                        <i class="icon icon-search"></i>
                        <span>scan barcode</span>
                    </button>
                </div>
                <!-- SCANNER -->
              <section id="scanner-section" class="scanner-section" style="display: none;">
                <div class="scanner-viewport">
                    <video id="scanner-video" autoplay muted playsinline></video>
                    <div class="scanner-guideline"></div>
                    <div class="scanner-status" id="scannerStatus">position barcode in view</div>
                </div>
                <div class="quick-actions">
                    <button type="button" id="stop-scanner-btn" class="btn btn-lg btn-danger" title="stop scanner">
                        <i class="icon icon-close"></i>
                    </button>
                </div>
            </section>
                
                <!-- Current Physical Edition Display -->
                <div id="currentPhysicalEdition" style="display: none;">
                    <div class="physical-edition-info">
                        <div class="edition-row">
                            <span class="edition-label">format:</span>
                            <span id="currentEditionFormat">-</span>
                        </div>
                        <div class="edition-row">
                            <span class="edition-label">edition:</span>
                            <span id="currentEditionType">-</span>
                        </div>
                        <div class="edition-row">
                            <span class="edition-label">region:</span>
                            <span id="currentEditionRegion">-</span>
                        </div>
                        <div class="edition-row">
                            <span class="edition-label">distributor:</span>
                            <span id="currentEditionDistributor">-</span>
                        </div>
                        <div class="edition-row" id="currentEditionFeaturesRow" style="display: none;">
                            <span class="edition-label">features:</span>
                            <span id="currentEditionFeatures">-</span>
                        </div>
                        <div class="edition-row">
                            <span class="edition-label">barcode:</span>
                            <span id="currentEditionBarcode">-</span>
                        </div>
                    </div>
                </div>
                
            <!-- Enhanced Editable Form -->
                <div id="editablePhysicalForm" style="display: none;">
                    <!-- Format - Dropdown -->
                    <div class="form-group">
                        <label for="edition-format">format</label>
                        <select id="edition-format" name="edition-format" class="form-select">
                            <option value="">select format...</option>
                            <option value="4K UHD">4K UHD</option>
                            <option value="Blu-ray">Blu-ray</option>
                            <option value="DVD">DVD</option>
                            <option value="VHS">VHS</option>
                            <option value="Digital">Digital</option>
                        </select>
                    </div>

            <!-- Edition - Multiple Choice Checkboxes -->
            <div class="form-group">
                <label>edition Types</label>
                <div class="checkbox-grid">
                    <div class="checkbox-item">
                        <input type="checkbox" id="edition-standard" class="form-checkbox" value="Standard">
                        <label for="edition-standard" class="checkbox-label">standard</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="edition-special" class="form-checkbox" value="Special Edition">
                        <label for="edition-special" class="checkbox-label">special edition</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="edition-directors" class="form-checkbox" value="Director's Cut">
                        <label for="edition-directors" class="checkbox-label">director's cut</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="edition-collectors" class="form-checkbox" value="Collector's Edition">
                        <label for="edition-collectors" class="checkbox-label">collector's edition</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="edition-extended" class="form-checkbox" value="Extended Edition">
                        <label for="edition-extended" class="checkbox-label">extended edition</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="edition-anniversary" class="form-checkbox" value="Anniversary Edition">
                        <label for="edition-anniversary" class="checkbox-label">anniversary</label>
                    </div>
                </div>
            </div>

            <!-- Region - Radio Buttons -->
            <div class="form-group">
                <label>region</label>
                <div class="radio-grid">
                    <div class="radio-item">
                        <input type="radio" id="region-free" name="region" class="form-radio" value="Region Free">
                        <label for="region-free" class="radio-label">region free</label>
                    </div>
                    <div class="radio-item">
                        <input type="radio" id="region-1" name="region" class="form-radio" value="Region 1">
                        <label for="region-1" class="radio-label">region 1</label>
                    </div>
                    <div class="radio-item">
                        <input type="radio" id="region-2" name="region" class="form-radio" value="Region 2">
                        <label for="region-2" class="radio-label">region 2</label>
                    </div>
                    <div class="radio-item">
                        <input type="radio" id="region-3" name="region" class="form-radio" value="Region 3">
                        <label for="region-3" class="radio-label">region 3</label>
                    </div>
                    <div class="radio-item">
                        <input type="radio" id="region-a" name="region" class="form-radio" value="Region A">
                        <label for="region-a" class="radio-label">region 4</label>
                    </div>
                    <div class="radio-item">
                        <input type="radio" id="region-b" name="region" class="form-radio" value="Region B">
                        <label for="region-b" class="radio-label">Region 5</label>
                    </div>
                    <div class="radio-item">
                        <input type="radio" id="region-c" name="region" class="form-radio" value="Region C">
                        <label for="region-c" class="radio-label">Region 6</label>
                    </div>
                </div>
            </div>

            <!-- Distributor - Text Input -->
            <div class="form-group">
                <label for="edition-distributor">distributor</label>
                <input type="text" id="edition-distributor" name="edition-distributor" class="form-input" placeholder="enter distributor name...">
            </div>

            <!-- Features - Multiple Choice Checkboxes -->
            <div class="form-group">
                <label>special features</label>
                <div class="checkbox-grid">
                    <div class="checkbox-item">
                        <input type="checkbox" id="feature-commentary" class="form-checkbox" value="cast/crew commentary">
                        <label for="feature-commentary" class="checkbox-label">commentary</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="feature-interview" class="form-checkbox" value="interviews/features">
                        <label for="feature-interview" class="checkbox-label">interviews</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="feature-making" class="form-checkbox" value="making of/bts">
                        <label for="feature-making" class="checkbox-label">bts</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="feature-notes" class="form-checkbox" value="production notes">
                        <label for="feature-notes" class="checkbox-label">production notes</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="feature-deleted" class="form-checkbox" value="deleted scenes">
                        <label for="feature-deleted" class="checkbox-label">deleted scenes</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="feature-bloopers" class="form-checkbox" value="Bloopers/Outtakes">
                        <label for="feature-bloopers" class="checkbox-label">bloopers</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="feature-trailers" class="form-checkbox" value="trailers">
                        <label for="feature-trailers" class="checkbox-label">trailers</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="feature-gallery" class="form-checkbox" value="photo gallery">
                        <label for="feature-gallery" class="checkbox-label">photo gallery</label>
                    </div>
                </div>
            </div>

            <!-- Barcode - Number Input -->
            <div class="form-group">
                <label for="upc-code">barcode</label>
                <input type="number" id="upc-code" name="upc-code" class="form-input" placeholder="enter barcode..." inputmode="numeric">
            </div>
        </div>
            </div>
                <!-- Action Buttons -->
                <div class="form-actions">
                    <div class="form-actions-left">
                        <button type="submit" id="save-btn" class="btn btn-xl btn-success" title="save">
                            <i class="icon icon-confirm"></i>
                        </button>
                        <a onclick="history.back()" class="btn btn-xl btn-danger" title="take me away">
                            <i class="icon icon-back"></i>
                        </a>
                    </div>
                    <div class="form-actions-right">
                        <button type="button" id="delete-btn" class="btn btn-xl btn-danger" title="this is garbage">
                            <i class="icon icon-delete"></i>
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </main>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDDW8LtwpYevdkD7Q-_CxJ23mMfi00P21M",
            authDomain: "tiny-lizard.firebaseapp.com",
            projectId: "tiny-lizard",
            storageBucket: "tiny-lizard.firebasestorage.app",
            messagingSenderId: "250872474692",
            appId: "1:250872474692:web:969e0b1302ae3cb4666011",
        };
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore(); 
        const auth = firebase.auth();

        // Global variables
        let currentRating = 0;
        let starRatingController = null;
        let editScanner = null;
        let physicalEditionData = {};
        let isEditingPhysical = false;

    function updatePageContext(fromParam) {
        const pageTitle = document.querySelector('title');
        const heroTitle = document.querySelector('.hero-subtitle');
        
        if (fromParam === 'review') {
            pageTitle.textContent = 'review my thots - the library sale';
            if (heroTitle) {
                heroTitle.textContent = 'review and edit your personal thots';
            }
        } else {
            // Default context
            pageTitle.textContent = 'edit my collection - the library sale';
            if (heroTitle) {
                heroTitle.textContent = 'edit your personal collection details';
            }
        }
    }

        document.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            const movieId = params.get('id');
            const fromParam = params.get('from');

            if (!movieId) {
                window.location.href = 'index.html';
                return;
            }
            // Update page context based on where user came from
            updatePageContext(fromParam);

                const mainContent = document.getElementById('mainContent');
                const scannerSection = document.getElementById('scanner-section');
                const editMovieForm = document.getElementById('edit-movie-form');
                const watchedToggle = document.getElementById('watched-toggle');
                const ownedToggle = document.getElementById('owned-toggle');
                const physicalDetailsSection = document.getElementById('physical-edition-details');
                const cancelBtn = document.getElementById('delete-btn');

            // Authentication Check
            auth.onAuthStateChanged(user => {
                if (user) {
                    currentUser = user; // Set currentUser
                    loadMovieData(user.uid);
                    initializeEditScanner();
                    // Now check permissions after user is set
                    checkEditPermissions(movieId);
                } else {
                    window.location.href = 'auth.html';
                }
            });
            // Setup Star Rating using LibraryUtils
            // LibraryUtils is already available from utils.js
            
            const setupStars = (initialRating) => {
                currentRating = initialRating;
                if (window.LibraryUtils && window.LibraryUtils.stars) {
                    starRatingController = window.LibraryUtils.stars.setupInteractiveStarRating('star-rating', (rating) => {
                        currentRating = rating;
                    }, currentRating);
                } else {
                    console.error('LibraryUtils or LibraryUtils.stars not available. Check that utils.js is loaded correctly.');
                }
            };

            // Toggle Button Logic
            watchedToggle.addEventListener('click', () => {
                const isWatched = watchedToggle.dataset.active === 'true';
                const newWatchedState = !isWatched;
                watchedToggle.dataset.active = newWatchedState ? 'true' : 'false';
                
                // Show/hide the watched date field
                const watchedDateGroup = document.getElementById('watched-date-group');
                watchedDateGroup.style.display = newWatchedState ? 'block' : 'none';
                
                // Clear the date if unwatched
                if (!newWatchedState) {
                    document.getElementById('watched-date').value = '';
                }
            });

            ownedToggle.addEventListener('click', () => {
                const isOwned = ownedToggle.dataset.active === 'true';
                const newOwnedState = !isOwned;
                ownedToggle.dataset.active = newOwnedState ? 'true' : 'false';
                
                physicalDetailsSection.style.display = newOwnedState ? 'block' : 'none';
                if (!newOwnedState) {
                    document.getElementById('edition-title').value = '';
                    document.getElementById('edition-format').value = '';
                    document.getElementById('upc-code').value = '';
                }
            });

            // Cancel Button Logic
            cancelBtn.addEventListener('click', (e) => {
                e.preventDefault();
                if (document.referrer && !document.referrer.includes('edit-movie.html')) {
                    window.history.back();
                } else {
                    window.location.href = 'index.html';
                }
            });

            // Data Loading and Form Population
            const populateForm = (userData) => {
                setupStars(userData.rating || 0);

                watchedToggle.dataset.active = userData.watched === true ? 'true' : 'false';
                if (userData.watched === true) {
                    document.getElementById('watched-date-group').style.display = 'block'; 
                    document.getElementById('watched-date').value = userData.watchedDate || '';
                } else {
                    document.getElementById('watched-date-group').style.display = 'none';
                }

                ownedToggle.dataset.active = userData.owned === true ? 'true' : 'false';

                ownedToggle.dataset.active = userData.owned === true ? 'true' : 'false';

                if (userData.owned === true) {
                    physicalDetailsSection.style.display = 'block';
                    displayCurrentPhysicalEdition(userData);
                } else {
                    physicalDetailsSection.style.display = 'none';
                }

                document.getElementById('comments').value = userData.review || '';
            };
            
            // Load Movie Data Function
            const loadMovieData = async (userId) => {
                try {
                    const [movieDoc] = await Promise.all([
                        db.collection('movies').doc(movieId).get(),
                        new Promise(resolve => setTimeout(resolve, 800)) // Smooth UX
                    ]);

                    if (!movieDoc.exists) throw new Error('Movie not found');

                    const movieData = movieDoc.data();
                    
                    document.getElementById('movie-poster-img').src = movieData.posterUrl || 'https://placehold.co/300x450/2D194D/DEF0F7?text=No+Poster';
                    document.getElementById('movie-title').textContent = movieData.title || 'Unknown Title';
                    document.getElementById('movie-year').textContent = movieData.year || 'N/A';
                    document.getElementById('movie-director').textContent = movieData.director || 'N/A';
                    document.getElementById('movie-cast').textContent = Array.isArray(movieData.cast) ? movieData.cast.join(', ') : (movieData.cast || 'N/A');
                    document.getElementById('movie-genre').textContent = movieData.genre || 'N/A';

                    const overviewElement = document.getElementById('movieOverview');
                    const readMoreBtn = document.getElementById('readMoreBtn');
                    const overview = movieData.overview || 'No description available.';
                    overviewElement.textContent = overview;
                    
                    if (overview.length > 200) {
                        readMoreBtn.style.display = 'inline-flex';
                        readMoreBtn.onclick = function() {
                            overviewElement.classList.toggle('collapsed');
                            this.textContent = overviewElement.classList.contains('collapsed') ? 'Read more' : 'Read less';
                        };
                    }

                    const interactionDoc = await db.collection('users').doc(userId).collection('movieInteractions').doc(movieId).get();

                    if (interactionDoc.exists) {
                        populateForm(interactionDoc.data());
                    } else {
                        setupStars(0);
                    }
                    
                    document.getElementById('editLoadingState').style.display = 'none';
                    mainContent.style.display = 'block';
                    
                } catch (error) {
                    console.error("Error loading movie data:", error);
                    document.getElementById('editLoadingState').innerHTML = `<div class="error-state"><h3>Error</h3><p>${error.message}</p><a href="index.html" class="btn btn-primary">Back</a></div>`;
                }
            };

            // Form Submission
            editMovieForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const user = auth.currentUser;

                if (window.hasFullEditRights) {
                    const updatedMovieData = {
                        title: document.getElementById('edit-title').value.trim(),
                        year: parseInt(document.getElementById('edit-year').value) || null,
                        director: document.getElementById('edit-director').value.trim(),
                        genre: document.getElementById('edit-genre').value.trim(),
                        cast: document.getElementById('edit-cast').value.split(',').map(c => c.trim()).filter(c => c),
                        posterUrl: document.getElementById('movie-poster-img').src,
                        overview: document.getElementById('edit-summary').value.trim(),
                        contentType: document.querySelector('#contentTypeToggle .active')?.dataset.value || 'movie',
                        lastEditedBy: currentUser.uid,
                        lastEditedDate: firebase.firestore.FieldValue.serverTimestamp()
                    };

                    await db.collection('movies').doc(movieId).update(updatedMovieData);
                }

                if (!user) return;

                const saveBtn = document.getElementById('save-btn');
                saveBtn.classList.add('saving');

                const watchedDateElement = document.getElementById('watched-date');
                const watchedDateValue = watchedDateElement ? watchedDateElement.value || null : null;
                const updatedData = {
                    movieId: movieId,
                    rating: currentRating,
                    watched: watchedToggle.dataset.active === 'true',
                    owned: ownedToggle.dataset.active === 'true',
                    review: document.getElementById('comments').value.trim(),
                    interactionDate: firebase.firestore.FieldValue.serverTimestamp(),
                    watchedDate: watchedDateValue            
                    };

// Find this section in the form submission and replace it:
                if (updatedData.owned) {
                    // Get selected edition types
                    const editionTypes = [];
                    document.querySelectorAll('input[id^="edition-"]:checked').forEach(cb => {
                        editionTypes.push(cb.value);
                    });

                    // Get selected region
                    const region = document.querySelector('input[name="region"]:checked')?.value || 'Region 1';

                    // Get selected features
                    const features = [];
                    document.querySelectorAll('input[id^="feature-"]:checked').forEach(cb => {
                        features.push(cb.value);
                    });

                    const newPhysicalData = {
                        format: document.getElementById('edition-format').value,
                        edition: editionTypes.join(', ') || 'Standard',
                        region: region,
                        distributor: document.getElementById('edition-distributor').value.trim(),
                        features: features,
                        barcode: document.getElementById('upc-code').value.trim()
                    };

                    // NEW: Create or update physical copy
                    let physicalCopyId = null;
                    
                    if (newPhysicalData.barcode) {
                        const uniqueId = MediaLookupUtils.generateUniqueIdentifier(
                            newPhysicalData.barcode,
                            newPhysicalData.format,
                            newPhysicalData.edition,
                            newPhysicalData.region
                        );

                        // Check if this physical copy already exists
                        const existingCopy = await MediaLookupUtils.findExistingPhysicalCopy(uniqueId);
                        
                        if (existingCopy) {
                            physicalCopyId = existingCopy.id;
                        } else {
                            physicalCopyId = await MediaLookupUtils.createPhysicalCopy(
                                movieId, 
                                newPhysicalData, 
                                user.uid
                            );
                        }
                    }

                    // NEW: Handle duplicate detection for edit page
                    if (physicalCopyId) {
                        // Check if user already has this copy
                        const existingInteractionDoc = await db.collection('users')
                            .doc(user.uid)
                            .collection('movieInteractions')
                            .doc(movieId)
                            .get();
                        
                        let physicalCopiesArray = [];
                        if (existingInteractionDoc.exists) {
                            const existingData = existingInteractionDoc.data();
                            physicalCopiesArray = existingData.physicalCopies || [];
                            
                            if (physicalCopiesArray.includes(physicalCopyId)) {
                                const currentCount = physicalCopiesArray.filter(id => id === physicalCopyId).length;
                                const shouldAddAnyway = confirm(
                                    `You already own ${currentCount} copy/copies of this edition. Add another copy anyway?`
                                );
                                
                                if (shouldAddAnyway) {
                                    physicalCopiesArray.push(physicalCopyId);
                                }
                            } else {
                                physicalCopiesArray.push(physicalCopyId);
                            }
                        } else {
                            physicalCopiesArray = [physicalCopyId];
                        }
                        
                        updatedData.physicalCopies = physicalCopiesArray;
                    }
                    // DEPRECATED: Keep for backward compatibility
                    updatedData.physicalEdition = newPhysicalData;
                    updatedData.upc = newPhysicalData.barcode;
                }

                try {
                    await db.collection('users').doc(user.uid).collection('movieInteractions').doc(movieId).set(updatedData, { merge: true });
                    LibraryUtils.ui.showStatusMessage('Changes saved successfully!', 'success');
                    setTimeout(() => window.location.href = `movie-details.html?id=${movieId}`, 1500);
                } catch (error) {
                    console.error("Error updating movie:", error);
                    LibraryUtils.ui.showStatusMessage('Error saving changes.', 'error');
                } finally {
                    saveBtn.classList.remove('saving');
                }
            });
            
            // Barcode Scanner Logic
            const scanBtn = document.getElementById('scan-barcode-btn');
            const stopBtn = document.getElementById('stop-scanner-btn');
            const video = document.getElementById('scanner-video');

            // Delete Button Logic
            const deleteBtn = document.getElementById('delete-btn');
            deleteBtn.addEventListener('click', async () => {
                if (!confirm('Are you sure you want to delete this movie from your collection? This cannot be undone.')) return;

                const user = auth.currentUser;
                if (!user) return;

                deleteBtn.classList.add('loading');
                try {
                    await db.collection('users').doc(user.uid).collection('movieInteractions').doc(movieId).delete();
                    
                    const otherInteractions = await db.collectionGroup('movieInteractions').where('movieId', '==', movieId).limit(1).get();
                    if (otherInteractions.empty) {
                        await db.collection('movies').doc(movieId).delete();
                    }

                    LibraryUtils.ui.showStatusMessage('Movie deleted from your collection.', 'success');
                    setTimeout(() => window.location.href = 'index.html', 1500);
                } catch (error) {
                    console.error('Error deleting movie:', error);
                    LibraryUtils.ui.showStatusMessage('Failed to delete movie.', 'error');
                } finally {
                    deleteBtn.classList.remove('loading');
                }
            });
        });
async function checkEditPermissions(movieId) {
    // Wait for auth state to be available
    const user = auth.currentUser;
    if (!user) {
        console.log('User not authenticated yet, waiting...');
        return;
    }
    
    try {
        const [movieDoc, adminDoc] = await Promise.all([
            db.collection('movies').doc(movieId).get(),
            db.collection('admins').doc(user.uid).get()
        ]);
        
        if (!movieDoc.exists) {
            throw new Error('Movie not found');
        }

        const movieData = movieDoc.data();
        const isOriginalUploader = movieData.originalUploaderId === user.uid;
        const isAdmin = adminDoc.exists && adminDoc.data().isActive === true;
        
        const hasFullEditRights = isOriginalUploader || isAdmin;
        
        setupEditMode(hasFullEditRights, movieData);
        
        if (hasFullEditRights && isAdmin && !isOriginalUploader) {
            showAdminIndicator();
        }
        
    } catch (error) {
        console.error('Permission check failed:', error);
        // Default to limited mode
        setupEditMode(false, null);
    }
}
function setupEditMode(hasFullRights, movieData) {
    if (hasFullRights) {
        // Show full edit mode
        document.getElementById('tmdbSearchSection').style.display = 'block';
        document.getElementById('movieDetailsForm').style.display = 'block';
        document.getElementById('contentTypeSection').style.display = 'block';
        
        // Make fields editable
        ['edit-title', 'edit-year', 'edit-director', 'edit-genre', 'edit-cast', 'edit-summary'].forEach(id => {
            const field = document.getElementById(id);
            if (field) field.removeAttribute('readonly');
        });
        
        // Initialize TMDB search
        initializeTMDBSearch();
        
        // Populate with current movie data
        if (movieData) {
            populateMovieFields(movieData);
        }
        
        // Store for form submission
        window.hasFullEditRights = true;
    } else {
        // Limited mode - keep fields readonly
        document.getElementById('tmdbSearchSection').style.display = 'none';
        document.getElementById('movieDetailsForm').style.display = 'none';
        document.getElementById('contentTypeSection').style.display = 'none';
        
        // Update page title
        document.querySelector('.hero-subtitle').textContent = 'edit your personal collection details';
        
        // Store for form submission
        window.hasFullEditRights = false;
    }
}

function showAdminIndicator() {
    const adminIndicator = document.createElement('p');
    adminIndicator.className = 'admin-indicator';
    adminIndicator.innerHTML = '👑 editing as admin';
    document.querySelector('.hero-subtitle').after(adminIndicator);
}

async function initializeTMDBSearch() {
            SearchUI.initialize({
                searchInputId: 'tmdb-search',
                searchBtnId: 'tmdb-search-btn',
                resultsContainerId: 'tmdb-results',
                // UPDATE these lines from null to use the new element IDs
                searchFooterId: 'tmdb-search-footer',
                resultCountId: 'tmdb-result-count',
                loadMoreBtnId: 'tmdb-load-more-btn',
                onSelect: (id, type) => {
                    selectTMDBResult(id, type);
                }
            });
            const searchInput = document.getElementById('tmdb-search');
            const searchBtn = document.getElementById('tmdb-search-btn');
            const resultsContainer = document.getElementById('tmdb-results');

            searchBtn.addEventListener('click', () => performTMDBSearch());
            
            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    performTMDBSearch();
                }
            });
        }
async function selectTMDBResult(id, type) {
    if (!id || !type) return;

    try {
        // Show a loading message
        LibraryUtils.ui.showStatusMessage('Loading full details...', 'info');

        // Get full details for the selected item
        const detailsUrl = `${MediaLookupUtils.TMDB_BASE_URL}/${type}/${id}?append_to_response=credits`;
        const response = await fetch(detailsUrl);
        const fullData = await response.json();

        if (!response.ok) {
            throw new Error('Failed to load full details');
        }

        // Populate the edit form with the new TMDB data
        document.getElementById('edit-title').value = fullData.title || fullData.name || '';
        document.getElementById('edit-year').value = (fullData.release_date || fullData.first_air_date || '').substring(0, 4);
        document.getElementById('edit-director').value = fullData.credits?.crew?.find(c => c.job === 'Director')?.name || '';
        document.getElementById('edit-genre').value = fullData.genres?.map(g => g.name).join(', ') || '';
        document.getElementById('edit-cast').value = fullData.credits?.cast?.slice(0, 5).map(c => c.name).join(', ') || '';
        
        const posterUrl = fullData.poster_path 
            ? `${MediaLookupUtils.TMDB_IMAGE_BASE}${fullData.poster_path}` 
            : 'https://placehold.co/300x450/2D194D/DEF0F7?text=No+Poster';

        document.getElementById('movie-poster-img').src = posterUrl;
        document.getElementById('edit-summary').value = fullData.overview || '';
        document.getElementById('edit-content-type').value = type;

        // Hide search results
        document.getElementById('tmdb-results').style.display = 'none';
        document.getElementById('tmdb-search').value = '';

        LibraryUtils.ui.showStatusMessage('form populated with TMDB data! review and save when ready.', 'success');

    } catch (error) {
        console.error('Error loading TMDB details:', error);
        LibraryUtils.ui.showStatusMessage('failed to load full details. flease try again.', 'error');
    }
}
function populateMovieFields(movieData) {
    document.getElementById('edit-title').value = movieData.title || '';
    document.getElementById('edit-year').value = movieData.year || '';
    document.getElementById('edit-director').value = movieData.director || '';
    document.getElementById('edit-genre').value = movieData.genre || '';
    document.getElementById('edit-cast').value = Array.isArray(movieData.cast) ? 
        movieData.cast.join(', ') : (movieData.cast || '');
    document.getElementById('edit-summary').value = movieData.overview || '';
    
    // Set content type
    updateContentTypeToggle(movieData.contentType || 'movie');
}
function updateContentTypeToggle(selectedValue) {
    const toggleContainer = document.getElementById('contentTypeToggle');
    if (toggleContainer) {
        toggleContainer.querySelectorAll('.content-type-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.value === selectedValue);
        });
    }
}
async function initializeEditScanner() {
    // Get references to the UI elements
    const scanBtn = document.getElementById('scan-barcode-btn');
    const stopBtn = document.getElementById('stop-scanner-btn');
    const scannerSection = document.getElementById('scanner-section');
    const videoEl = document.getElementById('scanner-video');

    // Create a new ScannerManager instance
    editScanner = new ScannerManager({
        continuous: false, // Stop after one successful scan
        onBarcodeScanned: async (barcode) => {
            // When a barcode is found, hide the scanner UI
            scannerSection.style.display = 'none';

            try {
                // Use the centralized lookup utility
                LibraryUtils.ui.showStatusMessage('Looking up barcode...', 'info');
                const { physicalEdition } = await MediaLookupUtils.completeMovieLookup(barcode);

                // Populate the editable form with the new data
                document.getElementById('edition-format').value = physicalEdition.format || '';
                document.getElementById('edition-type').value = physicalEdition.edition || '';
                document.getElementById('edition-region').value = physicalEdition.region || '';
                document.getElementById('edition-distributor').value = physicalEdition.distributor || '';
                document.getElementById('edition-features').value = physicalEdition.features.join(', ');
                document.getElementById('upc-code').value = barcode;

                LibraryUtils.ui.showStatusMessage('Physical edition details updated!', 'success');

            } catch (error) {
                console.error('Barcode lookup failed:', error);
                LibraryUtils.ui.showStatusMessage(error.message, 'error');
            }
        },
        onStatusUpdate: (message, type) => {
            ScannerUI.updateStatus(message, type, 'scannerStatus');
        },
        onError: (message) => {
            LibraryUtils.ui.showStatusMessage(message, 'error');
            scannerSection.style.display = 'none';
        }
    });

        // Initialize the scanner and set up button event listeners
        const initialized = await editScanner.initialize();
        if (!initialized) {
            scanBtn.disabled = true;
            scanBtn.textContent = 'Scanner N/A';
            return;
        }

        scanBtn.addEventListener('click', async () => {
            document.getElementById('editablePhysicalForm').style.display = 'block';
            document.getElementById('currentPhysicalEdition').style.display = 'none';
            scannerSection.style.display = 'block';
            await editScanner.startCamera(videoEl, 'scannerStatus');
        });

        stopBtn.addEventListener('click', () => {
            editScanner.stopCamera();
            scannerSection.style.display = 'none';
        });
}
async function displayCurrentPhysicalEdition(userData) {
    const physicalSection = document.getElementById('physical-edition-details');
    const editableForm = document.getElementById('editablePhysicalForm');

    if (userData.owned && userData.physicalCopies && userData.physicalCopies.length > 0) {
        physicalSection.style.display = 'block';
        editableForm.style.display = 'block';

        // NEW: Load physical copy data from the physicalCopies collection
        try {
            const copyId = userData.physicalCopies[0]; // Show first copy for now
            const copyDoc = await db.collection('physicalCopies').doc(copyId).get();
            
            if (copyDoc.exists) {
                const copyData = copyDoc.data();
                
                // Populate form with physical copy data
                document.getElementById('edition-format').value = copyData.format || '';
                
                // Handle edition types (convert string to checkboxes)
                const editionTypes = (copyData.edition || '').split(',').map(e => e.trim());
                document.querySelectorAll('input[id^="edition-"]').forEach(cb => {
                    cb.checked = editionTypes.includes(cb.value);
                });

                // Set region radio button
                const regionRadio = document.querySelector(`input[name="region"][value="${copyData.region || 'Region 1'}"]`);
                if (regionRadio) regionRadio.checked = true;

                // Set other fields
                document.getElementById('edition-distributor').value = copyData.distributor || '';
                
                // Handle features
                const features = Array.isArray(copyData.features) ? copyData.features : [];
                document.querySelectorAll('input[id^="feature-"]').forEach(cb => {
                    cb.checked = features.some(feature => feature.includes(cb.value.split('/')[0]));
                });

                document.getElementById('upc-code').value = copyData.barcode || '';
            } else {
                console.warn('Physical copy not found:', copyId);
                // Fall back to old data structure
                displayLegacyPhysicalEdition(userData);
            }
        } catch (error) {
            console.error('Error loading physical copy:', error);
            // Fall back to old data structure
            displayLegacyPhysicalEdition(userData);
        }
    } else if (userData.owned) {
        // User owns but no physical copies reference - check legacy data
        displayLegacyPhysicalEdition(userData);
    } else {
        physicalSection.style.display = 'none';
    }
}
// Helper function for backward compatibility
function displayLegacyPhysicalEdition(userData) {
    const physicalSection = document.getElementById('physical-edition-details');
    const editableForm = document.getElementById('editablePhysicalForm');
    
    physicalSection.style.display = 'block';
    editableForm.style.display = 'block';

    const edition = userData.physicalEdition || {};

    // Populate dropdown
    document.getElementById('edition-format').value = edition.format || userData.editionFormat || '';

    // Populate edition checkboxes
    const editionTypes = (edition.edition || userData.editionTitle || '').split(',').map(e => e.trim());
    document.querySelectorAll('input[id^="edition-"]').forEach(cb => {
        cb.checked = editionTypes.includes(cb.value);
    });

    // Populate region radio button
    const regionValue = edition.region || 'Region 1';
    const regionRadio = document.querySelector(`input[name="region"][value="${regionValue}"]`);
    if (regionRadio) regionRadio.checked = true;

    // Populate distributor
    document.getElementById('edition-distributor').value = edition.distributor || '';

    // Populate features checkboxes
    const features = Array.isArray(edition.features) ? edition.features : 
                    (edition.features || '').split(',').map(f => f.trim());
    document.querySelectorAll('input[id^="feature-"]').forEach(cb => {
        cb.checked = features.some(feature => feature.includes(cb.value.split('/')[0]));
    });

    // Populate barcode
    document.getElementById('upc-code').value = userData.upc || '';
}
function savePhysicalEditionChanges() {
    const format = document.getElementById('edition-format').value.trim();
    const edition = document.getElementById('edition-type').value.trim();
    const region = document.getElementById('edition-region').value.trim();
    const distributor = document.getElementById('edition-distributor').value.trim();
    const featuresText = document.getElementById('edition-features').value.trim();
    const features = featuresText ? featuresText.split(',').map(f => f.trim()).filter(f => f) : [];
    const barcode = document.getElementById('upc-code').value.trim();
    
    // Update physical edition data
    physicalEditionData = {
        format: format || 'Unknown',
        edition: edition || 'Standard', 
        region: region || 'Unknown',
        distributor: distributor || 'Unknown',
        features: features,
        barcode: barcode
    };
    document.getElementById('currentEditionFormat').textContent = physicalEditionData.format;
    document.getElementById('currentEditionType').textContent = physicalEditionData.edition;
    document.getElementById('currentEditionRegion').textContent = physicalEditionData.region;
    document.getElementById('currentEditionDistributor').textContent = physicalEditionData.distributor;
    document.getElementById('currentEditionBarcode').textContent = physicalEditionData.barcode || 'None';
    
    const featuresRow = document.getElementById('currentEditionFeaturesRow');
    const featuresSpan = document.getElementById('currentEditionFeatures');
    if (features.length > 0) {
        featuresRow.style.display = 'flex';
        featuresSpan.textContent = features.join(', ');
    } else {
        featuresRow.style.display = 'none';
    }
    
    // Switch back to display mode
    togglePhysicalEditMode();
    
    LibraryUtils.ui.showStatusMessage('Physical edition details updated locally. Save the form to persist changes.', 'info');
}

// Mobile-friendly status message improvements
function showStatusMessage(message, type) {
    const statusDiv = document.getElementById('statusMessage');
    const iconClass = type === 'success' ? 'icon-confirm' : type === 'error' ? 'icon-close' : 'icon-details';
    
    // Create mobile-friendly status message
    statusDiv.innerHTML = `
        <div class="status-message status-${type}" style="
            position: fixed;
            top: var(--space-lg);
            left: var(--space-md);
            right: var(--space-md);
            z-index: var(--z-modal);
            text-align: center;
            font-size: var(--font-size-base);
            padding: var(--space-lg);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
        ">
            <span class="icon ${iconClass} icon-md"></span>
            ${message}
        </div>
    `;
    
    // Auto-dismiss after 4 seconds on mobile
    if (window.innerWidth <= 768) {
        setTimeout(() => {
            statusDiv.innerHTML = '';
        }, 4000);
    }
}

// Mobile-friendly search improvements
function displayResults(results, isNewSearch) {
    const resultsDiv = document.getElementById('searchResults');
    if (isNewSearch) {
        resultsDiv.innerHTML = '';
    }
    
    if (results.length === 0 && isNewSearch) {
        resultsDiv.innerHTML = `
            <div class="empty-state">
                <span class="icon icon-search" style="font-size: var(--icon-size-3xl); margin-bottom: var(--space-lg);"></span>
                <h3>No results found</h3>
                <p>Try adjusting your search terms or check the spelling.</p>
            </div>
        `;
        return;
    }
    
    const resultsHTML = results.map((item) => {
        const title = item.title || item.name;
        const year = (item.release_date || item.first_air_date || '').substring(0, 4);
        const overview = LibraryUtils.ui.truncateText(item.overview, window.innerWidth <= 480 ? 80 : 100);
        const badgeHTML = item.media_type === 'tv' 
            ? `<span class="badge badge-tv" title="TV Show"><span class="icon icon-tv icon-sm"></span></span>`
            : `<span class="badge badge-movie" title="Movie"><span class="icon icon-movie icon-sm"></span></span>`;
        
        return `
            <div class="search-result" onclick="selectMedia('${item.id}', '${item.media_type}')" style="cursor: pointer;">
                <img src="${item.poster_path ? TMDB_IMAGE_BASE + item.poster_path : 'https://placehold.co/80x120/2D194D/DEF0F7?text=N/A'}" 
                    class="search-result-poster" 
                    loading="lazy"
                    onerror="this.style.display='none'">
                <div class="search-result-info">
                    <h4>${title} (${year}) ${badgeHTML}</h4>
                    <p>${overview}</p>
                </div>
            </div>
        `;
    }).join('');
    
    resultsDiv.insertAdjacentHTML('beforeend', resultsHTML);
}
// Mobile-friendly scanner improvements
async function startScanner() {
    if (!codeReader || videoInputDevices.length === 0) {
        showStatusMessage('Camera not available', 'error');
        return;
    }
    
    const modal = document.getElementById('scannerContainer');
    const video = document.getElementById('video');
    
    modal.classList.add('active');
    
    // Mobile-specific scanner message
    const isMobile = window.innerWidth <= 768;
    showStatusMessage(
        isMobile ? 'Starting camera... Hold phone steady and position barcode in center of screen.' : 'Starting camera...', 
        'info'
    );
    
    try {
        await codeReader.decodeFromVideoDevice(
            videoInputDevices[0].deviceId, 
            video,
            (result, err) => {
                if (result) {
                    console.log('Barcode detected:', result.text);
                    
                    // Provide haptic feedback on mobile if available
                    if (navigator.vibrate) {
                        navigator.vibrate(200);
                    }
                    
                    stopScanner();
                    lookupMovieByBarcode(result.text);
                }
                if (err && !(err instanceof ZXing.NotFoundException)) {
                    console.warn('Scanner error:', err);
                }
            }
        );
        
        showStatusMessage(
            isMobile ? 'Camera ready. Center barcode in view and hold steady.' : 'Camera ready. Position barcode in view.',
            'info'
        );
    } catch (error) {
        console.error('Failed to start camera:', error);
        showStatusMessage(`Camera error: ${error.message}. Please ensure camera permissions are granted.`, 'error');
        stopScanner();
    }
}

        // Improved form validation for mobile
        function validateFormOnMobile() {
            const titleValue = document.getElementById('title').value.trim();
            if (!titleValue) {
                showStatusMessage('Please search for and select a movie first.', 'error');
                
                // Scroll to search section on mobile
                if (window.innerWidth <= 768) {
                    document.querySelector('.search-section').scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'start' 
                    });
                }
                return false;
            }
            return true;
        }

        // Mobile-friendly modal improvements
        function showTimedRedirectModal(title, message, redirectUrl, duration = 5) {
            const modal = document.getElementById('alertModal');
            if (!modal) {
                alert(message);
                setTimeout(() => { window.location.href = redirectUrl; }, 100);
                return;
            }

            const titleEl = modal.querySelector('#alertModalTitle');
            const messageEl = modal.querySelector('#alertModalMessage');
            const okBtn = modal.querySelector('#alertModalOk');
            const closeBtn = modal.querySelector('#alertModalClose');

            titleEl.textContent = title;
            okBtn.style.display = 'inline-flex';
            closeBtn.style.display = 'flex';

            let countdown = duration;
            const isMobile = window.innerWidth <= 768;
            
            messageEl.innerHTML = isMobile 
                ? `${message}<br><br><strong>Redirecting in ${countdown}s...</strong>`
                : `${message}<br><br>Redirecting in ${countdown} seconds...`;
            
            modal.classList.add('active');

            const interval = setInterval(() => {
                countdown--;
                if (countdown > 0) {
                    messageEl.innerHTML = isMobile 
                        ? `${message}<br><br><strong>Redirecting in ${countdown}s...</strong>`
                        : `${message}<br><br>Redirecting in ${countdown} seconds...`;
                } else {
                    clearInterval(interval);
                    window.location.href = redirectUrl;
                }
            }, 1000);

            const cleanup = () => {
                clearInterval(interval);
                modal.classList.remove('active');
            };
            
            okBtn.onclick = () => {
                cleanup();
                window.location.href = redirectUrl;
            };

            closeBtn.onclick = cleanup;
            
            // Close modal on background tap for mobile
            modal.onclick = (e) => {
                if (e.target === modal) {
                    cleanup();
                }
            };
        }

        // Add touch event improvements for mobile
        document.addEventListener('DOMContentLoaded', () => {
            // Improve touch targets on mobile
            if (window.innerWidth <= 768) {
                const style = document.createElement('style');
                style.textContent = `
                    .search-result {
                        min-height: 60px;
                        touch-action: manipulation;
                    }
                    .btn {
                        touch-action: manipulation;
                    }
                    .star-rating-interactive .star {
                        touch-action: manipulation;
                        padding: var(--space-xs);
                    }
                `;
                document.head.appendChild(style);
            }
            
            // Prevent zoom on input focus for iOS
            if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
                const inputs = document.querySelectorAll('input, textarea, select');
                inputs.forEach(input => {
                    if (parseFloat(getComputedStyle(input).fontSize) < 16) {
                        input.style.fontSize = '16px';
                    }
                });
            }
        });
        
    </script>
    <footer id="footer-placeholder"></footer>
</body>
</html>
