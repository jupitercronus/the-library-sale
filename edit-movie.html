<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, maximum-scale=5.0">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#24143E">
    <meta name="format-detection" content="telephone=no">
    <title>add your thots and rating - the library sale</title>
    <!-- Google Fonts Import -->
     <link rel="preconnect" href="https://fonts.googleapis.com">
     <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
     <link href="https://fonts.googleapis.com/css2?family=B612+Mono&family=Dokdo&family=Kirang+Haerang&family=M+PLUS+2&family=Syne+Mono&display=swap" rel="stylesheet">
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-auth-compat.js"></script>
    <!-- ZXing Barcode Scanner Library -->
    <script type="text/javascript" src="https://unpkg.com/@zxing/library@0.20.0/umd/index.min.js"></script>
    <!-- App Utilities -->
    <script src="utils.js"></script>
    <script src="modal-manager.js"></script>
    <script src="scanner-utils.js"></script>
    <script src="cache.js"></script>
    <script src="search-ui.js"></script> 

    <!-- Styles -->
    <link rel="stylesheet" href="styles/variables.css">
    <link rel="stylesheet" href="styles/base.css">  
    <link rel="stylesheet" href="styles/components.css">
    <link rel="stylesheet" href="styles/pages.css">
    
    <!-- Main Script -->
    <script src="main.js" defer></script>
</head>
<body>
    <header id="navbar-placeholder"></header>

    <main class="edit-movie-container">
        <!-- Loading Skeleton (initially visible) -->
        <div id="editLoadingState">
            <section class="details-ticket skeleton">
                <div class="skeleton" style="height: 36px; width: 60%; margin: 0 auto 8px;"></div>
                <div class="skeleton" style="height: 24px; width: 20%; margin: 0 auto;"></div>
            </section>
            <section class="details-main-content">
                <div class="details-poster skeleton"></div>
                <div class="details-info">
                    <div class="skeleton" style="height: 20px; width: 80px; margin-bottom: 8px;"></div>
                    <div class="skeleton" style="height: 16px; width: 90%;"></div>
                    <div class="skeleton" style="height: 20px; width: 80px; margin-top: 16px; margin-bottom: 8px;"></div>
                    <div class="skeleton" style="height: 16px; width: 70%;"></div>
                </div>
            </section>
            <section class="details-section skeleton" style="margin-top: 40px;">
                <div class="skeleton" style="height: 28px; width: 150px; margin-bottom: 16px;"></div>
                <div class="skeleton" style="height: 16px; width: 100%; margin-bottom: 8px;"></div>
                <div class="skeleton" style="height: 16px; width: 100%; margin-bottom: 8px;"></div>
                <div class="skeleton" style="height: 16px; width: 40%;"></div>
            </section>
        </div>

        <!-- Main Content and Form (initially hidden) -->
        <div id="mainContent" style="display: none;">
            <!-- Ticket-style header -->
            <section class="details-ticket">
                <h1 id="movie-title" class="details-title">loading...</h1>
                <p id="movie-year" class="details-year">----</p>
                <p class="hero-subtitle">add your thots and rating</p>
            </section>

            <!-- Main Content Grid (Poster + Info) -->
            <section class="details-main-content">
                <div class="details-poster">
                    <img id="movie-poster-img" src="" alt="Movie Poster" loading="lazy">
                </div>
                <div class="details-info">
                    <div class="details-info-group">
                        <h3>director</h3>
                        <p id="movie-director">Loading...</p>
                    </div>
                    <div class="details-info-group">
                        <h3>top cast</h3>
                        <p id="movie-cast">Loading...</p>
                    </div>
                    <div class="details-info-group">
                        <h3>genre</h3>
                        <p id="movie-genre">Loading...</p>
                    </div>
                </div>
            </section>

            <!-- Summary Section -->
            <section class="details-section">
                <h2 class="details-section-header">
                    <i class="icon icon-details"></i>
                    <span>summary</span>
                </h2>
                <div class="details-summary" id="summaryGroup">
                    <p id="movieOverview" class="summary-text">loading summary...</p>
                    <button id="readMoreBtn" class="read-more-btn" style="display: none;">
                        read more
                    </button>
                </div>
            </section>
            <!-- Movie Details Form (only show for full edit mode) -->
            <section id="movieDetailsForm" class="details-section" style="display: none;">
                <h2 class="details-section-header">
                    <i class="icon icon-edit"></i>
                    <span>Movie Details</span>
                </h2>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="edit-title">title *</label>
                        <input type="text" id="edit-title" required readonly>
                    </div>
                    <div class="form-group">
                        <label for="edit-year">year</label>
                        <input type="number" id="edit-year" min="1900" max="2030" readonly>
                    </div>
                </div>

                <div class="form-group">
                    <label for="edit-director">director</label>
                    <input type="text" id="edit-director" readonly>
                </div>

                <div class="form-group">
                    <label for="edit-genre">genre</label>
                    <input type="text" id="edit-genre" readonly>
                </div>

                <div class="form-group">
                    <label for="edit-cast">cast</label>
                    <input type="text" id="edit-cast" readonly>
                </div>

                <div class="form-group">
                    <label for="edit-summary">summary</label>
                    <textarea id="edit-summary" rows="6" readonly></textarea>
                </div>

                <div class="form-group" id="contentTypeSection" style="display: none;">
                    <label for="edit-content-type">content type</label>
                    <div id="contentTypeToggle" class="content-type-toggle">
                        <button type="button" class="content-type-btn active" data-value="movie">
                            <span class="icon icon-movie"></span> 
                        </button>
                        <button type="button" class="content-type-btn" data-value="tv">
                            <span class="icon icon-tv"></span> 
                        </button>
                    </div>
                </div>
            </section>

            <!-- User Data Form -->
            <form id="edit-movie-form" class="details-section">
                <h2 class="heading-with-icon">
                    <i class="icon icon-comment"></i>
                    <span>comments</span>
                </h2>
                <!-- Rating and Status Toggles -->
                <div class="rating-and-status-container">
                    <div class="form-group">
                        <label>Your Rating</label>
                        <div id="star-rating" class="star-rating-interactive star-rating-xlg">
                            <span class="star star-empty" data-value="1"></span>
                            <span class="star star-empty" data-value="2"></span>
                            <span class="star star-empty" data-value="3"></span>
                            <span class="star star-empty" data-value="4"></span>
                            <span class="star star-empty" data-value="5"></span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <div class="toggle-group gap-md">
                            <button type="button" id="watched-toggle" class="toggle-btn" data-active="false" title="Toggle Watched Status">
                                <i class="icon icon-watched"></i>
                            </button>
                            <button type="button" id="owned-toggle" class="toggle-btn" data-active="false" title="Toggle Owned Status">
                                <i class="icon icon-dvds"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="form-group" id="watched-date-group" style="display: none;">
                    <label for="watched-date">watched Date</label>
                    <input type="date" id="watched-date">
                </div>
                    <br>
                <div class="form-group">
                <textarea id="comments" name="comments" rows="4" placeholder="your notes, thoughts, or review..."></textarea>
                </div>
                <br>

                <!-- TMDB Search Section (only show for full edit mode) -->
                <section id="tmdbSearchSection" class="details-section" style="display: none;">
                    <h2 class="details-section-header">
                        <i class="icon icon-search"></i>
                        <span>Search & Replace from TMDB</span>
                    </h2>
                    
                    <div class="tmdb-search-container">
                        <div class="search-controls">
                            <div class="search-bar">
                                <input type="text" id="tmdb-search" placeholder="Search TMDB for better movie data...">
                            </div>
                            <button type="button" id="tmdb-search-btn" class="btn btn-rectangular btn-primary">
                                <span class="icon icon-search"></span>
                            </button>
                        </div>
                        
                        <div id="tmdb-results" class="tmdb-search-results" style="display: none;">
                            <!-- Results will be populated here -->
                        </div>
                        <div id="tmdb-search-footer" class="search-footer" style="display: none;">
                            <span id="tmdb-result-count"></span>
                            <button type="button" id="tmdb-load-more-btn" class="btn btn-rectangular btn-primary">Load More</button>
                        </div>
                    </div>
                </section>
            <!-- Enhanced Physical Edition Details -->
            <div class="form-group" id="physical-edition-details" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-md);">
                    <h3>physical copy details</h3>
                    <button type="button" id="scan-barcode-btn" class="btn btn-barcode btn-rectangular btn-primary">
                        <i class="icon icon-search"></i>
                        <span>scan barcode</span>
                    </button>
                </div>
                <!-- SCANNER -->
              <section id="scanner-section" class="scanner-section" style="display: none;">
                <div class="scanner-viewport">
                    <video id="scanner-video" autoplay muted playsinline></video>
                    <div class="scanner-guideline"></div>
                    <div class="scanner-status" id="scannerStatus">position barcode in view</div>
                </div>
                <div class="quick-actions">
                    <button type="button" id="stop-scanner-btn" class="btn btn-lg btn-danger" title="stop scanner">
                        <i class="icon icon-close"></i>
                    </button>
                </div>
            </section>
                
                <!-- Current Physical Edition Display -->
                <div id="currentPhysicalEdition" style="display: none;">
                    <div class="physical-edition-info">
                        <div class="edition-row">
                            <span class="edition-label">format:</span>
                            <span id="currentEditionFormat">-</span>
                        </div>
                        <div class="edition-row">
                            <span class="edition-label">edition:</span>
                            <span id="currentEditionType">-</span>
                        </div>
                        <div class="edition-row">
                            <span class="edition-label">region:</span>
                            <span id="currentEditionRegion">-</span>
                        </div>
                        <div class="edition-row">
                            <span class="edition-label">distributor:</span>
                            <span id="currentEditionDistributor">-</span>
                        </div>
                        <div class="edition-row" id="currentEditionFeaturesRow" style="display: none;">
                            <span class="edition-label">features:</span>
                            <span id="currentEditionFeatures">-</span>
                        </div>
                        <div class="edition-row">
                            <span class="edition-label">barcode:</span>
                            <span id="currentEditionBarcode">-</span>
                        </div>
                    </div>
                </div>
                
            <!-- Enhanced Editable Form -->
                <div id="editablePhysicalForm" style="display: none;">
                    <!-- Format - Dropdown -->
                    <div class="form-group">
                        <label for="edition-format">format</label>
                        <select id="edition-format" name="edition-format" class="form-select">
                            <option value="">select format...</option>
                            <option value="4K UHD">4K UHD</option>
                            <option value="Blu-ray">Blu-ray</option>
                            <option value="DVD">DVD</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="edition">edition</label>
                        <select id="edition" name="edition" class="form-select">
                            <option value="">select format...</option>
                            <option value="fullscreen">fullscreen</option>
                            <option value="widescreen">widescreen</option>
                            <option value="special edition">special edition</option>
                            <option value="collector's edition">collector's edition</option>
                            <option value="director's cut">director's cut</option>
                            <option value="extended version">extended version</option>
                            <option value="criterion collection">criterion collection</option>
                            <option value="other">other</option>
                        </select>
                    </div>

                    <div class="form-group" id="other-edition-group" style="display: none;">
                        <label for="other-edition-text">Please specify other edition:</label>
                        <input type="text" id="other-edition-text" name="other-edition-text" class="form-input" placeholder="Enter edition type...">
                    </div>
                </div>

            <!-- Region - -->
            <div class="form-group">
                <label for="region">region</label>
                <input type="number" id="region" name="region" class="form-input" placeholder="enter region" inputmode="numeric">
            </div>

            <!-- Distributor - Text Input -->
            <div class="form-group">
                <label for="edition-distributor">distributor</label>
                <input type="text" id="edition-distributor" name="edition-distributor" class="form-input" placeholder="enter distributor name...">
            </div>

            <!-- Features - Multiple Choice Checkboxes -->
            <div class="form-group">
                <label>special features</label>
                <div class="checkbox-grid">
                    <div class="checkbox-item">
                        <input type="checkbox" id="feature-commentary" class="form-checkbox" value="cast/crew commentary">
                        <label for="feature-commentary" class="checkbox-label">commentary</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="feature-interview" class="form-checkbox" value="interviews/features">
                        <label for="feature-interview" class="checkbox-label">interviews</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="feature-making" class="form-checkbox" value="making of/bts">
                        <label for="feature-making" class="checkbox-label">bts</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="feature-notes" class="form-checkbox" value="production notes">
                        <label for="feature-notes" class="checkbox-label">production notes</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="feature-deleted" class="form-checkbox" value="deleted scenes">
                        <label for="feature-deleted" class="checkbox-label">deleted scenes</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="feature-bloopers" class="form-checkbox" value="Bloopers/Outtakes">
                        <label for="feature-bloopers" class="checkbox-label">bloopers</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="feature-trailers" class="form-checkbox" value="trailers">
                        <label for="feature-trailers" class="checkbox-label">trailers</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="feature-gallery" class="form-checkbox" value="photo gallery">
                        <label for="feature-gallery" class="checkbox-label">photo gallery</label>
                    </div>
                </div>
            </div>

            <!-- Barcode - Number Input -->
            <div class="form-group">
                <label for="upc-code">barcode</label>
                <input type="number" id="upc-code" name="upc-code" class="form-input" placeholder="enter barcode..." inputmode="numeric">
            </div>
        </div>
            </div>
                <!-- Action Buttons -->
                <div class="form-actions">
                    <div class="form-actions-left">
                        <button type="submit" id="save-btn" class="btn btn-xl btn-success" title="save">
                            <i class="icon icon-confirm"></i>
                        </button>
                        <a onclick="history.back()" class="btn btn-xl btn-danger" title="take me away">
                            <i class="icon icon-back"></i>
                        </a>
                    </div>
                    <div class="form-actions-right">
                        <button type="button" id="delete-btn" class="btn btn-xl btn-danger" title="this is garbage">
                            <i class="icon icon-delete"></i>
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </main>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDDW8LtwpYevdkD7Q-_CxJ23mMfi00P21M",
            authDomain: "tiny-lizard.firebaseapp.com",
            projectId: "tiny-lizard",
            storageBucket: "tiny-lizard.firebasestorage.app",
            messagingSenderId: "250872474692",
            appId: "1:250872474692:web:969e0b1302ae3cb4666011",
        };
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore(); 
        const auth = firebase.auth();

        // Global variables
        let currentUser = null; // Defined globally so all functions can see it
        let currentRating = 0;
        let starRatingController = null;
        let editScanner = null;
        let physicalEditionData = {};
        let isEditingPhysical = false;

document.addEventListener('DOMContentLoaded', () => {
    // --- 1. Get DOM Elements ---
    const params = new URLSearchParams(window.location.search);
    const movieId = params.get('id');
    const fromParam = params.get('from');

    const mainContent = document.getElementById('mainContent');
    const editMovieForm = document.getElementById('edit-movie-form');
    const watchedToggle = document.getElementById('watched-toggle');
    const ownedToggle = document.getElementById('owned-toggle');
    const physicalDetailsSection = document.getElementById('physical-edition-details');
    const editionSelect = document.getElementById('edition');
    const otherEditionGroup = document.getElementById('other-edition-group');
    const deleteBtn = document.getElementById('delete-btn');
    const saveBtn = document.getElementById('save-btn');


    function updatePageContext(fromParam) {
            const pageTitle = document.querySelector('title');
            const heroTitle = document.querySelector('.hero-subtitle');
            if (fromParam === 'review') {
                pageTitle.textContent = 'review my thots - the library sale';
                if (heroTitle) heroTitle.textContent = 'review and edit your personal thots';
            } else {
                pageTitle.textContent = 'edit media - the library sale';
                if (heroTitle) heroTitle.textContent = 'review and add your personal thots';
            }
        }

        const setupStars = (initialRating) => {
            currentRating = initialRating;
            if (window.LibraryUtils && window.LibraryUtils.stars) {
                starRatingController = window.LibraryUtils.stars.setupInteractiveStarRating('star-rating', (rating) => {
                    currentRating = rating;
                }, currentRating);
            }
        };
        
        function toggleOtherEditionField() {
            if (editionSelect.value === 'other') {
                otherEditionGroup.style.display = 'block';
            } else {
                otherEditionGroup.style.display = 'none';
            }
        }

        function populateEdition(editionValue) {
            const otherEditionInput = document.getElementById('other-edition-text');
            const isStandardOption = [...editionSelect.options].some(opt => opt.value === editionValue);
            if (isStandardOption) {
                editionSelect.value = editionValue;
            } else if (editionValue) {
                editionSelect.value = 'other';
                otherEditionInput.value = editionValue;
            }
            toggleOtherEditionField();
        }

        function displayLegacyPhysicalEdition(userData) {
            document.getElementById('editablePhysicalForm').style.display = 'block';
            const edition = userData.physicalEdition || {};
            document.getElementById('edition-format').value = edition.format || '';
            populateEdition(edition.edition || userData.editionTitle);
            document.getElementById('region').value = edition.region || '';
            document.getElementById('edition-distributor').value = edition.distributor || '';
            document.getElementById('upc-code').value = userData.upc || '';
        }

        async function displayCurrentPhysicalEdition(userData) {
            const editableForm = document.getElementById('editablePhysicalForm');
            if (userData.owned && userData.physicalCopies && userData.physicalCopies.length > 0) {
                editableForm.style.display = 'block';
                try {
                    const copyId = userData.physicalCopies[0];
                    const copyDoc = await db.collection('physicalCopies').doc(copyId).get();
                    if (copyDoc.exists) {
                        const copyData = copyDoc.data();
                        document.getElementById('edition-format').value = copyData.format || '';
                        populateEdition(copyData.edition);
                        document.getElementById('region').value = copyData.region || '';
                        document.getElementById('edition-distributor').value = copyData.distributor || '';
                        const features = Array.isArray(copyData.features) ? copyData.features : [];
                        document.querySelectorAll('input[id^="feature-"]').forEach(cb => {
                            cb.checked = features.some(feature => feature.includes(cb.value.split('/')[0]));
                        });
                        document.getElementById('upc-code').value = copyData.barcode || '';
                    } else {
                        displayLegacyPhysicalEdition(userData);
                    }
                } catch (error) {
                    console.error('Error loading physical copy:', error);
                    displayLegacyPhysicalEdition(userData);
                }
            } else if (userData.owned) {
                displayLegacyPhysicalEdition(userData);
            }
        }

        const populateForm = (userData) => {
            setupStars(userData.rating || 0);
            watchedToggle.dataset.active = userData.watched === true ? 'true' : 'false';
            document.getElementById('watched-date-group').style.display = userData.watched ? 'block' : 'none';
            document.getElementById('watched-date').value = userData.watchedDate || '';
            ownedToggle.dataset.active = userData.owned === true ? 'true' : 'false';
            physicalDetailsSection.style.display = userData.owned ? 'block' : 'none';
            if (userData.owned) {
                displayCurrentPhysicalEdition(userData);
            }
            document.getElementById('comments').value = userData.review || '';
        };

        const loadMovieData = async (userId, movieId) => {
            try {
                const [movieDoc, interactionDoc] = await Promise.all([
                    db.collection('movies').doc(movieId).get(),
                    db.collection('users').doc(userId).collection('movieInteractions').doc(movieId).get()
                ]);

                if (!movieDoc.exists) throw new Error('Movie not found');
                const movieData = movieDoc.data();

                const form = document.getElementById('edit-movie-form');
                form.dataset.originalMovieId = movieDoc.id;
                form.dataset.originalTmdbId = movieData.tmdbId;
                
                document.getElementById('movie-poster-img').src = movieData.posterUrl || 'https://placehold.co/300x450/2D194D/DEF0F7?text=No+Poster';
                document.getElementById('movie-title').textContent = movieData.title || 'Unknown Title';
                document.getElementById('movie-year').textContent = movieData.year || 'N/A';
                document.getElementById('movie-director').textContent = movieData.director || 'N/A';
                document.getElementById('movie-cast').textContent = Array.isArray(movieData.cast) ? movieData.cast.join(', ') : (movieData.cast || 'N/A');
                document.getElementById('movie-genre').textContent = movieData.genre || 'N/A';
                document.getElementById('movieOverview').textContent = movieData.overview || 'No description available.';

                if (interactionDoc.exists) {
                    populateForm(interactionDoc.data());
                } else {
                    setupStars(0);
                }
                
                document.getElementById('editLoadingState').style.display = 'none';
                mainContent.style.display = 'block';
            } catch (error) {
                console.error("Error loading movie data:", error);
                document.getElementById('editLoadingState').innerHTML = `<div class="error-state"><h3>Error</h3><p>${error.message}</p><a href="index.html" class="btn btn-primary">Back</a></div>`;
            }
        };

        function setupEditMode(hasFullRights, movieData) {
        if (hasFullRights) {
            // Show full edit mode
            document.getElementById('tmdbSearchSection').style.display = 'block';
            document.getElementById('movieDetailsForm').style.display = 'block';
            document.getElementById('contentTypeSection').style.display = 'block';
            
            // Make fields editable
            ['edit-title', 'edit-year', 'edit-director', 'edit-genre', 'edit-cast', 'edit-summary'].forEach(id => {
                const field = document.getElementById(id);
                if (field) field.removeAttribute('readonly');
            });
            
            // Initialize TMDB search
            initializeTMDBSearch();
            
            // Populate with current movie data
            if (movieData) {
                populateMovieFields(movieData);
            }
            
            // Store for form submission
            window.hasFullEditRights = true;
        } else {
            // Limited mode - keep fields readonly
            document.getElementById('tmdbSearchSection').style.display = 'none';
            document.getElementById('movieDetailsForm').style.display = 'none';
            document.getElementById('contentTypeSection').style.display = 'none';
            
            // Update page title
            document.querySelector('.hero-subtitle').textContent = 'edit your personal collection details';
            
            // Store for form submission
            window.hasFullEditRights = false;
        }
    };

    async function initializeEditScanner() {
        // Get references to the UI elements
        const scanBtn = document.getElementById('scan-barcode-btn');
        const stopBtn = document.getElementById('stop-scanner-btn');
        const scannerSection = document.getElementById('scanner-section');
        const videoEl = document.getElementById('scanner-video');

        // Create a new ScannerManager instance
        editScanner = new ScannerManager({
        continuous: false, // Stop after one successful scan
        onBarcodeScanned: async (barcode) => {
        // When a barcode is found, hide the scanner UI
        scannerSection.style.display = 'none';

        try {
            // Use the centralized lookup utility
            LibraryUtils.ui.showStatusMessage('Looking up barcode...', 'info');
            const { physicalEdition } = await MediaLookupUtils.completeMovieLookup(barcode);

            // Populate the editable form with the new data
            document.getElementById('edition-format').value = physicalEdition.format || '';
            populateEdition(physicalEdition.edition);
            document.getElementById('region').value = physicalEdition.region || '';
            document.getElementById('edition-distributor').value = physicalEdition.distributor || '';
            const features = Array.isArray(physicalEdition.features) ? physicalEdition.features : [];
                document.querySelectorAll('input[id^="feature-"]').forEach(cb => {
                    // Check the box if a feature from the scan results includes the checkbox's value
                    // e.g., "Bloopers/Outtakes" includes "Bloopers"
                    cb.checked = features.some(feature => feature.includes(cb.value.split('/')[0]));
                });
            document.getElementById('upc-code').value = barcode;

            LibraryUtils.ui.showStatusMessage('physical copy details updated!', 'success');

        } catch (error) {
            console.error('Barcode lookup failed:', error);
            LibraryUtils.ui.showStatusMessage(error.message, 'error');
        }
        },
        onStatusUpdate: (message, type) => {
            ScannerUI.updateStatus(message, type, 'scannerStatus');
        },
        onError: (message) => {
            LibraryUtils.ui.showStatusMessage(message, 'error');
            scannerSection.style.display = 'none';
        }
        });

        // Initialize the scanner and set up button event listeners
        const initialized = await editScanner.initialize();
        if (!initialized) {
            scanBtn.disabled = true;
            scanBtn.textContent = 'Scanner N/A';
            return;
        }

        scanBtn.addEventListener('click', async () => {
            document.getElementById('editablePhysicalForm').style.display = 'block';
            document.getElementById('currentPhysicalEdition').style.display = 'none';
            scannerSection.style.display = 'block';
            await editScanner.startCamera(videoEl, 'scannerStatus');
        });

        stopBtn.addEventListener('click', () => {
            editScanner.stopCamera();
            scannerSection.style.display = 'none';
        });
    };

    async function checkEditPermissions(movieId) {
    const user = auth.currentUser;
        if (!user) return;
        try {
            const [movieDoc, adminDoc] = await Promise.all([
                db.collection('movies').doc(movieId).get(),
                db.collection('admins').doc(user.uid).get()
            ]);
            if (!movieDoc.exists) throw new Error('Movie not found');
            const movieData = movieDoc.data();
            const isOriginalUploader = movieData.originalUploaderId === user.uid;
            const isAdmin = adminDoc.exists && adminDoc.data().isActive === true;
            const hasFullEditRights = isOriginalUploader || isAdmin;

            // This is the corrected section from the last fix
            console.log('Checking permissions for user:', user.uid);
            console.log('Has full edit rights:', hasFullEditRights);
            
            setupEditMode(hasFullEditRights, movieData);
        } catch (error) {
            console.error('Permission check failed:', error);
            setupEditMode(false, null);
        };
    };

    function showAdminIndicator() {
        const adminIndicator = document.createElement('p');
            adminIndicator.className = 'admin-indicator';
            adminIndicator.innerHTML = 'ðŸ‘‘ editing as admin';
            document.querySelector('.hero-subtitle').after(adminIndicator);
    }

    function updatePageContext(fromParam) {
    const pageTitle = document.querySelector('title');
    const heroTitle = document.querySelector('.hero-subtitle');
    
        if (fromParam === 'review') {
            pageTitle.textContent = 'review my thots - the library sale';
            if (heroTitle) {
                heroTitle.textContent = 'review and edit your personal thots';
            }
        } else {
            pageTitle.textContent = 'edit media - the library sale';
            if (heroTitle) {
                heroTitle.textContent = 'review and add your personal thots';
            }
        };
    };
    async function initializeTMDBSearch() {
    const searchInput = document.getElementById('tmdb-search');
    const searchBtn = document.getElementById('tmdb-search-btn');
    const resultsContainer = document.getElementById('tmdb-results');

    if (!searchInput || !searchBtn || !resultsContainer) {
        console.error('TMDB search elements not found');
        return;
    }

    const performSearch = async () => {
        const query = searchInput.value.trim();
        if (!query) return;

        try {
            const searchUrl = `${MediaLookupUtils.TMDB_BASE_URL}/search/multi?query=${encodeURIComponent(query)}`;
            const response = await fetch(searchUrl);
            const data = await response.json();

            if (!response.ok) throw new Error('Search failed');

            displayTMDBResults(data.results || [], true);
        } catch (error) {
            console.error('TMDB search error:', error);
            resultsContainer.innerHTML = '<div class="error-state"><p>Search failed. Please try again.</p></div>';
            resultsContainer.style.display = 'block';
        }
    };

    searchBtn.addEventListener('click', performSearch);
    
    searchInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            performSearch();
        }
    });
    }
    function displayTMDBResults(results, isNewSearch) {
    const resultsContainer = document.getElementById('tmdb-results');
    if (!resultsContainer) return;

    if (isNewSearch) {
        resultsContainer.innerHTML = '';
    }

    if (results.length === 0 && isNewSearch) {
        resultsContainer.innerHTML = '<div class="empty-state"><p>No results found.</p></div>';
        resultsContainer.style.display = 'block';
        return;
    }

    const validResults = results.filter(item => item.media_type === 'movie' || item.media_type === 'tv');

    const resultsHTML = validResults.map(item => {
        const title = item.title || item.name;
        const year = (item.release_date || item.first_air_date || '').substring(0, 4);
        const poster = item.poster_path ? `${MediaLookupUtils.TMDB_IMAGE_BASE}${item.poster_path}` : 'https://placehold.co/50x75/2D194D/DEF0F7?text=N/A';
        const overview = item.overview ? item.overview.substring(0, 150) + '...' : '';
        const badgeHTML = item.media_type === 'tv' ?
            `<span class="badge badge-tv"><span class="icon icon-tv icon-sm"></span></span>` :
            `<span class="badge badge-movie"><span class="icon icon-movie icon-sm"></span></span>`;

        return `
            <div class="search-result" data-id="${item.id}" data-type="${item.media_type}">
                <img src="${poster}" class="search-result-poster" loading="lazy">
                <div class="search-result-info">
                    <h4>${title} (${year}) ${badgeHTML}</h4>
                    <p>${overview}</p>
                </div>
            </div>
        `;
    }).join('');

    resultsContainer.insertAdjacentHTML('beforeend', resultsHTML);
    resultsContainer.style.display = 'block';
    // Add click handlers
    resultsContainer.querySelectorAll('.search-result').forEach(result => {
        result.addEventListener('click', (e) => {
            const id = e.currentTarget.dataset.id;
            const type = e.currentTarget.dataset.type;
            
            // Add selected styling
            resultsContainer.querySelectorAll('.search-result').forEach(r => r.classList.remove('selected'));
            e.currentTarget.classList.add('selected');
            
            selectTMDBResult(id, type);
        });
    });
    }
    async function selectTMDBResult(id, type) {
        if (!id || !type) return;

        try {
            // Show a loading message
            LibraryUtils.ui.showStatusMessage('Loading full details...', 'info');

            // Get full details for the selected item
            const detailsUrl = `${MediaLookupUtils.TMDB_BASE_URL}/${type}/${id}?append_to_response=credits`;
            const response = await fetch(detailsUrl);
            const fullData = await response.json();

            if (!response.ok) {
                throw new Error('Failed to load full details');
            }

            // Populate the edit form with the new TMDB data
            document.getElementById('edit-title').value = fullData.title || fullData.name || '';
            document.getElementById('edit-year').value = (fullData.release_date || fullData.first_air_date || '').substring(0, 4);
            document.getElementById('edit-director').value = fullData.credits?.crew?.find(c => c.job === 'Director')?.name || '';
            document.getElementById('edit-genre').value = fullData.genres?.map(g => g.name).join(', ') || '';
            document.getElementById('edit-cast').value = fullData.credits?.cast?.slice(0, 5).map(c => c.name).join(', ') || '';
            
            const posterUrl = fullData.poster_path 
                ? `${MediaLookupUtils.TMDB_IMAGE_BASE}${fullData.poster_path}` 
                : 'https://placehold.co/300x450/2D194D/DEF0F7?text=No+Poster';

            document.getElementById('movie-poster-img').src = posterUrl;
            document.getElementById('edit-summary').value = fullData.overview || '';
            
            // Update content type toggle
            updateContentTypeToggle(type);

            // CRITICAL FIX: Clear the search results and remove all selected states IMMEDIATELY
            // This prevents the form submission from thinking we're doing a movie replacement
            const resultsContainer = document.getElementById('tmdb-results');
            const searchInput = document.getElementById('tmdb-search');
            
            if (resultsContainer) {
                // Remove selected class from all results
                resultsContainer.querySelectorAll('.search-result').forEach(r => r.classList.remove('selected'));
                // Hide and clear the results container
                resultsContainer.style.display = 'none';
                resultsContainer.innerHTML = '';
            }
            
            if (searchInput) {
                searchInput.value = '';
            }

            LibraryUtils.ui.showStatusMessage('Form populated with TMDB data! Review and save when ready.', 'success');

        } catch (error) {
            console.error('Error loading TMDB details:', error);
            LibraryUtils.ui.showStatusMessage('Failed to load full details. Please try again.', 'error');
        }
}
    function populateMovieFields(movieData) {
    document.getElementById('edit-title').value = movieData.title || '';
    document.getElementById('edit-year').value = movieData.year || '';
    document.getElementById('edit-director').value = movieData.director || '';
    document.getElementById('edit-genre').value = movieData.genre || '';
    document.getElementById('edit-cast').value = Array.isArray(movieData.cast) ? 
        movieData.cast.join(', ') : (movieData.cast || '');
    document.getElementById('edit-summary').value = movieData.overview || '';
    
    // Set content type
    updateContentTypeToggle(movieData.contentType || 'movie');
    } 

    function updateContentTypeToggle(selectedValue) {
    const toggleContainer = document.getElementById('contentTypeToggle');
    if (toggleContainer) {
        toggleContainer.querySelectorAll('.content-type-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.value === selectedValue);
        });
    }
    }
    
    /**
     * Finds a movie by its TMDB ID. If it doesn't exist, creates it.
     * Returns the Firestore document reference.
     */
    async function findOrCreateMovieByTmdbId(tmdbId, newData) {
        const numericTmdbId = parseInt(tmdbId);
        if (isNaN(numericTmdbId)) {
            throw new Error("Invalid TMDB ID provided.");
        }

        const moviesRef = db.collection('movies');
        const query = await moviesRef.where('tmdbId', '==', numericTmdbId).limit(1).get();

        if (!query.empty) {
            console.log("Found existing document for the new movie.");
            return query.docs[0].ref;
        } else {
            console.log("Creating a new document for the new movie.");
            // Make sure to add the tmdbId to the data being saved
            newData.tmdbId = numericTmdbId;
            return await moviesRef.add(newData);
        }
    }

    /**
     * Gets the user's interaction data for a specific movie.
     */
    async function getUserInteraction(movieId) {
        if (!currentUser || !movieId) return null;

        const interactionRef = db.collection('users').doc(currentUser.uid).collection('movieInteractions').doc(movieId);
        const doc = await interactionRef.get();
        return doc.exists ? doc.data() : null;
    }

/**
 * Gathers the core movie details from the editable form fields.
 */
function getMovieDataFromForm() {
    const posterImg = document.getElementById('movie-poster-img');
    const contentTypeToggle = document.getElementById('contentTypeToggle');

    const movieData = {
        title: document.getElementById('edit-title').value.trim(),
        year: parseInt(document.getElementById('edit-year').value) || null,
        director: document.getElementById('edit-director').value.trim(),
        genre: document.getElementById('edit-genre').value.trim(),
        cast: document.getElementById('edit-cast').value.split(',').map(c => c.trim()).filter(c => c),
        overview: document.getElementById('edit-summary').value.trim(),
        posterUrl: posterImg ? posterImg.src : null,
        contentType: contentTypeToggle ? contentTypeToggle.querySelector('.active').dataset.value : 'movie'
    };
    return movieData;
}

    // --- Main Logic and Event Listeners ---
    if (!movieId) {
            window.location.href = 'index.html';
            return;
        }
        updatePageContext(fromParam);

        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                loadMovieData(user.uid, movieId);
                initializeEditScanner();
                checkEditPermissions(movieId);
            } else {
                window.location.href = 'auth.html';
            }
        });

        editionSelect.addEventListener('change', toggleOtherEditionField);

        watchedToggle.addEventListener('click', () => {
            const isActive = watchedToggle.dataset.active === 'true';
            watchedToggle.dataset.active = !isActive;
            document.getElementById('watched-date-group').style.display = !isActive ? 'block' : 'none';
        });

        ownedToggle.addEventListener('click', () => {
            const isActive = ownedToggle.dataset.active === 'true';
            ownedToggle.dataset.active = !isActive;
            physicalDetailsSection.style.display = !isActive ? 'block' : 'none';
        });

    /// In the edit-movie.html form submission handler, add cache invalidation after saving changes
    editMovieForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const user = auth.currentUser;
        if (!user) return;

        UIUtils.setButtonLoading('save-btn', 'Saving...');
        
        const originalMovieId = e.target.dataset.originalMovieId;
        const originalTmdbId = e.target.dataset.originalTmdbId;
        const selectedResult = document.getElementById('tmdb-results')?.querySelector('.selected');
        const newTmdbId = selectedResult ? selectedResult.dataset.id : originalTmdbId;
        const isNewMovie = newTmdbId && (String(originalTmdbId) !== String(newTmdbId));

        try {
            let finalMovieId = originalMovieId;
            
            const interactionData = {
                rating: currentRating,
                watched: document.getElementById('watched-toggle').dataset.active === 'true',
                owned: document.getElementById('owned-toggle').dataset.active === 'true',
                review: document.getElementById('comments').value.trim(),
                interactionDate: firebase.firestore.FieldValue.serverTimestamp(),
                watchedDate: document.getElementById('watched-date').value || null,
            };
            const movieDataFromForm = getMovieDataFromForm();

            if (isNewMovie) {
                console.log("New movie selected. Performing re-linking operation.");
                
                const newMovieRef = await findOrCreateMovieByTmdbId(newTmdbId, movieDataFromForm);
                finalMovieId = newMovieRef.id;

                const oldInteraction = await getUserInteraction(originalMovieId);
                if (oldInteraction) {
                    interactionData.physicalCopies = oldInteraction.physicalCopies || [];
                }
                await db.collection('users').doc(user.uid).collection('movieInteractions').doc(finalMovieId).set(interactionData);
                await db.collection('users').doc(user.uid).collection('movieInteractions').doc(originalMovieId).delete();

                if (interactionData.physicalCopies && interactionData.physicalCopies.length > 0) {
                    const batch = db.batch();
                    interactionData.physicalCopies.forEach(copyId => {
                        const copyRef = db.collection('physicalCopies').doc(copyId);
                        batch.update(copyRef, { movieId: finalMovieId });
                    });
                    await batch.commit();
                }
                
            } else {
                console.log("Same movie. Performing standard update.");
                if (window.hasFullEditRights) {
                    await db.collection('movies').doc(finalMovieId).update(movieDataFromForm);
                }
                await db.collection('users').doc(user.uid).collection('movieInteractions').doc(finalMovieId).set(interactionData, { merge: true });
            }

            // ðŸ”¥ CRITICAL FIX: Clear the cache for this movie after saving changes
            if (window.CachedFirestore && typeof window.CachedFirestore.invalidateMovie === 'function') {
                console.log('Invalidating cache for movie:', finalMovieId);
                window.CachedFirestore.invalidateMovie(finalMovieId);
            } else if (window.cache && typeof window.cache.delete === 'function') {
                // Alternative cache clearing method if using a different cache system
                window.cache.delete('movies', finalMovieId);
            } else {
                // Fallback: clear all movie-related localStorage entries
                console.log('Clearing movie cache via localStorage fallback');
                Object.keys(localStorage).forEach(key => {
                    if (key.includes('movie') && key.includes(finalMovieId)) {
                        localStorage.removeItem(key);
                    }
                });
            }

            LibraryUtils.ui.showStatusMessage('Changes saved successfully!', 'success');
            setTimeout(() => {
                window.location.href = `movie-details.html?id=${finalMovieId}&from=edit`;
            }, 1000);

        } catch (error) {
            console.error("Error saving changes:", error);
            LibraryUtils.ui.showStatusMessage(`Error: ${error.message}`, 'error');
        } finally {
            UIUtils.resetButton('save-btn');
        }
    });

    // Single, correct 'delete' event listener
    deleteBtn.addEventListener('click', async () => {
        if (!confirm('Are you sure you want to delete this movie from your collection? This cannot be undone.')) return;
        const user = auth.currentUser;
        if (!user) return;
        deleteBtn.classList.add('loading');
        try {
            await db.collection('users').doc(user.uid).collection('movieInteractions').doc(movieId).delete();
            const otherInteractions = await db.collectionGroup('movieInteractions').where('movieId', '==', movieId).limit(1).get();
            if (otherInteractions.empty) {
                await db.collection('movies').doc(movieId).delete();
            }
            LibraryUtils.ui.showStatusMessage('Movie deleted from your collection.', 'success');
            setTimeout(() => window.location.href = 'library.html', 1500);
        } catch (error) {
            console.error('Error deleting movie:', error);
            LibraryUtils.ui.showStatusMessage('Failed to delete movie.', 'error');
        } finally {
            deleteBtn.classList.remove('loading');
        }
    });
 });

// Mobile-friendly status message improvements
function showStatusMessage(message, type) {
    const statusDiv = document.getElementById('statusMessage');
    const iconClass = type === 'success' ? 'icon-confirm' : type === 'error' ? 'icon-close' : 'icon-details';
    
    // Create mobile-friendly status message
    statusDiv.innerHTML = `
        <div class="status-message status-${type}" style="
            position: fixed;
            top: var(--space-lg);
            left: var(--space-md);
            right: var(--space-md);
            z-index: var(--z-modal);
            text-align: center;
            font-size: var(--font-size-base);
            padding: var(--space-lg);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
        ">
            <span class="icon ${iconClass} icon-md"></span>
            ${message}
        </div>
    `;
    
    // Auto-dismiss after 4 seconds on mobile
    if (window.innerWidth <= 768) {
        setTimeout(() => {
            statusDiv.innerHTML = '';
        }, 4000);
    }
}

// Mobile-friendly search improvements
function displayResults(results, isNewSearch) {
    const resultsDiv = document.getElementById('searchResults');
    if (isNewSearch) {
        resultsDiv.innerHTML = '';
    }
    
    if (results.length === 0 && isNewSearch) {
        resultsDiv.innerHTML = `
            <div class="empty-state">
                <span class="icon icon-search" style="font-size: var(--icon-size-3xl); margin-bottom: var(--space-lg);"></span>
                <h3>No results found</h3>
                <p>Try adjusting your search terms or check the spelling.</p>
            </div>
        `;
        return;
    }
    
    const resultsHTML = results.map((item) => {
        const title = item.title || item.name;
        const year = (item.release_date || item.first_air_date || '').substring(0, 4);
        const overview = LibraryUtils.ui.truncateText(item.overview, window.innerWidth <= 480 ? 80 : 100);
        const badgeHTML = item.media_type === 'tv' 
            ? `<span class="badge badge-tv" title="TV Show"><span class="icon icon-tv icon-sm"></span></span>`
            : `<span class="badge badge-movie" title="Movie"><span class="icon icon-movie icon-sm"></span></span>`;
        
        return `
            <div class="search-result" onclick="selectMedia('${item.id}', '${item.media_type}')" style="cursor: pointer;">
                <img src="${item.poster_path ? TMDB_IMAGE_BASE + item.poster_path : 'https://placehold.co/80x120/2D194D/DEF0F7?text=N/A'}" 
                    class="search-result-poster" 
                    loading="lazy"
                    onerror="this.style.display='none'">
                <div class="search-result-info">
                    <h4>${title} (${year}) ${badgeHTML}</h4>
                    <p>${overview}</p>
                </div>
            </div>
        `;
    }).join('');
    
    resultsDiv.insertAdjacentHTML('beforeend', resultsHTML);
}
// Mobile-friendly scanner improvements
async function startScanner() {
    if (!codeReader || videoInputDevices.length === 0) {
        showStatusMessage('Camera not available', 'error');
        return;
    }
    
    const modal = document.getElementById('scannerContainer');
    const video = document.getElementById('video');
    
    modal.classList.add('active');
    
    // Mobile-specific scanner message
    const isMobile = window.innerWidth <= 768;
    showStatusMessage(
        isMobile ? 'Starting camera... Hold phone steady and position barcode in center of screen.' : 'Starting camera...', 
        'info'
    );
    
    try {
        await codeReader.decodeFromVideoDevice(
            videoInputDevices[0].deviceId, 
            video,
            (result, err) => {
                if (result) {
                    console.log('Barcode detected:', result.text);
                    
                    // Provide haptic feedback on mobile if available
                    if (navigator.vibrate) {
                        navigator.vibrate(200);
                    }
                    
                    stopScanner();
                    lookupMovieByBarcode(result.text);
                }
                if (err && !(err instanceof ZXing.NotFoundException)) {
                    console.warn('Scanner error:', err);
                }
            }
        );
        
        showStatusMessage(
            isMobile ? 'Camera ready. Center barcode in view and hold steady.' : 'Camera ready. Position barcode in view.',
            'info'
        );
    } catch (error) {
        console.error('Failed to start camera:', error);
        showStatusMessage(`Camera error: ${error.message}. Please ensure camera permissions are granted.`, 'error');
        stopScanner();
    }
}

// Improved form validation for mobile
function validateFormOnMobile() {
    const titleValue = document.getElementById('title').value.trim();
    if (!titleValue) {
        showStatusMessage('Please search for and select a movie first.', 'error');
        
        // Scroll to search section on mobile
        if (window.innerWidth <= 768) {
            document.querySelector('.search-section').scrollIntoView({ 
                behavior: 'smooth', 
                block: 'start' 
            });
        }
        return false;
    }
    return true;
}

// Mobile-friendly modal improvements
function showTimedRedirectModal(title, message, redirectUrl, duration = 5) {
    const modal = document.getElementById('alertModal');
    if (!modal) {
        alert(message);
        setTimeout(() => { window.location.href = redirectUrl; }, 100);
        return;
    }

    const titleEl = modal.querySelector('#alertModalTitle');
    const messageEl = modal.querySelector('#alertModalMessage');
    const okBtn = modal.querySelector('#alertModalOk');
    const closeBtn = modal.querySelector('#alertModalClose');

    titleEl.textContent = title;
    okBtn.style.display = 'inline-flex';
    closeBtn.style.display = 'flex';

    let countdown = duration;
    const isMobile = window.innerWidth <= 768;
    
    messageEl.innerHTML = isMobile 
        ? `${message}<br><br><strong>Redirecting in ${countdown}s...</strong>`
        : `${message}<br><br>Redirecting in ${countdown} seconds...`;
    
    modal.classList.add('active');

    const interval = setInterval(() => {
        countdown--;
        if (countdown > 0) {
            messageEl.innerHTML = isMobile 
                ? `${message}<br><br><strong>Redirecting in ${countdown}s...</strong>`
                : `${message}<br><br>Redirecting in ${countdown} seconds...`;
        } else {
            clearInterval(interval);
            window.location.href = redirectUrl;
        }
    }, 1000);

    const cleanup = () => {
        clearInterval(interval);
        modal.classList.remove('active');
    };
    
    okBtn.onclick = () => {
        cleanup();
        window.location.href = redirectUrl;
    };

    closeBtn.onclick = cleanup;
    
    // Close modal on background tap for mobile
    modal.onclick = (e) => {
        if (e.target === modal) {
            cleanup();
        }
    };
}

// Add touch event improvements for mobile
document.addEventListener('DOMContentLoaded', () => {
    // Improve touch targets on mobile
    if (window.innerWidth <= 768) {
        const style = document.createElement('style');
        style.textContent = `
            .search-result {
                min-height: 60px;
                touch-action: manipulation;
            }
            .btn {
                touch-action: manipulation;
            }
            .star-rating-interactive .star {
                touch-action: manipulation;
                padding: var(--space-xs);
            }
        `;
        document.head.appendChild(style);
    }
    
    // Prevent zoom on input focus for iOS
    if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
        const inputs = document.querySelectorAll('input, textarea, select');
        inputs.forEach(input => {
            if (parseFloat(getComputedStyle(input).fontSize) < 16) {
                input.style.fontSize = '16px';
            }
        });
    }
})
        
    </script>
    <footer id="footer-placeholder"></footer>
</body>
</html>