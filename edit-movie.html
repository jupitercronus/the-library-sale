<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, maximum-scale=5.0">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#24143E">
    <meta name="format-detection" content="telephone=no">
    <title>Edit Media - the library sale</title>
    <!-- Google Fonts Import -->
     <link rel="preconnect" href="https://fonts.googleapis.com">
     <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
     <link href="https://fonts.googleapis.com/css2?family=B612+Mono&family=Dokdo&family=Kirang+Haerang&family=M+PLUS+2&family=Syne+Mono&display=swap" rel="stylesheet">
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-auth-compat.js"></script>
    <!-- ZXing Barcode Scanner Library -->
    <script type="text/javascript" src="https://unpkg.com/@zxing/library@0.20.0/umd/index.min.js"></script>
    <!-- App Utilities -->
    <script src="utils.js"></script>
    <script src="cache.js"></script>
    <script src="scanner-utils.js"></script>
    <!-- Styles -->
    <link rel="stylesheet" href="styles/variables.css">
    <link rel="stylesheet" href="styles/base.css">  
    <link rel="stylesheet" href="styles/components.css">
    <link rel="stylesheet" href="styles/pages.css">
    <!-- Main utilities -->
    <script src="main.js" defer></script>
</head>
<body>
    <header id="navbar-placeholder"></header>

    <main class="edit-movie-container">
        <!-- Loading Skeleton (initially visible) -->
        <div id="editLoadingState">
            <section class="details-ticket skeleton">
                <div class="skeleton" style="height: 36px; width: 60%; margin: 0 auto 8px;"></div>
                <div class="skeleton" style="height: 24px; width: 20%; margin: 0 auto;"></div>
            </section>
            <section class="details-main-content">
                <div class="details-poster skeleton"></div>
                <div class="details-info">
                    <div class="skeleton" style="height: 20px; width: 80px; margin-bottom: 8px;"></div>
                    <div class="skeleton" style="height: 16px; width: 90%;"></div>
                    <div class="skeleton" style="height: 20px; width: 80px; margin-top: 16px; margin-bottom: 8px;"></div>
                    <div class="skeleton" style="height: 16px; width: 70%;"></div>
                </div>
            </section>
            <section class="details-section skeleton" style="margin-top: 40px;">
                <div class="skeleton" style="height: 28px; width: 150px; margin-bottom: 16px;"></div>
                <div class="skeleton" style="height: 16px; width: 100%; margin-bottom: 8px;"></div>
                <div class="skeleton" style="height: 16px; width: 100%; margin-bottom: 8px;"></div>
                <div class="skeleton" style="height: 16px; width: 40%;"></div>
            </section>
        </div>

        <!-- Main Content and Form (initially hidden) -->
        <div id="mainContent" style="display: none;">
            <!-- Ticket-style header -->
            <section class="details-ticket">
                <h1 id="movie-title" class="details-title">Loading...</h1>
                <p id="movie-year" class="details-year">----</p>
            </section>

            <!-- Main Content Grid (Poster + Info) -->
            <section class="details-main-content">
                <div class="details-poster">
                    <img id="movie-poster-img" src="" alt="Movie Poster" loading="lazy">
                </div>
                <div class="details-info">
                    <div class="details-info-group">
                        <h3>Director</h3>
                        <p id="movie-director">Loading...</p>
                    </div>
                    <div class="details-info-group">
                        <h3>Top Cast</h3>
                        <p id="movie-cast">Loading...</p>
                    </div>
                    <div class="details-info-group">
                        <h3>Genre</h3>
                        <p id="movie-genre">Loading...</p>
                    </div>
                </div>
            </section>

            <!-- Summary Section -->
            <section class="details-section">
                <h2 class="details-section-header">
                    <i class="icon icon-details"></i>
                    <span>Summary</span>
                </h2>
                <div class="details-summary" id="summaryGroup">
                    <p id="movieOverview" class="summary-text">Loading summary...</p>
                    <button id="readMoreBtn" class="read-more-btn" style="display: none;">
                        Read more
                    </button>
                </div>
            </section>

            <!-- User Data Form -->
            <form id="edit-movie-form" class="details-section">
                <h2 class="heading-with-icon">
                    <i class="icon icon-comment"></i>
                    <span>Comments</span>
                </h2>
                <!-- Rating and Status Toggles -->
                <div class="rating-and-status-container">
                    <div class="form-group">
                        <label>Your Rating</label>
                        <div id="star-rating" class="star-rating-interactive star-rating-xlg">
                            <span class="star star-empty" data-value="1"></span>
                            <span class="star star-empty" data-value="2"></span>
                            <span class="star star-empty" data-value="3"></span>
                            <span class="star star-empty" data-value="4"></span>
                            <span class="star star-empty" data-value="5"></span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <div class="toggle-group gap-md">
                            <button type="button" id="watched-toggle" class="toggle-btn" data-active="false" title="Toggle Watched Status">
                                <i class="icon icon-watched"></i>
                            </button>
                            <button type="button" id="owned-toggle" class="toggle-btn" data-active="false" title="Toggle Owned Status">
                                <i class="icon icon-dvds"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="form-group" id="watched-date-group" style="display: none;">
                    <label for="watched-date">Watched Date</label>
                    <input type="date" id="watched-date">
                </div>
                    <br>
                <div class="form-group">
                <textarea id="comments" name="comments" rows="4" placeholder="Your notes, thoughts, or review..."></textarea>
                </div>
                <br>
            <!-- Enhanced Physical Edition Details -->
            <div class="form-group" id="physical-edition-details" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-md);">
                    <label>Physical Copy Details</label>
                    <button type="button" id="scan-barcode-btn" class="btn btn-barcode btn-rectangular btn-primary">
                        <i class="icon icon-search"></i>
                        <span>Scan Barcode</span>
                    </button>
                </div>
                <!-- SCANNER -->
              <section id="scanner-section" class="scanner-section" style="display: none;">
                <div class="scanner-viewport">
                    <video id="scanner-video" autoplay muted playsinline></video>
                    <div class="scanner-guideline"></div>
                    <div class="scanner-status" id="scannerStatus">Position barcode in view</div>
                </div>
                <div class="quick-actions">
                    <button type="button" id="stop-scanner-btn" class="btn btn-lg btn-danger" title="Stop Scanner">
                        <i class="icon icon-close"></i>
                    </button>
                </div>
            </section>
                
                <!-- Current Physical Edition Display -->
                <div id="currentPhysicalEdition" style="display: none;">
                    <div class="physical-edition-info">
                        <div class="edition-row">
                            <span class="edition-label">Format:</span>
                            <span id="currentEditionFormat">-</span>
                        </div>
                        <div class="edition-row">
                            <span class="edition-label">Edition:</span>
                            <span id="currentEditionType">-</span>
                        </div>
                        <div class="edition-row">
                            <span class="edition-label">Region:</span>
                            <span id="currentEditionRegion">-</span>
                        </div>
                        <div class="edition-row">
                            <span class="edition-label">Distributor:</span>
                            <span id="currentEditionDistributor">-</span>
                        </div>
                        <div class="edition-row" id="currentEditionFeaturesRow" style="display: none;">
                            <span class="edition-label">Features:</span>
                            <span id="currentEditionFeatures">-</span>
                        </div>
                        <div class="edition-row">
                            <span class="edition-label">Barcode:</span>
                            <span id="currentEditionBarcode">-</span>
                        </div>
                    </div>
                </div>
                
                <!-- Editable Form (hidden by default) -->
                <div id="editablePhysicalForm" style="display: none;">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="edition-format">Format</label>
                            <input type="text" id="edition-format" name="edition-format" placeholder="e.g., 4K, Blu-ray, DVD">
                        </div>
                        <div class="form-group">
                            <label for="edition-type">Edition</label>
                            <input type="text" id="edition-type" name="edition-type" placeholder="e.g., Special Edition, Director's Cut">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="edition-region">Region</label>
                            <input type="text" id="edition-region" name="edition-region" placeholder="e.g., Region 1, All Regions">
                        </div>
                        <div class="form-group">
                            <label for="edition-distributor">Distributor</label>
                            <input type="text" id="edition-distributor" name="edition-distributor" placeholder="e.g., Warner Bros, Sony">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="edition-features">Special Features</label>
                        <textarea id="edition-features" name="edition-features" rows="3" placeholder="e.g., Director Commentary, Deleted Scenes, Behind the Scenes"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="upc-code">UPC/Barcode</label>
                        <input type="text" id="upc-code" name="upc-code">
                    </div>
                </div>
            </div>
                <!-- Action Buttons -->
                <div class="form-actions">
                    <div class="form-actions-left">
                        <button type="submit" id="save-btn" class="btn btn-xl btn-success" title="Save Changes">
                            <i class="icon icon-confirm"></i>
                        </button>
                        <a id="cancel-btn" class="btn btn-xl btn-danger" title="Go Back">
                            <i class="icon icon-back"></i>
                        </a>
                    </div>
                    <div class="form-actions-right">
                        <button type="button" id="delete-btn" class="btn btn-xl btn-danger" title="Delete from Collection">
                            <i class="icon icon-delete"></i>
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </main>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDDW8LtwpYevdkD7Q-_CxJ23mMfi00P21M",
            authDomain: "tiny-lizard.firebaseapp.com",
            projectId: "tiny-lizard",
            storageBucket: "tiny-lizard.firebasestorage.app",
            messagingSenderId: "250872474692",
            appId: "1:250872474692:web:969e0b1302ae3cb4666011",
        };
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore(); 
        const auth = firebase.auth();

        // Global variables
        let currentRating = 0;
        let starRatingController = null;
        let editScanner = null;
        let physicalEditionData = {};
        let isEditingPhysical = false;

        document.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            const movieId = params.get('id');

            if (!movieId) {
                window.location.href = 'index.html';
                return;
            }

            const mainContent = document.getElementById('mainContent');
            const scannerSection = document.getElementById('scanner-section');
            const editMovieForm = document.getElementById('edit-movie-form');
            const watchedToggle = document.getElementById('watched-toggle');
            const ownedToggle = document.getElementById('owned-toggle');
            const physicalDetailsSection = document.getElementById('physical-edition-details');
            const cancelBtn = document.getElementById('cancel-btn');

            // Setup Star Rating using LibraryUtils
            const LibraryUtils = {
                stars: StarUtils,
                dates: DateUtils,
                errors: ErrorUtils,
                validation: ValidationUtils,
                ui: UIUtils,  // This should already include showStatusMessage now
                skeleton: SkeletonUtils,
                search: SearchUtils
            };
            const setupStars = (initialRating) => {
                currentRating = initialRating;
                if (window.LibraryUtils && window.LibraryUtils.stars) {
                    starRatingController = window.LibraryUtils.stars.setupInteractiveStarRating('star-rating', (rating) => {
                        currentRating = rating;
                    }, currentRating);
                } else {
                    console.error('LibraryUtils or LibraryUtils.stars not available. Check that utils.js is loaded correctly.');
                }
            };

            // Toggle Button Logic
            watchedToggle.addEventListener('click', () => {
                const isWatched = watchedToggle.dataset.active === 'true';
                const newWatchedState = !isWatched;
                watchedToggle.dataset.active = newWatchedState ? 'true' : 'false';
                
                // Show/hide the watched date field
                const watchedDateGroup = document.getElementById('watched-date-group');
                watchedDateGroup.style.display = newWatchedState ? 'block' : 'none';
                
                // Clear the date if unwatched
                if (!newWatchedState) {
                    document.getElementById('watched-date').value = '';
                }
            });

            ownedToggle.addEventListener('click', () => {
                const isOwned = ownedToggle.dataset.active === 'true';
                const newOwnedState = !isOwned;
                ownedToggle.dataset.active = newOwnedState ? 'true' : 'false';
                
                physicalDetailsSection.style.display = newOwnedState ? 'block' : 'none';
                if (!newOwnedState) {
                    document.getElementById('edition-title').value = '';
                    document.getElementById('edition-format').value = '';
                    document.getElementById('upc-code').value = '';
                }
            });

            document.getElementById('updatePhysicalBtn').addEventListener('click', togglePhysicalEditMode);
            document.getElementById('savePhysicalBtn').addEventListener('click', savePhysicalEditionChanges);
            document.getElementById('cancelPhysicalBtn').addEventListener('click', togglePhysicalEditMode);

            // Cancel Button Logic
            cancelBtn.addEventListener('click', (e) => {
                e.preventDefault();
                if (document.referrer && !document.referrer.includes('edit-movie.html')) {
                    window.history.back();
                } else {
                    window.location.href = 'index.html';
                }
            });

            // Data Loading and Form Population
            const populateForm = (userData) => {
                setupStars(userData.rating || 0);

                watchedToggle.dataset.active = userData.watched === true ? 'true' : 'false';
                if (userData.watched === true) {
                    document.getElementById('watched-date-group').style.display = 'block'; 
                    document.getElementById('watched-date').value = userData.watchedDate || '';
                } else {
                    document.getElementById('watched-date-group').style.display = 'none';
                }

                ownedToggle.dataset.active = userData.owned === true ? 'true' : 'false';

                ownedToggle.dataset.active = userData.owned === true ? 'true' : 'false';

                if (userData.owned === true) {
                    physicalDetailsSection.style.display = 'block';
                    displayCurrentPhysicalEdition(userData);
                } else {
                    physicalDetailsSection.style.display = 'none';
                }

                document.getElementById('comments').value = userData.review || '';
            };
            
            // Load Movie Data Function
            const loadMovieData = async (userId) => {
                try {
                    const [movieDoc] = await Promise.all([
                        db.collection('movies').doc(movieId).get(),
                        new Promise(resolve => setTimeout(resolve, 800)) // Smooth UX
                    ]);

                    if (!movieDoc.exists) throw new Error('Movie not found');

                    const movieData = movieDoc.data();
                    
                    document.getElementById('movie-poster-img').src = movieData.posterUrl || 'https://placehold.co/300x450/2D194D/DEF0F7?text=No+Poster';
                    document.getElementById('movie-title').textContent = movieData.title || 'Unknown Title';
                    document.getElementById('movie-year').textContent = movieData.year || 'N/A';
                    document.getElementById('movie-director').textContent = movieData.director || 'N/A';
                    document.getElementById('movie-cast').textContent = Array.isArray(movieData.cast) ? movieData.cast.join(', ') : (movieData.cast || 'N/A');
                    document.getElementById('movie-genre').textContent = movieData.genre || 'N/A';

                    const overviewElement = document.getElementById('movieOverview');
                    const readMoreBtn = document.getElementById('readMoreBtn');
                    const overview = movieData.overview || 'No description available.';
                    overviewElement.textContent = overview;
                    
                    if (overview.length > 200) {
                        readMoreBtn.style.display = 'inline-flex';
                        readMoreBtn.onclick = function() {
                            overviewElement.classList.toggle('collapsed');
                            this.textContent = overviewElement.classList.contains('collapsed') ? 'Read more' : 'Read less';
                        };
                    }

                    const interactionDoc = await db.collection('users').doc(userId).collection('movieInteractions').doc(movieId).get();

                    if (interactionDoc.exists) {
                        populateForm(interactionDoc.data());
                    } else {
                        setupStars(0);
                    }
                    
                    document.getElementById('editLoadingState').style.display = 'none';
                    mainContent.style.display = 'block';
                    
                } catch (error) {
                    console.error("Error loading movie data:", error);
                    document.getElementById('editLoadingState').innerHTML = `<div class="error-state"><h3>Error</h3><p>${error.message}</p><a href="index.html" class="btn btn-primary">Back</a></div>`;
                }
            };

            // Authentication Check
            auth.onAuthStateChanged(user => {
                if (user) {
                    loadMovieData(user.uid);
                    initializeEditScanner(); 
                } else {
                    window.location.href = 'auth.html';
                }
            });

            // Form Submission
            editMovieForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const user = auth.currentUser;
                if (!user) return;

                const saveBtn = document.getElementById('save-btn');
                saveBtn.classList.add('saving');

                const watchedDateElement = document.getElementById('watched-date');
                const watchedDateValue = watchedDateElement ? watchedDateElement.value || null : null;
                const updatedData = {
                    movieId: movieId,
                    rating: currentRating,
                    watched: watchedToggle.dataset.active === 'true',
                    owned: ownedToggle.dataset.active === 'true',
                    review: document.getElementById('comments').value.trim(),
                    interactionDate: firebase.firestore.FieldValue.serverTimestamp(),
                    watchedDate: watchedDateValue            
                    };

                if (updatedData.owned) {
                    // Read directly from the form fields
                    const featuresText = document.getElementById('edition-features').value.trim();
                    
                    updatedData.physicalEdition = {
                        format: document.getElementById('edition-format').value.trim(),
                        edition: document.getElementById('edition-type').value.trim(),
                        region: document.getElementById('edition-region').value.trim(),
                        distributor: document.getElementById('edition-distributor').value.trim(),
                        features: featuresText ? featuresText.split(',').map(f => f.trim()) : [],
                        barcode: document.getElementById('upc-code').value.trim()
                    };
                    updatedData.upc = updatedData.physicalEdition.barcode;
                }

                try {
                    await db.collection('users').doc(user.uid).collection('movieInteractions').doc(movieId).set(updatedData, { merge: true });
                    LibraryUtils.ui.showStatusMessage('Changes saved successfully!', 'success');
                    setTimeout(() => window.location.href = `library.html?id=${movieId}`, 1500);
                } catch (error) {
                    console.error("Error updating movie:", error);
                    LibraryUtils.ui.showStatusMessage('Error saving changes.', 'error');
                } finally {
                    saveBtn.classList.remove('saving');
                }
            });
            
            // Barcode Scanner Logic
            const scanBtn = document.getElementById('scan-barcode-btn');
            const stopBtn = document.getElementById('stop-scanner-btn');
            const video = document.getElementById('scanner-video');

            // Delete Button Logic
            const deleteBtn = document.getElementById('delete-btn');
            deleteBtn.addEventListener('click', async () => {
                if (!confirm('Are you sure you want to delete this movie from your collection? This cannot be undone.')) return;

                const user = auth.currentUser;
                if (!user) return;

                deleteBtn.classList.add('loading');
                try {
                    await db.collection('users').doc(user.uid).collection('movieInteractions').doc(movieId).delete();
                    
                    const otherInteractions = await db.collectionGroup('movieInteractions').where('movieId', '==', movieId).limit(1).get();
                    if (otherInteractions.empty) {
                        await db.collection('movies').doc(movieId).delete();
                    }

                    LibraryUtils.ui.showStatusMessage('Movie deleted from your collection.', 'success');
                    setTimeout(() => window.location.href = 'index.html', 1500);
                } catch (error) {
                    console.error('Error deleting movie:', error);
                    LibraryUtils.ui.showStatusMessage('Failed to delete movie.', 'error');
                } finally {
                    deleteBtn.classList.remove('loading');
                }
            });
        });

async function initializeEditScanner() {
    // Get references to the UI elements
    const scanBtn = document.getElementById('scan-barcode-btn');
    const stopBtn = document.getElementById('stop-scanner-btn');
    const scannerSection = document.getElementById('scanner-section');
    const videoEl = document.getElementById('scanner-video');

    // Create a new ScannerManager instance
    editScanner = new ScannerManager({
        continuous: false, // Stop after one successful scan
        onBarcodeScanned: async (barcode) => {
            // When a barcode is found, hide the scanner UI
            scannerSection.style.display = 'none';

            try {
                // Use the centralized lookup utility
                LibraryUtils.ui.showStatusMessage('Looking up barcode...', 'info');
                const { physicalEdition } = await MediaLookupUtils.completeMovieLookup(barcode);

                // Populate the editable form with the new data
                document.getElementById('edition-format').value = physicalEdition.format || '';
                document.getElementById('edition-type').value = physicalEdition.edition || '';
                document.getElementById('edition-region').value = physicalEdition.region || '';
                document.getElementById('edition-distributor').value = physicalEdition.distributor || '';
                document.getElementById('edition-features').value = physicalEdition.features.join(', ');
                document.getElementById('upc-code').value = barcode;

                LibraryUtils.ui.showStatusMessage('Physical edition details updated!', 'success');

            } catch (error) {
                console.error('Barcode lookup failed:', error);
                LibraryUtils.ui.showStatusMessage(error.message, 'error');
            }
        },
        onStatusUpdate: (message, type) => {
            ScannerUI.updateStatus(message, type, 'scannerStatus');
        },
        onError: (message) => {
            LibraryUtils.ui.showStatusMessage(message, 'error');
            scannerSection.style.display = 'none';
        }
    });

        // Initialize the scanner and set up button event listeners
        const initialized = await editScanner.initialize();
        if (!initialized) {
            scanBtn.disabled = true;
            scanBtn.textContent = 'Scanner N/A';
            return;
        }

        scanBtn.addEventListener('click', async () => {
            document.getElementById('editablePhysicalForm').style.display = 'block';
            document.getElementById('currentPhysicalEdition').style.display = 'none';
            scannerSection.style.display = 'block';
            await editScanner.startCamera(videoEl, 'scannerStatus');
        });

        stopBtn.addEventListener('click', () => {
            editScanner.stopCamera();
            scannerSection.style.display = 'none';
        });
}
        function displayCurrentPhysicalEdition(userData) {
            const physicalSection = document.getElementById('physical-edition-details');
            const editableForm = document.getElementById('editablePhysicalForm');

            if (userData.owned) {
                physicalSection.style.display = 'block';
                editableForm.style.display = 'block'; // Always show the editable form

                const edition = userData.physicalEdition || {};

                // Populate the input fields directly
                document.getElementById('edition-format').value = edition.format || userData.editionFormat || '';
                document.getElementById('edition-type').value = edition.edition || userData.editionTitle || '';
                document.getElementById('edition-region').value = edition.region || '';
                document.getElementById('edition-distributor').value = edition.distributor || '';
                const featuresText = Array.isArray(edition.features) ? edition.features.join(', ') : (edition.features || '');
                document.getElementById('edition-features').value = featuresText;
                document.getElementById('upc-code').value = userData.upc || '';
            } else {
                physicalSection.style.display = 'none';
            }
        }

        function togglePhysicalEditMode() {
            const currentSection = document.getElementById('currentPhysicalEdition');
            const editableForm = document.getElementById('editablePhysicalForm');
            
            if (isEditingPhysical) {
                // Switch to display mode
                currentSection.style.display = 'block';
                editableForm.style.display = 'none';
                isEditingPhysical = false;
            } else {
                // Switch to edit mode - populate form with current data
                document.getElementById('edition-format').value = physicalEditionData.format || '';
                document.getElementById('edition-type').value = physicalEditionData.edition || '';
                document.getElementById('edition-region').value = physicalEditionData.region || '';
                document.getElementById('edition-distributor').value = physicalEditionData.distributor || '';
                document.getElementById('edition-features').value = Array.isArray(physicalEditionData.features) 
                    ? physicalEditionData.features.join(', ') : (physicalEditionData.features || '');
                document.getElementById('upc-code').value = physicalEditionData.barcode || '';
                
                currentSection.style.display = 'none';
                editableForm.style.display = 'block';
                isEditingPhysical = true;
            }
        }

        function savePhysicalEditionChanges() {
            const format = document.getElementById('edition-format').value.trim();
            const edition = document.getElementById('edition-type').value.trim();
            const region = document.getElementById('edition-region').value.trim();
            const distributor = document.getElementById('edition-distributor').value.trim();
            const featuresText = document.getElementById('edition-features').value.trim();
            const features = featuresText ? featuresText.split(',').map(f => f.trim()).filter(f => f) : [];
            const barcode = document.getElementById('upc-code').value.trim();
            
            // Update physical edition data
            physicalEditionData = {
                format: format || 'Unknown',
                edition: edition || 'Standard', 
                region: region || 'Unknown',
                distributor: distributor || 'Unknown',
                features: features,
                barcode: barcode
            };
            document.getElementById('currentEditionFormat').textContent = physicalEditionData.format;
            document.getElementById('currentEditionType').textContent = physicalEditionData.edition;
            document.getElementById('currentEditionRegion').textContent = physicalEditionData.region;
            document.getElementById('currentEditionDistributor').textContent = physicalEditionData.distributor;
            document.getElementById('currentEditionBarcode').textContent = physicalEditionData.barcode || 'None';
            
            const featuresRow = document.getElementById('currentEditionFeaturesRow');
            const featuresSpan = document.getElementById('currentEditionFeatures');
            if (features.length > 0) {
                featuresRow.style.display = 'flex';
                featuresSpan.textContent = features.join(', ');
            } else {
                featuresRow.style.display = 'none';
            }
            
            // Switch back to display mode
            togglePhysicalEditMode();
            
            LibraryUtils.ui.showStatusMessage('Physical edition details updated locally. Save the form to persist changes.', 'info');
        }

        // Mobile-friendly status message improvements
        function showStatusMessage(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            const iconClass = type === 'success' ? 'icon-confirm' : type === 'error' ? 'icon-close' : 'icon-details';
            
            // Create mobile-friendly status message
            statusDiv.innerHTML = `
                <div class="status-message status-${type}" style="
                    position: fixed;
                    top: var(--space-lg);
                    left: var(--space-md);
                    right: var(--space-md);
                    z-index: var(--z-modal);
                    text-align: center;
                    font-size: var(--font-size-base);
                    padding: var(--space-lg);
                    border-radius: var(--radius-lg);
                    box-shadow: var(--shadow-lg);
                ">
                    <span class="icon ${iconClass} icon-md"></span>
                    ${message}
                </div>
            `;
            
            // Auto-dismiss after 4 seconds on mobile
            if (window.innerWidth <= 768) {
                setTimeout(() => {
                    statusDiv.innerHTML = '';
                }, 4000);
            }
        }

        // Mobile-friendly search improvements
        function displayResults(results, isNewSearch) {
            const resultsDiv = document.getElementById('searchResults');
            if (isNewSearch) {
                resultsDiv.innerHTML = '';
            }
            
            if (results.length === 0 && isNewSearch) {
                resultsDiv.innerHTML = `
                    <div class="empty-state">
                        <span class="icon icon-search" style="font-size: var(--icon-size-3xl); margin-bottom: var(--space-lg);"></span>
                        <h3>No results found</h3>
                        <p>Try adjusting your search terms or check the spelling.</p>
                    </div>
                `;
                return;
            }
            
            const resultsHTML = results.map((item) => {
                const title = item.title || item.name;
                const year = (item.release_date || item.first_air_date || '').substring(0, 4);
                const overview = LibraryUtils.ui.truncateText(item.overview, window.innerWidth <= 480 ? 80 : 100);
                const badgeHTML = item.media_type === 'tv' 
                    ? `<span class="badge badge-tv" title="TV Show"><span class="icon icon-tv icon-sm"></span></span>`
                    : `<span class="badge badge-movie" title="Movie"><span class="icon icon-movie icon-sm"></span></span>`;
                
                return `
                    <div class="search-result" onclick="selectMedia('${item.id}', '${item.media_type}')" style="cursor: pointer;">
                        <img src="${item.poster_path ? TMDB_IMAGE_BASE + item.poster_path : 'https://placehold.co/80x120/2D194D/DEF0F7?text=N/A'}" 
                            class="search-result-poster" 
                            loading="lazy"
                            onerror="this.style.display='none'">
                        <div class="search-result-info">
                            <h4>${title} (${year}) ${badgeHTML}</h4>
                            <p>${overview}</p>
                        </div>
                    </div>
                `;
            }).join('');
            
            resultsDiv.insertAdjacentHTML('beforeend', resultsHTML);
        }

        // Mobile-friendly scanner improvements
        async function startScanner() {
            if (!codeReader || videoInputDevices.length === 0) {
                showStatusMessage('Camera not available', 'error');
                return;
            }
            
            const modal = document.getElementById('scannerContainer');
            const video = document.getElementById('video');
            
            modal.classList.add('active');
            
            // Mobile-specific scanner message
            const isMobile = window.innerWidth <= 768;
            showStatusMessage(
                isMobile ? 'Starting camera... Hold phone steady and position barcode in center of screen.' : 'Starting camera...', 
                'info'
            );
            
            try {
                await codeReader.decodeFromVideoDevice(
                    videoInputDevices[0].deviceId, 
                    video,
                    (result, err) => {
                        if (result) {
                            console.log('Barcode detected:', result.text);
                            
                            // Provide haptic feedback on mobile if available
                            if (navigator.vibrate) {
                                navigator.vibrate(200);
                            }
                            
                            stopScanner();
                            lookupMovieByBarcode(result.text);
                        }
                        if (err && !(err instanceof ZXing.NotFoundException)) {
                            console.warn('Scanner error:', err);
                        }
                    }
                );
                
                showStatusMessage(
                    isMobile ? 'Camera ready. Center barcode in view and hold steady.' : 'Camera ready. Position barcode in view.',
                    'info'
                );
            } catch (error) {
                console.error('Failed to start camera:', error);
                showStatusMessage(`Camera error: ${error.message}. Please ensure camera permissions are granted.`, 'error');
                stopScanner();
            }
        }

        // Improved form validation for mobile
        function validateFormOnMobile() {
            const titleValue = document.getElementById('title').value.trim();
            if (!titleValue) {
                showStatusMessage('Please search for and select a movie first.', 'error');
                
                // Scroll to search section on mobile
                if (window.innerWidth <= 768) {
                    document.querySelector('.search-section').scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'start' 
                    });
                }
                return false;
            }
            return true;
        }

        // Mobile-friendly modal improvements
        function showTimedRedirectModal(title, message, redirectUrl, duration = 5) {
            const modal = document.getElementById('alertModal');
            if (!modal) {
                alert(message);
                setTimeout(() => { window.location.href = redirectUrl; }, 100);
                return;
            }

            const titleEl = modal.querySelector('#alertModalTitle');
            const messageEl = modal.querySelector('#alertModalMessage');
            const okBtn = modal.querySelector('#alertModalOk');
            const closeBtn = modal.querySelector('#alertModalClose');

            titleEl.textContent = title;
            okBtn.style.display = 'inline-flex';
            closeBtn.style.display = 'flex';

            let countdown = duration;
            const isMobile = window.innerWidth <= 768;
            
            messageEl.innerHTML = isMobile 
                ? `${message}<br><br><strong>Redirecting in ${countdown}s...</strong>`
                : `${message}<br><br>Redirecting in ${countdown} seconds...`;
            
            modal.classList.add('active');

            const interval = setInterval(() => {
                countdown--;
                if (countdown > 0) {
                    messageEl.innerHTML = isMobile 
                        ? `${message}<br><br><strong>Redirecting in ${countdown}s...</strong>`
                        : `${message}<br><br>Redirecting in ${countdown} seconds...`;
                } else {
                    clearInterval(interval);
                    window.location.href = redirectUrl;
                }
            }, 1000);

            const cleanup = () => {
                clearInterval(interval);
                modal.classList.remove('active');
            };
            
            okBtn.onclick = () => {
                cleanup();
                window.location.href = redirectUrl;
            };

            closeBtn.onclick = cleanup;
            
            // Close modal on background tap for mobile
            modal.onclick = (e) => {
                if (e.target === modal) {
                    cleanup();
                }
            };
        }

        // Add touch event improvements for mobile
        document.addEventListener('DOMContentLoaded', () => {
            // Improve touch targets on mobile
            if (window.innerWidth <= 768) {
                const style = document.createElement('style');
                style.textContent = `
                    .search-result {
                        min-height: 60px;
                        touch-action: manipulation;
                    }
                    .btn {
                        touch-action: manipulation;
                    }
                    .star-rating-interactive .star {
                        touch-action: manipulation;
                        padding: var(--space-xs);
                    }
                `;
                document.head.appendChild(style);
            }
            
            // Prevent zoom on input focus for iOS
            if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
                const inputs = document.querySelectorAll('input, textarea, select');
                inputs.forEach(input => {
                    if (parseFloat(getComputedStyle(input).fontSize) < 16) {
                        input.style.fontSize = '16px';
                    }
                });
            }
        });
        
    </script>
    <footer id="footer-placeholder"></footer>
</body>
</html>
