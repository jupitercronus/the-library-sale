<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Movie Details - The Library Sale</title>
    <!-- Google Fonts & Styles -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=B612+Mono&family=Dokdo&family=Kirang+Haerang&family=M+PLUS+2&family=Syne+Mono&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles/variables.css">
    <link rel="stylesheet" href="styles/base.css">  
    <link rel="stylesheet" href="styles/components.css">
    <link rel="stylesheet" href="styles/pages.css">    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-auth-compat.js"></script>   
    
    <!-- App Utilities -->
    <script src="utils.js"></script>
    <script src="modal-manager.js"></script>
    <script src="scanner-utils.js"></script>
    <script src="cache.js"></script>
    <script src="search-ui.js"></script> 

    <!-- Styles -->
    <link rel="stylesheet" href="styles/variables.css">
    <link rel="stylesheet" href="styles/base.css">  
    <link rel="stylesheet" href="styles/components.css">
    <link rel="stylesheet" href="styles/pages.css">
    
    <!-- Main Script -->
    <script src="main.js" defer></script>
    
</head>
<body>
    <div>    
        <header id="navbar-placeholder"></header>
    </div>

    <main id="detailsContainer" class="details-page-container" style="display: none;">
        
        <!-- Centered Title, Year, and Ratings (Ticket Style) -->
        <div class="details-ticket">
            <h1 id="movieTitle" class="details-title"></h1>
        
            <div class="details-meta-line">
                <p id="movieYear" class="details-year"></p>
                <span id="contentTypeBadge" class="content-type-badge"></span>
            </div>
        
            <div class="details-ratings">
                <div class="rating-box">
                    <h3>avg rating</h3>
                    <div id="averageRating" class="star-rating star-rating-sm"></div>
                </div>
                <div class="rating-box">
                    <h3>my rating</h3>
                    <div id="myRating" class="star-rating star-rating-sm"></div>
                </div>
            </div>
        </div>

        <!-- Main Content Grid (Poster + Info) -->
        <div class="details-main-content">
            <div class="details-poster">
                <img id="moviePoster" src="" alt="Movie Poster">
            </div>
            <div class="details-info">
                <div class="details-info-group">
                    <h3>Director</h3>
                    <p id="movieDirector"></p>
                </div>
                <div class="details-info-group">
                    <h3>Top Cast</h3>
                    <p id="movieCast"></p>
                </div>
                <div class="details-info-group">
                    <h3>Genre</h3>
                    <p id="movieGenre"></p>
                </div>
            </div>
        </div>

        <!-- Summary Section -->
        <div class="details-section">
            <div class="section-header-actions">
            <h2 class="details-section-header">
                <i class="icon icon-details"></i>
                <span>summary</span>
            </h2>
                <a id="editDetailsBtn" href="#" class="btn btn-rectangular btn-primary" style="display: none;">
                    <i class="icon icon-edit"></i>
                    <span>edit details</span>
                </a>
            </div>
            <div class="details-summary" id="summaryGroup">
                <p id="movieOverview" class="summary-text"></p>
                <button id="readMoreBtn" class="read-more-btn" style="display: none;">read more</button>
            </div>
        </div>

        <!-- Comments Section -->
        <div class="details-section">
            <div class="section-header">
                <h2 class="details-section-header">
                    <i class="icon icon-comment"></i>
                    <span>comments</span>
                </h2>
                <button id="toggleCommentEditBtn" class="btn btn-rectangular btn-primary" style="display: none;">
                    <i class="icon icon-edit"></i>
                    <span id="commentBtnText">add comments</span>
                </button>
            </div>
                <div id="myStatusDisplay" class="my-status-grid" style="display: none;">
                    <div class="status-item">
                        <label>my rating</label>
                    <div id="myStatusRating" class="star-rating star-rating-lg"> 
                            <span class="star star-empty" data-value="1"></span>
                            <span class="star star-empty" data-value="2"></span>
                            <span class="star star-empty" data-value="3"></span>
                            <span class="star star-empty" data-value="4"></span>
                            <span class="star star-empty" data-value="5"></span>
                        </div>
                    </div>
                    <div class="status-item">
                        <label>watched</label>
                        <div id="myStatusWatched" class="status-icon"></div>
                    </div>
                    <div class="status-item">
                        <label>owned</label>
                        <div id="myStatusOwned" class="status-icon"></div>
                    </div>
                </div>

            <div id="commentEditForm" class="comment-edit-form" style="display: none;">
                <div class="edit-status-grid">
                    <div class="form-group">
                        <label>my rating</label>
                        <div id="comment-star-rating" class="star-rating-interactive star-rating-lg">
                            <span class="star star-empty" data-value="1"></span>
                            <span class="star star-empty" data-value="2"></span>
                            <span class="star star-empty" data-value="3"></span>
                            <span class="star star-empty" data-value="4"></span>
                            <span class="star star-empty" data-value="5"></span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>watched</label>
                        <div class="toggle-group">
                            <button type="button" id="watched-toggle" class="toggle-btn" data-active="false" title="Toggle Watched Status">
                                <i class="icon icon-watched"></i>
                            </button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>owned</label>
                        <div class="toggle-group">
                            <button type="button" id="owned-toggle" class="toggle-btn" data-active="false" title="Toggle Owned Status">
                                <i class="icon icon-dvds"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="form-group" id="watched-date-group" style="display: none;">
                    <label for="watched-date">watched date</label>
                    <input type="date" id="watched-date" class="form-input">
                </div>
                <div class="form-group">
                    <label for="comment-textarea">my comments</label>
                    <textarea id="comment-textarea" class="comment-edit-textarea" rows="4" placeholder="your notes, thoughts, or review..."></textarea>
                </div>
                <div class="comment-edit-actions">
                    <button id="saveCommentBtn" type="button" class="btn btn-lg btn-success"><i class="icon icon-confirm"></i></button>
                    <button id="cancelCommentBtn" type="button" class="btn btn-lg btn-danger"> <i class="icon icon-close"></i></button>
                </div>
            </div>

            <div id="commentsContainer" class="comments-list">
                </div>
        </div>

        <!-- Enhanced Physical Copies Section -->
        <div class="details-section">
            <div class="section-header-actions">
                <h2 class="details-section-header">
                    <i class="icon icon-dvds"></i>
                    <span>physical copies</span>
                </h2>
                <a href="#" id="addCopyBtn" class="btn btn-rectangular btn-primary" style="display: none;">
                    <i class="icon icon-add"></i>
                    <span>add copy</span>
                </a>
            </div>
            <div id="physicalCopiesContainer" class="physical-copies-list">
                </div>
        </div>
    </main>
    
    <footer class="site-footer">
        <div class="footer-container" style="text-align: center;">
             <button id="smartBackBtn" onclick="goBack()" class="btn btn-lg btn-danger" title="take me away">
                <i class="icon icon-back"></i>
            </button>
        </div>
    </footer>

    <!-- Skeleton Loading State -->
    <div id="loadingState" class="library-loading-skeleton" style="display: block;">
        <div class="skeleton-details-ticket">
            <div class="skeleton" style="width: 300px; height: 32px; margin: 0 auto 8px;"></div>
            <div class="skeleton" style="width: 100px; height: 20px; margin: 0 auto 15px;"></div>
            <div style="display: flex; justify-content: center; gap: 30px;">
                <div style="min-width: 120px;"><div class="skeleton" style="width: 100px; height: 12px; margin: 0 auto 10px;"></div><div class="skeleton" style="width: 80px; height: 16px; margin: 0 auto;"></div></div>
                <div style="min-width: 120px;"><div class="skeleton" style="width: 60px; height: 12px; margin: 0 auto 10px;"></div><div class="skeleton" style="width: 80px; height: 16px; margin: 0 auto;"></div></div>
            </div>
        </div>
        <div class="skeleton-details-main">
            <div class="skeleton skeleton-details-poster"></div>
            <div class="skeleton-details-info">
                <div class="skeleton-info-group"><div class="skeleton skeleton-info-title"></div><div class="skeleton skeleton-info-text"></div></div>
                <div class="skeleton-info-group"><div class="skeleton skeleton-info-title"></div><div class="skeleton skeleton-info-text"></div></div>
                <div class="skeleton-info-group"><div class="skeleton skeleton-info-title"></div><div class="skeleton skeleton-info-text"></div></div>
            </div>
        </div>
        <div class="skeleton skeleton-section">
            <div class="skeleton skeleton-section-header"></div>
            <div class="skeleton-section-content"><div class="skeleton skeleton-text-line long"></div><div class="skeleton skeleton-text-line medium"></div><div class="skeleton skeleton-text-line short"></div></div>
        </div>
        <div class="skeleton skeleton-section">
            <div class="skeleton skeleton-section-header"></div>
            <div class="skeleton-section-content"><div class="skeleton skeleton-text-line long"></div><div class="skeleton skeleton-text-line medium"></div></div>
        </div>
    </div>
<script>
    const firebaseConfig = {
        apiKey: "AIzaSyDDW8LtwpYevdkD7Q-_CxJ23mMfi00P21M",
        authDomain: "tiny-lizard.firebaseapp.com",
        projectId: "tiny-lizard",
        storageBucket: "tiny-lizard.firebasestorage.app",
        messagingSenderId: "250872474692",
        appId: "1:250872474692:web:969e0b1302ae3cb4666011"
    };
    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore(); 
    const auth = firebase.auth();

    let commentStarRatingController = null;

async function loadMoviePage(user, movieId) {
    document.getElementById('loadingState').style.display = 'block';
    document.getElementById('detailsContainer').style.display = 'none';

    try {
        // Check if we're coming from an edit operation
        const urlParams = new URLSearchParams(window.location.search);
        const fromEdit = urlParams.get('from') === 'edit' || document.referrer.includes('edit-movie.html');

        const adminDoc = user ? await db.collection('admins').doc(user.uid).get() : null;
        const isAdmin = adminDoc && adminDoc.exists && adminDoc.data().isActive === true;  
        
        let movieDoc;
        if (fromEdit) {
            // Bypass cache and get fresh data directly from Firestore
            console.log('Bypassing cache due to edit operation');
            movieDoc = await db.collection('movies').doc(movieId).get();
        } else {
            // Use cached version for normal navigation
            movieDoc = await CachedFirestore.getMovieByDocId(movieId);
        }
        
        if (!movieDoc.exists) {
            throw new Error("This movie could not be found in the main library.");
        }
        
        const movieData = { id: movieDoc.id, ...movieDoc.data() };
        const interactionsSnapshot = await db.collectionGroup('movieInteractions').where('movieId', '==', movieId).get();

        const allInteractions = interactionsSnapshot.docs.map(doc => ({
            userId: doc.ref.path.split('/')[1],
            ...doc.data()
        }));
        
        const myInteraction = allInteractions.find(interaction => user && interaction.userId === user.uid);

        populateMovieDetails(movieData, myInteraction, allInteractions);
        await loadCommentsWithUserData(allInteractions);
        await loadPhysicalCopies(allInteractions, user, isAdmin);
        await setupFactualDetailsEditButton(user, movieData); 
        setupCommentForm(user, movieId, myInteraction);

        document.getElementById('loadingState').style.display = 'none';
        document.getElementById('detailsContainer').style.display = 'flex';
   
    } catch (error) {
        console.error("Error loading movie page:", error);
        const container = document.getElementById('detailsContainer');
        container.innerHTML = `<div class="error-state"><h3>Error</h3><p>${error.message}</p></div>`;
        container.style.display = 'block';
        document.getElementById('loadingState').style.display = 'none';
    }
}
function populateMovieDetails(movieData, myInteraction, allInteractions) {
    document.getElementById('movieTitle').textContent = movieData.title || 'Untitled';
    document.getElementById('movieYear').textContent = movieData.year || 'N/A';
    const contentType = movieData.contentType || 'movie';
        const badgeElement = document.getElementById('contentTypeBadge');
        const iconClass = contentType === 'tv' ? 'icon-tv' : 'icon-movie';
            badgeElement.innerHTML = `<span class="icon ${iconClass}"></span>`;
            
    document.getElementById('moviePoster').src = movieData.posterUrl || 'https://placehold.co/300x450/2D194D/DEF0F7?text=No+Poster';
    document.getElementById('moviePoster').alt = `Poster for ${movieData.title}`;
    document.getElementById('movieDirector').textContent = movieData.director || 'N/A';
    document.getElementById('movieCast').textContent = Array.isArray(movieData.cast) ? movieData.cast.join(', ') : 'N/A';
    document.getElementById('movieGenre').textContent = movieData.genre || 'N/A';
    
    const overviewElement = document.getElementById('movieOverview');
    const readMoreBtn = document.getElementById('readMoreBtn');
    const summaryGroup = document.getElementById('summaryGroup');
    const overview = movieData.overview || 'No description available.';
    
    overviewElement.textContent = overview;
    
    if (overview.length > 250) { // Adjusted threshold
        summaryGroup.classList.add('collapsed');
        readMoreBtn.style.display = 'inline-flex';
        readMoreBtn.onclick = () => {
            summaryGroup.classList.toggle('collapsed');
            readMoreBtn.textContent = summaryGroup.classList.contains('collapsed') ? 'read more' : 'read less';
        };
    } else {
            readMoreBtn.style.display = 'none';
    }

    const ratings = allInteractions.map(i => i.rating).filter(r => r > 0);
    const avgRating = ratings.length > 0 ? ratings.reduce((a, b) => a + b, 0) / ratings.length : 0;
    renderStars(document.getElementById('averageRating'), avgRating); 
    renderStars(document.getElementById('myRating'), myInteraction ? myInteraction.rating : 0);

    const myStatusDisplay = document.getElementById('myStatusDisplay');
    if (myInteraction) {
        myStatusDisplay.style.display = 'grid'; // Show the grid if the user has interacted

        const myStatusRating = document.getElementById('myStatusRating');
        const myStatusWatched = document.getElementById('myStatusWatched');
        const myStatusOwned = document.getElementById('myStatusOwned');

        renderStars(myStatusRating, myInteraction.rating || 0);

        myStatusWatched.innerHTML = myInteraction.watched ? '<i class="icon icon-watched"></i>' : '<i class="icon icon-unwatched"></i>';
        myStatusWatched.classList.toggle('active', myInteraction.watched);

        myStatusOwned.innerHTML = '<i class="icon icon-dvds"></i>';
        myStatusOwned.classList.toggle('active', myInteraction.owned);
    }
}
async function loadCommentsWithUserData(interactions) {
    const commentsContainer = document.getElementById('commentsContainer');
    commentsContainer.innerHTML = '';

    const commentsWithReviews = interactions.filter(i => i.review && i.review.trim() !== '');
    
    if (commentsWithReviews.length === 0) {
        commentsContainer.innerHTML = `<p class="review-text-empty">No comments yet. Be the first to leave one!</p>`;
        return;
    }

    const userIds = [...new Set(commentsWithReviews.map(c => c.userId))];
    const userPromises = userIds.map(id => db.collection('users').doc(id).get());
    const userDocs = await Promise.all(userPromises);
    
    const userMap = new Map();
    userDocs.forEach(doc => {
        if(doc.exists) userMap.set(doc.id, doc.data().displayName || 'Anonymous');
    });

    commentsWithReviews.forEach(comment => {
        const username = userMap.get(comment.userId) || 'Anonymous';
        const commentEl = document.createElement('div');
        commentEl.className = 'comment-item';
        commentEl.innerHTML = `
            <p class="review-text">${comment.review}</p>
            <p class="comment-author">by <a href="profile.html?id=${comment.userId}">${username}</a></p>
        `;
        commentsContainer.appendChild(commentEl);
    });
}
function renderStars(container, rating) {
    if (!container) return;
    container.innerHTML = '';
    if (typeof rating !== 'number' || rating <= 0) {
        container.innerHTML = `<span class="not-rated">Not Rated</span>`;
        return;
    }
    let starsHTML = '';
    for (let i = 1; i <= 5; i++) {
        if (i <= rating) starsHTML += `<span class="star star-full"></span>`;
        else if (i - 0.5 <= rating) starsHTML += `<span class="star star-half"></span>`;
        else starsHTML += `<span class="star star-empty"></span>`;
    }
    container.innerHTML = starsHTML;
}
//Enhanced physical copies display with quantities (for movie-details.html)
async function loadPhysicalCopies(interactions, currentUser, isAdmin) {
    const container = document.getElementById('physicalCopiesContainer');
    container.innerHTML = '';
    // Logic for the "Add Copy" button
    const addCopyBtn = document.getElementById('addCopyBtn');
    if (currentUser) {
        const movieId = new URLSearchParams(window.location.search).get('id');
        addCopyBtn.href = `edit-movie.html?id=${movieId}&mode=addCopy`;
        addCopyBtn.style.display = 'inline-flex';
    }

    //Support both old and new data structures
    const physicalCopies = interactions.filter(i => {
        return i.owned === true && (
            (i.physicalCopies && i.physicalCopies.length > 0) || // New format
            (i.physicalEdition && Object.keys(i.physicalEdition).length > 0) || // Old format
            i.upc // Very old format
        );
    });

    if (physicalCopies.length === 0) {
        container.innerHTML = `<p class="no-physical-copies">No physical copies have been tracked by users yet.</p>`;
        return;
    }

    // Handle new format (physicalCopies arrays)
    const newFormatCopies = physicalCopies.filter(i => i.physicalCopies && i.physicalCopies.length > 0);
    if (newFormatCopies.length > 0) {
        // Get all unique physical copy IDs
        const allPhysicalCopyIds = [];
        newFormatCopies.forEach(copy => {
            if (copy.physicalCopies) {
                allPhysicalCopyIds.push(...copy.physicalCopies);
            }
        });

        // Fetch physical copy details
        const uniqueCopyIds = [...new Set(allPhysicalCopyIds)];
        const copyPromises = uniqueCopyIds.map(id => 
            db.collection('physicalCopies').doc(id).get()
        );
        const copyDocs = await Promise.all(copyPromises);
        
        const copyMap = new Map();
        copyDocs.forEach(doc => {
            if (doc.exists) {
                copyMap.set(doc.id, doc.data());
            }
        });

        // Get user data
        const userIds = [...new Set(newFormatCopies.map(c => c.userId))];
        const userPromises = userIds.map(id => db.collection('users').doc(id).get());
        const userDocs = await Promise.all(userPromises);
        
        const userMap = new Map();
        userDocs.forEach(doc => {
            if(doc.exists) userMap.set(doc.id, doc.data().displayName || 'Anonymous');
        });

        // Group copies by user and copy type
        const copyGroups = new Map(); // userId -> copyId -> count
        
        newFormatCopies.forEach(userCopy => {
            const userId = userCopy.userId;
            if (!copyGroups.has(userId)) {
                copyGroups.set(userId, new Map());
            }
            
            const userCopyGroups = copyGroups.get(userId);
            
            userCopy.physicalCopies.forEach(copyId => {
                const currentCount = userCopyGroups.get(copyId) || 0;
                userCopyGroups.set(copyId, currentCount + 1);
            });
        });

    // NOW display grouped copies with edit/delete buttons
    copyGroups.forEach((userCopies, userId) => {
        const username = userMap.get(userId) || 'Anonymous';
        const currentUser = auth.currentUser;
        const canModify = (currentUser && currentUser.uid === userId) || isAdmin;

        userCopies.forEach((count, copyId) => {
            const copyData = copyMap.get(copyId);
            if (!copyData) return;
            
            const copyEl = document.createElement('div');
            copyEl.className = 'physical-copy-item';
            
            let copyInfo = '';
            const details = [];
            
            if (copyData.format && copyData.format !== 'Unknown') {
                details.push(`<span class="copy-format">${copyData.format}</span>`);
            }
            if (copyData.edition && copyData.edition !== 'Standard') {
                details.push(`<span class="copy-edition">${copyData.edition}</span>`);
            }
            
            copyInfo = details.length > 0 ? details.join(' • ') : 'Physical Copy';
            
            // Add quantity indicator if more than 1
            if (count > 1) {
                copyInfo += ` <span class="copy-quantity">(${count})</span>`;
            }
            
            // Add special features if available
            if (copyData.features && copyData.features.length > 0) {
                const featuresText = Array.isArray(copyData.features) 
                    ? copyData.features.join(', ') 
                    : copyData.features;
                copyInfo += `<div class="copy-features"><small>Features: ${featuresText}</small></div>`;
            }
            
            // Add barcode if available
            if (copyData.barcode) {
                copyInfo += `<div class="copy-barcode"><small>UPC: ${copyData.barcode}</small></div>`;
            }
            
            // Add edit/delete buttons only for current user's copies
            const actionButtons = canModify ? `
                <div class="copy-actions">
                    <button onclick="editPhysicalCopy('${copyId}', '${copyData.movieId || movieId}')" 
                            class="btn btn-md btn-primary" title="Edit">
                        <i class="icon icon-edit"></i>
                    </button>
                    <button onclick="deletePhysicalCopy('${copyId}', '${copyData.movieId || movieId}')" 
                            class="btn btn-md btn-danger" title="Delete">
                        <i class="icon icon-delete"></i>
                    </button>
                </div>
            ` : '';
            
            copyEl.innerHTML = `
                <div class="copy-details-wrapper">
                    <div class="copy-edition-details">${copyInfo}</div>
                    <div class="copy-owner">by <a href="profile.html?id=${userId}">${username}</a></div>
                </div>
                ${actionButtons}
            `;
            container.appendChild(copyEl);
        });
    });
    }
        
        // Handle old format (physicalEdition objects)
        const oldFormatCopies = physicalCopies.filter(i => 
            !i.physicalCopies && i.physicalEdition && Object.keys(i.physicalEdition).length > 0
        );

        if (oldFormatCopies.length > 0) {
            // Get user data for old format
            const userIds = [...new Set(oldFormatCopies.map(c => c.userId))];
            const userPromises = userIds.map(id => db.collection('users').doc(id).get());
            const userDocs = await Promise.all(userPromises);
            
            const userMap = new Map();
            userDocs.forEach(doc => {
                if(doc.exists) userMap.set(doc.id, doc.data().displayName || 'Anonymous');
            });

            oldFormatCopies.forEach(userCopy => {
                const username = userMap.get(userCopy.userId) || 'Anonymous';
                const edition = userCopy.physicalEdition;
                
                const copyEl = document.createElement('div');
                copyEl.className = 'physical-copy-item';
                
                let copyInfo = '';
                const details = [];
                
                if (edition.format) details.push(`<span class="copy-format">${edition.format}</span>`);
                if (edition.edition && edition.edition !== 'Standard') details.push(`<span class="copy-edition">${edition.edition}</span>`);
                if (edition.region) details.push(`<span class="copy-region">${edition.region}</span>`);
                
                copyInfo = details.length > 0 ? details.join(' • ') : 'Physical Copy (Legacy)';
                
                // Check for permission to modify
                const canModify = (currentUser && currentUser.uid === userCopy.userId) || isAdmin;

                const actionButtons = canModify ? `
                    <div class="copy-actions">
                        <button onclick="editAndMigrateLegacyCopy('${userCopy.movieId}')"
                                class="btn btn-md btn-primary" title="Edit Legacy Copy">
                            <i class="icon icon-edit"></i>
                        </button>
                        <button onclick="deleteLegacyCopy('${userCopy.movieId}')" 
                                class="btn btn-md btn-danger" title="Delete Legacy Data">
                            <i class="icon icon-delete"></i>
                        </button>
                    </div>
                ` : '';

                copyEl.innerHTML = `
                    <div class="copy-details-wrapper">
                        <div class="copy-edition-details">${copyInfo}</div>
                        <div class="copy-owner">by <a href="profile.html?id=${userCopy.userId}">${username}</a></div>
                    </div>
                    ${actionButtons}
                `;
                container.appendChild(copyEl);
            });
        }
}   
function editPhysicalCopy(copyId, movieId) {
    // Redirect to edit-movie page with a special parameter to focus on physical copy editing
    window.location.href = `edit-movie.html?id=${movieId}&editCopy=${copyId}`; 
}
function setupCommentForm(user, movieId, myInteraction) {
    // --- Get DOM Elements ---
    const myStatusDisplay = document.getElementById('myStatusDisplay'); 
    const toggleBtn = document.getElementById('toggleCommentEditBtn');
    const commentForm = document.getElementById('commentEditForm');
    const commentsContainer = document.getElementById('commentsContainer');
    const saveBtn = document.getElementById('saveCommentBtn');
    const cancelBtn = document.getElementById('cancelCommentBtn');
    const textarea = document.getElementById('comment-textarea');
    const commentBtnText = document.getElementById('commentBtnText');
    const starRatingContainer = document.getElementById('comment-star-rating');
    const watchedToggle = document.getElementById('watched-toggle');
    const ownedToggle = document.getElementById('owned-toggle'); 
    const watchedDateGroup = document.getElementById('watched-date-group');
    const watchedDateInput = document.getElementById('watched-date');

    if (!user) {
        toggleBtn.style.display = 'none';
        return;
    }
    
    toggleBtn.style.display = 'inline-flex';
    commentBtnText.textContent = (myInteraction && myInteraction.review) ? 'edit comments' : 'add comments';

    // --- Event Listeners ---
    toggleBtn.onclick = () => {
        commentForm.style.display = 'block';
        commentsContainer.style.display = 'none';
        myStatusDisplay.style.display = 'none'; 
        toggleBtn.style.display = 'none';

        // Populate form with existing data from myInteraction
        const initialRating = myInteraction?.rating || 0;
        const isWatched = myInteraction?.watched || false;
        
        textarea.value = myInteraction?.review || '';
        watchedToggle.dataset.active = isWatched;
        ownedToggle.dataset.active = myInteraction?.owned || false; 
        watchedDateGroup.style.display = isWatched ? 'block' : 'none';
        watchedDateInput.value = myInteraction?.watchedDate || '';
        
        // Initialize interactive stars
        if (window.LibraryUtils && window.LibraryUtils.stars) {
            commentStarRatingController = window.LibraryUtils.stars.setupInteractiveStarRating('comment-star-rating', () => {}, initialRating);
        }
    };

    cancelBtn.onclick = () => {
        commentForm.style.display = 'none';
        commentsContainer.style.display = 'block';
        if (myInteraction) myStatusDisplay.style.display = 'grid'; 
        toggleBtn.style.display = 'inline-flex';
    };

    watchedToggle.addEventListener('click', () => {
        const isActive = watchedToggle.dataset.active === 'true';
        watchedToggle.dataset.active = !isActive;
        watchedDateGroup.style.display = !isActive ? 'block' : 'none';
    });

    ownedToggle.addEventListener('click', () => {
        const isCurrentlyOwned = myInteraction?.owned || false;
        
        if (isCurrentlyOwned) {
            UIUtils.showStatusMessage("Manage your copies in the section below.", "info");
            return;
        }

            // Use ModalManager for a better UX
            ModalManager.show({
                title: 'add physical copy?',
                content: 'do you want to add a physical copy of this movie to your collection?',
                buttons: [
                    {
                        text: 'Cancel',
                        class: 'btn-secondary',
                        onClick: () => {
                            // The modal will close automatically. No action needed.
                        }

                    },
                    {
                        text: 'Yes, Add Copy',
                        class: 'btn-primary',
                        onClick: () => {
                            // Redirect to the edit page in 'addCopy' mode.
                            window.location.href = `edit-movie.html?id=${movieId}&mode=addCopy`;
                        }
                    }
                ]
            });
        });

    saveBtn.onclick = async () => {
        UIUtils.setButtonLoading(saveBtn.id, '...');
        try {
            // Gather all data from the form
            const newRating = commentStarRatingController ? commentStarRatingController.getRating() : (myInteraction?.rating || 0);
            const newReview = textarea.value.trim();
            const newWatchedStatus = watchedToggle.dataset.active === 'true';
            const newWatchedDate = watchedDateInput.value || null;

            const interactionData = {
                ...(myInteraction || {}),
                rating: newRating,
                review: newReview,
                watched: newWatchedStatus,
                watchedDate: newWatchedStatus ? newWatchedDate : null, // Only save date if watched
                movieId: movieId,
                userId: user.uid,
                interactionDate: firebase.firestore.FieldValue.serverTimestamp(),
            };

            await db.collection('users').doc(user.uid).collection('movieInteractions').doc(movieId).set(interactionData, { merge: true });

            UIUtils.showStatusMessage('Your review has been saved!', 'success');
            setTimeout(() => window.location.reload(), 1500);

        } catch (error) {
            console.error('Error saving comment:', error);
            UIUtils.showStatusMessage('Failed to save review.', 'error');
        } finally {
            UIUtils.resetButton(saveBtn.id);
        }
    };
}
async function deletePhysicalCopy(copyId, movieId) {
    ModalManager.show({
        title: 'delete physical copy?',
        content: 'are you sure you want to delete this specific physical copy from your collection?',
        buttons: [
            { text: '<span class="icon icon-close"></span> cancel', 
            class: 'btn-rectangular' },
            {
                text: '<span class="icon icon-trash"></span> trash',
                class: 'btn-danger btn-rectangular',
                onClick: async () => {
                    const user = auth.currentUser;
                    if (!user) {
                        alert('You must be logged in to delete copies');
                        return;
                    }
                    
                    try {
                        // Delete the physical copy document
                        await db.collection('physicalCopies').doc(copyId).delete();
                        
                        // Remove reference from user's interaction
                        const interactionRef = db.collection('users').doc(user.uid)
                            .collection('movieInteractions').doc(movieId);
                        const interactionDoc = await interactionRef.get();
                        
                        if (interactionDoc.exists) {
                            const data = interactionDoc.data();
                            const updatedCopies = (data.physicalCopies || []).filter(id => id !== copyId);
                            
                            await interactionRef.update({
                                physicalCopies: updatedCopies,
                                owned: updatedCopies.length > 0 // Set owned to false if no copies left
                            });
                        }
                        // Reload the page to show updated list
                        window.location.reload();
                    } catch (error) {
                        console.error('Error deleting physical copy:', error);
                        alert('Failed to delete copy. Please try again.');
                    }
                }
            }
        ]
    });
}
// Add this new function to your script
async function editAndMigrateLegacyCopy(movieId) {
    const user = auth.currentUser;
    if (!user) return;

    try {
        const interactionRef = db.collection('users').doc(user.uid).collection('movieInteractions').doc(movieId);
        const interactionDoc = await interactionRef.get();

        if (!interactionDoc.exists || !interactionDoc.data().physicalEdition) {
            throw new Error('Legacy data not found.');
        }

        const legacyData = interactionDoc.data().physicalEdition;
        const upc = interactionDoc.data().upc || '';

        // 1. Create a new physical copy document from the legacy data
        const newCopyRef = await db.collection('physicalCopies').add({
            format: legacyData.format || '',
            edition: legacyData.edition || '',
            region: legacyData.region || '',
            distributor: legacyData.distributor || '',
            barcode: upc,
            features: legacyData.features || [],
            movieId: movieId,
            userId: user.uid,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        // 2. Update the interaction document: remove old fields and add a reference to the new one
        await interactionRef.update({
            physicalEdition: firebase.firestore.FieldValue.delete(),
            upc: firebase.firestore.FieldValue.delete(),
            editionTitle: firebase.firestore.FieldValue.delete(),
            physicalCopies: firebase.firestore.FieldValue.arrayUnion(newCopyRef.id)
        });
        
        // 3. Redirect to the edit page for the newly created copy
        window.location.href = `edit-movie.html?id=${movieId}&editCopy=${newCopyRef.id}&from=details`;

    } catch (error) {
        console.error("Error migrating legacy copy:", error);
        UIUtils.showStatusMessage('Could not upgrade legacy data.', 'error');
    }
}

// Add this new function inside the <script> tag
async function setupFactualDetailsEditButton(user, movieData) {
    const editDetailsBtn = document.getElementById('editDetailsBtn');
    if (!user || !movieData) {
        editDetailsBtn.style.display = 'none';
        return;
    }

    try {
        const adminDoc = await db.collection('admins').doc(user.uid).get();
        const isOriginalUploader = movieData.originalUploaderId === user.uid;
        const isAdmin = adminDoc.exists && adminDoc.data().isActive === true;

        if (isOriginalUploader || isAdmin) {
            editDetailsBtn.href = `edit-movie.html?id=${movieData.id}&mode=details`;
            editDetailsBtn.style.display = 'inline-flex';
        } else {
            editDetailsBtn.style.display = 'none';
        }
    } catch (error) {
        console.error("Permission check failed:", error);
        editDetailsBtn.style.display = 'none';
    }
}
document.addEventListener('authStateReady', (e) => {
    const user = e.detail.user;
    const movieId = new URLSearchParams(window.location.search).get('id');

    if (user && movieId) {
        // If user is logged in AND there's a movie ID, load the page.
        loadMoviePage(user, movieId);
    } else if (!user) {
        // If user is NOT logged in, redirect them to the auth page.
        window.location.href = 'auth.html';
    } else {
        // Handle the case where there's no movie ID.
        const container = document.getElementById('detailsContainer');
        container.innerHTML = `<div class="error-state"><h3>Error</h3><p>No movie ID was provided.</p></div>`;
        container.style.display = 'block';
        document.getElementById('loadingState').style.display = 'none';
    }
});

document.addEventListener('DOMContentLoaded', () => {
    // This listener now only handles page-specific UI like the back button.
    updateBackButton();
});
function goBack() {
    const urlParams = new URLSearchParams(window.location.search);
    const fromParam = urlParams.get('from');
    
    switch(fromParam) {
        case 'library':
        case 'home':
            window.location.href = 'index.html';
            break;
        case 'profile':
            const profileId = urlParams.get('profileId');
            window.location.href = profileId ? `profile.html?id=${profileId}` : 'profile.html';
            break;
        case 'review':
            window.location.href = 'review-failed.html';
            break;
        case 'bulk':
            window.location.href = 'bulk-scan.html';
            break;
        case 'search':
            // Try browser back first for search results
            if (window.history.length > 1) {
                window.history.back();
            } else {
                window.location.href = 'index.html';
            }
            break;
        default:
            // Default fallback to library
            window.location.href = 'index.html';
    }
}
function updateBackButton() {
    const urlParams = new URLSearchParams(window.location.search);
    const fromParam = urlParams.get('from');
    const backBtnText = document.getElementById('backBtnText');
    const backBtn = document.getElementById('smartBackBtn');
    
    if (!backBtnText || !backBtn) return;
    
    switch(fromParam) {
        case 'library':
        case 'home':
            backBtnText.textContent = 'Back to Library';
            backBtn.title = 'Back to Library';
            break;
        case 'profile':
            backBtnText.textContent = 'Back to Profile';
            backBtn.title = 'Back to Profile';
            break;
        case 'review':
            backBtnText.textContent = 'Back to Review';
            backBtn.title = 'Back to Review';
            break;
        case 'bulk':
            backBtnText.textContent = 'Back to Bulk Scan';
            backBtn.title = 'Back to Bulk Scan';
            break;
        case 'search':
            backBtnText.textContent = 'Back to Results';
            backBtn.title = 'Back to Search Results';
            break;
        default:
            backBtnText.textContent = 'Back to Library';
            backBtn.title = 'Back to Library';
    }
}
</script>
</div>
<div id="footer-placeholder"></div>
</body>
</html>
