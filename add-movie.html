<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Media - the library sale</title>
    <!-- Google Fonts Import -->
     <link rel="preconnect" href="https://fonts.googleapis.com">
     <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
     <link href="https://fonts.googleapis.com/css2?family=B612+Mono&family=Dokdo&family=Kirang+Haerang&family=M+PLUS+2&family=Syne+Mono&display=swap" rel="stylesheet">
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-auth-compat.js"></script>
    <!-- ZXing Barcode Scanner Library -->
    <script type="text/javascript" src="https://unpkg.com/@zxing/library@0.20.0/umd/index.min.js"></script>
    <!-- App Utilities -->
    <script src="utils.js"></script>
    <script src="cache.js"></script>
    <link rel="stylesheet" href="style.css">
    <script src="main.js" defer></script>
</head>
<body>
    <div>
        <header id="navbar-placeholder"></header>
    </div>

    <div class="container">
        <h1 id="formTitle">Add New Media</h1>
        
        <div class="search-section">
            <div class="search-controls">
                <input type="text" id="movieSearch" placeholder="Type title, actor, director...">
                <button type="button" id="searchBtn" class="btn-icon" title="Search"></button>
                <div class="loading-spinner" id="searchSpinner"></div>
                <button type="button" id="cameraBtn" class="btn">Scan Barcode</button>
                <button type="button" id="manualBarcodeBtn" class="btn">Enter Barcode</button>
            </div>
            
            <div id="manualBarcodeInput" style="display: none; margin-bottom: 15px;">
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="text" id="barcodeInput" placeholder="Enter 8-18 digit barcode" pattern="[0-9]{8,18}" maxlength="18">
                    <button type="button" id="lookupBarcodeBtn" class="btn">Lookup</button>
                    <button type="button" id="cancelBarcodeBtn" class="btn" style="background: #6c757d;">Cancel</button>
                    <div class="loading-spinner" id="barcodeSpinner"></div>
                </div>
                <small style="color: #666; display: block; margin-top: 5px;">UPC/EAN barcodes are typically 12-13 digits</small>
            </div>
            
            <div class="scanner-container" id="scannerContainer" style="display: none;">
                <div class="scanner-overlay">
                    <video id="video" autoplay muted style="width: 100%; max-width: 400px; height: 300px; border: 2px solid #007bff; border-radius: 5px; background: #000;"></video>
                </div>
                <p style="margin: 10px 0; color: #666;">Position barcode in camera view</p>
                <button type="button" id="stopScanBtn" class="btn">Stop Camera</button>
            </div>
            
            <div id="statusMessage"></div>
            <div id="searchResults"></div>
            <div id="searchFooter" class="search-footer" style="display: none;">
                <span id="resultCount"></span>
                <button id="loadMoreBtn" class="btn btn-load-more">Load More</button>
            </div>
        </div>
        
        <hr>
        
        <h3>Media Details</h3>
        <form id="movieForm">
            <input type="hidden" id="editionDetailsInput">

            <div class="form-row">
                <div class="form-group">
                    <label for="title">Title *</label>
                    <input type="text" id="title" required readonly>
                </div>
                <div class="form-group">
                    <label for="year">Year</label>
                    <input type="number" id="year" min="1900" max="2030" readonly>
                </div>
            </div>
            
             <div class="form-row">
                <div class="form-group">
                    <label for="director">Director</label>
                    <input type="text" id="director" readonly>
                </div>
                <div class="form-group">
                    <label for="genre">Genre</label>
                    <input type="text" id="genre" readonly>
                </div>
            </div>

            <div class="form-group">
                <label for="summary">Summary</label>
                <textarea id="summary" rows="6" placeholder="Media summary from TMDb" readonly></textarea>
            </div>
            
            <div class="form-group">
                <label for="cast">Cast</label>
                <input type="text" id="cast" placeholder="e.g., Leonardo DiCaprio, Joseph Gordon-Levitt" readonly>
            </div>

            <div class="form-group">
                <label for="contentType">Content Type *</label>
                <select id="contentType" required>
                    <option value="movie">Movie</option>
                    <option value="tv">TV Show</option>
                </select>
            </div>
            
            <hr>

            <h3 class="heading-with-icon">
                <span class="icon icon-comment"></span>Comments
            </h3>

            <div class="rating-and-status-container">
                <div class="form-group">
                    <div class="star-rating" id="starRating">
                        <span class="star"></span>
                        <span class="star"></span>
                        <span class="star"></span>
                        <span class="star"></span>
                        <span class="star"></span>
                    </div>
                </div>

                <div class="form-group">
                    <label>Watched?</label>
                    <div class="toggle-group">
                        <button type="button" id="watchedToggle" class="toggle-btn watched-toggle" data-watched="false" title="Toggle Watched Status"></button>
                    </div>
                </div>

                <div class="form-group" id="watchedDateGroup" style="display: none;">
                    <label for="watchedDate">Watched Date</label>
                    <input type="date" id="watchedDate">
                </div>

                <div class="form-group">
                    <label>Owned?</label>
                    <div class="toggle-group">
                        <button type="button" id="ownedToggle" class="toggle-btn owned-toggle" data-owned="false" title="Toggle Owned Status"></button>
                    </div>
                </div>
            </div>
            
            <div class="form-group" id="editionDetailsGroup" style="display: none;">
                <label for="editionDetails">Edition Details (e.g., Collector's Edition, Blu-ray)</label>
                <input type="text" id="editionDetails" placeholder="Details from the box">
            </div>

            <div class="form-group">
                <textarea id="review" rows="4" placeholder="What did you think of this media?"></textarea>
            </div>
            
            <button type="submit" class="btn-icon btn-submit" id="submitBtn" title="Add Media"></button>
        </form>
    </div>

    <div id="alertModal" class="modal">
        <div class="modal-content">
            <button class="modal-close-btn" id="alertModalClose" title="Close"></button>
            <h3 id="alertModalTitle">Alert</h3>
            <p id="alertModalMessage">Something happened.</p>
            <div class="modal-buttons">
                <button class="modal-btn ok" id="alertModalOk" title="OK"></button>
            </div>
        </div>
    </div>

    <script>
        let currentRating = 0;
        let editingMovieId = null; 
        let currentUser = null; 
        let isPublicFieldsEditable = true;
        let codeReader = null;
        let videoInputDevices = [];
        let starRatingController = null;
        
        let currentSearchQuery = '';
        let currentPage = 1;
        let totalPages = 1;
        let totalResults = 0;
        let isLoadingMore = false;
        
        const apiCache = new CacheManager('tmdb_api_cache_', 50, 24);

        const TMDB_BASE_URL = '/api/tmdb';
        const UPC_BASE_URL = '/api/upc';
        const TMDB_IMAGE_BASE = 'https://image.tmdb.org/t/p/w500';

        const firebaseConfig = {
          apiKey: "AIzaSyDDW8LtwpYevdkD7Q-_CxJ23mMfi00P21M",
          authDomain: "tiny-lizard.firebaseapp.com",
          projectId: "tiny-lizard",
          storageBucket: "tiny-lizard.firebasestorage.app",
          messagingSenderId: "250872474692",
          appId: "1:250872474692:web:969e0b1302ae3cb4666011",
        };
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore(); 
        const auth = firebase.auth(); 

        document.addEventListener('DOMContentLoaded', () => {
            auth.onAuthStateChanged(user => {
                if (user) {
                    currentUser = user;
                    initializePage();
                } else {
                    window.location.href = 'auth.html'; 
                }
            });
            // Auth button logic is handled by main.js
        });

        async function handleAuthButtonClick() {
            if (currentUser) {
                await auth.signOut();
                window.location.href = 'auth.html';
            } else {
                window.location.href = 'auth.html';
            }
        }

        function initializePage() {
            setupForm();
            setupSearch();
            setupToggles();
            setupStarRating();
            setupBarcodeScanner();
            checkEditMode();
            
            const urlParams = new URLSearchParams(window.location.search);
            const queryFromUrl = urlParams.get('query');
            const pageFromUrl = parseInt(urlParams.get('page')) || 1;
            if (queryFromUrl) {
                document.getElementById('movieSearch').value = queryFromUrl;
                performSearch(queryFromUrl, pageFromUrl);
            }
        }

        function setupToggles() {
            const watchedToggle = document.getElementById('watchedToggle');
            const watchedDateGroup = document.getElementById('watchedDateGroup');
            watchedToggle.addEventListener('click', () => {
                const isWatched = watchedToggle.dataset.watched === 'false';
                watchedToggle.dataset.watched = isWatched;
                watchedDateGroup.style.display = isWatched ? 'flex' : 'none';
            });

            const ownedToggle = document.getElementById('ownedToggle');
            const editionDetailsGroup = document.getElementById('editionDetailsGroup');
            ownedToggle.addEventListener('click', () => {
                const isOwned = ownedToggle.dataset.owned === 'false';
                ownedToggle.dataset.owned = isOwned;
                editionDetailsGroup.style.display = isOwned ? 'block' : 'none';
            });
        }

        function setupForm() {
            const form = document.getElementById('movieForm');
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                if (editingMovieId) updateMedia(); else addMedia();
            });
        }
        
         // FIXED addMedia() function - add this to your add-movie.html
        async function addMedia() {
            const submitBtn = document.getElementById('submitBtn');
            LibraryUtils.ui.setButtonLoading(submitBtn);

        try {
            const titleValue = LibraryUtils.validation.sanitizeInput(document.getElementById('title').value);
            if (!titleValue) throw new Error('Title is a required field.');
        
            const yearValue = document.getElementById('year').value;
            if (yearValue && !LibraryUtils.validation.isValidYear(yearValue)) throw new Error('Please enter a valid year.');
        
            const rating = starRatingController ? starRatingController.getRating() : currentRating;
            if (!LibraryUtils.validation.isValidRating(rating)) throw new Error('Invalid rating value.');
        
            const tmdbId = document.getElementById('movieForm').dataset.tmdbId;
            let movieDocRef, mainMediaData;

            if (tmdbId) {
                const existingQuery = await db.collection('movies').where('tmdbId', '==', parseInt(tmdbId)).limit(1).get();
                if (!existingQuery.empty) {
                movieDocRef = existingQuery.docs[0].ref;
                mainMediaData = existingQuery.docs[0].data();
                }
            }
        
            if (!movieDocRef) {
                mainMediaData = {
                    title: titleValue, 
                    year: yearValue ? parseInt(yearValue) : null, 
                    director: LibraryUtils.validation.sanitizeInput(document.getElementById('director').value),
                    genre: LibraryUtils.validation.sanitizeInput(document.getElementById('genre').value), 
                    posterUrl: document.getElementById('movieForm').dataset.posterUrl || null,
                    runtime: document.getElementById('movieForm').dataset.runtime || null, 
                    tmdbId: tmdbId ? parseInt(tmdbId) : null,
                    overview: LibraryUtils.validation.sanitizeInput(document.getElementById('summary').value, 1000), 
                    cast: document.getElementById('cast').value.split(',').map(c => LibraryUtils.validation.sanitizeInput(c)),
                    contentType: document.getElementById('contentType').value, 
                    dateAdded: firebase.firestore.FieldValue.serverTimestamp(),
                    originalUploaderId: currentUser.uid, 
                    originalUploaderDisplayName: currentUser.displayName || currentUser.email, 
                    isManualEntry: isPublicFieldsEditable
                };
                movieDocRef = await db.collection('movies').add(mainMediaData);
            }

        // ✅ FIXED: Added movieId field to the interaction data
            const userInteractionData = {
                movieId: movieDocRef.id,  // ← ADD THIS LINE
                rating: rating, 
                review: LibraryUtils.validation.sanitizeInput(document.getElementById('review').value, 1000),
                watched: document.getElementById('watchedToggle').dataset.watched === 'true',
                watchedDate: document.getElementById('watchedDate').value || null,
                owned: document.getElementById('ownedToggle').dataset.owned === 'true',
                interactionDate: firebase.firestore.FieldValue.serverTimestamp()
            };
            await db.collection('users').doc(currentUser.uid).collection('movieInteractions').doc(movieDocRef.id).set(userInteractionData);
        
            showTimedRedirectModal('Success!', 'Media added to your library.', 'index.html', 3, movieDocRef.id);

        } catch (error) {
            LibraryUtils.errors.handleError(error, 'Adding Media');
        } finally {
            LibraryUtils.ui.resetButton(submitBtn);
        }
    }
        async function updateMedia() {
            const submitBtn = document.getElementById('submitBtn');
            LibraryUtils.ui.setButtonLoading(submitBtn);

            try {
                const rating = starRatingController ? starRatingController.getRating() : currentRating;
                if (!LibraryUtils.validation.isValidRating(rating)) throw new Error('Invalid rating value.');
                
                // ✅ FIXED: Added movieId field to the interaction data
                const userInteractionData = {
                    movieId: editingMovieId,  // ← ADD THIS LINE
                    rating: rating, 
                    review: LibraryUtils.validation.sanitizeInput(document.getElementById('review').value, 1000),
                    watched: document.getElementById('watchedToggle').dataset.watched === 'true',
                    watchedDate: document.getElementById('watchedDate').value || null,
                    owned: document.getElementById('ownedToggle').dataset.owned === 'true',
                    interactionDate: firebase.firestore.FieldValue.serverTimestamp()
                };
                await db.collection('users').doc(currentUser.uid).collection('movieInteractions').doc(editingMovieId).set(userInteractionData, { merge: true });

                showTimedRedirectModal('Success!', 'Your details have been updated.', 'index.html', 3, editingMovieId);

            } catch (error) {
                LibraryUtils.errors.handleError(error, 'Updating Media');
            } finally {
                LibraryUtils.ui.resetButton(submitBtn);
            }
        }
        // Replace your lookupMovieByBarcode function with this version that uses skeleton loading
        async function lookupMovieByBarcode(barcode) {
            if (!LibraryUtils.validation.isValidBarcode(barcode)) {
                showStatusMessage('Invalid barcode format.', 'error');
                return;
            }

            // Show skeleton loading in the form instead of spinner/text
            showBarcodeLoadingSkeleton();

            try {
                // Step 1: Lookup the barcode to get product info
                const upcResponse = await fetch(`${UPC_BASE_URL}?upc=${barcode}`);
                const upcData = await upcResponse.json();

                if (!upcResponse.ok || !upcData.items || upcData.items.length === 0) {
                    throw new Error('Product not found for this barcode.');
                }

                const product = upcData.items[0];
                const productTitle = extractMovieTitle(product.title);

                // Update skeleton to show we're searching for movie details
                updateBarcodeLoadingSkeleton('Searching movie database...');

                // Step 2: Search TMDb for the extracted title
                const searchResponse = await fetch(`${TMDB_BASE_URL}/search/multi?query=${encodeURIComponent(productTitle)}`);
                const searchData = await searchResponse.json();

                if (!searchResponse.ok || !searchData.results || searchData.results.length === 0) {
                    throw new Error(`No movie/TV show found for "${productTitle}".`);
                }

                // Find the best match (movie or TV show)
                const bestMatch = searchData.results.find(item => 
                    (item.media_type === 'movie' || item.media_type === 'tv') &&
                    (item.title || item.name)
                );

                if (!bestMatch) {
                    throw new Error(`No suitable movie/TV match found for "${productTitle}".`);
                }

                // Step 3: Get detailed info for the best match
                const detailsResponse = await fetch(`${TMDB_BASE_URL}/${bestMatch.media_type}/${bestMatch.id}?append_to_response=credits`);
                const detailsData = await detailsResponse.json();

                if (!detailsResponse.ok) {
                    throw new Error('Failed to fetch detailed movie information.');
                }

                // Step 4: Hide skeleton and populate the form with the movie data
                hideBarcodeLoadingSkeleton();
                populateFormWithData(detailsData);
                
                // Step 5: Store edition details from barcode lookup
                document.getElementById('editionDetails').value = product.title || '';
                document.getElementById('editionDetailsInput').value = product.title || '';
                
                // Step 6: Auto-set as owned since they scanned a physical copy
                document.getElementById('ownedToggle').dataset.owned = 'true';
                document.getElementById('editionDetailsGroup').style.display = 'block';

                // Show success message briefly
                showStatusMessage(`Found: ${detailsData.title || detailsData.name}`, 'success');
                setTimeout(() => {
                    document.getElementById('statusMessage').innerHTML = '';
                }, 3000);

            } catch (error) {
                console.error('Barcode lookup error:', error);
                hideBarcodeLoadingSkeleton();
                showStatusMessage(error.message || 'Barcode lookup failed.', 'error');
            }
        }
            // New functions to handle skeleton loading UI
            function showBarcodeLoadingSkeleton() {
                // Clear any existing status messages
                document.getElementById('statusMessage').innerHTML = '';
                
                // Show skeleton loading in the form fields
                const formFields = ['title', 'year', 'director', 'genre', 'summary', 'cast'];
                
                formFields.forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    if (field) {
                        field.classList.add('skeleton-loading');
                        field.value = '';
                        field.placeholder = '';
                    }
                });
                
                // Add a loading message with skeleton animation
                document.getElementById('statusMessage').innerHTML = `
                    <div class="barcode-loading-container">
                        <div class="barcode-loading-text">
                            <div class="skeleton skeleton-text-line"></div>
                            <div class="skeleton skeleton-text-line short"></div>
                        </div>
                        <div class="barcode-loading-message">Looking up product...</div>
                    </div>
                `;
            }
            function updateBarcodeLoadingSkeleton(message) {
                    const messageEl = document.querySelector('.barcode-loading-message');
                    if (messageEl) {
                        messageEl.textContent = message;
                    }
            }
            function hideBarcodeLoadingSkeleton() {
                // Remove skeleton loading from form fields
                const formFields = ['title', 'year', 'director', 'genre', 'summary', 'cast'];
                
                formFields.forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    if (field) {
                        field.classList.remove('skeleton-loading');
                    }
                });
                
                // Clear the loading message
                const loadingContainer = document.querySelector('.barcode-loading-container');
                if (loadingContainer) {
                    loadingContainer.remove();
                }
        }

        async function checkEditMode() {
            const urlParams = new URLSearchParams(window.location.search);
            editingMovieId = urlParams.get('edit');
            if (!editingMovieId) {
                togglePublicFieldsReadonly(false);
                return;
            }

            document.getElementById('formTitle').textContent = 'Edit My Details';
            document.getElementById('submitBtn').title = 'Update Details';

            try {
                const mediaDoc = await db.collection('movies').doc(editingMovieId).get();
                const interactionDoc = await db.collection('users').doc(currentUser.uid).collection('movieInteractions').doc(editingMovieId).get();
                if (!mediaDoc.exists) throw new Error('Media not found.');

                const mediaData = mediaDoc.data();
                document.getElementById('title').value = mediaData.title || ''; document.getElementById('year').value = mediaData.year || '';
                document.getElementById('director').value = mediaData.director || ''; document.getElementById('genre').value = mediaData.genre || '';
                document.getElementById('summary').value = mediaData.overview || ''; document.getElementById('cast').value = (mediaData.cast || []).join(', ');
                document.getElementById('contentType').value = mediaData.contentType || 'movie';
                togglePublicFieldsReadonly(true);

                if (interactionDoc.exists) {
                    const interactionData = interactionDoc.data();
                    currentRating = interactionData.rating || 0;
                    if (starRatingController) starRatingController.setRating(currentRating);
                    document.getElementById('review').value = interactionData.review || '';
                    
                    const watched = interactionData.watched || false;
                    const owned = interactionData.owned || false;

                    document.getElementById('watchedToggle').dataset.watched = watched;
                    document.getElementById('watchedDateGroup').style.display = watched ? 'flex' : 'none';
                    document.getElementById('watchedDate').value = interactionData.watchedDate || '';

                    document.getElementById('ownedToggle').dataset.owned = owned;
                    document.getElementById('editionDetailsGroup').style.display = owned ? 'block' : 'none';

                    if (owned) {
                        const myCopyQuery = await db.collection('movies').doc(editingMovieId).collection('physicalCopies').where('ownerId', '==', currentUser.uid).limit(1).get();
                        if (!myCopyQuery.empty) { document.getElementById('editionDetails').value = myCopyQuery.docs[0].data().editionDetails || ''; }
                    }
                }
            } catch (error) {
                LibraryUtils.errors.handleError(error, 'Loading edit data');
            }
        }
        
        function populateFormWithData(data) {
            document.getElementById('title').value = data.title || data.name;
            document.getElementById('year').value = (data.release_date || data.first_air_date || '').substring(0, 4);
            document.getElementById('summary').value = data.overview;
            document.getElementById('genre').value = data.genres.map(g => g.name).join(', ');
            document.getElementById('cast').value = data.credits.cast.slice(0, 5).map(c => c.name).join(', ');
            const director = data.credits.crew.find(c => c.job === 'Director');
            document.getElementById('director').value = director ? director.name : '';
            document.getElementById('contentType').value = data.media_type || (data.seasons ? 'tv' : 'movie');
            
            document.getElementById('movieForm').dataset.tmdbId = data.id;
            document.getElementById('movieForm').dataset.posterUrl = data.poster_path ? TMDB_IMAGE_BASE + data.poster_path : '';
            document.getElementById('movieForm').dataset.runtime = data.runtime || (data.episode_run_time ? data.episode_run_time[0] : null);

            togglePublicFieldsReadonly(true); isPublicFieldsEditable = false;
            showStatusMessage('Media details loaded successfully!', 'success');
        }

        function showTimedRedirectModal(title, message, redirectUrl, duration = 5, newlyAddedMovieId = null) {
            const modal = document.getElementById('alertModal');
            if (!modal) {
                alert(message);
                setTimeout(() => { window.location.href = redirectUrl; }, 100);
                return;
            }

            const titleEl = modal.querySelector('#alertModalTitle');
            const messageEl = modal.querySelector('#alertModalMessage');
            
            // Clone and replace buttons to ensure old event listeners are removed
            const okBtn = modal.querySelector('#alertModalOk');
            const newOkBtn = okBtn.cloneNode(true);
            okBtn.parentNode.replaceChild(newOkBtn, okBtn);
            newOkBtn.classList.remove('ok');
            newOkBtn.classList.add('confirm');
            newOkBtn.title = 'Go to Library';

            const closeBtn = modal.querySelector('#alertModalClose');
            const newCloseBtn = closeBtn.cloneNode(true);
            closeBtn.parentNode.replaceChild(newCloseBtn, closeBtn);
            newCloseBtn.title = 'Keep Editing';

            titleEl.textContent = title;
            newOkBtn.style.display = 'inline-flex';
            newCloseBtn.style.display = 'flex';

            let countdown = duration;
            messageEl.innerHTML = `${message}<br><br>Redirecting in ${countdown} seconds...`;
            modal.style.display = 'flex';

            const interval = setInterval(() => {
                countdown--;
                if (countdown > 0) {
                    messageEl.innerHTML = `${message}<br><br>Redirecting in ${countdown} seconds...`;
                } else {
                    clearInterval(interval);
                    window.location.href = redirectUrl;
                }
            }, 1000);

            const cleanup = () => {
                clearInterval(interval);
                modal.style.display = 'none';
                // Restore original button state for next use
                newOkBtn.classList.remove('confirm');
                newOkBtn.classList.add('ok');
                newOkBtn.title = 'OK';
            };
            
            newOkBtn.addEventListener('click', () => {
                cleanup();
                window.location.href = redirectUrl;
            }, { once: true });

            const closeAction = () => {
                cleanup();
                if (newlyAddedMovieId) {
                    // Navigate to the edit page for the movie just added/updated
                    window.location.href = `add-movie.html?edit=${newlyAddedMovieId}`;
                }
            };
            
            newCloseBtn.addEventListener('click', closeAction, { once: true });
        }


        function showAlertModal(title, message, onOk = () => {}) { 
            const modal = document.getElementById('alertModal');
            if (!modal) { alert(`${title}: ${message}`); onOk(); return; }

            modal.querySelector('#alertModalTitle').textContent = title;
            modal.querySelector('#alertModalMessage').textContent = message;
            
            const okBtn = modal.querySelector('#alertModalOk');
            const closeBtn = modal.querySelector('#alertModalClose');
            okBtn.style.display = 'inline-flex'; // Use flex for icon centering
            closeBtn.style.display = 'flex';

            const okHandler = () => { modal.style.display = 'none'; onOk(); okBtn.removeEventListener('click', okHandler); };
            const closeHandler = () => { modal.style.display = 'none'; onOk(); closeBtn.removeEventListener('click', closeHandler); };

            okBtn.addEventListener('click', okHandler, { once: true });
            closeBtn.addEventListener('click', closeHandler, { once: true });
            modal.style.display = 'flex';
        }

        // --- Other helper functions (unmodified) ---
        function setupStarRating() { starRatingController = LibraryUtils.stars.setupInteractiveStarRating('starRating', (rating) => { currentRating = rating; }, currentRating); }
        function togglePublicFieldsReadonly(isReadonly) { const fields = ['title', 'year', 'director', 'genre', 'summary', 'cast', 'contentType']; fields.forEach(id => { const el = document.getElementById(id); if (el.tagName === 'SELECT') el.disabled = isReadonly; else el.readOnly = isReadonly; }); }
        function showStatusMessage(message, type) { const statusDiv = document.getElementById('statusMessage'); statusDiv.innerHTML = `<div class="status-message status-${type}">${message}</div>`; }
        // Replace your existing extractMovieTitle function with this improved version
        function extractMovieTitle(productName) {
            if (!productName) return '';
            
            let title = productName;
            
            // Remove common DVD/Blu-ray related terms (case insensitive)
            const termsToRemove = [
                /\b(DVD|Blu-ray|4K|UHD|Ultra HD|Digital|Copy|Widescreen|Full Screen|Fullscreen)\b/gi,
                /\b(Special Edition|Collector's Edition|Director's Cut|Extended Edition|Anniversary Edition)\b/gi,
                /\b(Movie|Film|Cinema|Video)\b/gi,
                /\b(New|Used|Sealed|Region \d+)\b/gi
            ];
            
            termsToRemove.forEach(regex => {
                title = title.replace(regex, ' ');
            });
            
            // Remove content in parentheses and brackets
            title = title.replace(/\s*\([^)]*\)\s*/g, ' ');
            title = title.replace(/\s*\[[^\]]*\]\s*/g, ' ');
            
            // Remove year patterns like "2019" or "'19" 
            title = title.replace(/\b(19|20)\d{2}\b/g, '');
            title = title.replace(/'\d{2}\b/g, '');
            
            // Clean up extra whitespace
            title = title.replace(/\s+/g, ' ').trim();
            
            // If title is too short or empty, return original
            if (title.length < 2) {
                return productName;
            }
            
            return title;
        }
        function setupSearch() { const searchInput = document.getElementById('movieSearch'); const searchSpinner = document.getElementById('searchSpinner'); const searchResultsContainer = document.getElementById('searchResults'); const loadMoreBtn = document.getElementById('loadMoreBtn'); const debouncedSearch = LibraryUtils.search.createDebouncedSearch((query) => { const sanitizedQuery = LibraryUtils.validation.sanitizeInput(query); if (sanitizedQuery.length > 2) { performSearch(sanitizedQuery, 1); } else { document.getElementById('searchResults').innerHTML = ''; document.getElementById('searchFooter').style.display = 'none'; } }); searchInput.addEventListener('input', (e) => { debouncedSearch(e.target.value, searchSpinner); }); document.getElementById('searchBtn').addEventListener('click', () => { const sanitizedQuery = LibraryUtils.validation.sanitizeInput(searchInput.value); performSearch(sanitizedQuery, 1); }); searchResultsContainer.addEventListener('scroll', () => { if (isLoadingMore || currentPage >= totalPages) return; const { scrollTop, scrollHeight, clientHeight } = searchResultsContainer; if (scrollHeight - scrollTop <= clientHeight + 100) { loadNextPage(); } }); loadMoreBtn.addEventListener('click', loadNextPage); }
        function loadNextPage() { if (isLoadingMore || currentPage >= totalPages) return; performSearch(currentSearchQuery, currentPage + 1); }
        async function performSearch(query, page = 1) { if (!query || isLoadingMore) return; const isNewSearch = page === 1; if (isNewSearch) { currentSearchQuery = query; currentPage = 1; } isLoadingMore = true; const cacheKey = `search_${query.toLowerCase().replace(/\s+/g, '_')}_p${page}`; const cachedData = apiCache.get('multi-search', cacheKey); if (cachedData) { processAndDisplayResults(cachedData, query, isNewSearch); isLoadingMore = false; return; } if (isNewSearch) { LibraryUtils.skeleton.showSkeleton('searchResults', 'search-results', 5); } else { document.getElementById('loadMoreBtn').textContent = 'Loading...'; document.getElementById('loadMoreBtn').disabled = true; } try { const searchUrl = `${TMDB_BASE_URL}/search/multi?query=${encodeURIComponent(query)}&page=${page}`; const response = await fetch(searchUrl); const data = await response.json(); apiCache.set('multi-search', cacheKey, data); processAndDisplayResults(data, query, isNewSearch); } catch (error) { LibraryUtils.errors.handleError(error, 'Search'); showStatusMessage('Search failed.', 'error'); } finally { isLoadingMore = false; const loadMoreBtn = document.getElementById('loadMoreBtn'); loadMoreBtn.textContent = 'Load More'; loadMoreBtn.disabled = currentPage >= totalPages; } }
        function processAndDisplayResults(data, query, isNewSearch) { currentPage = data.page; totalPages = data.total_pages; totalResults = data.total_results; const results = data.results.filter(item => item.media_type === 'movie' || item.media_type === 'tv').map(item => ({ ...item, score: calculateRelevanceScore(item, query) })).sort((a, b) => b.score - a.score); displayResults(results, isNewSearch); updateUrl(query, currentPage); updateSearchFooter(); }
        function calculateRelevanceScore(item, query) { const keywords = query.toLowerCase().split(' ').filter(k => k.length > 2); const title = (item.title || item.name || '').toLowerCase(); const overview = (item.overview || '').toLowerCase(); let score = 0; keywords.forEach(keyword => { if (title === keyword) score += 100; if (title.startsWith(keyword)) score += 50; if (title.includes(keyword)) score += 20; if (overview.includes(keyword)) score += 5; }); const releaseYear = parseInt((item.release_date || item.first_air_date || '').substring(0, 4)); if (releaseYear > 2020) score += 5; score += Math.min(item.popularity / 10, 20); score += (item.vote_average || 0) * 2; return score; }
        function displayResults(results, isNewSearch) { const resultsDiv = document.getElementById('searchResults'); if (isNewSearch) { resultsDiv.innerHTML = ''; } if (results.length === 0 && isNewSearch) { resultsDiv.innerHTML = '<p style="text-align: center; padding: 20px;">No results found.</p>'; return; } const resultsHTML = results.map((item) => { const title = item.title || item.name; const year = (item.release_date || item.first_air_date || '').substring(0, 4); const overview = LibraryUtils.ui.truncateText(item.overview, 100); const badgeHTML = item.media_type === 'tv' ? `<span class="badge badge-tv" title="TV Show"></span>` : `<span class="badge badge-movie" title="Movie"></span>`; return ` <div class="search-result" onclick="selectMedia('${item.id}', '${item.media_type}')"> <img src="${item.poster_path ? TMDB_IMAGE_BASE + item.poster_path : ''}" class="search-result-poster" onerror="this.style.display='none'"> <div class="search-result-info"> <h4>${title} (${year}) ${badgeHTML}</h4> <p>${overview}</p> </div> </div> `; }).join(''); resultsDiv.insertAdjacentHTML('beforeend', resultsHTML); }
        function updateSearchFooter() { const footer = document.getElementById('searchFooter'); const countSpan = document.getElementById('resultCount'); const loadMoreBtn = document.getElementById('loadMoreBtn'); if (totalResults > 0) { footer.style.display = 'flex'; const itemsShown = document.getElementById('searchResults').children.length; countSpan.textContent = `Showing ${itemsShown} of ${totalResults} results`; if (currentPage < totalPages) { loadMoreBtn.style.display = 'block'; loadMoreBtn.disabled = false; } else { loadMoreBtn.style.display = 'none'; } } else { footer.style.display = 'none'; } }
        function updateUrl(query, page) { const url = new URL(window.location); url.searchParams.set('query', query); url.searchParams.set('page', page); window.history.pushState({ path: url.href }, '', url.href); }
       
        // Replace your selectMedia function with this improved version
        async function selectMedia(id, type) {
            // Immediate visual feedback - highlight the selected item
            const selectedResult = event.target.closest('.search-result');
            if (selectedResult) {
                selectedResult.classList.add('selected');
                // Disable other search results to prevent double-clicking
                const allResults = document.querySelectorAll('.search-result');
                allResults.forEach(result => {
                    if (result !== selectedResult) {
                        result.style.opacity = '0.5';
                        result.style.pointerEvents = 'none';
                    }
                });
            }

            // Show skeleton loading for form fields instead of text message
            showMovieSelectionSkeleton();
            
            const cacheKey = `details_${type}_${id}`;
            const cachedData = apiCache.get('details', cacheKey);
            
            if (cachedData) {
                // Even with cached data, show brief loading for user feedback
                setTimeout(() => {
                    hideMovieSelectionSkeleton();
                    populateFormWithData(cachedData);
                    clearSearchResults();
                    showStatusMessage('Movie details loaded successfully!', 'success');
                    // Clear success message after 3 seconds
                    setTimeout(() => {
                        document.getElementById('statusMessage').innerHTML = '';
                    }, 3000);
                }, 300);
                return;
            }

            try {
                const response = await fetch(`${TMDB_BASE_URL}/${type}/${id}?append_to_response=credits`);
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error('Failed to load movie details');
                }
                
                apiCache.set('details', cacheKey, data);
                hideMovieSelectionSkeleton();
                populateFormWithData(data);
                clearSearchResults();
                
                showStatusMessage('Movie details loaded successfully!', 'success');
                // Clear success message after 3 seconds
                setTimeout(() => {
                    document.getElementById('statusMessage').innerHTML = '';
                }, 3000);
                
            } catch (error) {
                // Restore search results on error
                hideMovieSelectionSkeleton();
                if (selectedResult) {
                    selectedResult.classList.remove('selected');
                    const allResults = document.querySelectorAll('.search-result');
                    allResults.forEach(result => {
                        result.style.opacity = '';
                        result.style.pointerEvents = '';
                    });
                }
                
                LibraryUtils.errors.handleError(error, 'Loading media details');
                showStatusMessage('Failed to load movie details. Please try again.', 'error');
            }
        }
        // New function to clear search results and provide clean state
        function clearSearchResults() {
            // Clear search results
            document.getElementById('searchResults').innerHTML = '';
            document.getElementById('searchFooter').style.display = 'none';
            
            // Clear search input to show the selection was successful
            document.getElementById('movieSearch').value = '';
            
            // Reset search state
            currentSearchQuery = '';
            currentPage = 1;
            totalPages = 1;
            totalResults = 0;
            isLoadingMore = false;
        }
        // Skeleton loading functions for movie selection (consistent with barcode loading)
        function showMovieSelectionSkeleton() {
            // Clear any existing status messages
            document.getElementById('statusMessage').innerHTML = '';
            
            // Show skeleton loading in the form fields (same as barcode)
            const formFields = ['title', 'year', 'director', 'genre', 'summary', 'cast'];
            
            formFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.classList.add('skeleton-loading');
                    field.value = '';
                    field.placeholder = '';
                }
            });
            
            // Add loading message with same styling as barcode loading
            document.getElementById('statusMessage').innerHTML = `
                <div class="barcode-loading-container">
                    <div class="barcode-loading-text">
                        <div class="skeleton skeleton-text-line"></div>
                        <div class="skeleton skeleton-text-line short"></div>
                    </div>
                    <div class="barcode-loading-message">Loading movie details...</div>
                </div>
            `;
        }
        function hideMovieSelectionSkeleton() {
            // Remove skeleton loading from form fields (same as barcode)
            const formFields = ['title', 'year', 'director', 'genre', 'summary', 'cast'];
            
            formFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.classList.remove('skeleton-loading');
                }
            });
            
            // Clear the loading message
            const loadingContainer = document.querySelector('.barcode-loading-container');
            if (loadingContainer) {
                loadingContainer.remove();
            }
        }
        function populateFormWithData(data) {
    document.getElementById('title').value = data.title || data.name;
    document.getElementById('year').value = (data.release_date || data.first_air_date || '').substring(0, 4);
    document.getElementById('summary').value = data.overview;
    document.getElementById('genre').value = data.genres.map(g => g.name).join(', ');
    document.getElementById('cast').value = data.credits.cast.slice(0, 5).map(c => c.name).join(', ');
    const director = data.credits.crew.find(c => c.job === 'Director');
    document.getElementById('director').value = director ? director.name : '';
    document.getElementById('contentType').value = data.media_type || (data.seasons ? 'tv' : 'movie');
    
    document.getElementById('movieForm').dataset.tmdbId = data.id;
    document.getElementById('movieForm').dataset.posterUrl = data.poster_path ? TMDB_IMAGE_BASE + data.poster_path : '';
    document.getElementById('movieForm').dataset.runtime = data.runtime || (data.episode_run_time ? data.episode_run_time[0] : null);

    togglePublicFieldsReadonly(true); 
    isPublicFieldsEditable = false;
    
    // Scroll to the form so user can see the populated data
    document.getElementById('movieForm').scrollIntoView({ 
        behavior: 'smooth', 
        block: 'start' 
    });
}
        async function setupBarcodeScanner() { const cameraBtn = document.getElementById('cameraBtn'); const manualBtn = document.getElementById('manualBarcodeBtn'); const lookupBtn = document.getElementById('lookupBarcodeBtn'); const cancelBtn = document.getElementById('cancelBarcodeBtn'); const stopBtn = document.getElementById('stopScanBtn'); const barcodeInput = document.getElementById('barcodeInput'); manualBtn.addEventListener('click', showManualInput); lookupBtn.addEventListener('click', lookupManualBarcode); cancelBtn.addEventListener('click', hideManualInput); stopBtn.addEventListener('click', stopScanner); barcodeInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') { e.preventDefault(); lookupManualBarcode(); } }); barcodeInput.addEventListener('input', (e) => { const value = e.target.value; if (!/^\d{0,18}$/.test(value)) { e.target.value = value.replace(/\D/g, '').slice(0, 18); } document.getElementById('lookupBarcodeBtn').disabled = !LibraryUtils.validation.isValidBarcode(e.target.value); }); cameraBtn.addEventListener('click', startScanner); try { if (typeof ZXing !== 'undefined' && ZXing.BrowserMultiFormatReader) { codeReader = new ZXing.BrowserMultiFormatReader(); videoInputDevices = await codeReader.listVideoInputDevices(); if (videoInputDevices.length === 0) { cameraBtn.disabled = true; cameraBtn.textContent = 'No Camera'; } } else { cameraBtn.disabled = true; cameraBtn.textContent = 'Scanner N/A'; } } catch (err) { console.error("Error setting up barcode scanner:", err); cameraBtn.disabled = true; cameraBtn.textContent = 'Scanner Error'; } }
        function showManualInput() { document.getElementById('manualBarcodeInput').style.display = 'block'; document.getElementById('barcodeInput').focus(); document.getElementById('lookupBarcodeBtn').disabled = true; }
        function hideManualInput() { document.getElementById('manualBarcodeInput').style.display = 'none'; }
        function lookupManualBarcode() { const barcode = LibraryUtils.validation.sanitizeInput(document.getElementById('barcodeInput').value); if (!LibraryUtils.validation.isValidBarcode(barcode)) { showStatusMessage('Please enter a valid barcode (8-18 digits).', 'error'); return; } document.getElementById('barcodeSpinner').style.display = 'block'; lookupMovieByBarcode(barcode).finally(() => hideManualInput()); }
        async function startScanner() { if (!codeReader || videoInputDevices.length === 0) return; document.getElementById('scannerContainer').style.display = 'block'; showStatusMessage('Starting camera...', 'info'); try { await codeReader.decodeFromVideoDevice(videoInputDevices[0].deviceId, 'video', (result, err) => { if (result) { stopScanner(); lookupMovieByBarcode(result.text); } }); showStatusMessage('Camera ready. Position barcode in view.', 'info'); } catch (error) { LibraryUtils.errors.handleError(error, 'Camera Scanner'); stopScanner(); } }
        function stopScanner() { if (codeReader) codeReader.reset(); document.getElementById('scannerContainer').style.display = 'none'; }
    </script>
</body>
</html>
