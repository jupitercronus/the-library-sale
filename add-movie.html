<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Media - the library sale</title>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-auth-compat.js"></script>
    <!-- ZXing Barcode Scanner Library -->
    <script type="text/javascript" src="https://unpkg.com/@zxing/library@0.20.0/umd/index.min.js"></script>
    <!-- App Utilities -->
    <script src="utils.js"></script>
    <script src="cache.js"></script>
    <link rel="stylesheet" href="style.css">
    <script src="main.js" defer></script>

</head>
<body>
    <div>
        <header id="navbar-placeholder"></header>
        <!-- The rest of your page content -->
    </div>

    <div class="container">
        <h1 id="formTitle">Add New Media</h1>
        
        <div class="search-section">
            <h3>üîç Search for Media</h3>
            <div class="search-controls">
                <input type="text" id="movieSearch" placeholder="Type title, actor, director...">
                <button type="button" id="searchBtn" class="btn">Search</button>
                <div class="loading-spinner" id="searchSpinner"></div>
                <button type="button" id="cameraBtn" class="btn">Scan Barcode</button>
                <button type="button" id="manualBarcodeBtn" class="btn">Enter Barcode</button>
            </div>
            
            <div id="manualBarcodeInput" style="display: none; margin-bottom: 15px;">
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="text" id="barcodeInput" placeholder="Enter 8-18 digit barcode" pattern="[0-9]{8,18}" maxlength="18">
                    <button type="button" id="lookupBarcodeBtn" class="btn">Lookup</button>
                    <button type="button" id="cancelBarcodeBtn" class="btn" style="background: #6c757d;">Cancel</button>
                    <div class="loading-spinner" id="barcodeSpinner"></div>
                </div>
                <small style="color: #666; display: block; margin-top: 5px;">UPC/EAN barcodes are typically 12-13 digits</small>
            </div>
            
            <div class="scanner-container" id="scannerContainer" style="display: none;">
                <div class="scanner-overlay">
                    <video id="video" autoplay muted style="width: 100%; max-width: 400px; height: 300px; border: 2px solid #007bff; border-radius: 5px; background: #000;"></video>
                </div>
                <p style="margin: 10px 0; color: #666;">Position barcode in camera view</p>
                <button type="button" id="stopScanBtn" class="btn">Stop Camera</button>
            </div>
            
            <div id="statusMessage"></div>
            <div id="searchResults"></div>
            <div id="searchFooter" class="search-footer" style="display: none;">
                <span id="resultCount"></span>
                <button id="loadMoreBtn" class="btn btn-load-more">Load More</button>
            </div>
        </div>
        
        <hr>
        
        <h3>‚úèÔ∏è Media Details</h3>
        <form id="movieForm">
            <input type="hidden" id="editionDetailsInput">

            <div class="form-row">
                <div class="form-group">
                    <label for="title">Title *</label>
                    <input type="text" id="title" required readonly>
                </div>
                <div class="form-group">
                    <label for="year">Year</label>
                    <input type="number" id="year" min="1900" max="2030" readonly>
                </div>
            </div>
            
             <div class="form-row">
                <div class="form-group">
                    <label for="director">Director</label>
                    <input type="text" id="director" readonly>
                </div>
                <div class="form-group">
                    <label for="genre">Genre</label>
                    <input type="text" id="genre" readonly>
                </div>
            </div>

            <div class="form-group">
                <label for="summary">Summary</label>
                <textarea id="summary" rows="6" placeholder="Media summary from TMDb" readonly></textarea>
            </div>
            
            <div class="form-group">
                <label for="cast">Cast</label>
                <input type="text" id="cast" placeholder="e.g., Leonardo DiCaprio, Joseph Gordon-Levitt" readonly>
            </div>

            <div class="form-group">
                <label for="contentType">Content Type *</label>
                <select id="contentType" required>
                    <option value="movie">Movie</option>
                    <option value="tv">TV Show</option>
                </select>
            </div>

            <h3>‚úèÔ∏è My Rating & Notes</h3>
            <div class="form-group">
                <label>Rating</label>
                <div class="star-rating" id="starRating">
                    <span class="star">‚òÖ</span>
                    <span class="star">‚òÖ</span>
                    <span class="star">‚òÖ</span>
                    <span class="star">‚òÖ</span>
                    <span class="star">‚òÖ</span>
                </div>
            </div>
            
            <div class="form-group">
                <label for="review">Review/Notes</label>
                <textarea id="review" rows="4" placeholder="What did you think of this media?"></textarea>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="watchedCheckbox">Watched?</label>
                    <input type="checkbox" id="watchedCheckbox" style="width: auto; margin-top: 8px;">
                </div>
                <div class="form-group">
                    <label for="watchedDate">Watched Date (Optional)</label>
                    <input type="date" id="watchedDate">
                </div>
            </div>

            <div class="form-group">
                <label for="ownedCheckbox">I own a physical copy</label>
                <input type="checkbox" id="ownedCheckbox" style="width: auto; margin-top: 8px;">
            </div>
            <div class="form-group" id="editionDetailsGroup" style="display: none;">
                <label for="editionDetails">Edition Details (e.g., Collector's Edition, Blu-ray)</label>
                <input type="text" id="editionDetails" placeholder="Details from the box">
            </div>
            
            <button type="submit" class="btn" id="submitBtn">Add Media</button>
        </form>
    </div>

    <div id="alertModal" class="modal">
        <div class="modal-content">
            <h3 id="alertModalTitle">Alert</h3>
            <p id="alertModalMessage">Something happened.</p>
            <div class="modal-buttons">
                <button class="modal-btn ok" id="alertModalOk">OK</button>
            </div>
        </div>
    </div>

    <script>
        let currentRating = 0;
        let editingMovieId = null; 
        let currentUser = null; 
        let isPublicFieldsEditable = true;
        let codeReader = null;
        let videoInputDevices = [];
        let starRatingController = null;
        
        // --- PAGINATION & SEARCH STATE ---
        let currentSearchQuery = '';
        let currentPage = 1;
        let totalPages = 1;
        let totalResults = 0;
        let isLoadingMore = false;
        
        const apiCache = new CacheManager('tmdb_api_cache_', 50, 24);

        const TMDB_BASE_URL = '/api/tmdb';
        const UPC_BASE_URL = '/api/upc';
        const TMDB_IMAGE_BASE = 'https://image.tmdb.org/t/p/w500';

        const firebaseConfig = {
          apiKey: "AIzaSyDDW8LtwpYevdkD7Q-_CxJ23mMfi00P21M",
          authDomain: "tiny-lizard.firebaseapp.com",
          projectId: "tiny-lizard",
          storageBucket: "tiny-lizard.firebasestorage.app",
          messagingSenderId: "250872474692",
          appId: "1:250872474692:web:969e0b1302ae3cb4666011",
        };
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore(); 
        const auth = firebase.auth(); 

        document.addEventListener('DOMContentLoaded', () => {
            auth.onAuthStateChanged(user => {
                const authBtn = document.getElementById('authBtn');
                if (user) {
                    currentUser = user;
                    authBtn.textContent = 'Logout';
                    initializePage();
                } else {
                    authBtn.textContent = 'Login';
                    window.location.href = 'auth.html'; 
                }
            });
            document.getElementById('authBtn').addEventListener('click', handleAuthButtonClick);
        });

        async function handleAuthButtonClick() {
            if (currentUser) await auth.signOut();
            else window.location.href = 'auth.html';
        }

        function initializePage() {
            setupForm();
            setupSearch();
            setupStarRating();
            setupBarcodeScanner();
            checkEditMode();
            
            document.getElementById('ownedCheckbox').addEventListener('change', (e) => {
                document.getElementById('editionDetailsGroup').style.display = e.target.checked ? 'block' : 'none';
            });

            // Check for search params in URL on load
            const urlParams = new URLSearchParams(window.location.search);
            const queryFromUrl = urlParams.get('query');
            const pageFromUrl = parseInt(urlParams.get('page')) || 1;
            if (queryFromUrl) {
                document.getElementById('movieSearch').value = queryFromUrl;
                performSearch(queryFromUrl, pageFromUrl);
            }
        }

        function setupForm() {
            const form = document.getElementById('movieForm');
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                if (editingMovieId) {
                    updateMedia();
                } else {
                    addMedia();
                }
            });
        }
        
        async function updateHistory(collectionName, docId, mediaId, mediaData, userInteraction) {
            if (collectionName === 'watchHistory' && userInteraction.watched && userInteraction.watchedDate) {
                 await db.collection('watchHistory').doc(docId).set({
                    userId: currentUser.uid,
                    userDisplayName: currentUser.displayName || currentUser.email,
                    mediaId: mediaId,
                    mediaTitle: mediaData.title,
                    posterUrl: mediaData.posterUrl,
                    watchedDate: userInteraction.watchedDate,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
            } else if (collectionName === 'purchaseHistory' && userInteraction.owned) {
                await db.collection('purchaseHistory').doc(docId).set({
                    userId: currentUser.uid,
                    userDisplayName: currentUser.displayName || currentUser.email,
                    mediaId: mediaId,
                    mediaTitle: mediaData.title,
                    posterUrl: mediaData.posterUrl,
                    editionDetails: document.getElementById('editionDetails').value || 'Physical Copy',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
            }
        }

        async function addMedia() {
            const submitBtn = document.getElementById('submitBtn');
            LibraryUtils.ui.setButtonLoading(submitBtn, 'Adding...');

            try {
                const titleValue = LibraryUtils.validation.sanitizeInput(document.getElementById('title').value);
                if (!titleValue) throw new Error('Title is a required field.');
                
                const yearValue = document.getElementById('year').value;
                if (yearValue && !LibraryUtils.validation.isValidYear(yearValue)) throw new Error('Please enter a valid year (e.g., 1999).');
                
                const rating = starRatingController ? starRatingController.getRating() : currentRating;
                if (!LibraryUtils.validation.isValidRating(rating)) throw new Error('Invalid rating value provided.');
                
                const tmdbId = document.getElementById('movieForm').dataset.tmdbId;
                let movieDocRef;
                let mainMediaData;

                if (tmdbId) {
                    const existingQuery = await db.collection('movies').where('tmdbId', '==', parseInt(tmdbId)).limit(1).get();
                    if (!existingQuery.empty) {
                        movieDocRef = existingQuery.docs[0].ref;
                        mainMediaData = existingQuery.docs[0].data();
                    }
                }
                
                if (!movieDocRef) {
                    mainMediaData = {
                        title: titleValue,
                        year: yearValue ? parseInt(yearValue) : null,
                        director: LibraryUtils.validation.sanitizeInput(document.getElementById('director').value),
                        genre: LibraryUtils.validation.sanitizeInput(document.getElementById('genre').value),
                        posterUrl: document.getElementById('movieForm').dataset.posterUrl || null,
                        runtime: document.getElementById('movieForm').dataset.runtime || null,
                        tmdbId: tmdbId ? parseInt(tmdbId) : null,
                        overview: LibraryUtils.validation.sanitizeInput(document.getElementById('summary').value, 1000),
                        cast: document.getElementById('cast').value.split(',').map(c => LibraryUtils.validation.sanitizeInput(c)),
                        contentType: document.getElementById('contentType').value,
                        dateAdded: firebase.firestore.FieldValue.serverTimestamp(),
                        originalUploaderId: currentUser.uid,
                        originalUploaderDisplayName: currentUser.displayName || currentUser.email,
                        isManualEntry: isPublicFieldsEditable
                    };
                    movieDocRef = await db.collection('movies').add(mainMediaData);
                }

                const userInteractionData = {
                    rating: rating,
                    review: LibraryUtils.validation.sanitizeInput(document.getElementById('review').value, 1000),
                    watched: document.getElementById('watchedCheckbox').checked,
                    watchedDate: document.getElementById('watchedDate').value || null,
                    owned: document.getElementById('ownedCheckbox').checked,
                    interactionDate: firebase.firestore.FieldValue.serverTimestamp()
                };
                await db.collection('users').doc(currentUser.uid).collection('movieInteractions').doc(movieDocRef.id).set(userInteractionData);

                const historyDocId = `${currentUser.uid}_${movieDocRef.id}`;
                await updateHistory('watchHistory', historyDocId, movieDocRef.id, mainMediaData, userInteractionData);
                await updateHistory('purchaseHistory', historyDocId, movieDocRef.id, mainMediaData, userInteractionData);

                if (userInteractionData.owned) {
                    const physicalCopyData = {
                        ownerId: currentUser.uid,
                        ownerDisplayName: currentUser.displayName || currentUser.email,
                        editionDetails: LibraryUtils.validation.sanitizeInput(document.getElementById('editionDetails').value) || 
                                       LibraryUtils.validation.sanitizeInput(document.getElementById('editionDetailsInput').value) || 'Standard Edition',
                        dateAdded: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    await movieDocRef.collection('physicalCopies').add(physicalCopyData);
                }

                showAlertModal('Success', 'Media added to the library!', () => {
                    window.location.href = `library.html?id=${movieDocRef.id}`;
                });

            } catch (error) {
                LibraryUtils.errors.handleError(error, 'Adding Media');
            } finally {
                LibraryUtils.ui.resetButton(submitBtn);
            }
        }
        
        async function updateMedia() {
            const submitBtn = document.getElementById('submitBtn');
            LibraryUtils.ui.setButtonLoading(submitBtn, 'Updating...');

            try {
                const rating = starRatingController ? starRatingController.getRating() : currentRating;
                if (!LibraryUtils.validation.isValidRating(rating)) throw new Error('Invalid rating value provided.');
                
                const movieDocRef = db.collection('movies').doc(editingMovieId);
                const mediaDoc = await movieDocRef.get();
                const mainMediaData = mediaDoc.data();

                const userInteractionData = {
                    rating: rating,
                    review: LibraryUtils.validation.sanitizeInput(document.getElementById('review').value, 1000),
                    watched: document.getElementById('watchedCheckbox').checked,
                    watchedDate: document.getElementById('watchedDate').value || null,
                    owned: document.getElementById('ownedCheckbox').checked,
                    interactionDate: firebase.firestore.FieldValue.serverTimestamp()
                };
                await db.collection('users').doc(currentUser.uid).collection('movieInteractions').doc(editingMovieId).set(userInteractionData, { merge: true });

                const historyDocId = `${currentUser.uid}_${editingMovieId}`;
                await updateHistory('watchHistory', historyDocId, editingMovieId, mainMediaData, userInteractionData);
                await updateHistory('purchaseHistory', historyDocId, editingMovieId, mainMediaData, userInteractionData);

                const ownedCheckbox = document.getElementById('ownedCheckbox');
                const physicalCopiesRef = movieDocRef.collection('physicalCopies');
                const myCopyQuery = await physicalCopiesRef.where('ownerId', '==', currentUser.uid).get();

                if (ownedCheckbox.checked && myCopyQuery.empty) {
                    const physicalCopyData = {
                        ownerId: currentUser.uid,
                        ownerDisplayName: currentUser.displayName || currentUser.email,
                        editionDetails: LibraryUtils.validation.sanitizeInput(document.getElementById('editionDetails').value) || 'Standard Edition',
                        dateAdded: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    await physicalCopiesRef.add(physicalCopyData);
                } else if (!ownedCheckbox.checked && !myCopyQuery.empty) {
                    for (const doc of myCopyQuery.docs) {
                        await doc.ref.delete();
                    }
                }

                showAlertModal('Success', 'Your details have been updated!', () => {
                    window.location.href = `library.html?id=${editingMovieId}`;
                });

            } catch (error) {
                LibraryUtils.errors.handleError(error, 'Updating Media');
            } finally {
                LibraryUtils.ui.resetButton(submitBtn);
            }
        }

        async function checkEditMode() {
            const urlParams = new URLSearchParams(window.location.search);
            editingMovieId = urlParams.get('edit');
            if (!editingMovieId) {
                togglePublicFieldsReadonly(false);
                return;
            }

            document.getElementById('formTitle').textContent = 'Edit My Details';
            document.getElementById('submitBtn').textContent = 'Update Details';

            try {
                const mediaDoc = await db.collection('movies').doc(editingMovieId).get();
                const interactionDoc = await db.collection('users').doc(currentUser.uid).collection('movieInteractions').doc(editingMovieId).get();
                
                if (!mediaDoc.exists) throw new Error('Media not found.');

                const mediaData = mediaDoc.data();
                document.getElementById('title').value = mediaData.title || '';
                document.getElementById('year').value = mediaData.year || '';
                document.getElementById('director').value = mediaData.director || '';
                document.getElementById('genre').value = mediaData.genre || '';
                document.getElementById('summary').value = mediaData.overview || '';
                document.getElementById('cast').value = (mediaData.cast || []).join(', ');
                document.getElementById('contentType').value = mediaData.contentType || 'movie';
                togglePublicFieldsReadonly(true);

                if (interactionDoc.exists) {
                    const interactionData = interactionDoc.data();
                    currentRating = interactionData.rating || 0;
                    if (starRatingController) starRatingController.setRating(currentRating);
                    document.getElementById('review').value = interactionData.review || '';
                    document.getElementById('watchedCheckbox').checked = interactionData.watched || false;
                    document.getElementById('watchedDate').value = interactionData.watchedDate || '';
                    document.getElementById('ownedCheckbox').checked = interactionData.owned || false;

                    if (interactionData.owned) {
                        document.getElementById('editionDetailsGroup').style.display = 'block';
                        const myCopyQuery = await db.collection('movies').doc(editingMovieId).collection('physicalCopies').where('ownerId', '==', currentUser.uid).limit(1).get();
                        if (!myCopyQuery.empty) {
                            document.getElementById('editionDetails').value = myCopyQuery.docs[0].data().editionDetails || '';
                        }
                    }
                }
            } catch (error) {
                LibraryUtils.errors.handleError(error, 'Loading edit data');
            }
        }
        
        function setupSearch() {
            const searchInput = document.getElementById('movieSearch');
            const searchSpinner = document.getElementById('searchSpinner');
            const searchResultsContainer = document.getElementById('searchResults');
            const loadMoreBtn = document.getElementById('loadMoreBtn');
            
            const debouncedSearch = LibraryUtils.search.createDebouncedSearch((query) => {
                const sanitizedQuery = LibraryUtils.validation.sanitizeInput(query);
                if (sanitizedQuery.length > 2) {
                    performSearch(sanitizedQuery, 1);
                } else {
                    document.getElementById('searchResults').innerHTML = '';
                    document.getElementById('searchFooter').style.display = 'none';
                }
            });

            searchInput.addEventListener('input', (e) => {
                debouncedSearch(e.target.value, searchSpinner);
            });
            
            document.getElementById('searchBtn').addEventListener('click', () => {
                const sanitizedQuery = LibraryUtils.validation.sanitizeInput(searchInput.value);
                performSearch(sanitizedQuery, 1);
            });

            // Virtual scrolling
            searchResultsContainer.addEventListener('scroll', () => {
                if (isLoadingMore || currentPage >= totalPages) return;
                
                const { scrollTop, scrollHeight, clientHeight } = searchResultsContainer;
                if (scrollHeight - scrollTop <= clientHeight + 100) { // 100px threshold
                    loadNextPage();
                }
            });

            // Load more button
            loadMoreBtn.addEventListener('click', loadNextPage);
        }

        function loadNextPage() {
            if (isLoadingMore || currentPage >= totalPages) return;
            performSearch(currentSearchQuery, currentPage + 1);
        }

        function calculateRelevanceScore(item, query) {
            const keywords = query.toLowerCase().split(' ').filter(k => k.length > 2);
            const title = (item.title || item.name || '').toLowerCase();
            const overview = (item.overview || '').toLowerCase();
            let score = 0;

            keywords.forEach(keyword => {
                if (title === keyword) score += 100;
                if (title.startsWith(keyword)) score += 50;
                if (title.includes(keyword)) score += 20;
                if (overview.includes(keyword)) score += 5;
            });

            const releaseYear = parseInt((item.release_date || item.first_air_date || '').substring(0, 4));
            if (releaseYear > 2020) score += 5;

            score += Math.min(item.popularity / 10, 20);
            score += (item.vote_average || 0) * 2;
            return score;
        }

        async function performSearch(query, page = 1) {
            if (!query || isLoadingMore) return;
            
            const isNewSearch = page === 1;
            if (isNewSearch) {
                currentSearchQuery = query;
                currentPage = 1;
            }

            isLoadingMore = true;
            
            const cacheKey = `search_${query.toLowerCase().replace(/\s+/g, '_')}_p${page}`;
            const cachedData = apiCache.get('multi-search', cacheKey);

            if (cachedData) {
                processAndDisplayResults(cachedData, query, isNewSearch);
                isLoadingMore = false;
                return;
            }

            if (isNewSearch) {
                LibraryUtils.skeleton.showSkeleton('searchResults', 'search-results', 5);
            } else {
                document.getElementById('loadMoreBtn').textContent = 'Loading...';
                document.getElementById('loadMoreBtn').disabled = true;
            }
            
            try {
                const searchUrl = `${TMDB_BASE_URL}/search/multi?query=${encodeURIComponent(query)}&page=${page}`;
                const response = await fetch(searchUrl);
                const data = await response.json();

                apiCache.set('multi-search', cacheKey, data);
                processAndDisplayResults(data, query, isNewSearch);

            } catch (error) {
                LibraryUtils.errors.handleError(error, 'Search');
                showStatusMessage('Search failed.', 'error');
            } finally {
                isLoadingMore = false;
                const loadMoreBtn = document.getElementById('loadMoreBtn');
                loadMoreBtn.textContent = 'Load More';
                loadMoreBtn.disabled = currentPage >= totalPages;
            }
        }

        function processAndDisplayResults(data, query, isNewSearch) {
            currentPage = data.page;
            totalPages = data.total_pages;
            totalResults = data.total_results;

            const results = data.results
                .filter(item => item.media_type === 'movie' || item.media_type === 'tv')
                .map(item => ({
                    ...item,
                    score: calculateRelevanceScore(item, query)
                }))
                .sort((a, b) => b.score - a.score);

            displayResults(results, isNewSearch);
            updateUrl(query, currentPage);
            updateSearchFooter();
        }

        function displayResults(results, isNewSearch) {
            const resultsDiv = document.getElementById('searchResults');
            
            if (isNewSearch) {
                resultsDiv.innerHTML = '';
            }

            if (results.length === 0 && isNewSearch) {
                resultsDiv.innerHTML = '<p style="text-align: center; padding: 20px;">No results found.</p>';
                return;
            }

            const resultsHTML = results.map((item) => {
                const title = item.title || item.name;
                const year = (item.release_date || item.first_air_date || '').substring(0, 4);
                const type = item.media_type === 'tv' ? 'TV Show' : 'Movie';
                const overview = LibraryUtils.ui.truncateText(item.overview, 100);
                
                return `
                    <div class="search-result" onclick="selectMedia('${item.id}', '${item.media_type}')">
                        <img src="${item.poster_path ? TMDB_IMAGE_BASE + item.poster_path : ''}" 
                             class="search-result-poster" onerror="this.style.display='none'">
                        <div class="search-result-info">
                            <h4>${title} (${year}) 
                                <span style="font-size:0.7em; background:#007bff; color:white; padding: 2px 6px; border-radius: 4px;">${type}</span>
                            </h4>
                            <p>${overview}</p>
                        </div>
                    </div>
                `;
            }).join('');

            resultsDiv.insertAdjacentHTML('beforeend', resultsHTML);
        }

        function updateSearchFooter() {
            const footer = document.getElementById('searchFooter');
            const countSpan = document.getElementById('resultCount');
            const loadMoreBtn = document.getElementById('loadMoreBtn');
            
            if (totalResults > 0) {
                footer.style.display = 'flex';
                const itemsShown = document.getElementById('searchResults').children.length;
                countSpan.textContent = `Showing ${itemsShown} of ${totalResults} results`;
                
                if (currentPage < totalPages) {
                    loadMoreBtn.style.display = 'block';
                    loadMoreBtn.disabled = false;
                } else {
                    loadMoreBtn.style.display = 'none';
                }
            } else {
                footer.style.display = 'none';
            }
        }

        function updateUrl(query, page) {
            const url = new URL(window.location);
            url.searchParams.set('query', query);
            url.searchParams.set('page', page);
            window.history.pushState({ path: url.href }, '', url.href);
        }

        async function selectMedia(id, type) {
            showStatusMessage('Loading details...', 'info');
            
            const cacheKey = `details_${type}_${id}`;
            const cachedData = apiCache.get('details', cacheKey);

            if (cachedData) {
                populateFormWithData(cachedData);
                return;
            }

            try {
                const response = await fetch(`${TMDB_BASE_URL}/${type}/${id}?append_to_response=credits`);
                const data = await response.json();
                
                apiCache.set('details', cacheKey, data);
                populateFormWithData(data);

            } catch (error) {
                LibraryUtils.errors.handleError(error, 'Loading media details');
            }
        }

        function populateFormWithData(data) {
            document.getElementById('title').value = data.title || data.name;
            document.getElementById('year').value = (data.release_date || data.first_air_date || '').substring(0, 4);
            document.getElementById('summary').value = data.overview;
            document.getElementById('genre').value = data.genres.map(g => g.name).join(', ');
            document.getElementById('cast').value = data.credits.cast.slice(0, 5).map(c => c.name).join(', ');
            const director = data.credits.crew.find(c => c.job === 'Director');
            document.getElementById('director').value = director ? director.name : '';
            document.getElementById('contentType').value = data.media_type || (data.seasons ? 'tv' : 'movie');
            
            document.getElementById('movieForm').dataset.tmdbId = data.id;
            document.getElementById('movieForm').dataset.posterUrl = data.poster_path ? TMDB_IMAGE_BASE + data.poster_path : '';
            document.getElementById('movieForm').dataset.runtime = data.runtime || (data.episode_run_time ? data.episode_run_time[0] : null);

            togglePublicFieldsReadonly(true);
            isPublicFieldsEditable = false;
            showStatusMessage('Media details loaded successfully!', 'success');
        }
        
        function setupStarRating() {
            starRatingController = LibraryUtils.stars.setupInteractiveStarRating(
                'starRating',
                (rating) => { currentRating = rating; },
                currentRating
            );
        }

        function togglePublicFieldsReadonly(isReadonly) {
             const fields = ['title', 'year', 'director', 'genre', 'summary', 'cast', 'contentType'];
             fields.forEach(id => {
                const el = document.getElementById(id);
                if (el.tagName === 'SELECT') el.disabled = isReadonly;
                else el.readOnly = isReadonly;
             });
        }

        function showAlertModal(title, message, onOk = () => {}) { 
            LibraryUtils.errors.showErrorModal(title, message, onOk);
        }

        function showStatusMessage(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.innerHTML = `<div class="status-message status-${type}">${message}</div>`;
        }
        
        async function setupBarcodeScanner() {
            const cameraBtn = document.getElementById('cameraBtn');
            const manualBtn = document.getElementById('manualBarcodeBtn');
            const lookupBtn = document.getElementById('lookupBarcodeBtn');
            const cancelBtn = document.getElementById('cancelBarcodeBtn');
            const stopBtn = document.getElementById('stopScanBtn');
            const barcodeInput = document.getElementById('barcodeInput');
            
            manualBtn.addEventListener('click', showManualInput);
            lookupBtn.addEventListener('click', lookupManualBarcode);
            cancelBtn.addEventListener('click', hideManualInput);
            stopBtn.addEventListener('click', stopScanner);
            
            barcodeInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') { e.preventDefault(); lookupManualBarcode(); } });

            barcodeInput.addEventListener('input', (e) => {
                const value = e.target.value;
                if (!/^\d{0,18}$/.test(value)) {
                    e.target.value = value.replace(/\D/g, '').slice(0, 18);
                }
                document.getElementById('lookupBarcodeBtn').disabled = !LibraryUtils.validation.isValidBarcode(e.target.value);
            });

            cameraBtn.addEventListener('click', startScanner);

            try {
                if (typeof ZXing !== 'undefined' && ZXing.BrowserMultiFormatReader) {
                    codeReader = new ZXing.BrowserMultiFormatReader();
                    videoInputDevices = await codeReader.listVideoInputDevices();
                    if (videoInputDevices.length === 0) {
                        cameraBtn.disabled = true;
                        cameraBtn.textContent = 'No Camera';
                    }
                } else {
                    cameraBtn.disabled = true;
                    cameraBtn.textContent = 'Scanner N/A';
                }
            } catch (err) {
                console.error("Error setting up barcode scanner:", err);
                cameraBtn.disabled = true;
                cameraBtn.textContent = 'Scanner Error';
            }
        }

        function showManualInput() {
            document.getElementById('manualBarcodeInput').style.display = 'block';
            document.getElementById('barcodeInput').focus();
            document.getElementById('lookupBarcodeBtn').disabled = true;
        }

        function hideManualInput() {
            document.getElementById('manualBarcodeInput').style.display = 'none';
        }

        function lookupManualBarcode() {
            const barcode = LibraryUtils.validation.sanitizeInput(document.getElementById('barcodeInput').value);
            if (!LibraryUtils.validation.isValidBarcode(barcode)) {
                showStatusMessage('Please enter a valid barcode (8-18 digits).', 'error');
                return;
            }
            document.getElementById('barcodeSpinner').style.display = 'block';
            lookupMovieByBarcode(barcode).finally(() => hideManualInput());
        }

        async function startScanner() {
            if (!codeReader || videoInputDevices.length === 0) return;
            document.getElementById('scannerContainer').style.display = 'block';
            showStatusMessage('Starting camera...', 'info');
            try {
                await codeReader.decodeFromVideoDevice(videoInputDevices[0].deviceId, 'video', (result, err) => {
                    if (result) {
                        stopScanner();
                        lookupMovieByBarcode(result.text);
                    }
                });
                showStatusMessage('Camera ready. Position barcode in view.', 'info');
            } catch (error) {
                LibraryUtils.errors.handleError(error, 'Camera Scanner');
                stopScanner();
            }
        }

        function stopScanner() {
            if (codeReader) codeReader.reset();
            document.getElementById('scannerContainer').style.display = 'none';
        }

        async function lookupMovieByBarcode(barcode) {
            showStatusMessage(`Looking up barcode: ${barcode}...`, 'info');
            try {
                const upcResponse = await fetch(`${UPC_BASE_URL}?upc=${barcode}`);
                if (!upcResponse.ok) throw new Error(`UPC lookup failed: ${upcResponse.statusText}`);
                
                const upcData = await upcResponse.json();
                if (!upcData.items || upcData.items.length === 0) {
                    showStatusMessage('No product found for this barcode.', 'error');
                    return;
                }
                
                const product = upcData.items[0];
                const productName = LibraryUtils.validation.sanitizeInput(product.title || product.description);
                document.getElementById('editionDetailsInput').value = productName;
                if (document.getElementById('editionDetails')) document.getElementById('editionDetails').value = productName;
                
                const movieTitle = extractMovieTitle(productName);
                if (movieTitle) await performSearch(movieTitle, 1);
                else showStatusMessage('Could not extract movie title from product name.', 'error');

            } catch (error) {
                LibraryUtils.errors.handleError(error, 'Barcode Lookup');
            }
        }

        function extractMovieTitle(productName) {
            let title = productName;
            title = title.replace(/\b(DVD|Blu-ray|4K|UHD|Digital|Copy|Widescreen|Full Screen|Special Edition|Collector's Edition)\b/gi, '');
            title = title.replace(/\s*\(.*?\)\s*/g, ' ').trim(); 
            title = title.replace(/\s*\[.*?\]\s*/g, ' ').trim();
            title = title.replace(/\s+/g, ' ').trim();
            return LibraryUtils.validation.sanitizeInput(title) || productName;
        }
    </script>
</body>
</html>
