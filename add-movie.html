<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, maximum-scale=5.0">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#24143E">
    <meta name="format-detection" content="telephone=no">    <title>add media - the library sale</title>
    <!-- Google Fonts Import -->
     <link rel="preconnect" href="https://fonts.googleapis.com">
     <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
     <link href="https://fonts.googleapis.com/css2?family=B612+Mono&family=Dokdo&family=Kirang+Haerang&family=M+PLUS+2&family=Syne+Mono&display=swap" rel="stylesheet">
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-auth-compat.js"></script>
    <!-- ZXing Barcode Scanner Library -->
    <script type="text/javascript" src="https://unpkg.com/@zxing/library@0.20.0/umd/index.min.js"></script>
    <!-- App Utilities -->
    <script src="utils.js"></script>
    <script src="cache.js"></script>
    <script src="scanner-utils.js"></script>
    <!-- Styles -->
    <link rel="stylesheet" href="styles/variables.css">
    <link rel="stylesheet" href="styles/base.css">  
    <link rel="stylesheet" href="styles/components.css">
    <link rel="stylesheet" href="styles/pages.css">
    <!-- Main utilities -->
    <script src="main.js" defer></script>
</head>
<body>
    <header id="navbar-placeholder"></header>

    <main class="add-movie-container">
        <section class="hero-section">
            <h1 id="formTitle">add new media</h1>
        </section>
        <br>
        <!-- Search Section -->
        <section class="search-section">
            <div class="search-controls">
                <div  class="flex-center" style="flex-wrap: wrap; gap: var(--space-md);"> 
                <div class="search-bar">
                    <input type="text" id="movieSearch" placeholder="Type title, actor, director..."> 
                </div>              
                <button type="button" id="searchBtn" class="btn btn-rectangular btn-primary" title="search">
                    <span class="icon icon-search icon-lg"></span>
                </button>
                </div>
                <div class="loading-spinner" id="searchSpinner" style="display: none;"></div>
            </div>    
        </section>
                <br>
        <section class="button-section">
            <div>
                <button type="button" id="cameraBtn" class="btn btn-rectangular btn-primary">
                    scan barcode
                </button>
                <button type="button" id="manualBarcodeBtn" class="btn btn-rectangular btn-primary">
                    enter barcode
                </button>
            </div>
            <br>
            <div>
                <p class="text-muted">do u have too many?</p>
                <a href="bulk-scan.html" class="btn btn-rectangular btn-primary">
                    <span class="icon icon-bulk icon-md"></span>
                    take me to bulk scan
                </a>
            </div>
        </section>

        <!-- Scanner  -->
            <section id="scannerSection" class="scanner-section" style="display: none;">
                <div class="scanner-viewport">
                    <video id="video" autoplay muted playsinline></video>
                    <div class="scanner-guideline"></div> 
                    <div class="scanner-status" id="scannerStatus">position barcode in camera view</div>
                </div>
                <div class="quick-actions">
                    <p>position the barcode in the camera view girl cmon</p>
                    <button type="button" id="stop-scanner-btn" class="btn btn-lg btn-danger" title="stop scanner">
                        <i class="icon icon-close"></i>
                    </button>
                </div>
            </section>
            
            <div id="statusMessage"></div>
            <div id="searchResults"></div>
            
            <div id="searchFooter" class="search-footer" style="display: none;">
                <span id="resultCount"></span>
                <button id="loadMoreBtn" class="btn btn-rectangular btn-primary">load more</button>
            </div>
        </section>
        
        <hr class="list-divider">
        
        <!-- Media Details Form -->
        <section>
            <h2 class="heading-with-icon">
                <span class="icon icon-movie icon-sm"></span> <span class="icon icon-tv icon-sm"></span>
                media details
            </h2>
            <div id="form-skeleton" style="display: none;">
                <div class="details-main-content">
                    <div class="details-poster skeleton"></div>
                    <div class="details-info">
                        <div class="form-group">
                            <div class="skeleton" style="height: 16px; width: 50px; margin-bottom: 8px;"></div>
                            <div class="skeleton" style="height: 45px; width: 100%;"></div>
                        </div>
                        <div class="form-group">
                            <div class="skeleton" style="height: 16px; width: 40px; margin-bottom: 8px;"></div>
                            <div class="skeleton" style="height: 45px; width: 100%;"></div>
                        </div>
                        <div class="form-group">
                            <div class="skeleton" style="height: 16px; width: 60px; margin-bottom: 8px;"></div>
                            <div class="skeleton" style="height: 45px; width: 100%;"></div>
                        </div>
                        <div class="form-group">
                            <div class="skeleton" style="height: 16px; width: 50px; margin-bottom: 8px;"></div>
                            <div class="skeleton" style="height: 45px; width: 100%;"></div>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <div class="skeleton" style="height: 16px; width: 40px; margin-bottom: 8px;"></div>
                    <div class="skeleton" style="height: 45px; width: 100%;"></div>
                </div>
                <div class="form-group">
                    <div class="skeleton" style="height: 16px; width: 70px; margin-bottom: 8px;"></div>
                    <div class="skeleton" style="height: 120px; width: 100%;"></div>
                </div>
            </div>
            <form id="movieForm">
                <div class="details-main-content">
                    <div class="details-poster">
                        <img id="movie-poster-img" src="https://placehold.co/300x450/2D194D/DEF0F7?text=poster.jpeg" alt="Movie Poster">
                    </div>
                    <div class="details-info">
                        <input type="hidden" id="editionDetailsInput">
                            <div class="form-group">
                                <label for="title">title *</label>
                                <input type="text" id="title" required readonly>
                            </div>
                            <div class="form-group">
                                <label for="year">year</label>
                                <input type="number" id="year" min="1900" max="2030" readonly>
                            </div>
                            <div class="form-group">
                                <label for="director">director</label>
                                <input type="text" id="director" readonly>
                            </div>
                            <div class="form-group">
                                <label for="genre">genre</label>
                                <input type="text" id="genre" readonly>
                            </div>
                            <div class="form-group">
                                <label for="cast">cast</label>
                                <input type="text" id="cast" placeholder="e.g., Leonardo DiCaprio, Joseph Gordon-Levitt" readonly>
                            </div>
                            <div class="form-group">
                                <label for="contentType">content type *</label>
                                <div id="contentTypeToggle" class="content-type-toggle">
                                    <button type="button" class="content-type-btn active" data-value="movie">
                                        <span class="icon icon-movie"></span> 
                                    </button>
                                    <button type="button" class="content-type-btn" data-value="tv">
                                        <span class="icon icon-tv"></span>
                                    </button>
                                </div>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="summary">summary</label>
                        <textarea id="summary" rows="6" placeholder="media summary from TMDd" readonly></textarea>
                    </div>
                    <!-- Physical Edition Details (shows when barcode data exists) -->
                    <div id="physicalEditionSection" class="form-group" style="display: none;">
                        <label>physical edition details</label>
                        <div class="physical-edition-info">
                            <div class="edition-row">
                                <span class="edition-label">format:</span>
                                <span id="editionFormat">-</span>
                            </div>
                            <div class="edition-row">
                                <span class="edition-label">edition:</span>
                                <span id="editionType">-</span>
                            </div>
                            <div class="edition-row">
                                <span class="edition-label">region:</span>
                                <span id="editionRegion">-</span>
                            </div>
                            <div class="edition-row">
                                <span class="edition-label">distributor:</span>
                                <span id="editionDistributor">-</span>
                            </div>
                            <div class="edition-row" id="editionFeaturesRow" style="display: none;">
                                <span class="edition-label">features:</span>
                                <span id="editionFeatures">-</span>
                            </div>
                            <div class="edition-row">
                                <span class="edition-label">barcode:</span>
                                <span id="editionBarcode">-</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SUBMIT BUTTON -->
                <div class="flex-center" style="margin-top: var(--space-4xl);">
                    <button type="submit" id="save-btn" class="btn btn-xl btn-success" title="send it">
                            <i class="icon icon-confirm"></i>
                        </button>
                </div>
            </form>
        </section>
        
    </main>

    <script>
        let currentUser = null; 
        let isPublicFieldsEditable = true;
        let movieScanner = null;
        
        let currentSearchQuery = '';
        let currentPage = 1;
        let totalPages = 1;
        let totalResults = 0;
        let isLoadingMore = false;
        
        const apiCache = new CacheManager('tmdb_api_cache_', 50, 24);

        const TMDB_BASE_URL = '/api/tmdb';
        const UPC_BASE_URL = '/api/upc';
        const TMDB_IMAGE_BASE = 'https://image.tmdb.org/t/p/w500';
    const firebaseConfig = {
      apiKey: "AIzaSyDDW8LtwpYevdkD7Q-_CxJ23mMfi00P21M",
      authDomain: "tiny-lizard.firebaseapp.com",
      projectId: "tiny-lizard",
      storageBucket: "tiny-lizard.firebasestorage.app",
      messagingSenderId: "250872474692",
      appId: "1:250872474692:web:969e0b1302ae3cb4666011",
    };
    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore(); 
    const auth = firebase.auth(); 

    document.addEventListener('DOMContentLoaded', () => {
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                initializePage();
            } else {
                window.location.href = 'auth.html'; 
            }
        });
    });
    
    document.getElementById('contentTypeToggle').addEventListener('click', (e) => {
        const selectedBtn = e.target.closest('.content-type-btn');
        if (selectedBtn) {
            updateContentTypeToggle(selectedBtn.dataset.value);
        }
    });

async function initializePage() {
    setupForm();
    await initializeMovieScanner();       
    
    // Initialize the centralized search UI
    SearchUI.initialize({
        searchInputId: 'movieSearch',
        searchBtnId: 'searchBtn',
        resultsContainerId: 'searchResults',
        searchFooterId: 'searchFooter',
        resultCountId: 'resultCount',
        loadMoreBtnId: 'loadMoreBtn',
        onSelect: (id, type, element) => {
            selectMedia(id, type, element); 
        }
    });

    // Initialize the manual entry modal with proper callback
    ScannerUI.initialize(async (barcode) => {
        // Let the scanner manager handle it through its normal flow
        if (movieScanner) {
            return await movieScanner.addManualBarcode(barcode);
        }
        return false;
    });

    document.getElementById('manualBarcodeBtn').addEventListener('click', () => {
        ScannerUI.showManualEntryModal();
    });
}
    function setupForm() {
        const form = document.getElementById('movieForm');
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            addMedia();
        });
    }
async function initializeMovieScanner() {
    // Define constants for the elements we'll be working with
    const cameraBtn = document.getElementById('cameraBtn');
    const stopBtn = document.getElementById('stop-scanner-btn');
    const scannerSection = document.getElementById('scannerSection');
    const videoEl = document.getElementById('video');

        movieScanner = new ScannerManager({
            continuous: false, // This is correct for single-item adding
            allowDuplicates: true,
            enableHapticFeedback: true,
            onBarcodeScanned: async (barcode) => {
                // When a barcode is found, hide the scanner view
                scannerSection.style.display = 'none';
                
                // Process the barcode as before
                try {
                    showStatusMessage('Looking up barcode...', 'info');
                    const lookupData = await MediaLookupUtils.completeMovieLookup(barcode);
                    const { tmdbData, upcData, physicalEdition } = lookupData; 
                    populateFormWithTMDBAndUPC(tmdbData, upcData, physicalEdition);
                    showStatusMessage('Movie details loaded successfully!', 'success');
                } catch (error) {
                    console.error('Movie lookup failed:', error);
                    showStatusMessage(`Lookup failed: ${error.message}. You can search manually or try again.`, 'error');
                }
            },
            onStatusUpdate: (message, type) => {
                // Correctly targets the status element inside the scanner section
                ScannerUI.updateStatus(message, type, 'scannerStatus');
            },
            onError: (message, context) => {
                console.error(`Scanner error (${context}):`, message);
                showStatusMessage(message, 'error');
                // Also hide the scanner if an error occurs
                scannerSection.style.display = 'none';
            }
        });
    
        // Initialize the scanner
        const initialized = await movieScanner.initialize();
        
        if (!initialized) {
            // Disable camera button if scanner fails to initialize
            if (cameraBtn) {
                cameraBtn.disabled = true;
                cameraBtn.innerHTML = '<span class="icon icon-close icon-md"></span>Scanner N/A';
            }
            return;
        }
    
        cameraBtn.addEventListener('click', async () => {
            if (movieScanner) {
                // Show the scanner section inline
                scannerSection.style.display = 'block'; 
                const success = await movieScanner.startCamera(videoEl, 'scannerStatus');
                
                if (!success) {
                    // Hide the section if the camera fails to start
                    scannerSection.style.display = 'none';
                }
            }
        });

        stopBtn.addEventListener('click', () => {
            if (movieScanner) {
                movieScanner.stopCamera();
            }
            // Hide the scanner section
            scannerSection.style.display = 'none';
            document.getElementById('statusMessage').innerHTML = '';
        });
    }
    async function addMedia() {
    const submitBtn = document.getElementById('save-btn');
    if (submitBtn) {
        submitBtn.classList.add('saving');
    }

    try {
        const form = document.getElementById('movieForm');
        const titleValue = document.getElementById('title').value.trim();
        if (!titleValue) {
            throw new Error('Title is a required field. Please search for and select a movie first.');
        }
    
        const yearValue = document.getElementById('year').value;
        if (yearValue && (isNaN(yearValue) || yearValue < 1900 || yearValue > 2030)) {
            throw new Error('Please enter a valid year between 1900 and 2030.');
        }
    
        const tmdbId = document.getElementById('movieForm').dataset.tmdbId;
        let movieDocRef;

        if (tmdbId && tmdbId !== `upc_${document.getElementById('movieForm').dataset.upcCode}`) {
            const existingQuery = await db.collection('movies').where('tmdbId', '==', parseInt(tmdbId)).limit(1).get();
            if (!existingQuery.empty) {
                movieDocRef = existingQuery.docs[0].ref;
                console.log('Found existing movie in database');
            }
        }

        if (!movieDocRef) {
            const form = document.getElementById('movieForm');
            const mainMediaData = {
                title: titleValue,
                year: yearValue ? parseInt(yearValue) : null,
                director: document.getElementById('director').value.trim(),
                genre: document.getElementById('genre').value.trim(),
                posterUrl: form.dataset.posterUrl || null,
                runtime: form.dataset.runtime ? parseInt(form.dataset.runtime) : null,
                tmdbId: tmdbId && !tmdbId.startsWith('upc_') ? parseInt(tmdbId) : null,
                overview: document.getElementById('summary').value.trim(),
                cast: document.getElementById('cast').value.split(',').map(c => c.trim()).filter(c => c),
                contentType: document.querySelector('#contentTypeToggle .active').dataset.value,
                dateAdded: firebase.firestore.FieldValue.serverTimestamp(),
                originalUploaderId: currentUser.uid,
                originalUploaderDisplayName: currentUser.displayName || currentUser.email,
                isManualEntry: isPublicFieldsEditable,
            };
            
            console.log('Creating new movie entry:', mainMediaData);
            movieDocRef = await db.collection('movies').add(mainMediaData);
        }

        // Handle physical copy creation
        let physicalCopyId = null;
        const physicalEditionData = JSON.parse(form.dataset.physicalEdition || '{}');
        const upcCode = form.dataset.upcCode;

        if (upcCode && Object.keys(physicalEditionData).length > 0) {
            const uniqueId = MediaLookupUtils.generateUniqueIdentifier(
                upcCode,
                physicalEditionData.format,
                physicalEditionData.edition,
                physicalEditionData.region
            );

            // Check if this physical copy already exists
            const existingCopy = await MediaLookupUtils.findExistingPhysicalCopy(uniqueId);
            
            if (existingCopy) {
                physicalCopyId = existingCopy.id;
                console.log('Using existing physical copy:', physicalCopyId);
            } else {
                physicalCopyId = await MediaLookupUtils.createPhysicalCopy(
                    movieDocRef.id, 
                    {
                        ...physicalEditionData,
                        barcode: upcCode
                    }, 
                    currentUser.uid
                );
                console.log('Created new physical copy:', physicalCopyId);
            }
        }

        // FIXED: Check for existing user interaction and append to physical copies
        const userInteractionRef = db.collection('users').doc(currentUser.uid).collection('movieInteractions').doc(movieDocRef.id);
        const existingInteraction = await userInteractionRef.get();
        
        let physicalCopiesArray = [];
        if (existingInteraction.exists) {
            // Get existing physical copies
            const existingData = existingInteraction.data();
            physicalCopiesArray = existingData.physicalCopies || [];
            
            // Add new physical copy if not already in array
            if (physicalCopyId && !physicalCopiesArray.includes(physicalCopyId)) {
                physicalCopiesArray.push(physicalCopyId);
            }
            
            // NEW: Check for duplicates before creating/adding physical copy
        if (upcCode && Object.keys(physicalEditionData).length > 0) {
            const uniqueId = MediaLookupUtils.generateUniqueIdentifier(
                upcCode,
                physicalEditionData.format,
                physicalEditionData.edition,
                physicalEditionData.region
            );

            // Check if this physical copy already exists
            const existingCopy = await MediaLookupUtils.findExistingPhysicalCopy(uniqueId);
            
            if (existingCopy) {
                physicalCopyId = existingCopy.id;
                
                // Check if user already owns this exact copy
                const userInteractionRef = db.collection('users').doc(currentUser.uid).collection('movieInteractions').doc(movieDocRef.id);
                const existingInteraction = await userInteractionRef.get();
                
                if (existingInteraction.exists) {
                    const existingData = existingInteraction.data();
                    const currentPhysicalCopies = existingData.physicalCopies || [];
                    
                    if (currentPhysicalCopies.includes(physicalCopyId)) {
                        // User already owns this exact copy - show confirmation
                        const currentCount = currentPhysicalCopies.filter(id => id === physicalCopyId).length;
                        const shouldAddAnyway = confirm(
                            `You already own ${currentCount} copy/copies of this ${physicalEditionData.format} edition of "${movieData.title}". Add another copy anyway?`
                        );
                        
                        if (!shouldAddAnyway) {
                            showStatusMessage('Duplicate copy skipped by user choice.', 'info');
                            return; // Exit the function early
                        }
                    }
                }
                console.log('Using existing physical copy:', physicalCopyId);
            } else {
                physicalCopyId = await MediaLookupUtils.createPhysicalCopy(
                    movieDocRef.id, 
                    {
                        ...physicalEditionData,
                        barcode: upcCode
                    }, 
                    currentUser.uid
                );
                console.log('Created new physical copy:', physicalCopyId);
            }
        }

            // Update only the physical copies, preserve ratings/reviews/etc
            await userInteractionRef.update({
                physicalCopies: physicalCopiesArray,
                owned: true, // Make sure owned is true when adding physical copy
                // Update legacy fields for backward compatibility
                upc: upcCode || existingData.upc || '',
                physicalEdition: physicalEditionData
            });
            
            console.log(`Updated existing interaction. Total physical copies: ${physicalCopiesArray.length}`);
        } else {
            // Create new user interaction
            if (physicalCopyId) {
                physicalCopiesArray = [physicalCopyId];
            }
            
            const userInteractionData = {
                movieId: movieDocRef.id,
                rating: 0,
                review: "",
                watched: false,
                watchedDate: null,
                owned: true,
                interactionDate: firebase.firestore.FieldValue.serverTimestamp(),
                physicalCopies: physicalCopiesArray,
                
                // DEPRECATED: Keep for backward compatibility
                upc: upcCode || '',
                physicalEdition: physicalEditionData
            };

            await userInteractionRef.set(userInteractionData);
            console.log('Created new user interaction');
        }
    
        // Show brief success message
        LibraryUtils.ui.showStatusMessage('Media added successfully!', 'success', 1000);

        // Redirect after 1 second
        setTimeout(() => {
            window.location.href = `edit-movie.html?id=${movieDocRef.id}`;
        }, 1000);
    } catch (error) {
        console.error('Error adding media:', error);
        
        const errorMessage = document.createElement('div');
        errorMessage.className = 'status-message status-error';
        errorMessage.innerHTML = `<span class="icon icon-close icon-md"></span>${error.message}`;
        errorMessage.style.position = 'fixed';
        errorMessage.style.top = 'var(--space-xl)';
        errorMessage.style.right = 'var(--space-xl)';
        errorMessage.style.zIndex = 'var(--z-modal)';
        document.body.appendChild(errorMessage);
        
        setTimeout(() => errorMessage.remove(), 5000);
    } finally {
        if (submitBtn) {
            submitBtn.classList.remove('saving');
        }
    }
}
    function populateFormWithData(data) {
            document.getElementById('title').value = data.title || data.name;
            document.getElementById('year').value = (data.release_date || data.first_air_date || '').substring(0, 4);
            document.getElementById('summary').value = data.overview;
            document.getElementById('genre').value = data.genres.map(g => g.name).join(', ');
            document.getElementById('cast').value = data.credits.cast.slice(0, 5).map(c => c.name).join(', ');
        const director = data.credits.crew.find(c => c.job === 'Director');
            document.getElementById('director').value = director ? director.name : '';
        const contentType = data.media_type || (data.seasons ? 'tv' : 'movie');
            updateContentTypeToggle(contentType);        
        const posterUrl = data.poster_path ? TMDB_IMAGE_BASE + data.poster_path : 'https://placehold.co/300x450/2D194D/DEF0F7?text=No+Poster';
            document.getElementById('movie-poster-img').src = posterUrl;
            
            document.getElementById('movieForm').dataset.tmdbId = data.id;
            document.getElementById('movieForm').dataset.posterUrl = posterUrl;
            document.getElementById('movieForm').dataset.runtime = data.runtime || (data.episode_run_time ? data.episode_run_time[0] : null);

        togglePublicFieldsReadonly(true);
        isPublicFieldsEditable = false;
    }
    function togglePublicFieldsReadonly(isReadonly) {
        const fields = ['title', 'year', 'director', 'genre', 'summary', 'cast', 'contentType'];
        fields.forEach(id => {
            const el = document.getElementById(id);
            if (el.tagName === 'SELECT') el.disabled = isReadonly;
            else el.readOnly = isReadonly;
        });
    }
    // Simple debounce function to replace LibraryUtils dependency
    function createSimpleDebounce(func, delay) {
        let timeoutId;
        return function(...args) {
            clearTimeout(timeoutId);
            timeoutId = setTimeout(() => func.apply(this, args), delay);
        };
    }
    function populateFormWithTMDBAndUPC(tmdbData, upcData, physicalEdition) {
        // Use TMDB data for all the rich movie info
        document.getElementById('title').value = tmdbData.title || tmdbData.name;
        document.getElementById('year').value = (tmdbData.release_date || tmdbData.first_air_date || '').substring(0, 4);
        document.getElementById('summary').value = tmdbData.overview || 'No summary available';
        document.getElementById('genre').value = tmdbData.genres ? tmdbData.genres.map(g => g.name).join(', ') : '';
        document.getElementById('cast').value = tmdbData.credits && tmdbData.credits.cast ? 
            tmdbData.credits.cast.slice(0, 5).map(c => c.name).join(', ') : '';
        
        const director = tmdbData.credits && tmdbData.credits.crew ? 
            tmdbData.credits.crew.find(c => c.job === 'Director') : null;
        document.getElementById('director').value = director ? director.name : '';
        
        const contentType = tmdbData.media_type || (tmdbData.seasons ? 'tv' : 'movie');
        updateContentTypeToggle(contentType);

        const confidence = tmdbData.matchScore || 0;
            const needsReview = MediaLookupUtils.needsManualReview(tmdbData, upcData.originalTitle, null);
            
            if (needsReview || confidence < 40) {
                showNeedsReviewMessage(tmdbData.title || tmdbData.name, upcData.originalTitle);
            }

        // Use TMDB poster
        const posterUrl = tmdbData.poster_path ? 
            TMDB_IMAGE_BASE + tmdbData.poster_path : 
            'https://placehold.co/300x450/2D194D/DEF0F7?text=No+Poster';
        document.getElementById('movie-poster-img').src = posterUrl;
        
        // Store both TMDB and UPC data in the form
        const form = document.getElementById('movieForm');
        form.dataset.tmdbId = tmdbData.id;
        form.dataset.posterUrl = posterUrl;
        form.dataset.runtime = tmdbData.runtime || (tmdbData.episode_run_time ? tmdbData.episode_run_time[0] : null);

        // Store UPC/barcode data
        form.dataset.upcCode = upcData.barcode;
        form.dataset.upcBrand = upcData.brand;
        form.dataset.upcCategory = upcData.category;
        form.dataset.upcOriginalTitle = upcData.originalTitle;
        form.dataset.upcDescription = upcData.description;
        
        // FIX: If physicalEdition wasn't passed, create it from upcData
        if (!physicalEdition && upcData && window.MediaLookupUtils) {
            physicalEdition = MediaLookupUtils.createPhysicalEditionData(upcData);
        }

        form.dataset.physicalEdition = JSON.stringify(physicalEdition || {});

        // Make fields readonly since we have good data
        togglePublicFieldsReadonly(true);
        isPublicFieldsEditable = false;
        
        console.log('Form populated with TMDB + UPC data:', {
            tmdb: tmdbData.title || tmdbData.name,
            upc: upcData.originalTitle,
            barcode: upcData.barcode
        });

        // FIX: Pass the correct physicalEdition object
        displayPhysicalEditionDetails(physicalEdition, upcData.barcode);
    }
    function displayPhysicalEditionDetails(physicalEdition, barcode) {
        const section = document.getElementById('physicalEditionSection');
        if (!physicalEdition || !barcode) {
            section.style.display = 'none';
            return;
        }
        
        section.style.display = 'block';
        document.getElementById('editionFormat').textContent = physicalEdition.format || 'Unknown';
        document.getElementById('editionType').textContent = physicalEdition.edition || 'Standard';
        document.getElementById('editionRegion').textContent = physicalEdition.region || 'Unknown';
        document.getElementById('editionDistributor').textContent = physicalEdition.distributor || 'Unknown';
        document.getElementById('editionBarcode').textContent = barcode;
        
        const featuresRow = document.getElementById('editionFeaturesRow');
        const featuresSpan = document.getElementById('editionFeatures');
        
        if (physicalEdition.features && physicalEdition.features.length > 0) {
            featuresRow.style.display = 'flex';
            featuresSpan.textContent = physicalEdition.features.join(', ');
        } else {
            featuresRow.style.display = 'none';
        }
    }
    function showNeedsReviewMessage(suggestedTitle, originalTitle) {
        // Populate search with the suggested title
        document.getElementById('movieSearch').value = suggestedTitle;
        
        // Show helpful message
        showStatusMessage(
            `‚ö†Ô∏è Auto-match found "${suggestedTitle}" but confidence is low for "${originalTitle}". please verify this is correct using the search bar above, or search for the right movie.`, 
            'warning'
        );
        
        // Scroll to search section
        document.querySelector('.search-section').scrollIntoView({ 
            behavior: 'smooth', 
            block: 'center' 
        });
        
        // Make fields editable again so user can manually select
        togglePublicFieldsReadonly(false);
        isPublicFieldsEditable = true;
    }
    function createBasicUPCEntry(cleanTitle, upcData) {
        const mockTmdbData = {
            id: `upc_${upcData.barcode}`,
            title: cleanTitle,
            name: cleanTitle,
            overview: upcData.description || 'No description available',
            release_date: '',
            first_air_date: '',
            poster_path: null,
            genres: upcData.category ? [{ name: upcData.category }] : [],
            credits: {
                cast: [],
                crew: upcData.brand ? [{ job: 'Studio', name: upcData.brand }] : []
            },
            media_type: 'movie'
        };
        
        populateFormWithTMDBAndUPC(mockTmdbData, upcData);
        showStatusMessage('Basic entry created with UPC data. You can edit details before saving.', 'info');
    }
    function processAndDisplayResults(data, query, isNewSearch) {
        currentPage = data.page;
        totalPages = data.total_pages;
        totalResults = data.total_results;
        
        const results = data.results.filter(item => item.media_type === 'movie' || item.media_type === 'tv')
            .map(item => ({ ...item, score: calculateRelevanceScore(item, query) }))
            .sort((a, b) => b.score - a.score);
        
        displayResults(results, isNewSearch);
        updateUrl(query, currentPage);
        updateSearchFooter();
    }
    async function selectMedia(id, type, selectedElement) {
    // Visual selection feedback
    if (selectedElement) {
        selectedElement.classList.add('selected');
        const allResults = document.querySelectorAll('.search-result');
        allResults.forEach(result => {
            if (result !== selectedElement) {
                result.style.opacity = '0.5';
                result.style.pointerEvents = 'none';
            }
        });
    }
    
    showMovieSelectionSkeleton();
    
    const cacheKey = `details_${type}_${id}`;
    const cachedData = apiCache.get('details', cacheKey);
    
    if (cachedData) {
        setTimeout(() => {
            hideMovieSelectionSkeleton();
            populateFormWithData(cachedData);
            showStatusMessage('Movie details loaded successfully!', 'success');
            setTimeout(() => {
                document.getElementById('statusMessage').innerHTML = '';
            }, 3000);
        }, 300);
        return;
    }

    try {
        const response = await fetch(`${TMDB_BASE_URL}/${type}/${id}?append_to_response=credits`);
        const data = await response.json();
        
        if (!response.ok) {
            throw new Error('Failed to load movie details');
        }
        
        apiCache.set('details', cacheKey, data);
        hideMovieSelectionSkeleton();
        populateFormWithData(data);
        
        showStatusMessage('Movie details loaded successfully!', 'success');
        setTimeout(() => {
            document.getElementById('statusMessage').innerHTML = '';
        }, 3000);
        
    } catch (error) {
        hideMovieSelectionSkeleton();
        if (selectedElement) {
            selectedElement.classList.remove('selected');
            const allResults = document.querySelectorAll('.search-result');
            allResults.forEach(result => {
                result.style.opacity = '';
                result.style.pointerEvents = '';
            });
        }
        
        console.error('Loading media details error:', error);
        showStatusMessage('Failed to load movie details. Please try again.', 'error');
    }
}
    function showMovieSelectionSkeleton() {
            // Hide the real form and show the skeleton UI
            document.getElementById('movieForm').style.display = 'none';
            document.getElementById('form-skeleton').style.display = 'block';
        }
    function hideMovieSelectionSkeleton() {
            // Hide the skeleton UI and show the real form
            document.getElementById('form-skeleton').style.display = 'none';
            document.getElementById('movieForm').style.display = 'block';
        }
    function validateFormOnMobile() {
        const titleValue = document.getElementById('title').value.trim();
        if (!titleValue) {
            showStatusMessage('Please search for and select a movie first.', 'error');
            
            // Scroll to search section on mobile
            if (window.innerWidth <= 768) {
                document.querySelector('.search-section').scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'start' 
                });
            }
            return false;
        }
        return true;
    }
    function updateContentTypeToggle(selectedValue) {
        const toggleContainer = document.getElementById('contentTypeToggle');
        toggleContainer.querySelectorAll('.content-type-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.value === selectedValue);
        });
    }
// === TEST FUNCTION FOR DEBUGGING UPC API ===
window.testUPCLookup = async function(testBarcode = '883929736171') {
    console.log('üîç Testing UPC lookup with barcode:', testBarcode);
    
    try {
        const response = await fetch(`/api/upc?upc=${testBarcode}`);
        console.log('Response status:', response.status);
        console.log('Response ok:', response.ok);
        
        if (response.ok) {
            const data = await response.json();
            console.log('‚úÖ UPC API Response:', data);
            
            if (data.code === 'OK' && data.items && data.items.length > 0) {
                console.log('üì¶ First item:', data.items[0]);
                console.log('üé¨ Title:', data.items[0].title);
                console.log('üìù Description:', data.items[0].description);
                console.log('üè∑Ô∏è Category:', data.items[0].category);
                console.log('üè¢ Brand:', data.items[0].brand);
            } else {
                console.log('‚ùå No items found or API returned error');
            }
        } else {
            const errorData = await response.json().catch(() => ({}));
            console.log('‚ùå API Error:', errorData);
        }
    } catch (error) {
        console.error('üí• Request failed:', error);
    }
};

(function initializeMobileImprovements() {
    // Only run once when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', setupMobileImprovements);
    } else {
        setupMobileImprovements();
    }
    
    function setupMobileImprovements() {
        // Improve touch targets on mobile
        if (window.innerWidth <= 768) {
            const style = document.createElement('style');
            style.textContent = `
                .search-result {
                    min-height: 60px;
                    touch-action: manipulation;
                }
                .btn {
                    touch-action: manipulation;
                }
                .star-rating-interactive .star {
                    touch-action: manipulation;
                    padding: var(--space-xs);
                }
            `;
            document.head.appendChild(style);
        }
        
        // Prevent zoom on input focus for iOS
        if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
            const inputs = document.querySelectorAll('input, textarea, select');
            inputs.forEach(input => {
                if (parseFloat(getComputedStyle(input).fontSize) < 16) {
                    input.style.fontSize = '16px';
                }
            });
        }
    }
})();
function showStatusMessage(message, type = 'info', duration = 3000) {
    // Remove existing messages
    const existingMessages = document.querySelectorAll('.toast-message');
    existingMessages.forEach(msg => msg.remove());
    
    const statusMessage = document.createElement('div');
    statusMessage.className = `toast-message status-message status-${type}`;
    const iconClass = type === 'success' ? 'icon-confirm' :
        type === 'error' ? 'icon-close' : 'icon-details';
    statusMessage.innerHTML = `<span class="icon ${iconClass} icon-md"></span>${message}`;
    
    // Position it as a toast
    statusMessage.style.position = 'fixed';
    statusMessage.style.top = 'var(--space-xl)';
    statusMessage.style.right = 'var(--space-xl)';
    statusMessage.style.zIndex = 'var(--z-modal)';
    statusMessage.style.minWidth = '300px';
    statusMessage.style.maxWidth = '500px';
    
    document.body.appendChild(statusMessage);
    
    // Auto-remove after duration
    setTimeout(() => {
        statusMessage.remove();
    }, duration);
}

function clearSearchResults() {
    const resultsContainer = document.getElementById('searchResults');
    const footer = document.getElementById('searchFooter');
    const searchInput = document.getElementById('movieSearch');
    
    if (resultsContainer) {
        resultsContainer.innerHTML = '';
        resultsContainer.style.display = 'none';
    }
    
    if (footer) {
        footer.style.display = 'none';
    }
    
    if (searchInput) {
        searchInput.value = '';
    }
}
    </script>
    <footer id="footer-placeholder"></footer>
</body>
</html>
