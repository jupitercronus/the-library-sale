<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>the library sale</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=B612+Mono&family=Dokdo&family=Kirang+Haerang&family=M+PLUS+2&family=Syne+Mono&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-auth-compat.js"></script>
    
    <script src="utils.js" defer></script>
    <link rel="stylesheet" href="styles/variables.css">
    <link rel="stylesheet" href="styles/base.css">  
    <link rel="stylesheet" href="styles/components.css">
    <link rel="stylesheet" href="styles/pages.css">
    <script src="main.js" defer></script>
</head>
<body class="home-page">
    <header id="navbar-placeholder"></header>
    <main class="container">
        <section class="hero-section" style="text-align: center; margin-bottom: var(--space-4xl);">
            <h1>activity feed</h1>
        </section>
    
        <div class="home-layout">
            <div id="activityFeedContainer">
                <div class="activity-item-skeleton">
                    <div class="skeleton activity-skeleton-header"></div>
                    <div class="activity-skeleton-body">
                        <div class="skeleton activity-skeleton-poster"></div>
                        <div class="activity-skeleton-content">
                            <div class="skeleton skeleton-text-line"></div>
                            <div class="skeleton skeleton-text-line short"></div>
                        </div>
                    </div>
                </div>
                <div class="activity-item-skeleton">
                    <div class="skeleton activity-skeleton-header"></div>
                    <div class="activity-skeleton-body">
                        <div class="skeleton activity-skeleton-poster"></div>
                        <div class="activity-skeleton-content">
                            <div class="skeleton skeleton-text-line"></div>
                            <div class="skeleton skeleton-text-line short"></div>
                        </div>
                    </div>
                </div>
            </div>
    
            <aside class="sidebar-feed">
                <section class="latest-comments-section">
                    <h2>latest comments</h2>
                    <div id="latestCommentsContainer">
                        <div class="comment-item-skeleton">
                            <div class="skeleton" style="height: 14px; width: 70%; margin-bottom: 8px;"></div>
                            <div class="skeleton" style="height: 12px; width: 40%;"></div>
                        </div>
                        <div class="comment-item-skeleton">
                            <div class="skeleton" style="height: 14px; width: 80%; margin-bottom: 8px;"></div>
                            <div class="skeleton" style="height: 12px; width: 50%;"></div>
                        </div>
                    </div>
                </section>
    
                <section class="latest-ratings-section">
                    <h2>latest ratings</h2>
                    <div id="latestRatingsContainer">
                        <div class="rating-item-skeleton">
                            <div class="skeleton" style="height: 12px; width: 60%; margin-bottom: 10px;"></div>
                            <div class="skeleton" style="height: 16px; width: 50%;"></div>
                        </div>
                        <div class="rating-item-skeleton">
                            <div class="skeleton" style="height: 12px; width: 70%; margin-bottom: 10px;"></div>
                            <div class="skeleton" style="height: 16px; width: 40%;"></div>
                        </div>
                    </div>
                </section>
            </aside>
    
        </div> 
    </main>

    <footer id="footer-placeholder"></footer>

    <script>
        // --- Firebase & Globals ---
        const firebaseConfig = {
            apiKey: "AIzaSyDDW8LtwpYevdkD7Q-_CxJ23mMfi00P21M",
            authDomain: "tiny-lizard.firebaseapp.com",
            projectId: "tiny-lizard",
            storageBucket: "tiny-lizard.firebasestorage.app",
            messagingSenderId: "250872474692",
            appId: "1:250872474692:web:969e0b1302ae3cb4666011",
        };
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore(); 
        const auth = firebase.auth();
        let currentUser = null;

        // --- Main Logic ---
        document.addEventListener('DOMContentLoaded', () => {
            auth.onAuthStateChanged(user => {
                currentUser = user;
                loadActivityFeed();
                loadLatestComments(); 
                loadLatestRatings();
            });
        });

        async function loadActivityFeed() {
            const feedContainer = document.getElementById('activityFeedContainer');
            
            try {
                // 1. Fetch the most recent interactions using a collectionGroup query
                const interactionsSnapshot = await db.collectionGroup('movieInteractions')
                    .orderBy('interactionDate', 'desc')
                    .limit(20)
                    .get();

                if (interactionsSnapshot.empty) {
                    feedContainer.innerHTML = '<div class="empty-state"><h3>No recent activity</h3><p>Add or rate a movie to get started!</p></div>';
                    return;
                }

                const interactions = interactionsSnapshot.docs.map(doc => ({
                    id: doc.id,
                    userId: doc.ref.path.split('/')[1], // Extract userId from path
                    ...doc.data()
                }));

                // 2. Gather all unique user and movie IDs to fetch their data efficiently
                const userIds = [...new Set(interactions.map(i => i.userId))];
                const movieIds = [...new Set(interactions.map(i => i.movieId))];

                // 3. Fetch all required user and movie data in parallel
                const [userDocs, movieDocs] = await Promise.all([
                    db.collection('users').where(firebase.firestore.FieldPath.documentId(), 'in', userIds).get(),
                    db.collection('movies').where(firebase.firestore.FieldPath.documentId(), 'in', movieIds).get()
                ]);

                // 4. Create Maps for easy data lookup
                const userMap = new Map(userDocs.docs.map(doc => [doc.id, doc.data()]));
                const movieMap = new Map(movieDocs.docs.map(doc => [doc.id, doc.data()]));

                // 5. Render the feed
                renderActivityFeed(interactions, userMap, movieMap);

            } catch (error) {
                console.error("Error loading activity feed:", error);
                feedContainer.innerHTML = '<div class="error-state"><h3>Could not load activity</h3><p>Please try refreshing the page.</p></div>';
            }
        }

        function renderActivityFeed(interactions, userMap, movieMap) {
        const feedContainer = document.getElementById('activityFeedContainer');
        feedContainer.innerHTML = ''; // Clear skeleton

        for (const interaction of interactions) {
            const user = userMap.get(interaction.userId);
            const movie = movieMap.get(interaction.movieId);

            if (!user || !movie) continue; 

            const activityItem = document.createElement('div');
            activityItem.className = 'activity-item';

            // --- THIS IS THE MODIFIED PART ---
            // Create a reusable link for the movie title
            const movieLink = `<a href="library.html?id=${interaction.movieId}" class="activity-movie-link">${movie.title}</a>`;

            let actionText = '';
            let reviewHTML = '';

            if (interaction.review && interaction.review.trim() !== '') {
                // Use the movieLink variable here
                actionText = `wrote a review for <strong>${movieLink}</strong>`;
                reviewHTML = `<div class="activity-review"><p>"${interaction.review}"</p></div>`;
            } else if (interaction.rating > 0) {
                // And here
                actionText = `rated <strong>${movieLink}</strong>`;
            } else if (interaction.watched) {
                // And here
                actionText = `watched <strong>${movieLink}</strong>`;
            } else {
                // And here
                actionText = `added <strong>${movieLink}</strong> to their library`;
            }
            // --- END OF MODIFICATION ---

            const starRating = interaction.rating > 0 
                ? `<div class="star-rating">${generateStarDisplay(interaction.rating)}</div>` 
                : '';

            activityItem.innerHTML = `
                <div class="activity-header">
                    <div class="activity-user-info">
                        <a href="profile.html?id=${interaction.userId}" class="username">${user.displayName || 'Anonymous'}</a>
                        <span class="action-text">${actionText}</span>
                    </div>
                    <span class="activity-timestamp">${formatTimestamp(interaction.interactionDate)}</span>
                </div>
                <div class="activity-body">
                    <a href="library.html?id=${interaction.movieId}" class="activity-poster-link">
                        <img src="${movie.posterUrl || 'https://placehold.co/150x225/2D194D/DEF0F7?text=N/A'}" class="activity-poster" loading="lazy">
                    </a>
                    <div class="activity-content">
                        ${starRating}
                        ${reviewHTML}
                    </div>
                </div>
            `;
            feedContainer.appendChild(activityItem);
        }
    }
        
        async function loadLatestComments() {
            const commentsContainer = document.getElementById('latestCommentsContainer');
            try {
                // This query specifically gets interactions that have a non-empty review
                const commentsSnapshot = await db.collectionGroup('movieInteractions')
                    .where('review', '>', '')
                    .orderBy('review') // Firestore requires ordering by the inequality field first
                    .orderBy('interactionDate', 'desc')
                    .limit(5)
                    .get();

                if (commentsSnapshot.empty) {
                    commentsContainer.innerHTML = '<p>No comments to display yet.</p>';
                    return;
                }

                const comments = commentsSnapshot.docs.map(doc => ({
                    userId: doc.ref.path.split('/')[1],
                    ...doc.data()
                }));

                const userIds = [...new Set(comments.map(c => c.userId))];
                const movieIds = [...new Set(comments.map(c => c.movieId))];

                const [userDocs, movieDocs] = await Promise.all([
                    db.collection('users').where(firebase.firestore.FieldPath.documentId(), 'in', userIds).get(),
                    db.collection('movies').where(firebase.firestore.FieldPath.documentId(), 'in', movieIds).get()
                ]);

                const userMap = new Map(userDocs.docs.map(doc => [doc.id, doc.data()]));
                const movieMap = new Map(movieDocs.docs.map(doc => [doc.id, doc.data()]));

                renderLatestComments(comments, userMap, movieMap);

            } catch (error) {
                console.error("Error loading latest comments:", error);
                // We will add a warning about the needed index later.
            }
        }

        function renderLatestComments(comments, userMap, movieMap) {
            const commentsContainer = document.getElementById('latestCommentsContainer');
            commentsContainer.innerHTML = ''; // Clear skeleton

            for (const comment of comments) {
                const user = userMap.get(comment.userId);
                const movie = movieMap.get(comment.movieId);

                if (!user || !movie) continue;

                const commentItem = document.createElement('div');
                commentItem.className = 'latest-comment-item';
                commentItem.innerHTML = `
                    <p class="comment-text">"${comment.review}"</p>
                    <p class="comment-meta">
                        — <a href="profile.html?id=${comment.userId}" class="username">${user.displayName || 'Anonymous'}</a> 
                        on 
                        <a href="library.html?id=${comment.movieId}" class="movie-title">${movie.title}</a>
                    </p>
                `;
                commentsContainer.appendChild(commentItem);
            }
        }
        
        async function loadLatestRatings() {
            const ratingsContainer = document.getElementById('latestRatingsContainer');
            try {
                // This query gets interactions where a rating has been given (rating > 0)
                const ratingsSnapshot = await db.collectionGroup('movieInteractions')
                    .where('rating', '>', 0)
                    .orderBy('rating') // Firestore requires ordering by the inequality field first
                    .orderBy('interactionDate', 'desc')
                    .limit(5)
                    .get();

                if (ratingsSnapshot.empty) {
                    ratingsContainer.innerHTML = '<p>No ratings to display yet.</p>';
                    return;
                }

                const ratings = ratingsSnapshot.docs.map(doc => ({
                    userId: doc.ref.path.split('/')[1],
                    ...doc.data()
                }));

                const userIds = [...new Set(ratings.map(r => r.userId))];
                const movieIds = [...new Set(ratings.map(r => r.movieId))];

                const [userDocs, movieDocs] = await Promise.all([
                    db.collection('users').where(firebase.firestore.FieldPath.documentId(), 'in', userIds).get(),
                    db.collection('movies').where(firebase.firestore.FieldPath.documentId(), 'in', movieIds).get()
                ]);

                const userMap = new Map(userDocs.docs.map(doc => [doc.id, doc.data()]));
                const movieMap = new Map(movieDocs.docs.map(doc => [doc.id, doc.data()]));

                renderLatestRatings(ratings, userMap, movieMap);

            } catch (error) {
                console.error("Error loading latest ratings:", error);
            }
        }

        function renderLatestRatings(ratings, userMap, movieMap) {
            const ratingsContainer = document.getElementById('latestRatingsContainer');
            ratingsContainer.innerHTML = ''; // Clear skeleton

            for (const rating of ratings) {
                const user = userMap.get(rating.userId);
                const movie = movieMap.get(rating.movieId);

                if (!user || !movie) continue;

                const ratingItem = document.createElement('div');
                ratingItem.className = 'latest-rating-item';
                
                // We reuse the generateStarDisplay function that already exists in your script
                const starsHTML = generateStarDisplay(rating.rating);

                ratingItem.innerHTML = `
                    <p class="rating-meta">
                        <a href="profile.html?id=${rating.userId}" class="username">${user.displayName || 'Anonymous'}</a> 
                        rated 
                        <a href="library.html?id=${rating.movieId}" class="movie-title">${movie.title}</a>
                    </p>
                    <div class="star-rating">${starsHTML}</div>
                `;
                ratingsContainer.appendChild(ratingItem);
            }
        }
        
        
        // Helper function to generate star HTML
        function generateStarDisplay(rating) {
            let starsHTML = '';
            for (let i = 1; i <= 5; i++) {
                if (i <= rating) starsHTML += '<span class="star star-full"></span>';
                else if (i - 0.5 <= rating) starsHTML += '<span class="star star-half"></span>';
                else starsHTML += '<span class="star star-empty"></span>';
            }
            return starsHTML;
        }

        // Helper function to format timestamps
        function formatTimestamp(timestamp) {
            if (!timestamp || !timestamp.toDate) return '';
            const date = timestamp.toDate();
            const now = new Date();
            const diffSeconds = Math.round((now - date) / 1000);
            
            if (diffSeconds < 60) return `${diffSeconds}s ago`;
            const diffMinutes = Math.round(diffSeconds / 60);
            if (diffMinutes < 60) return `${diffMinutes}m ago`;
            const diffHours = Math.round(diffMinutes / 60);
            if (diffHours < 24) return `${diffHours}h ago`;
            const diffDays = Math.round(diffHours / 24);
            return `${diffDays}d ago`;
        }

    </script>
</body>
</html>