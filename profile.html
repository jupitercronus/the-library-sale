<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile - the library sale</title>
    <!-- Google Fonts Import -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=B612+Mono&family=Dokdo&family=Kirang+Haerang&family=M+PLUS+2&family=Syne+Mono&display=swap" rel="stylesheet">
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-auth-compat.js"></script>
    <!-- App Scripts -->
    <script src="utils.js" defer></script>
    <link rel="stylesheet" href="style.css">
    <script src="main.js" defer></script>
    <style>
        .sidebar-search {
            position: relative;
        }
        #userSearchResultsContainer {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background-color: #24143E;
            border: 1px solid #3a2a5c;
            border-radius: 5px;
            z-index: 100;
            max-height: 250px;
            overflow-y: auto;
            display: none;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .user-search-result {
            padding: 10px 15px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .user-search-result:hover {
            background-color: #3a2a5c;
        }
        
        /* Profile-specific skeleton styles */
        .skeleton-sidebar-block {
            background: #2D194D;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .skeleton-username {
            height: 28px;
            width: 80%;
            margin-bottom: 8px;
            border-radius: 4px;
        }
        
        .skeleton-email {
            height: 16px;
            width: 60%;
            margin-bottom: 15px;
            border-radius: 4px;
        }
        
        .skeleton-stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #3a2a5c;
        }
        
        .skeleton-stat-label {
            height: 16px;
            width: 50%;
            border-radius: 4px;
        }
        
        .skeleton-stat-value {
            height: 16px;
            width: 30%;
            border-radius: 4px;
        }
        
        .skeleton-media-section {
            margin-bottom: 40px;
        }
        
        .skeleton-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #90dcff;
            padding-bottom: 10px;
        }
        
        .skeleton-section-title {
            height: 32px;
            width: 120px;
            border-radius: 6px;
        }
        
        .skeleton-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .skeleton-search-input {
            height: 36px;
            width: 200px;
            border-radius: 5px;
        }
        
        .skeleton-dropdown {
            height: 36px;
            width: 150px;
            border-radius: 5px;
        }
        
        .skeleton-profile-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
        }
        
        .skeleton-profile-item {
            aspect-ratio: 1 / 1;
            border-radius: 5px;
            position: relative;
        }
        
        .skeleton-profile-title {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 30px;
            border-radius: 0 0 5px 5px;
        }
    </style>
</head>
<body>
    <header id="navbar-placeholder"></header>

    <div class="profile-page-container">
        <!-- Left Sidebar -->
        <aside class="profile-sidebar">
            <div class="sidebar-block">
                <div class="sidebar-search">
                    <input type="text" id="userSearchInput" placeholder="Find user..." autocomplete="off">
                    <button id="userSearchBtn" class="btn-icon" title="Search Users"></button>
                    <div id="userSearchResultsContainer"></div>
                </div>
            </div>

            <div class="sidebar-block">
                <div id="sidebarUserInfo">
                    <!-- User info will be loaded here -->
                </div>
                 <a href="#" id="myListsLink" class="sidebar-link">My Lists</a>
            </div>

            <div class="sidebar-block">
                <h3>Stats</h3>
                <ul class="sidebar-stats" id="statsList">
                    <!-- Stats will be loaded here -->
                </ul>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="profile-main-content">
            <!-- Owned Media Section -->
            <section id="owned-section">
                <div class="media-section-header">
                    <h2>Owned</h2>
                    <div class="media-section-controls">
                        <input type="text" id="ownedSearchInput" class="media-search-input" placeholder="Search owned media...">
                        <select id="ownedSortDropdown" class="filter-dropdown">
                            <option value="dateAddedDesc">Recently Added (Newest)</option>
                            <option value="dateAddedAsc">Recently Added (Oldest)</option>
                            <option value="titleAsc">Title (A-Z)</option>
                            <option value="titleDesc">Title (Z-A)</option>
                        </select>
                    </div>
                </div>
                <div id="ownedMediaGrid" class="profile-media-grid">
                    <!-- Owned media posters will be loaded here -->
                </div>
            </section>

            <!-- Watched Media Section -->
            <section id="watched-section">
                <div class="media-section-header">
                    <h2>Watched</h2>
                    <div class="media-section-controls">
                        <input type="text" id="watchedSearchInput" class="media-search-input" placeholder="Search watched media...">
                        <select id="watchedSortDropdown" class="filter-dropdown">
                            <option value="dateWatchedDesc">Recently Watched</option>
                            <option value="titleAsc">Title (A-Z)</option>
                            <option value="titleDesc">Title (Z-A)</option>
                            <option value="ratingDesc">Rating (High-Low)</option>
                            <option value="ratingAsc">Rating (Low-High)</option>
                        </select>
                    </div>
                </div>
                <div id="watchedMediaGrid" class="profile-media-grid">
                    <!-- Watched media posters will be loaded here -->
                </div>
            </section>
        </main>
    </div>

    <script>
        const firebaseConfig = {
          apiKey: "AIzaSyDDW8LtwpYevdkD7Q-_CxJ23mMfi00P21M",
          authDomain: "tiny-lizard.firebaseapp.com",
          projectId: "tiny-lizard",
          storageBucket: "tiny-lizard.firebasestorage.app",
          messagingSenderId: "250872474692",
          appId: "1:250872474692:web:969e0b1302ae3cb4666011"
        };
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore(); 
        const auth = firebase.auth(); 

        let currentUser = null;
        let viewedUserId = null;
        let allOwnedMedia = [];
        let allWatchedMedia = [];
        let allUsersCache = [];

        // === SKELETON UI UTILITIES ===
        const ProfileSkeletonUI = {
            showSidebarSkeleton() {
                document.getElementById('sidebarUserInfo').innerHTML = `
                    <div class="skeleton skeleton-username"></div>
                    <div class="skeleton skeleton-email"></div>
                `;
                
                document.getElementById('statsList').innerHTML = Array(9).fill(0).map(() => `
                    <li class="skeleton-stat-item">
                        <div class="skeleton skeleton-stat-label"></div>
                        <div class="skeleton skeleton-stat-value"></div>
                    </li>
                `).join('');
            },

            showMediaGridSkeleton(containerId, count = 12) {
                const container = document.getElementById(containerId);
                container.innerHTML = Array(count).fill(0).map(() => `
                    <div class="skeleton-profile-item">
                        <div class="skeleton" style="width: 100%; height: 100%;"></div>
                        <div class="skeleton skeleton-profile-title"></div>
                    </div>
                `).join('');
            },

            showSectionSkeleton(sectionId) {
                const section = document.getElementById(sectionId);
                const gridId = sectionId === 'owned-section' ? 'ownedMediaGrid' : 'watchedMediaGrid';
                
                // Header is already rendered, just show skeleton grid
                this.showMediaGridSkeleton(gridId, 8);
            },

            showFullPageSkeleton() {
                this.showSidebarSkeleton();
                this.showSectionSkeleton('owned-section');
                this.showSectionSkeleton('watched-section');
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            // Show skeleton immediately
            ProfileSkeletonUI.showFullPageSkeleton();

            const urlParams = new URLSearchParams(window.location.search);
            viewedUserId = urlParams.get('id');

            auth.onAuthStateChanged(user => {
                currentUser = user;
                if (!viewedUserId && user) {
                    viewedUserId = user.uid;
                }
                
                if (viewedUserId) {
                    loadProfileData(viewedUserId);
                } else {
                    window.location.href = 'auth.html';
                }

                fetchAllUsers();
                setupEventListeners();
            });
        });

        function setupEventListeners() {
            const userSearchInput = document.getElementById('userSearchInput');
            const userSearchBtn = document.getElementById('userSearchBtn');
            const userResultsContainer = document.getElementById('userSearchResultsContainer');

            const performUserSearch = (query) => {
                const lowerCaseQuery = query.toLowerCase();
                userResultsContainer.style.display = 'block';

                const filteredUsers = allUsersCache.filter(user =>
                    user.displayName && user.displayName.toLowerCase().includes(lowerCaseQuery)
                ).slice(0, 10);

                if (filteredUsers.length === 0) {
                    userResultsContainer.innerHTML = '<div class="user-search-result">No users found.</div>';
                    return;
                }

                userResultsContainer.innerHTML = filteredUsers.map(user => `
                    <div class="user-search-result" onclick="window.location.href='profile.html?id=${user.id}'">
                        ${user.displayName}
                    </div>
                `).join('');
            };
            
            const debouncedUserSearch = debounce(performUserSearch, 300);

            userSearchInput.addEventListener('input', () => debouncedUserSearch(userSearchInput.value.trim()));
            userSearchInput.addEventListener('focus', () => performUserSearch(userSearchInput.value.trim()));
            userSearchBtn.addEventListener('click', () => userSearchInput.focus());

            document.addEventListener('click', (e) => {
                if (!document.querySelector('.sidebar-search').contains(e.target)) {
                    userResultsContainer.style.display = 'none';
                }
            });

            // Media search listeners
            document.getElementById('ownedSearchInput').addEventListener('input', () => renderMediaGrid('owned'));
            document.getElementById('ownedSortDropdown').addEventListener('change', () => renderMediaGrid('owned'));
            
            document.getElementById('watchedSearchInput').addEventListener('input', () => renderMediaGrid('watched'));
            document.getElementById('watchedSortDropdown').addEventListener('change', () => renderMediaGrid('watched'));
        }

        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), delay);
            };
        }

        async function fetchAllUsers() {
            try {
                const usersSnapshot = await db.collection('users').get();
                allUsersCache = usersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            } catch (error) {
                console.error("Error fetching all users:", error);
            }
        }

        async function loadProfileData(userId) {
            try {
                const userDoc = await db.collection('users').doc(userId).get();
                if (!userDoc.exists) {
                    document.querySelector('.profile-main-content').innerHTML = '<h2>User not found</h2>';
                    return;
                }
                const profileData = userDoc.data();
                populateSidebar(profileData);

                const interactionsSnapshot = await db.collection('users').doc(userId).collection('movieInteractions').get();
                const interactions = interactionsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                if (interactions.length > 0) {
                    const mediaIds = interactions.map(i => i.id);
                    const mediaChunks = [];
                    for (let i = 0; i < mediaIds.length; i += 10) {
                        mediaChunks.push(mediaIds.slice(i, i + 10));
                    }

                    const allMoviesData = {};
                    for (const chunk of mediaChunks) {
                        const mediaSnapshot = await db.collection('movies').where(firebase.firestore.FieldPath.documentId(), 'in', chunk).get();
                        mediaSnapshot.forEach(doc => {
                            allMoviesData[doc.id] = doc.data();
                        });
                    }
                    
                    const fullMediaDetails = interactions.map(interaction => {
                        const mediaData = allMoviesData[interaction.id];
                        return mediaData ? { ...interaction, ...mediaData } : null;
                    }).filter(Boolean);

                    allOwnedMedia = fullMediaDetails.filter(m => m.owned);
                    allWatchedMedia = fullMediaDetails.filter(m => m.watched);
                    
                    calculateAndDisplayStats(fullMediaDetails);
                } else {
                     calculateAndDisplayStats([]);
                }
                
                // Add delay for smooth transition from skeleton
                await new Promise(resolve => setTimeout(resolve, 500));
                
                renderMediaGrid('owned');
                renderMediaGrid('watched');

            } catch (error) {
                console.error("Error loading profile data:", error);
            }
        }

        function populateSidebar(profileData) {
            const userInfoContainer = document.getElementById('sidebarUserInfo');
            const isMyProfile = currentUser && currentUser.uid === viewedUserId;
            
            userInfoContainer.innerHTML = `
                <h2 class="sidebar-username">${profileData.displayName || 'Anonymous'}</h2>
                ${isMyProfile ? `<p class="sidebar-email">${profileData.email}</p>` : ''}
            `;
            
            document.getElementById('myListsLink').href = `lists.html?userId=${viewedUserId}`;
        }
        
        function getTopItems(items, threshold = 3) {
            if (!items || items.length === 0) return 'N/A';
            const counts = items.reduce((acc, item) => {
                if (item) {
                    acc[item] = (acc[item] || 0) + 1;
                }
                return acc;
            }, {});

            const filteredItems = Object.entries(counts).filter(([key, value]) => value > threshold);

            if (filteredItems.length === 0) return 'N/A';

            return filteredItems
                .sort((a, b) => b[1] - a[1])
                .slice(0, 3)
                .map(entry => entry[0])
                .join(', ');
        }

        // Updated favorite decade function with proper logic
        function getFavoriteDecades(watchedItems) {
            if (!watchedItems || watchedItems.length === 0) return 'N/A';
            
            const decadeCounts = watchedItems
                .filter(item => item.year)
                .reduce((acc, item) => {
                    const decade = `${Math.floor(item.year / 10) * 10}s`;
                    acc[decade] = (acc[decade] || 0) + 1;
                    return acc;
                }, {});

            // Filter decades with more than 25 items
            const filteredDecades = Object.entries(decadeCounts)
                .filter(([decade, count]) => count > 25);

            if (filteredDecades.length === 0) return 'N/A';

            return filteredDecades
                .sort((a, b) => b[1] - a[1])
                .slice(0, 3)
                .map(entry => entry[0])
                .join(', ');
        }
        
        function generateStarDisplay(rating) {
            if (!rating || rating <= 0) return '<div class="media-rating"></div>'; 

            const totalStars = 5;
            let starsHTML = '';
            
            for (let i = 1; i <= totalStars; i++) {
                if (i <= rating) {
                    starsHTML += `<span class="star star-full"></span>`;
                } else if (i - 0.5 <= rating) {
                    starsHTML += `<span class="star star-half"></span>`;
                } else {
                    starsHTML += `<span class="star star-empty"></span>`;
                }
            }
            
            return `<div class="media-rating">${starsHTML}</div>`;
        }

        function calculateAndDisplayStats(mediaItems) {
            const statsList = document.getElementById('statsList');
            const watchedItems = mediaItems.filter(item => item.watched);

            const watchedCount = watchedItems.length;
            const ownedCount = mediaItems.filter(item => item.owned).length;
            
            const ratedItems = mediaItems.filter(item => item.rating && item.rating > 0);
            const avgRatingValue = ratedItems.length > 0
                ? (ratedItems.reduce((sum, item) => sum + item.rating, 0) / ratedItems.length)
                : 0;
            const avgRatingStars = generateStarDisplay(avgRatingValue);
            
            const hoursWatched = Math.round(
                watchedItems
                    .filter(item => item.runtime)
                    .reduce((sum, item) => sum + parseInt(item.runtime), 0) / 60
            );

            const reviewsWritten = mediaItems.filter(item => item.review && item.review.trim() !== '').length;
            
            const topGenre = getTopItems(watchedItems.flatMap(item => (item.genre || '').split(',').map(g => g.trim()).filter(Boolean)), 0);
            const favoriteDecade = getFavoriteDecades(watchedItems); // Updated function call
            const topDirectors = getTopItems(watchedItems.flatMap(item => (item.director || '').split(',').map(d => d.trim()).filter(Boolean)));
            const topCast = getTopItems(watchedItems.flatMap(item => Array.isArray(item.cast) ? item.cast.map(c => c.trim()).filter(Boolean) : []));

            statsList.innerHTML = `
                <li class="stat-stars"><strong>Avg. Rating:</strong> <span>${avgRatingStars}</span></li>
                <li><strong>Media Owned:</strong> <span>${ownedCount}</span></li>
                <li><strong>Media Watched:</strong> <span>${watchedCount}</span></li>
                <li><strong>Hours Watched:</strong> <span>${hoursWatched}</span></li>
                <li><strong>Reviews Written:</strong> <span>${reviewsWritten}</span></li>
                <li><strong>Top Genre:</strong> <span>${topGenre}</span></li>
                <li><strong>Favorite Decade:</strong> <span>${favoriteDecade}</span></li>
                <li><strong>Top Directors:</strong> <span>${topDirectors}</span></li>
                <li><strong>Top Cast:</strong> <span>${topCast}</span></li>
            `;
        }
        
        function renderMediaGrid(type) {
            const isOwned = type === 'owned';
            const sourceData = isOwned ? allOwnedMedia : allWatchedMedia;
            const gridContainer = document.getElementById(isOwned ? 'ownedMediaGrid' : 'watchedMediaGrid');
            const searchInput = document.getElementById(isOwned ? 'ownedSearchInput' : 'watchedSearchInput').value.toLowerCase();
            const sortValue = document.getElementById(isOwned ? 'ownedSortDropdown' : 'watchedSortDropdown').value;

            let mediaToDisplay = [...sourceData];

            if (searchInput) {
                mediaToDisplay = mediaToDisplay.filter(item => 
                    (item.title || '').toLowerCase().includes(searchInput)
                );
            }

            mediaToDisplay.sort((a, b) => {
                switch (sortValue) {
                    case 'titleAsc': return (a.title || '').localeCompare(b.title || '');
                    case 'titleDesc': return (b.title || '').localeCompare(a.title || '');
                    case 'dateAddedDesc': return (b.interactionDate?.seconds || 0) - (a.interactionDate?.seconds || 0);
                    case 'dateAddedAsc': return (a.interactionDate?.seconds || 0) - (b.interactionDate?.seconds || 0);
                    case 'dateWatchedDesc': return (b.interactionDate?.seconds || 0) - (a.interactionDate?.seconds || 0);
                    case 'ratingDesc': return (b.rating || 0) - (a.rating || 0);
                    case 'ratingAsc': return (a.rating || 0) - (b.rating || 0);
                    default: return 0;
                }
            });

            if (mediaToDisplay.length === 0) {
                gridContainer.innerHTML = `<p class="empty-grid-message">No media found.</p>`;
                return;
            }

            gridContainer.innerHTML = mediaToDisplay.map(item => {
                const badgeHTML = item.contentType === 'tv' 
                    ? `<span class="badge badge-tv" title="TV Show"></span>` 
                    : `<span class="badge badge-movie" title="Movie"></span>`;
                
                return `
                <div class="profile-media-item">
                    ${badgeHTML}
                    <a href="library.html?id=${item.id}">
                        <img src="${item.posterUrl || 'https://placehold.co/300x300/2D194D/DEF0F7?text=No+Poster'}" alt="${item.title || 'Untitled'}" loading="lazy" onerror="this.onerror=null;this.src='https://placehold.co/300x300/2D194D/DEF0F7?text=Error';">
                        <div class="profile-media-title">${item.title || 'Untitled'}</div>
                    </a>
                </div>
            `}).join('');
        }
    </script>
</body>
</html>