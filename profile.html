<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile - the library sale</title>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-auth-compat.js"></script>
    <script src="utils.js" defer></script>
    <link rel="stylesheet" href="style.css">
    <script src="main.js" defer></script>
</head>
<body>
    <div>
        <header id="navbar-placeholder"></header>
        <!-- The rest of your page content -->
    </div>

    <div class="main-container">
        <div class="user-search-section">
            <input type="text" id="userSearchInput" placeholder="Find user by username...">
            <button onclick="searchForUser()">Search</button>
        </div>

        <div id="profileContainer">
            <!-- Initial skeleton loading state -->
        </div>
    </div>

    <script>
        const firebaseConfig = {
          apiKey: "AIzaSyDDW8LtwpYevdkD7Q-_CxJ23mMfi00P21M",
          authDomain: "tiny-lizard.firebaseapp.com",
          projectId: "tiny-lizard",
          storageBucket: "tiny-lizard.firebasestorage.app",
          messagingSenderId: "250872474692",
          appId: "1:250872474692:web:969e0b1302ae3cb4666011"
        };
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore(); 
        const auth = firebase.auth(); 

        let currentUser = null;

        // === SKELETON UI UTILITIES ===
        const SkeletonUI = {
            showProfileSkeleton: (containerId) => {
                const container = document.getElementById(containerId);
                container.innerHTML = `
                    <div class="profile-section">
                        <div class="skeleton-profile-header">
                            <div class="skeleton skeleton-profile-name"></div>
                            <div class="skeleton skeleton-profile-email"></div>
                        </div>
                        <div class="skeleton-stats-grid">
                            <div class="skeleton-stat-card">
                                <div class="skeleton skeleton-stat-number"></div>
                                <div class="skeleton skeleton-stat-label"></div>
                            </div>
                            <div class="skeleton-stat-card">
                                <div class="skeleton skeleton-stat-number"></div>
                                <div class="skeleton skeleton-stat-label"></div>
                            </div>
                            <div class="skeleton-stat-card">
                                <div class="skeleton skeleton-stat-number"></div>
                                <div class="skeleton skeleton-stat-label"></div>
                            </div>
                            <div class="skeleton-stat-card">
                                <div class="skeleton skeleton-stat-number"></div>
                                <div class="skeleton skeleton-stat-label"></div>
                            </div>
                            <div class="skeleton-stat-card">
                                <div class="skeleton skeleton-stat-number"></div>
                                <div class="skeleton skeleton-stat-label"></div>
                            </div>
                        </div>
                    </div>
                    <h2 class="section-title">Watched Media</h2>
                    <div class="media-list-section">
                        <div id="watchedMediaList" class="media-list-grid">
                            ${SkeletonUI.generateMediaGridSkeleton(6)}
                        </div>
                    </div>
                    <h2 class="section-title">Owned Media</h2>
                    <div class="media-list-section">
                        <div id="ownedMediaList" class="media-list-grid">
                            ${SkeletonUI.generateMediaGridSkeleton(6)}
                        </div>
                    </div>
                `;
            },

            generateMediaGridSkeleton: (count) => {
                return Array(count).fill(0).map(() => `
                    <div class="skeleton-media-item">
                        <div class="skeleton skeleton-media-poster"></div>
                        <div class="skeleton skeleton-media-title"></div>
                    </div>
                `).join('');
            },

            showMediaGridSkeleton: (containerId, count = 6) => {
                const container = document.getElementById(containerId);
                // ✅ CORRECTED: Changed 'this' to 'SkeletonUI'
                container.innerHTML = SkeletonUI.generateMediaGridSkeleton(count);
            },

            showLoadingSpinner: (containerId, message = 'Loading...') => {
                const container = document.getElementById(containerId);
                container.innerHTML = `
                    <div class="loading-container">
                        <div class="loading-spinner"></div>
                        <div class="loading-text">${message}</div>
                    </div>
                `;
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const profileUserId = urlParams.get('id');

            // 識 SKELETON LOADING IMPLEMENTATION - Show profile skeleton immediately
            SkeletonUI.showProfileSkeleton('profileContainer');

            auth.onAuthStateChanged(user => {
                currentUser = user;
                const authBtn = document.getElementById('authBtn');
                authBtn.textContent = user ? 'Logout' : 'Login';
                
                if (user) {
                    document.getElementById('profileNav').href = `profile.html?id=${user.uid}`;
                } else {
                     document.getElementById('profileNav').href = `auth.html`;
                }

                const targetUserId = profileUserId || (currentUser ? currentUser.uid : null);

                if (targetUserId) {
                    loadProfileData(targetUserId);
                } else {
                    window.location.href = 'auth.html';
                }
            });
            
            document.getElementById('authBtn').addEventListener('click', handleAuthButtonClick);
        });

        async function handleAuthButtonClick() {
            if (currentUser) {
                await auth.signOut();
            } else {
                window.location.href = 'auth.html';
            }
        }
        
        async function searchForUser() {
            const username = LibraryUtils.validation.sanitizeInput(document.getElementById('userSearchInput').value);
            if (!username) return;
            
            try {
                const usersRef = db.collection('users');
                const snapshot = await usersRef.where('displayName', '==', username).limit(1).get();
                if (snapshot.empty) {
                    LibraryUtils.errors.showErrorModal('Not Found', 'User not found.');
                } else {
                    const userId = snapshot.docs[0].id;
                    window.location.href = `profile.html?id=${userId}`;
                }
            } catch (error) {
                LibraryUtils.errors.handleError(error, "Searching for user");
            }
        }

        async function loadProfileData(userId) {
            try {
                // 識 SKELETON LOADING IMPLEMENTATION - Show loading spinner
                SkeletonUI.showLoadingSpinner('profileContainer', 'Loading profile...');

                let userDoc = await db.collection('users').doc(userId).get();

                if (!userDoc.exists && currentUser && currentUser.uid === userId) {
                    console.log("User profile not found for current user. Creating one now...");
                    const newUserProfile = {
                        displayName: currentUser.displayName || currentUser.email.split('@')[0],
                        email: currentUser.email,
                        dateCreated: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    await db.collection('users').doc(userId).set(newUserProfile);
                    userDoc = await db.collection('users').doc(userId).get();
                } else if (!userDoc.exists) {
                    throw new Error("User not found.");
                }

                const profileData = userDoc.data();
                
                // Create the basic profile structure first
                document.getElementById('profileContainer').innerHTML = `
                    <div class="profile-section">
                        <div class="profile-header">
                            <h1 id="profileDisplayName">${profileData.displayName || 'User'}</h1>
                            <p id="profileEmail">${profileData.email}</p>
                        </div>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-number" id="totalMediaCount">0</div>
                                <div class="stat-label">Total Media in Collection</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="watchedMediaCount">0</div>
                                <div class="stat-label">Watched</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="ownedMediaCount">0</div>
                                <div class="stat-label">Owned Physical Copies</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="avgRating">0.0</div>
                                <div class="stat-label">Average Rating</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="totalHours">0</div>
                                <div class="stat-label">Hours Watched</div>
                            </div>
                        </div>
                    </div>
                    <h2 class="section-title">Watched Media</h2>
                    <div class="media-list-section">
                        <div id="watchedMediaList" class="media-list-grid">
                            <div class="empty-list">Loading watched media...</div>
                        </div>
                    </div>
                    <h2 class="section-title">Owned Media</h2>
                    <div class="media-list-section">
                        <div id="ownedMediaList" class="media-list-grid">
                            <div class="empty-list">Loading owned media...</div>
                        </div>
                    </div>
                `;

                const interactionsSnapshot = await db.collection('users').doc(userId).collection('movieInteractions').get();
                const interactions = interactionsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                if (interactions.length === 0) {
                    calculateAndDisplayStats([]);
                    displayWatchedMedia([]);
                    displayOwnedMedia([]);
                    return;
                }

                const mediaIds = interactions.map(i => i.id);
                
                const mediaSnapshot = await db.collection('movies').where(firebase.firestore.FieldPath.documentId(), 'in', mediaIds).get();
                const allMoviesData = {};
                mediaSnapshot.forEach(doc => {
                    allMoviesData[doc.id] = doc.data();
                });

                const fullMediaDetails = interactions.map(interaction => {
                    const mediaData = allMoviesData[interaction.id];
                    return { ...interaction, ...mediaData };
                });

                calculateAndDisplayStats(fullMediaDetails);
                displayWatchedMedia(fullMediaDetails.filter(m => m.watched));
                displayOwnedMedia(fullMediaDetails.filter(m => m.owned));

            } catch (error) {
                LibraryUtils.errors.handleError(error, 'Loading Profile Data', 'profileContainer');
            }
        }

        function calculateAndDisplayStats(mediaItems) {
            document.getElementById('totalMediaCount').textContent = mediaItems.length;
            document.getElementById('watchedMediaCount').textContent = mediaItems.filter(item => item.watched).length;
            document.getElementById('ownedMediaCount').textContent = mediaItems.filter(item => item.owned).length;
            
            const ratedItems = mediaItems.filter(item => item.rating > 0);
            const avgRating = ratedItems.length > 0
                ? (ratedItems.reduce((sum, item) => sum + item.rating, 0) / ratedItems.length).toFixed(1)
                : '0.0';
            document.getElementById('avgRating').textContent = avgRating;
            
            const totalHours = Math.round(
                mediaItems
                    .filter(item => item.watched && item.runtime)
                    .reduce((sum, item) => sum + parseInt(item.runtime), 0) / 60
            );
            document.getElementById('totalHours').textContent = totalHours;
        }

        function displayWatchedMedia(watchedItems) {
            const container = document.getElementById('watchedMediaList');
            
            // 識 SKELETON LOADING IMPLEMENTATION
            SkeletonUI.showMediaGridSkeleton('watchedMediaList', 6);
            
            // Small delay to show the skeleton
            setTimeout(() => {
                if (watchedItems.length === 0) {
                    container.innerHTML = '<div class="empty-list">No watched media yet.</div>';
                    return;
                }
                watchedItems.sort((a, b) => new Date(b.watchedDate) - new Date(a.watchedDate));
                container.innerHTML = watchedItems.map(item => renderMediaItem(item)).join('');
            }, 300);
        }

        function displayOwnedMedia(ownedItems) {
            const container = document.getElementById('ownedMediaList');
            
            // 識 SKELETON LOADING IMPLEMENTATION
            SkeletonUI.showMediaGridSkeleton('ownedMediaList', 6);
            
            // Small delay to show the skeleton
            setTimeout(() => {
                if (ownedItems.length === 0) {
                    container.innerHTML = '<div class="empty-list">No owned media yet.</div>';
                    return;
                }
                ownedItems.sort((a,b) => (a.title || '').localeCompare(b.title || ''));
                container.innerHTML = ownedItems.map(item => renderMediaItem(item)).join('');
            }, 300);
        }
        
        function renderMediaItem(item) {
            const title = item.title || 'Untitled';
            const posterHTML = item.posterUrl 
                ? `<img src="${item.posterUrl}" alt="${title}" class="media-list-poster" loading="lazy" onerror="this.onerror=null;this.parentElement.innerHTML = '<div class=\\'no-poster-small\\'></div>';">`
                : `<div class="no-poster-small"></div>`;

            return `
                <a href="library.html?id=${item.id}" class="media-list-item">
                    ${posterHTML}
                    <p>${title}</p>
                </a>
            `;
        }
    </script>
</body>
</html>
