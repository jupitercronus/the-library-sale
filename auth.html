<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login / Sign Up - the library sale</title>
    <!-- Google Fonts Import -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=B612+Mono&family=Dokdo&family=Kirang+Haerang&family=M+PLUS+2&family=Syne+Mono&display=swap" rel="stylesheet">
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>
    <!-- Utils -->
    <link rel="stylesheet" href="styles/variables.css">
    <link rel="stylesheet" href="styles/base.css">  
    <link rel="stylesheet" href="styles/components.css">
    <link rel="stylesheet" href="styles/pages.css">    
    <script src="utils.js"></script>
    <script src="modal-manager.js"></script>
</head>
<body class="auth-page">

    <div class="page-container">
        <h1 id="authTitle">login to the library sale</h1>
        <form id="authForm">
            <div class="form-group" id="displayNameGroup" style="display: none;">
                <label for="displayName">username</label>
                <input type="text" id="displayName" placeholder="Choose a username">
                <div class="field-error" id="displayNameError"></div>
            </div>
            <div class="form-group">
                <label for="email">email</label>
                <input type="email" id="email" required placeholder="your.email@example.com">
                <div class="field-error" id="emailError"></div>
            </div>
            <div class="form-group">
                <label for="password">password</label>
                <input type="password" id="password" required placeholder="Min 6 characters">
                <div class="field-error" id="passwordError"></div>
            </div>
            <div class="auth-form-actions">
                <button type="submit" id="authSubmitBtn" class="btn btn-lg btn-success" title="Confirm">
                    <i class="icon icon-confirm"></i>
                </button>
            </div>
        </form>
        <div id="authMessage"></div>
        <div class="switch-mode">
            <span id="switchText">Don't have an account? </span><a href="#" id="toggleAuthMode">Sign Up</a>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDDW8LtwpYevdkD7Q-_CxJ23mMfi00P21M",
            authDomain: "tiny-lizard.firebaseapp.com",
            projectId: "tiny-lizard",
            storageBucket: "tiny-lizard.firebasestorage.app",
            messagingSenderId: "250872474692",
            appId: "1:250872474692:web:969e0b1302ae3cb4666011",
            measurementId: "G-43FM6WR90B"
        };

        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth(); 
        const db = firebase.firestore(); 

        let isLoginMode = true; 
        
        document.addEventListener('DOMContentLoaded', function() {
            const authTitle = document.getElementById('authTitle');
            const toggleAuthModeLink = document.getElementById('toggleAuthMode');
            const switchText = document.getElementById('switchText');
            const authForm = document.getElementById('authForm');
            const authMessageDiv = document.getElementById('authMessage');
            const displayNameGroup = document.getElementById('displayNameGroup'); 
            const displayNameInput = document.getElementById('displayName');
            const authSubmitBtn = document.getElementById('authSubmitBtn');

            auth.onAuthStateChanged(user => {
                if (user) {
                    ensureUserProfileExists(user).then(() => {
                        window.location.href = 'index.html';
                    });
                }
            });

            setupValidation();

            toggleAuthModeLink.addEventListener('click', function(e) {
                e.preventDefault();
                isLoginMode = !isLoginMode;
                if (isLoginMode) {
                    authTitle.textContent = 'Login';
                    switchText.textContent = "Don't have an account? ";
                    toggleAuthModeLink.textContent = 'Sign Up';
                    displayNameGroup.style.display = 'none'; 
                    displayNameInput.removeAttribute('required'); 
                } else {
                    authTitle.textContent = 'Sign Up';
                    switchText.textContent = 'Already have an account? ';
                    toggleAuthModeLink.textContent = 'Login';
                    displayNameGroup.style.display = 'block'; 
                    displayNameInput.setAttribute('required', 'true'); 
                }
                authMessageDiv.style.display = 'none';
                clearValidationErrors();
            });

            authForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                if (!validateForm()) return;
                
                // This will now correctly show a spinner without text
                LibraryUtils.ui.setButtonLoading(authSubmitBtn);
                authMessageDiv.style.display = 'none';

                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                const displayName = document.getElementById('displayName').value; 

                try {
                    if (isLoginMode) {
                        await auth.signInWithEmailAndPassword(email, password);
                    } else {
                        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                        await userCredential.user.updateProfile({ displayName: displayName });
                    }
                } catch (error) {
                    console.error('Authentication Error:', error);
                    displayAuthMessage(LibraryUtils.errors.getUserFriendlyMessage(error.message), 'error');
                } finally {
                    // This will correctly stop the spinner
                    LibraryUtils.ui.resetButton(authSubmitBtn);
                }
            });

            async function ensureUserProfileExists(user) {
                const userRef = db.collection('users').doc(user.uid);
                const userDoc = await userRef.get();
                if (!userDoc.exists) {
                    try {
                        await userRef.set({
                            displayName: user.displayName || user.email.split('@')[0],
                            email: user.email,
                            dateCreated: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    } catch (error) {
                        console.error("Failed to create user profile:", error);
                    }
                }
            }
            
            function setupValidation() {
                document.getElementById('email').addEventListener('blur', validateEmail);
                document.getElementById('password').addEventListener('blur', validatePassword);
                document.getElementById('displayName').addEventListener('blur', validateDisplayName);
            }

            function validateForm() {
                const isEmailValid = validateEmail();
                const isPasswordValid = validatePassword();
                const isDisplayNameValid = isLoginMode ? true : validateDisplayName();
                return isEmailValid && isPasswordValid && isDisplayNameValid;
            }

            function validateEmail() {
                const input = document.getElementById('email');
                if (!LibraryUtils.validation.isValidEmail(input.value)) {
                    showFieldError('email', 'Please enter a valid email address.');
                    return false;
                }
                clearFieldError('email');
                return true;
            }

            function validatePassword() {
                const input = document.getElementById('password');
                if (input.value.length < 6) {
                    showFieldError('password', 'Password must be at least 6 characters.');
                    return false;
                }
                clearFieldError('password');
                return true;
            }
            
            function validateDisplayName() {
                const input = document.getElementById('displayName');
                if (!input.value.trim()) {
                    showFieldError('displayName', 'Username is required for sign up.');
                    return false;
                }
                clearFieldError('displayName');
                return true;
            }

            function showFieldError(field, message) {
                document.getElementById(field).classList.add('error');
                const errorDiv = document.getElementById(`${field}Error`);
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
            }

            function clearFieldError(field) {
                document.getElementById(field).classList.remove('error');
                document.getElementById(`${field}Error`).style.display = 'none';
            }
            
            function clearValidationErrors() {
                ['email', 'password', 'displayName'].forEach(clearFieldError);
            }

            function displayAuthMessage(message, type) {
                authMessageDiv.textContent = message;
                authMessageDiv.className = type;
                authMessageDiv.style.display = 'block';
            }
        });
    </script>
    <div id="footer-placeholder"></div>
</body>
</html>
