<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create New List - the library sale</title>
    
    <!-- Google Fonts Import -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=B612+Mono&family=Dokdo&family=Kirang+Haerang&family=M+PLUS+2&family=Syne+Mono&display=swap" rel="stylesheet">
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-auth-compat.js"></script>
    
    <!-- App Utilities -->
    <script src="utils.js"></script>
    <script src="modal-manager.js"></script>
    <script src="scanner-utils.js"></script>
    <script src="cache.js"></script>
    <script src="search-ui.js"></script> 

    <!-- Styles -->
    <link rel="stylesheet" href="styles/variables.css">
    <link rel="stylesheet" href="styles/base.css">  
    <link rel="stylesheet" href="styles/components.css">
    <link rel="stylesheet" href="styles/pages.css">
    
    <!-- Main Script -->
    <script src="main.js" defer></script>
</head>
<body>
    <header id="navbar-placeholder"></header>

    <main class="main-container view-list-container">
        <section class="hero-section">
            <h1 class="hero-title">Create New List</h1>
        </section>

        <form id="createListForm">
            <div class="list-header">
                <input type="text" id="listName" class="list-name-input" placeholder="My Awesome List" required>
                <p id="creatorName"></p>
            </div>
            
            <div class="form-group">
                <label for="listDescription">Description</label>
                <textarea id="listDescription" 
                         class="list-description-textarea" 
                         placeholder="A description for my awesome list..."
                         rows="3"></textarea>
            </div>
            
            <div class="privacy-control">
                <label>List Visibility:</label>
                <div class="privacy-toggle-group">
                    <button type="button" id="publicBtn" class="privacy-btn active" data-value="true">
                        <span class="icon icon-list icon-sm"></span>
                        Public
                    </button>
                    <button type="button" id="privateBtn" class="privacy-btn" data-value="false">
                        <span class="icon icon-close icon-sm"></span>
                        Private
                    </button>
                </div>
            </div>
        </form>

        <hr class="list-divider">
        
        <div class="status-message status-info">
            <span class="icon icon-list icon-md"></span>
            You can add media after creating the list.
        </div>

        <div class="edit-list-actions">
            <button type="submit" form="createListForm" class="btn btn-xl btn-success" title="Create List">
                <span class="icon icon-confirm icon-xl"></span>
            </button>
            <button onclick="history.back()" class="btn btn-xl btn-secondary" title="Go Back">
                <span class="icon icon-back icon-xl"></span>
            </button>
        </div>
    </main>

    <script>
        const firebaseConfig = {
          apiKey: "AIzaSyDDW8LtwpYevdkD7Q-_CxJ23mMfi00P21M",
          authDomain: "tiny-lizard.firebaseapp.com",
          projectId: "tiny-lizard",
          storageBucket: "tiny-lizard.firebasestorage.app",
          messagingSenderId: "250872474692",
          appId: "1:250872474692:web:969e0b1302ae3cb4666011"
        };
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore(); 
        const auth = firebase.auth();

        let currentUser = null;
        let isPublic = true;
    
    const SkeletonUI = {
            showCreateListSkeleton: () => {
                document.getElementById('listName').placeholder = 'Loading...';
                document.getElementById('listName').disabled = true;
                document.getElementById('creatorName').innerHTML = '<div class="skeleton" style="width: 120px; height: 1em;"></div>';
            },
            hideCreateListSkeleton: () => {
                document.getElementById('listName').placeholder = 'My Awesome List';
                document.getElementById('listName').disabled = false;
            }
        };
    document.addEventListener('authStateReady', (e) => {
        currentUser = e.detail.user;
        if (currentUser) {
            // Show skeleton briefly for smooth UX
            SkeletonUI.showCreateListSkeleton();
            setTimeout(() => {
                SkeletonUI.hideCreateListSkeleton();
                document.getElementById('creatorName').innerHTML = `by <a href="profile.html?id=${currentUser.uid}">${currentUser.displayName || 'Anonymous'}</a>`;
            }, 300);
        } else {
            // This page requires a user, so redirect if not logged in.
            window.location.href = 'auth.html';
        }
    });
    document.addEventListener('DOMContentLoaded', () => {
        // This listener now only handles page-specific UI events.
        document.getElementById('createListForm').addEventListener('submit', handleCreateList);
        
        const publicBtn = document.getElementById('publicBtn');
        const privateBtn = document.getElementById('privateBtn');
        
        publicBtn.addEventListener('click', () => {
            isPublic = true;
            publicBtn.classList.add('active');
            privateBtn.classList.remove('active');
        });

        privateBtn.addEventListener('click', () => {
            isPublic = false;
            privateBtn.classList.add('active');
            publicBtn.classList.remove('active');
        });
    });   
    async function handleCreateList(e) {
            e.preventDefault();
            if (!currentUser) {
                alert("You must be logged in to create a list.");
                return;
            }

            const listName = document.getElementById('listName').value.trim();
            const description = document.getElementById('listDescription').value.trim();

            if (!listName) {
                // Show error using status message component
                const existingMessage = document.querySelector('.status-message.status-error');
                if (existingMessage) existingMessage.remove();
                
                const errorMessage = document.createElement('div');
                errorMessage.className = 'status-message status-error';
                errorMessage.innerHTML = '<span class="icon icon-close icon-md"></span>List name is required.';
                document.getElementById('createListForm').after(errorMessage);
                
                setTimeout(() => errorMessage.remove(), 3000);
                return;
            }

            const saveButton = document.querySelector('button[type="submit"]');
            saveButton.classList.add('saving');

            try {
                const newList = {
                    listName: listName,
                    description: description,
                    isPublic: isPublic,
                    creatorId: currentUser.uid,
                    creatorDisplayName: currentUser.displayName || currentUser.email,
                    mediaIds: [], // Start with an empty list
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                const docRef = await db.collection('lists').add(newList);
                
                // Show success message briefly before redirect
                const successMessage = document.createElement('div');
                successMessage.className = 'status-message status-success';
                successMessage.innerHTML = '<span class="icon icon-confirm icon-md"></span>List created successfully!';
                document.getElementById('createListForm').after(successMessage);
                
                setTimeout(() => {
                    window.location.href = `edit-list.html?id=${docRef.id}`;
                }, 1000);

            } catch (error) {
                console.error("Error creating list:", error);
                
                const errorMessage = document.createElement('div');
                errorMessage.className = 'status-message status-error';
                errorMessage.innerHTML = '<span class="icon icon-close icon-md"></span>There was an error creating the list. Please try again.';
                document.getElementById('createListForm').after(errorMessage);
                
                saveButton.classList.remove('saving');
                setTimeout(() => errorMessage.remove(), 5000);
            }
        }
    </script>
    <footer id="footer-placeholder"></footer>
</body>
</html>