<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create New List - the library sale</title>
    <!-- Google Fonts Import -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=B612+Mono&family=Dokdo&family=Kirang+Haerang&family=M+PLUS+2&family=Syne+Mono&display=swap" rel="stylesheet">
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-auth-compat.js"></script>
    <!-- App Scripts -->
    <script src="utils.js" defer></script>
    <link rel="stylesheet" href="style.css">
    <script src="main.js" defer></script>
</head>
<body>
    <header id="navbar-placeholder"></header>

    <div class="main-container view-list-container">
        <form id="createListForm">
            <!-- FIX: This layout is now controlled by new CSS rules in style.css -->
            <div class="list-header">
                <input type="text" id="listName" class="list-name-input" placeholder="My Awesome List" required>
                <p id="creatorName"></p>
            </div>
            <textarea id="listDescription" class="list-description-textarea" placeholder="A description for my awesome list..."></textarea>
            
            <div class="privacy-control">
                <label>List Visibility:</label>
                <div class="privacy-toggle-group">
                    <button type="button" id="publicBtn" class="privacy-btn active" data-value="true">Public</button>
                    <button type="button" id="privateBtn" class="privacy-btn" data-value="false">Private</button>
                </div>
            </div>
        </form>

        <hr class="list-divider">
        <p style="text-align: center; color: #aaa;">You can add media after creating the list.</p>

        <div class="edit-list-actions">
            <button type="submit" form="createListForm" class="btn-save-list" title="Create List"></button>
            <button onclick="history.back()" class="btn-back" title="Go Back"></button>
        </div>
    </div>

    <script>
        const firebaseConfig = {
          apiKey: "AIzaSyDDW8LtwpYevdkD7Q-_CxJ23mMfi00P21M",
          authDomain: "tiny-lizard.firebaseapp.com",
          projectId: "tiny-lizard",
          storageBucket: "tiny-lizard.firebasestorage.app",
          messagingSenderId: "250872474692",
          appId: "1:250872474692:web:969e0b1302ae3cb4666011"
        };
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore(); 
        const auth = firebase.auth();

        let currentUser = null;
        let isPublic = true;


        // Add skeleton utilities
        const SkeletonUI = {
            showCreateListSkeleton: () => {
                document.getElementById('listName').placeholder = 'Loading...';
                document.getElementById('creatorName').innerHTML = '<div class="skeleton skeleton-text" style="width: 120px; height: 16px;"></div>';
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            auth.onAuthStateChanged(user => {
                if (user) {
                    currentUser = user;
                    // Small delay to show skeleton briefly
                    setTimeout(() => {
                        document.getElementById('listName').placeholder = 'My Awesome List';
                        document.getElementById('creatorName').innerHTML = `by <a href="profile.html?id=${currentUser.uid}">${currentUser.displayName || 'Anonymous'}</a>`;
                    }, 300);
                } else {
                    window.location.href = 'auth.html';
                }
            });
            document.getElementById('createListForm').addEventListener('submit', handleCreateList);
            
            // Privacy toggle logic
            const publicBtn = document.getElementById('publicBtn');
            const privateBtn = document.getElementById('privateBtn');
            
            publicBtn.addEventListener('click', () => {
                isPublic = true;
                publicBtn.classList.add('active');
                privateBtn.classList.remove('active');
            });

            privateBtn.addEventListener('click', () => {
                isPublic = false;
                privateBtn.classList.add('active');
                publicBtn.classList.remove('active');
            });
        });
        
        async function handleCreateList(e) {
            e.preventDefault();
            if (!currentUser) {
                alert("You must be logged in to create a list.");
                return;
            }

            const listName = document.getElementById('listName').value.trim();
            const description = document.getElementById('listDescription').value.trim();

            if (!listName) {
                alert("List name is required.");
                return;
            }

            const saveButton = document.querySelector('.btn-save-list');
            saveButton.classList.add('saving');

            try {
                const newList = {
                    listName: listName,
                    description: description,
                    isPublic: isPublic,
                    creatorId: currentUser.uid,
                    creatorDisplayName: currentUser.displayName || currentUser.email,
                    mediaIds: [], // Start with an empty list
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                const docRef = await db.collection('lists').add(newList);
                
                // Redirect to the edit page for the newly created list
                window.location.href = `edit-list.html?id=${docRef.id}`;

            } catch (error) {
                console.error("Error creating list:", error);
                alert("There was an error creating the list. Please try again.");
                saveButton.classList.remove('saving');
            }
        }
    </script>
</body>
</html>
