<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lists - the library sale</title>
    <!-- Google Fonts Import -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=B612+Mono&family=Dokdo&family=Kirang+Haerang&family=M+PLUS+2&family=Syne+Mono&display=swap" rel="stylesheet">
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-auth-compat.js"></script>
    
    <!-- App Utilities -->
    <script src="utils.js"></script>
    <script src="modal-manager.js"></script>
    <script src="cache.js"></script>
    <script src="scanner-utils.js"></script>
    <script src="search-ui.js"></script> 

    <!-- Styles -->
    <link rel="stylesheet" href="styles/variables.css">
    <link rel="stylesheet" href="styles/base.css">  
    <link rel="stylesheet" href="styles/components.css">
    <link rel="stylesheet" href="styles/pages.css">
    
    <!-- Main Script -->
    <script src="main.js" defer></script>
</head>
<body>
    <header id="navbar-placeholder"></header>

    <main class="main-container">
        <section class="hero-section">
            <h1 class="hero-title">Lists</h1>
        </section>

        <section class="controls-section">
            <div class="search-bar">
                <input type="text" id="listSearchInput" placeholder="Search for a list...">
                <button class="btn btn-md btn-primary" id="searchBtn" title="Search">
                    <span class="icon icon-search icon-md"></span>
                </button>
            </div>
            
            <div class="list-controls">
                <select id="sortDropdown" class="filter-dropdown">
                    <option value="createdAtDesc">Recently Created</option>
                    <option value="createdAtAsc">Oldest</option>
                    <option value="nameAsc">Name (A-Z)</option>
                    <option value="nameDesc">Name (Z-A)</option>
                </select>
                <button id="myListsBtn" class="list-toggle-btn">My Lists</button>
                <button id="allListsBtn" class="list-toggle-btn active">All Lists</button>
                <a href="create-list.html" class="btn btn-lg btn-primary" title="Create New List">
                    <span class="icon icon-add icon-lg"></span>
                </a>
            </div>
        </section>

        <div id="listGrid" class="list-grid">
            <!-- Loading skeleton will be shown initially -->
            <div class="loading-container">
                <div class="loading-content">
                    <div class="loading-spinner"></div>
                    <p class="loading-text">Loading lists...</p>
                </div>
            </div>
        </div>
    </main>
    
    <!-- Confirmation Modal using proper component structure -->
    <div id="confirmationModal" class="modal">
        <div class="modal-content">
            <h3 id="confirmationModalTitle">Confirm Deletion</h3>
            <p id="confirmationModalMessage">Are you sure you want to permanently delete this list? This action cannot be undone.</p>
            <div class="modal-buttons">
                <button class="btn btn-lg btn-danger" id="confirmModalYes" title="Delete List">
                    <span class="icon icon-delete icon-lg"></span>
                </button>
                <button class="btn btn-lg btn-secondary" id="confirmModalNo" title="Cancel">
                    <span class="icon icon-close icon-lg"></span>
                </button>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
          apiKey: "AIzaSyDDW8LtwpYevdkD7Q-_CxJ23mMfi00P21M",
          authDomain: "tiny-lizard.firebaseapp.com",
          projectId: "tiny-lizard",
          storageBucket: "tiny-lizard.firebasestorage.app",
          messagingSenderId: "250872474692",
          appId: "1:250872474692:web:969e0b1302ae3cb4666011"
        };
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        let currentUser = null;
        let allLists = [];
        let currentView = 'all'; 

        // Enhanced skeleton utilities using CSS component classes
        const SkeletonUI = {
            showListGridSkeleton: (count = 9) => {
                const grid = document.getElementById('listGrid');
                const skeletonHTML = Array(count).fill(0).map(() => `
                    <div class="list-card">
                        <div class="list-poster skeleton">
                            <!-- Skeleton poster area -->
                        </div>
                        <div class="list-info">
                            <div class="skeleton" style="height: 1.5em; width: 80%; margin-bottom: var(--space-sm);"></div>
                            <div class="skeleton" style="height: 1em; width: 60%; margin-bottom: var(--space-md);"></div>
                            <div class="list-actions gap-sm">
                                <div class="skeleton btn btn-sm"></div>
                                <div class="skeleton btn btn-sm"></div>
                            </div>
                        </div>
                    </div>
                `).join('');
                grid.innerHTML = skeletonHTML;
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            auth.onAuthStateChanged(user => {
                currentUser = user;
                if (!user) {
                    window.location.href = 'auth.html';
                } else {
                    document.getElementById('myListsBtn').style.display = 'inline-block';
                    loadLists();
                }
            });

            setupEventListeners();
        });

        const ListCache = {
            cache: new Map(),
            
            // Cache list data with movie posters
            cacheList(listId, listData) {
                this.cache.set(listId, {
                    data: listData,
                    timestamp: Date.now()
                });
                
                // Also cache in localStorage
                const cacheKey = `list_${listId}`;
                try {
                    localStorage.setItem(cacheKey, JSON.stringify({
                        data: listData,
                        timestamp: Date.now()
                    }));
                } catch (e) {
                    console.warn('Could not cache list:', e);
                }
            },

             getCachedList(listId) {
        const maxAge = 60 * 60 * 1000; // 1 hour
        
        // Check memory cache first
        const memCached = this.cache.get(listId);
        if (memCached && Date.now() - memCached.timestamp < maxAge) {
            return memCached.data;
        }
        
        // Check localStorage
        const cacheKey = `list_${listId}`;
        try {
            const stored = localStorage.getItem(cacheKey);
            if (stored) {
                const parsed = JSON.parse(stored);
                if (Date.now() - parsed.timestamp < maxAge) {
                    // Refresh memory cache
                    this.cache.set(listId, parsed);
                    return parsed.data;
                }
            }
        } catch (e) {
            localStorage.removeItem(cacheKey);
        }
        
        return null;
    }
};

        function setupEventListeners() {
            document.getElementById('listSearchInput').addEventListener('input', renderLists);
            document.getElementById('sortDropdown').addEventListener('change', renderLists);
            document.getElementById('myListsBtn').addEventListener('click', () => setView('my'));
            document.getElementById('allListsBtn').addEventListener('click', () => setView('all'));
        }

        function setView(view) {
            if (view === 'my' && !currentUser) {
                window.location.href = 'auth.html';
                return;
            }
            currentView = view;
            document.getElementById('myListsBtn').classList.toggle('active', view === 'my');
            document.getElementById('allListsBtn').classList.toggle('active', view === 'all');
            renderLists();
        }

        async function loadLists() {
            SkeletonUI.showListGridSkeleton(9);
            const grid = document.getElementById('listGrid');
    
                try {
                    // Check cache first
                    const cacheKey = 'all_lists';
                    const cached = ListCache.getCachedList(cacheKey);
                    if (cached) {
                        console.log('üìã Using cached lists');
                        allLists = cached;
                        renderLists();
                        return; // Skip Firestore query!
                    }
        
                    console.log('üîç Loading lists from Firestore');

                    const listsRef = db.collection('lists');
                    let query = listsRef.where('isPublic', '==', true);
                    
                    if (currentView === 'my' && currentUser) {
                        query = listsRef.where('creatorId', '==', currentUser.uid);
                    }
            
                    const listSnapshot = await db.collection('lists')
                        .where('isPublic', '==', true)
                        .orderBy('createdAt', 'desc')
                        .get();
        
                    const listDocs = listSnapshot.docs;

                    // Gather all unique movie IDs from the lists
                    const allMovieIds = new Set();
                    listDocs.forEach(doc => {
                        const mediaIds = doc.data().mediaIds;
                        if (mediaIds && mediaIds.length > 0) {
                            mediaIds.slice(0, 3).forEach(id => allMovieIds.add(id));
                        }
                    });

                    // Fetch all required movie documents in batches
                    const movieDataMap = new Map();
                    if (allMovieIds.size > 0) {
                        const movieIdsArray = Array.from(allMovieIds);
                        const moviePromises = [];
                        for (let i = 0; i < movieIdsArray.length; i += 10) {
                            const chunk = movieIdsArray.slice(i, i + 10);
                            moviePromises.push(db.collection('movies').where(firebase.firestore.FieldPath.documentId(), 'in', chunk).get());
                        }
                        const movieSnapshots = await Promise.all(moviePromises);
                        movieSnapshots.forEach(snapshot => {
                            snapshot.forEach(doc => {
                                movieDataMap.set(doc.id, doc.data());
                            });
                        });


                }

                // Combine list data with poster data
                const combinedLists = {};
                listDocs.forEach(doc => {
                    const list = { id: doc.id, ...doc.data() };
                    list.posterUrls = [];
                    if (list.mediaIds && list.mediaIds.length > 0) {
                        list.posterUrls = list.mediaIds
                            .slice(0, 3)
                            .map(id => movieDataMap.get(id)?.posterUrl)
                            .filter(Boolean);
                    }
                    combinedLists[doc.id] = list;
                });

                allLists = Object.values(combinedLists);
                renderLists();

            ListCache.cacheList(cacheKey, allLists);
            
            } catch (error) {
                console.error("Error loading lists:", error);
                const grid = document.getElementById('listGrid');
                grid.innerHTML = '<div class="error-state"><h3>Error Loading Lists</h3><p>Please check your connection and try again.</p></div>';
            }
        }

        function generatePosterCollageHTML(urls) {
            if (!urls || urls.length === 0) {
                return '<div class="no-poster-text">No Posters</div>';
            }

            if (urls.length < 2) {
                return `<img src="${urls[0]}" alt="List poster" class="single-poster-img" onerror="this.style.display='none'; this.parentElement.innerHTML = '<div class=\\'no-poster-text\\'>No Poster</div>';">`;
            }

            const mainImage = urls[0];
            const sideImage1 = urls[1];
            const sideImage2 = urls[2];

            let sideImagesHTML = `<img src="${sideImage1}" alt="List poster collage" onerror="this.style.display='none';">`;
            if (sideImage2) {
                sideImagesHTML += `<img src="${sideImage2}" alt="List poster collage" onerror="this.style.display='none';">`;
            }

            return `
                <div class="list-poster-collage">
                    <div class="collage-main">
                        <img src="${mainImage}" alt="Main list poster" onerror="this.style.display='none';">
                    </div>
                    ${sideImagesHTML}
                </div>
            `;
        }

        function renderLists() {
            const grid = document.getElementById('listGrid');
            const searchTerm = document.getElementById('listSearchInput').value.toLowerCase();
            const sort = document.getElementById('sortDropdown').value;

            let listsToDisplay = [...allLists];

            if (currentView === 'my') {
                if (currentUser) {
                    listsToDisplay = listsToDisplay.filter(list => list.creatorId === currentUser.uid);
                } else {
                    listsToDisplay = [];
                }
            } else {
                listsToDisplay = listsToDisplay.filter(list => list.isPublic);
            }
            
            if (searchTerm) {
                listsToDisplay = listsToDisplay.filter(list => 
                    list.listName.toLowerCase().includes(searchTerm) ||
                    (list.creatorDisplayName || '').toLowerCase().includes(searchTerm)
                );
            }

            listsToDisplay.sort((a, b) => {
                switch (sort) {
                    case 'nameAsc': return a.listName.localeCompare(b.listName);
                    case 'nameDesc': return b.listName.localeCompare(a.listName);
                    case 'createdAtAsc': return (a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0);
                    case 'createdAtDesc': default: return (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0);
                }
            });

            if (listsToDisplay.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <span class="icon icon-list icon-3xl"></span>
                        <h3>No lists found</h3>
                        <p>Try adjusting your search or create a new list!</p>
                        <a href="create-list.html" class="btn btn-lg btn-primary">
                            <span class="icon icon-add icon-lg"></span>
                            Create New List
                        </a>
                    </div>
                `;
                return;
            }

            grid.innerHTML = listsToDisplay.map(list => {
                const isOwner = currentUser && currentUser.uid === list.creatorId;
                
                let actionsHTML = `
                    <a href="view-list.html?id=${list.id}" class="btn btn-sm btn-primary" title="View Details">
                        <span class="icon icon-details icon-sm"></span>
                    </a>
                `;

                if (isOwner) {
                    actionsHTML += `
                        <a href="edit-list.html?id=${list.id}" class="btn btn-sm btn-secondary" title="Edit List">
                            <span class="icon icon-edit icon-sm"></span>
                        </a>
                        <button class="btn btn-sm btn-danger" onclick="confirmDeleteList('${list.id}')" title="Delete List">
                            <span class="icon icon-delete icon-sm"></span>
                        </button>
                    `;
                }
                
                const posterHTML = generatePosterCollageHTML(list.posterUrls);

                return `
                    <div class="list-card">
                        <a href="view-list.html?id=${list.id}" class="list-card-link" title="View ${list.listName}">
                            <div class="list-poster">
                                ${posterHTML}
                            </div>
                        </a>
                        <div class="list-info">
                            <h3><a href="view-list.html?id=${list.id}" class="list-card-link" title="View ${list.listName}">${list.listName}</a></h3>
                            <p>by <a href="profile.html?id=${list.creatorId}" title="View ${list.creatorDisplayName || 'Anonymous'}'s Profile">${list.creatorDisplayName || 'Anonymous'}</a></p>
                            <div class="list-actions flex gap-sm">
                                ${actionsHTML}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function confirmDeleteList(listId) {
            const modal = document.getElementById('confirmationModal');
            modal.classList.add('active');

            const yesBtn = document.getElementById('confirmModalYes');
            const noBtn = document.getElementById('confirmModalNo');

            const yesHandler = () => {
                modal.classList.remove('active');
                deleteList(listId);
            };
            const noHandler = () => {
                modal.classList.remove('active');
            };

            yesBtn.addEventListener('click', yesHandler, { once: true });
            noBtn.addEventListener('click', noHandler, { once: true });
        }

        async function deleteList(listId) {
            if (!currentUser) return;
            try {
                await db.collection('lists').doc(listId).delete();
                loadLists();
            } catch (error) {
                console.error("Error deleting list:", error);
                alert('There was an error deleting the list.');
            }
        }
    </script>
    <footer id="footer-placeholder"></footer>
</body>
</html>