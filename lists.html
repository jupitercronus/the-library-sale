<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lists - the library sale</title>
    <!-- Google Fonts Import -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=B612+Mono&family=Dokdo&family=Kirang+Haerang&family=M+PLUS+2&family=Syne+Mono&display=swap" rel="stylesheet">
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-auth-compat.js"></script>
    <!-- App Scripts -->
    <script src="utils.js" defer></script>
    <link rel="stylesheet" href="style.css">
    <script src="main.js" defer></script>
    <!-- Custom styles for clickable list items -->
    <style>
        .list-card-link {
            text-decoration: none;
            color: inherit;
            display: block; /* Ensures the poster link behaves like a block */
        }
        .list-card-link .list-poster {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .list-card-link:hover .list-poster {
            transform: scale(1.03);
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        .list-info h3 .list-card-link:hover {
            color: #fdfb76;
        }
    </style>
</head>
<body>
    <header id="navbar-placeholder"></header>

    <div class="main-container">
        <div class="controls-section">
            <div class="search-bar">
                <input type="text" id="listSearchInput" placeholder="Search for a list...">
            </div>
            <div class="list-controls">
                <select id="sortDropdown" class="filter-dropdown">
                    <option value="createdAtDesc">Recently Created</option>
                    <option value="createdAtAsc">Oldest</option>
                    <option value="nameAsc">Name (A-Z)</option>
                    <option value="nameDesc">Name (Z-A)</option>
                </select>
                <button id="myListsBtn" class="list-toggle-btn">My Lists</button>
                <button id="allListsBtn" class="list-toggle-btn active">All Lists</button>
                <a href="create-list.html" class="btn-create-list" title="Create New List"></a>
            </div>
        </div>

        <div id="listGrid" class="list-grid">
            <!-- Lists will be loaded here by JavaScript -->
        </div>
    </div>
    
    <div id="confirmationModal" class="modal">
        <div class="modal-content">
            <h3 id="confirmationModalTitle">Confirm Action</h3>
            <p id="confirmationModalMessage">Are you sure?</p>
            <div class="modal-buttons">
                <button class="modal-btn confirm" id="confirmModalYes" title="Yes"></button>
                <button class="modal-btn cancel" id="confirmModalNo" title="No"></button>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
          apiKey: "AIzaSyDDW8LtwpYevdkD7Q-_CxJ23mMfi00P21M",
          authDomain: "tiny-lizard.firebaseapp.com",
          projectId: "tiny-lizard",
          storageBucket: "tiny-lizard.firebasestorage.app",
          messagingSenderId: "250872474692",
          appId: "1:250872474692:web:969e0b1302ae3cb4666011"
        };
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        let currentUser = null;
        let allLists = [];
        let currentView = 'all'; 

        document.addEventListener('DOMContentLoaded', () => {
            auth.onAuthStateChanged(user => {
                currentUser = user;
                // FIX: Redirect to auth page if not logged in
                if (!user) {
                    window.location.href = 'auth.html';
                } else {
                    document.getElementById('myListsBtn').style.display = 'inline-block';
                    loadLists();
                }
            });

            setupEventListeners();
        });

        function setupEventListeners() {
            document.getElementById('listSearchInput').addEventListener('input', renderLists);
            document.getElementById('sortDropdown').addEventListener('change', renderLists);
            document.getElementById('myListsBtn').addEventListener('click', () => setView('my'));
            document.getElementById('allListsBtn').addEventListener('click', () => setView('all'));
        }

        function setView(view) {
            // FIX: If user clicks "My Lists" but is not logged in, redirect them.
            if (view === 'my' && !currentUser) {
                window.location.href = 'auth.html';
                return;
            }
            currentView = view;
            document.getElementById('myListsBtn').classList.toggle('active', view === 'my');
            document.getElementById('allListsBtn').classList.toggle('active', view === 'all');
            renderLists();
        }

        async function loadLists() {
            const grid = document.getElementById('listGrid');
            grid.innerHTML = '<p>Loading lists...</p>';
            try {
                // Step 1: Fetch the lists themselves
                const listsRef = db.collection('lists');
                let query = listsRef.where('isPublic', '==', true);
                
                // If showing "My Lists", we adjust the query
                if (currentView === 'my' && currentUser) {
                    query = listsRef.where('creatorId', '==', currentUser.uid);
                }
                
                const listSnapshots = await query.get();
                const listDocs = listSnapshots.docs;

                // Step 2: Gather all unique movie IDs from the lists
                const allMovieIds = new Set();
                listDocs.forEach(doc => {
                    const mediaIds = doc.data().mediaIds;
                    if (mediaIds && mediaIds.length > 0) {
                        mediaIds.slice(0, 3).forEach(id => allMovieIds.add(id));
                    }
                });

                // Step 3: Fetch all required movie documents in batches
                const movieDataMap = new Map();
                if (allMovieIds.size > 0) {
                    const movieIdsArray = Array.from(allMovieIds);
                    const moviePromises = [];
                    // Use chunks of 10 for 'in' query to be safe
                    for (let i = 0; i < movieIdsArray.length; i += 10) {
                        const chunk = movieIdsArray.slice(i, i + 10);
                        moviePromises.push(db.collection('movies').where(firebase.firestore.FieldPath.documentId(), 'in', chunk).get());
                    }
                    const movieSnapshots = await Promise.all(moviePromises);
                    movieSnapshots.forEach(snapshot => {
                        snapshot.forEach(doc => {
                            movieDataMap.set(doc.id, doc.data());
                        });
                    });
                }

                // Step 4: Combine list data with poster data
                const combinedLists = {};
                listDocs.forEach(doc => {
                    const list = { id: doc.id, ...doc.data() };
                    list.posterUrls = [];
                    if (list.mediaIds && list.mediaIds.length > 0) {
                        list.posterUrls = list.mediaIds
                            .slice(0, 3)
                            .map(id => movieDataMap.get(id)?.posterUrl)
                            .filter(Boolean); // Filter out any undefined URLs
                    }
                    combinedLists[doc.id] = list;
                });

                allLists = Object.values(combinedLists);
                renderLists();

            } catch (error) {
                console.error("Error loading lists:", error);
                grid.innerHTML = '<p>Error loading lists. Please check your Firestore security rules and indexes.</p>';
            }
        }
        
        function generatePosterCollageHTML(urls) {
            if (!urls || urls.length === 0) {
                return '<div class="no-poster-text">No Posters</div>';
            }

            // Fallback: Single poster
            if (urls.length < 2) {
                return `<img src="${urls[0]}" alt="List poster" class="single-poster-img" onerror="this.style.display='none'; this.parentElement.innerHTML = '<div class=\\'no-poster-text\\'>No Poster</div>';">`;
            }

            // Layout B: One large, two (or one) small
            const mainImage = urls[0];
            const sideImage1 = urls[1];
            const sideImage2 = urls[2]; // This might be undefined

            let sideImagesHTML = `<img src="${sideImage1}" alt="List poster collage" onerror="this.style.display='none';">`;
            if (sideImage2) {
                sideImagesHTML += `<img src="${sideImage2}" alt="List poster collage" onerror="this.style.display='none';">`;
            }

            return `
                <div class="list-poster-collage">
                    <div class="collage-main">
                        <img src="${mainImage}" alt="Main list poster" onerror="this.style.display='none';">
                    </div>
                    ${sideImagesHTML}
                </div>
            `;
        }


        function renderLists() {
            const grid = document.getElementById('listGrid');
            const searchTerm = document.getElementById('listSearchInput').value.toLowerCase();
            const sort = document.getElementById('sortDropdown').value;

            let listsToDisplay = [...allLists];

            if (currentView === 'my') {
                if (currentUser) {
                    listsToDisplay = listsToDisplay.filter(list => list.creatorId === currentUser.uid);
                } else {
                    listsToDisplay = [];
                }
            } else {
                // For "All Lists", filter only for public lists
                listsToDisplay = listsToDisplay.filter(list => list.isPublic);
            }
            
            if (searchTerm) {
                listsToDisplay = listsToDisplay.filter(list => 
                    list.listName.toLowerCase().includes(searchTerm) ||
                    (list.creatorDisplayName || '').toLowerCase().includes(searchTerm)
                );
            }

            listsToDisplay.sort((a, b) => {
                switch (sort) {
                    case 'nameAsc': return a.listName.localeCompare(b.listName);
                    case 'nameDesc': return b.listName.localeCompare(a.listName);
                    case 'createdAtAsc': return (a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0);
                    case 'createdAtDesc': default: return (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0);
                }
            });

            if (listsToDisplay.length === 0) {
                grid.innerHTML = `<div class="empty-state" style="text-align:center; color: #aaa; padding: 40px; grid-column: 1 / -1;"><h3>No lists found.</h3><p>Try adjusting your search or create a new list!</p></div>`;
                return;
            }

            grid.innerHTML = listsToDisplay.map(list => {
                const isOwner = currentUser && currentUser.uid === list.creatorId;
                
                let actionsHTML = `<a href="view-list.html?id=${list.id}" class="btn-small btn-details" title="View Details"></a>`;

                if (isOwner) {
                    actionsHTML += `
                        <a href="edit-list.html?id=${list.id}" class="btn-small btn-edit" title="Edit List"></a>
                        <button class="btn-small btn-delete" onclick="confirmDeleteList('${list.id}')" title="Delete List"></button>
                    `;
                }
                
                const posterHTML = generatePosterCollageHTML(list.posterUrls);

                return `
                    <div class="list-card">
                        <a href="view-list.html?id=${list.id}" class="list-card-link" title="View ${list.listName}">
                            <div class="list-poster">
                                ${posterHTML}
                            </div>
                        </a>
                        <div class="list-info">
                            <h3><a href="view-list.html?id=${list.id}" class="list-card-link" title="View ${list.listName}">${list.listName}</a></h3>
                            <p>by <a href="profile.html?id=${list.creatorId}" title="View ${list.creatorDisplayName || 'Anonymous'}'s Profile">${list.creatorDisplayName || 'Anonymous'}</a></p>
                            <div class="list-actions">
                                ${actionsHTML}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function confirmDeleteList(listId) {
            const modal = document.getElementById('confirmationModal');
            document.getElementById('confirmationModalTitle').textContent = 'Delete List';
            document.getElementById('confirmationModalMessage').textContent = 'Are you sure you want to permanently delete this list? This action cannot be undone.';
            modal.style.display = 'flex';

            const yesBtn = document.getElementById('confirmModalYes');
            const noBtn = document.getElementById('confirmModalNo');

            const yesHandler = () => {
                modal.style.display = 'none';
                deleteList(listId);
            };
            const noHandler = () => {
                modal.style.display = 'none';
            };

            yesBtn.addEventListener('click', yesHandler, { once: true });
            noBtn.addEventListener('click', noHandler, { once: true });
        }

        async function deleteList(listId) {
            if (!currentUser) return;
            try {
                await db.collection('lists').doc(listId).delete();
                loadLists();
            } catch (error) {
                console.error("Error deleting list:", error);
                alert('There was an error deleting the list.');
            }
        }
    </script>
</body>
</html>
