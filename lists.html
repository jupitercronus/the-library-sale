<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lists - the library sale</title>
    <!-- Google Fonts Import -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=B612+Mono&family=Dokdo&family=Kirang+Haerang&family=M+PLUS+2&family=Syne+Mono&display=swap" rel="stylesheet">
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-auth-compat.js"></script>
    <!-- App Scripts -->
    <script src="utils.js" defer></script>
    <link rel="stylesheet" href="style.css">
    <script src="main.js" defer></script>
</head>
<body>
    <header id="navbar-placeholder"></header>

    <div class="main-container">
        <div class="controls-section">
            <div class="search-bar">
                <input type="text" id="listSearchInput" placeholder="Search for a list...">
            </div>
            <div class="list-controls">
                <select id="sortDropdown" class="filter-dropdown">
                    <option value="createdAtDesc">Recently Created</option>
                    <option value="createdAtAsc">Oldest</option>
                    <option value="nameAsc">Name (A-Z)</option>
                    <option value="nameDesc">Name (Z-A)</option>
                </select>
                <button id="myListsBtn" class="list-toggle-btn">My Lists</button>
                <button id="allListsBtn" class="list-toggle-btn active">All Lists</button>
                <a href="create-list.html" class="btn-create-list" title="Create New List"></a>
            </div>
        </div>

        <div id="listGrid" class="list-grid">
            <!-- Lists will be loaded here by JavaScript -->
        </div>
    </div>
    
    <div id="confirmationModal" class="modal">
        <div class="modal-content">
            <h3 id="confirmationModalTitle">Confirm Action</h3>
            <p id="confirmationModalMessage">Are you sure?</p>
            <div class="modal-buttons">
                <button class="modal-btn confirm" id="confirmModalYes" title="Yes"></button>
                <button class="modal-btn cancel" id="confirmModalNo" title="No"></button>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
          apiKey: "AIzaSyDDW8LtwpYevdkD7Q-_CxJ23mMfi00P21M",
          authDomain: "tiny-lizard.firebaseapp.com",
          projectId: "tiny-lizard",
          storageBucket: "tiny-lizard.firebasestorage.app",
          messagingSenderId: "250872474692",
          appId: "1:250872474692:web:969e0b1302ae3cb4666011"
        };
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        let currentUser = null;
        let allLists = [];
        let currentView = 'all'; 

        document.addEventListener('DOMContentLoaded', () => {
            auth.onAuthStateChanged(user => {
                currentUser = user;
                if (!currentUser) {
                    document.getElementById('myListsBtn').style.display = 'none';
                }
                loadLists();
            });

            setupEventListeners();
        });

        function setupEventListeners() {
            document.getElementById('listSearchInput').addEventListener('input', renderLists);
            document.getElementById('sortDropdown').addEventListener('change', renderLists);
            document.getElementById('myListsBtn').addEventListener('click', () => setView('my'));
            document.getElementById('allListsBtn').addEventListener('click', () => setView('all'));
        }

        function setView(view) {
            currentView = view;
            document.getElementById('myListsBtn').classList.toggle('active', view === 'my');
            document.getElementById('allListsBtn').classList.toggle('active', view === 'all');
            renderLists();
        }

        async function loadLists() {
            const grid = document.getElementById('listGrid');
            grid.innerHTML = '<p>Loading lists...</p>';
            try {
                const snapshot = await db.collection('lists').get();
                allLists = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderLists();
            } catch (error) {
                console.error("Error loading lists:", error);
                grid.innerHTML = '<p>Error loading lists. Please try again later.</p>';
            }
        }

        function renderLists() {
            const grid = document.getElementById('listGrid');
            const searchTerm = document.getElementById('listSearchInput').value.toLowerCase();
            const sort = document.getElementById('sortDropdown').value;

            let listsToDisplay = [...allLists];

            if (currentView === 'my') {
                if (currentUser) {
                    listsToDisplay = listsToDisplay.filter(list => list.creatorId === currentUser.uid);
                } else {
                    listsToDisplay = [];
                }
            } else {
                 listsToDisplay = listsToDisplay.filter(list => list.isPublic || (currentUser && list.creatorId === currentUser.uid));
            }

            if (searchTerm) {
                listsToDisplay = listsToDisplay.filter(list => 
                    list.listName.toLowerCase().includes(searchTerm) ||
                    (list.creatorDisplayName || '').toLowerCase().includes(searchTerm)
                );
            }

            listsToDisplay.sort((a, b) => {
                switch (sort) {
                    case 'nameAsc':
                        return a.listName.localeCompare(b.listName);
                    case 'nameDesc':
                        return b.listName.localeCompare(a.listName);
                    case 'createdAtAsc':
                        return (a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0);
                    case 'createdAtDesc':
                    default:
                        return (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0);
                }
            });

            if (listsToDisplay.length === 0) {
                grid.innerHTML = `<div class="empty-state" style="text-align:center; color: #aaa; padding: 40px; grid-column: 1 / -1;"><h3>No lists found.</h3><p>Try adjusting your search or create a new list!</p></div>`;
                return;
            }

            grid.innerHTML = listsToDisplay.map(list => {
                const isOwner = currentUser && currentUser.uid === list.creatorId;
                
                let actionsHTML = `
                    <a href="view-list.html?id=${list.id}" class="btn-small btn-details" title="View Details"></a>
                `;

                if (isOwner) {
                    actionsHTML += `
                        <a href="edit-list.html?id=${list.id}" class="btn-small btn-edit" title="Edit List"></a>
                        <button class="btn-small btn-delete" onclick="confirmDeleteList('${list.id}')" title="Delete List"></button>
                    `;
                }

                return `
                    <div class="list-card">
                        <div class="list-poster">
                           <!-- In a real app, you might fetch a poster image from the first item in the list -->
                           ${list.listName.substring(0, 12)}
                        </div>
                        <div class="list-info">
                            <h3>${list.listName}</h3>
                            <p>by <a href="profile.html?id=${list.creatorId}" title="View ${list.creatorDisplayName || 'Anonymous'}'s Profile">${list.creatorDisplayName || 'Anonymous'}</a></p>
                            <div class="list-actions">
                                ${actionsHTML}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function confirmDeleteList(listId) {
            const modal = document.getElementById('confirmationModal');
            document.getElementById('confirmationModalTitle').textContent = 'Delete List';
            document.getElementById('confirmationModalMessage').textContent = 'Are you sure you want to permanently delete this list? This action cannot be undone.';
            modal.style.display = 'flex';

            const yesBtn = document.getElementById('confirmModalYes');
            const noBtn = document.getElementById('confirmModalNo');

            const yesHandler = () => {
                modal.style.display = 'none';
                deleteList(listId);
                yesBtn.removeEventListener('click', yesHandler);
            };

            const noHandler = () => {
                modal.style.display = 'none';
                noBtn.removeEventListener('click', noHandler);
            };

            yesBtn.addEventListener('click', yesHandler, { once: true });
            noBtn.addEventListener('click', noHandler, { once: true });
        }

        async function deleteList(listId) {
            if (!currentUser) {
                alert("You must be logged in to delete a list.");
                return;
            }
            try {
                await db.collection('lists').doc(listId).delete();
                loadLists();
            } catch (error) {
                console.error("Error deleting list:", error);
                alert('There was an error deleting the list.');
            }
        }
    </script>
</body>
</html>
