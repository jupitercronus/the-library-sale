<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit List - the library sale</title>
    <!-- Google Fonts Import -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=B612+Mono&family=Dokdo&family=Kirang+Haerang&family=M+PLUS+2&family=Syne+Mono&display=swap" rel="stylesheet">
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-auth-compat.js"></script>
    <!-- SortableJS Library for Drag & Drop -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <!-- App Scripts -->
    <script src="utils.js" defer></script>
    <link rel="stylesheet" href="style.css">
    <script src="main.js" defer></script>
    <!-- FIX: Added specific styles to position the search results container -->
    <style>
        .edit-list-search {
            position: relative; /* Establishes a positioning context for child elements */
        }
        #searchResultsContainer {
            position: absolute; /* Positions the container relative to .edit-list-search */
            top: 100%; /* Places it directly below the parent container */
            left: 0;
            right: 0;
            z-index: 100; /* Ensures it appears above other content */
        }
    </style>
</head>
<body>
    <header id="navbar-placeholder"></header>

    <div class="main-container view-list-container">
        <div id="list-content">
            <form id="editListForm">
                <div class="list-header">
                    <input type="text" id="listName" class="list-name-input" placeholder="List Name" required>
                    <p id="creatorName"></p>
                </div>
                <textarea id="listDescription" class="list-description-textarea" placeholder="Add a description..."></textarea>
            </form>

            <div class="edit-list-search">
                <input type="text" id="mediaSearchInput" placeholder="Search media to add to list..." autocomplete="off">
                <button id="mediaSearchBtn" class="btn-icon" title="Search"></button>
                <div id="searchResultsContainer"></div>
            </div>

            <hr class="list-divider">

            <div id="media-list-container">
                <!-- Media items will be rendered here -->
            </div>
        </div>
        <div class="edit-list-actions">
            <button type="submit" form="editListForm" class="btn-save-list" title="Save Changes"></button>
            <button onclick="history.back()" class="btn-back" title="Go Back"></button>
        </div>
    </div>

    <script>
        const firebaseConfig = {
          apiKey: "AIzaSyDDW8LtwpYevdkD7Q-_CxJ23mMfi00P21M",
          authDomain: "tiny-lizard.firebaseapp.com",
          projectId: "tiny-lizard",
          storageBucket: "tiny-lizard.firebasestorage.app",
          messagingSenderId: "250872474692",
          appId: "1:250872474692:web:969e0b1302ae3cb4666011"
        };
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        let listId = null;
        let listData = null;
        let sortable = null;
        let currentUser = null;
        let debouncedSearch = null;
        let allMoviesCache = []; // Cache for movies to avoid re-fetching

        // Add skeleton utilities
        const SkeletonUI = {
            showEditListSkeleton: () => {
                document.getElementById('listName').value = 'Loading...';
                document.getElementById('creatorName').innerHTML = '<div class="skeleton skeleton-text" style="width: 120px; height: 16px;"></div>';
                document.getElementById('listDescription').value = 'Loading description...';
                
                const container = document.getElementById('media-list-container');
                const skeletonHTML = Array(6).fill(0).map((_, index) => `
                    <div class="skeleton-list-item draggable">
                        <span class="skeleton skeleton-drag-handle"></span>
                        <span class="skeleton skeleton-number">${index + 1}.</span>
                        <div class="skeleton skeleton-poster"></div>
                        <div class="skeleton-item-info">
                            <div class="skeleton skeleton-title"></div>
                            <div class="skeleton skeleton-year"></div>
                        </div>
                        <div class="skeleton skeleton-remove-btn"></div>
                    </div>
                `).join('');
                container.innerHTML = skeletonHTML;
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            listId = urlParams.get('id');

            if (!listId) {
                document.getElementById('list-content').innerHTML = '<h1>Error: No List ID provided.</h1>';
                return;
            }

            auth.onAuthStateChanged(user => {
                currentUser = user;
                loadListData(listId);
                fetchAllMovies(); // Pre-fetch all movies for searching
            });

            document.getElementById('editListForm').addEventListener('submit', saveListChanges);
            
            const searchInput = document.getElementById('mediaSearchInput');
            const searchButton = document.getElementById('mediaSearchBtn');
            const resultsContainer = document.getElementById('searchResultsContainer');

            // This function now handles both filtering and showing initial results
            const performSearch = (query) => {
                const lowerCaseQuery = query.toLowerCase();
                resultsContainer.style.display = 'block';

                let filteredMovies;
                // If there's a query, filter the cache. Otherwise, show the first 10 from the cache.
                if (lowerCaseQuery) {
                    filteredMovies = allMoviesCache.filter(movie =>
                        movie.title && movie.title.toLowerCase().includes(lowerCaseQuery)
                    ).slice(0, 10);
                } else {
                    filteredMovies = allMoviesCache.slice(0, 10);
                }

                if (filteredMovies.length === 0) {
                    resultsContainer.innerHTML = '<div class="search-result-item-add">No results found.</div>';
                    return;
                }

                resultsContainer.innerHTML = filteredMovies.map(media => {
                    const isAlreadyInList = listData.mediaIds.includes(media.id);
                    const clickAction = isAlreadyInList ? '' : `onclick="addMediaItem('${media.id}')"`;
                    return `
                        <div class="search-result-item-add ${isAlreadyInList ? 'disabled' : ''}" ${clickAction}>
                            <span>${media.title} (${media.year || 'N/A'})</span>
                            ${isAlreadyInList ? '<span>Added</span>' : ''}
                        </div>
                    `;
                }).join('');
            };

            debouncedSearch = LibraryUtils.ui.debounce(performSearch, 200);

            // Live search as the user types
            searchInput.addEventListener('input', () => {
                debouncedSearch(searchInput.value.trim());
            });
            
            // Show initial list of results on focus
            searchInput.addEventListener('focus', () => {
                performSearch(searchInput.value.trim());
            });

            // The search button can now simply act as a way to focus the input
            searchButton.addEventListener('click', () => {
                searchInput.focus();
            });

            document.addEventListener('click', (e) => {
                if (!document.querySelector('.edit-list-search').contains(e.target)) {
                    resultsContainer.style.display = 'none';
                }
            });
        });

        // Function to fetch all movies once and cache them
        async function fetchAllMovies() {
            try {
                const moviesSnapshot = await db.collection('movies').get();
                allMoviesCache = moviesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            } catch (error) {
                console.error("Error fetching all movies for search:", error);
            }
        }

        async function loadListData(listId) {
            // Show skeleton immediately
            SkeletonUI.showEditListSkeleton();

            try {
                const [listDoc] = await Promise.all([
                db.collection('lists').doc(listId).get(),
                new Promise(resolve => setTimeout(resolve, 600))
            ])
            
                if (!listDoc.exists) throw new Error("List not found.");
                
                listData = listDoc.data();

                if (!currentUser || currentUser.uid !== listData.creatorId) {
                    window.location.href = `view-list.html?id=${listId}`;
                    return;
                }

                document.getElementById('listName').value = listData.listName;
                document.getElementById('creatorName').innerHTML = `by <a href="profile.html?id=${listData.creatorId}">${listData.creatorDisplayName || 'Anonymous'}</a>`;
                document.getElementById('listDescription').value = listData.description || '';

                await renderMediaItems(listData.mediaIds);
                initializeSortable();

            } catch (error) {
                console.error("Error loading list data:", error);
                document.getElementById('list-content').innerHTML = `<h1>Error: ${error.message}</h1>`;
            }
        }

        async function renderMediaItems(mediaIds) {
            const container = document.getElementById('media-list-container');
            if (!mediaIds || mediaIds.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #aaa;">This list is empty. Search for media to add.</p>';
                return;
            }

            const mediaDataMap = new Map();
            if (mediaIds.length > 0) {
                const moviePromises = [];
                for (let i = 0; i < mediaIds.length; i += 10) {
                    const chunk = mediaIds.slice(i, i + 10);
                    moviePromises.push(db.collection('movies').where(firebase.firestore.FieldPath.documentId(), 'in', chunk).get());
                }

                const movieSnapshots = await Promise.all(moviePromises);
                movieSnapshots.forEach(snapshot => {
                    snapshot.forEach(doc => mediaDataMap.set(doc.id, doc.data()));
                });
            }

            container.innerHTML = mediaIds.map((id, index) => {
                const media = mediaDataMap.get(id);
                if (!media) return '';
                
                return `
                    <div class="list-media-item draggable" data-id="${id}">
                        <span class="drag-handle"></span>
                        <span class="list-item-number">${index + 1}.</span>
                        <img src="${media.posterUrl || 'https://placehold.co/50x75/2D194D/DEF0F7?text=N/A'}" class="list-item-poster" alt="Poster for ${media.title}">
                        <div class="list-item-info">
                            <span class="list-item-title">${media.title}</span>
                            <span class="list-item-year">(${media.year || 'N/A'})</span>
                        </div>
                        <button class="btn-remove-item" onclick="removeMediaItem('${id}')" title="Remove from list"></button>
                    </div>
                `;
            }).join('');
        }

        function initializeSortable() {
            const container = document.getElementById('media-list-container');
            if (sortable) sortable.destroy();
            
            sortable = new Sortable(container, {
                animation: 150,
                handle: '.drag-handle',
                onEnd: (evt) => {
                    const items = container.querySelectorAll('.list-media-item');
                    const newMediaIds = Array.from(items).map(item => item.dataset.id);
                    listData.mediaIds = newMediaIds;
                    renderMediaItems(listData.mediaIds); 
                }
            });
        }

        async function saveListChanges(e) {
            e.preventDefault();
            const saveButton = document.querySelector('.btn-save-list');
            saveButton.classList.add('saving');

            const newName = document.getElementById('listName').value.trim();
            const newDescription = document.getElementById('listDescription').value.trim();

            try {
                await db.collection('lists').doc(listId).update({
                    listName: newName,
                    description: newDescription,
                    mediaIds: listData.mediaIds
                });
                
                setTimeout(() => {
                    saveButton.classList.remove('saving');
                    window.location.href = `view-list.html?id=${listId}`;
                }, 1000);

            } catch (error) {
                console.error("Error saving list:", error);
                alert("Could not save changes. Please try again.");
                saveButton.classList.remove('saving');
            }
        }
        
        async function addMediaItem(mediaId) {
            if (listData.mediaIds.includes(mediaId)) return;

            listData.mediaIds.push(mediaId);
            await renderMediaItems(listData.mediaIds);
            
            document.getElementById('mediaSearchInput').value = '';
            document.getElementById('searchResultsContainer').style.display = 'none';
        }

        function removeMediaItem(mediaId) {
            listData.mediaIds = listData.mediaIds.filter(id => id !== mediaId);
            renderMediaItems(listData.mediaIds);
        }

    </script>
</body>
</html>
