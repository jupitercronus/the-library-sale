<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit List - the library sale</title>
    <!-- Google Fonts Import -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=B612+Mono&family=Dokdo&family=Kirang+Haerang&family=M+PLUS+2&family=Syne+Mono&display=swap" rel="stylesheet">
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-auth-compat.js"></script>
    <!-- SortableJS Library for Drag & Drop -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <!-- App Scripts -->
    <script src="utils.js" defer></script>
    <link rel="stylesheet" href="style.css">
    <script src="main.js" defer></script>
</head>
<body>
    <header id="navbar-placeholder"></header>

    <div class="main-container view-list-container">
        <div id="list-content">
            <form id="editListForm">
                <!-- FIX: Title field now shares space with creator name -->
                <div class="list-header">
                    <input type="text" id="listName" class="list-name-input" placeholder="List Name" required>
                    <p id="creatorName"></p>
                </div>
                <textarea id="listDescription" class="list-description-textarea" placeholder="Add a description..."></textarea>
            </form>

            <!-- FIX: Simplified search bar structure -->
            <div class="edit-list-search">
                <input type="text" id="mediaSearchInput" placeholder="Search media to add to list..." autocomplete="off">
                <button id="mediaSearchBtn" class="btn-icon" title="Search"></button>
                <!-- Search results will be positioned absolutely relative to this container -->
                <div id="searchResultsContainer"></div>
            </div>

            <hr class="list-divider">

            <div id="media-list-container">
                <!-- Media items will be rendered here -->
            </div>
        </div>
        <div class="edit-list-actions">
            <button type="submit" form="editListForm" class="btn-save-list" title="Save Changes"></button>
            <button onclick="history.back()" class="btn-back" title="Go Back"></button>
        </div>
    </div>

    <script>
        const firebaseConfig = {
          apiKey: "AIzaSyDDW8LtwpYevdkD7Q-_CxJ23mMfi00P21M",
          authDomain: "tiny-lizard.firebaseapp.com",
          projectId: "tiny-lizard",
          storageBucket: "tiny-lizard.firebasestorage.app",
          messagingSenderId: "250872474692",
          appId: "1:250872474692:web:969e0b1302ae3cb4666011"
        };
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        let listId = null;
        let listData = null;
        let sortable = null;
        let currentUser = null;

        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            listId = urlParams.get('id');

            if (!listId) {
                document.getElementById('list-content').innerHTML = '<h1>Error: No List ID provided.</h1>';
                return;
            }

            auth.onAuthStateChanged(user => {
                currentUser = user;
                loadListData(listId);
            });

            document.getElementById('editListForm').addEventListener('submit', saveListChanges);
            
            // FIX: Correctly implemented search logic
            const searchInput = document.getElementById('mediaSearchInput');
            const searchButton = document.getElementById('mediaSearchBtn');
            const resultsContainer = document.getElementById('searchResultsContainer');

            const performSearch = async (query) => {
                if (!query || query.length < 2) {
                    resultsContainer.innerHTML = '';
                    resultsContainer.style.display = 'none';
                    return;
                }
                
                const moviesRef = db.collection('movies');
                const snapshot = await moviesRef.where('title_lowercase', '>=', query.toLowerCase()).where('title_lowercase', '<=', query.toLowerCase() + '\\uf8ff').limit(5).get();
                
                resultsContainer.style.display = 'block';
                if (snapshot.empty) {
                    resultsContainer.innerHTML = '<div class="search-result-item-add">No results found.</div>';
                    return;
                }

                resultsContainer.innerHTML = snapshot.docs.map(doc => {
                    const media = { id: doc.id, ...doc.data() };
                    const isAlreadyInList = listData.mediaIds.includes(media.id);
                    // Disable clicks on items already in the list
                    const clickAction = isAlreadyInList ? '' : `onclick="addMediaItem('${media.id}')"`;
                    return `
                        <div class="search-result-item-add ${isAlreadyInList ? 'disabled' : ''}" ${clickAction}>
                            <span>${media.title} (${media.year || 'N/A'})</span>
                            ${isAlreadyInList ? '<span>Added</span>' : ''}
                        </div>
                    `;
                }).join('');
            };

            const debouncer = LibraryUtils.search.createDebouncedSearch(performSearch, 300);

            searchInput.addEventListener('input', () => debouncer.run(searchInput.value.trim()));
            searchInput.addEventListener('focus', () => performSearch(searchInput.value.trim()));

            searchButton.addEventListener('click', () => {
                debouncer.cancel();
                performSearch(searchInput.value.trim());
            });

            // Hide results when clicking away
            document.addEventListener('click', (e) => {
                if (!document.querySelector('.edit-list-search').contains(e.target)) {
                    resultsContainer.style.display = 'none';
                }
            });
        });

        async function loadListData(listId) {
            try {
                const listDoc = await db.collection('lists').doc(listId).get();
                if (!listDoc.exists) throw new Error("List not found.");
                
                listData = listDoc.data();

                if (!currentUser || currentUser.uid !== listData.creatorId) {
                    window.location.href = `view-list.html?id=${listId}`;
                    return;
                }

                document.getElementById('listName').value = listData.listName;
                document.getElementById('creatorName').innerHTML = `by <a href="profile.html?id=${listData.creatorId}">${listData.creatorDisplayName || 'Anonymous'}</a>`;
                document.getElementById('listDescription').value = listData.description || '';

                await renderMediaItems(listData.mediaIds);
                initializeSortable();

            } catch (error) {
                console.error("Error loading list data:", error);
                document.getElementById('list-content').innerHTML = `<h1>Error: ${error.message}</h1>`;
            }
        }

        async function renderMediaItems(mediaIds) {
            const container = document.getElementById('media-list-container');
            if (!mediaIds || mediaIds.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #aaa;">This list is empty. Search for media to add.</p>';
                return;
            }

            const mediaDataMap = new Map();
            if (mediaIds.length > 0) {
                const moviePromises = [];
                // Firestore 'in' queries are limited to 10 items per query
                for (let i = 0; i < mediaIds.length; i += 10) {
                    const chunk = mediaIds.slice(i, i + 10);
                    moviePromises.push(db.collection('movies').where(firebase.firestore.FieldPath.documentId(), 'in', chunk).get());
                }

                const movieSnapshots = await Promise.all(moviePromises);
                movieSnapshots.forEach(snapshot => {
                    snapshot.forEach(doc => mediaDataMap.set(doc.id, doc.data()));
                });
            }

            container.innerHTML = mediaIds.map((id, index) => {
                const media = mediaDataMap.get(id);
                if (!media) return '';
                
                return `
                    <div class="list-media-item draggable" data-id="${id}">
                        <span class="drag-handle"></span>
                        <span class="list-item-number">${index + 1}.</span>
                        <img src="${media.posterUrl || 'https://placehold.co/50x75/2D194D/DEF0F7?text=N/A'}" class="list-item-poster" alt="Poster for ${media.title}">
                        <div class="list-item-info">
                            <span class="list-item-title">${media.title}</span>
                            <span class="list-item-year">(${media.year || 'N/A'})</span>
                        </div>
                        <button class="btn-remove-item" onclick="removeMediaItem('${id}')" title="Remove from list"></button>
                    </div>
                `;
            }).join('');
        }

        function initializeSortable() {
            const container = document.getElementById('media-list-container');
            if (sortable) sortable.destroy();
            
            sortable = new Sortable(container, {
                animation: 150,
                handle: '.drag-handle',
                onEnd: (evt) => {
                    const items = container.querySelectorAll('.list-media-item');
                    const newMediaIds = Array.from(items).map(item => item.dataset.id);
                    listData.mediaIds = newMediaIds;
                    // Re-render to update numbers and maintain consistency
                    renderMediaItems(listData.mediaIds); 
                }
            });
        }

        async function saveListChanges(e) {
            e.preventDefault();
            const saveButton = document.querySelector('.btn-save-list');
            saveButton.classList.add('saving');

            const newName = document.getElementById('listName').value.trim();
            const newDescription = document.getElementById('listDescription').value.trim();

            try {
                await db.collection('lists').doc(listId).update({
                    listName: newName,
                    description: newDescription,
                    mediaIds: listData.mediaIds
                });
                
                setTimeout(() => {
                    saveButton.classList.remove('saving');
                    window.location.href = `view-list.html?id=${listId}`;
                }, 1000);

            } catch (error) {
                console.error("Error saving list:", error);
                alert("Could not save changes. Please try again.");
                saveButton.classList.remove('saving');
            }
        }
        
        async function addMediaItem(mediaId) {
            if (listData.mediaIds.includes(mediaId)) return;

            listData.mediaIds.push(mediaId);
            await renderMediaItems(listData.mediaIds);
            
            // Clear search and hide results
            document.getElementById('mediaSearchInput').value = '';
            document.getElementById('searchResultsContainer').style.display = 'none';
        }

        function removeMediaItem(mediaId) {
            listData.mediaIds = listData.mediaIds.filter(id => id !== mediaId);
            renderMediaItems(listData.mediaIds);
        }

    </script>
</body>
</html>
