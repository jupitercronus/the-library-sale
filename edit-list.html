<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit List - the library sale</title>
    <!-- Google Fonts Import -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=B612+Mono&family=Dokdo&family=Kirang+Haerang&family=M+PLUS+2&family=Syne+Mono&display=swap" rel="stylesheet">
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-auth-compat.js"></script>
    <!-- SortableJS Library for Drag & Drop -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
   
    <!-- App Utilities -->
    <script src="utils.js"></script>
    <script src="modal-manager.js"></script>
    <script src="scanner-utils.js"></script>
    <script src="cache.js"></script>
    <script src="search-ui.js"></script>  

    <!-- Styles -->
    <link rel="stylesheet" href="styles/variables.css">
    <link rel="stylesheet" href="styles/base.css">  
    <link rel="stylesheet" href="styles/components.css">
    <link rel="stylesheet" href="styles/pages.css">
    
    <!-- Main Script -->
    <script src="main.js" defer></script>
    
</head>
<body>
    <header id="navbar-placeholder"></header>

    <main class="main-container view-list-container">
        <div id="list-content">
            <form id="editListForm">
                <div class="list-header">
                    <input type="text" id="listName" class="list-name-input" placeholder="List Name" required>
                    <p id="creatorName"></p>
                </div>
                
                <div class="form-group">
                    <label for="listDescription">Description</label>
                    <textarea id="listDescription" 
                             class="list-description-textarea" 
                             placeholder="Add a description..."
                             rows="3"></textarea>
                </div>
            </form>

            <div class="edit-list-search">
                <div class="search-bar">
                    <input type="text" id="mediaSearchInput" placeholder="Search media to add to list..." autocomplete="off">
                    <button id="mediaSearchBtn" class="btn btn-md btn-primary" title="Search">
                        <span class="icon icon-search icon-md"></span>
                    </button>
                </div>
                <div id="searchResultsContainer" class="search-results-dropdown"></div>
            </div>

            <hr class="list-divider">

            <div id="media-list-container">
                <!-- Initial loading state -->
                <div class="loading-container">
                    <div class="loading-content">
                        <div class="loading-spinner"></div>
                        <p class="loading-text">Loading list items...</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="edit-list-actions">
            <button type="submit" form="editListForm" class="btn btn-xl btn-success" title="Save Changes">
                <span class="icon icon-confirm icon-xl"></span>
            </button>
            <button onclick="history.back()" class="btn btn-xl btn-secondary" title="Go Back">
                <span class="icon icon-back icon-xl"></span>
            </button>
        </div>
    </main>

    <script>
        const firebaseConfig = {
          apiKey: "AIzaSyDDW8LtwpYevdkD7Q-_CxJ23mMfi00P21M",
          authDomain: "tiny-lizard.firebaseapp.com",
          projectId: "tiny-lizard",
          storageBucket: "tiny-lizard.firebasestorage.app",
          messagingSenderId: "250872474692",
          appId: "1:250872474692:web:969e0b1302ae3cb4666011"
        };
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        let listId = null;
        let listData = null;
        let sortable = null;
        let currentUser = null;
        let debouncedSearch = null;
        let allMoviesCache = []; // Cache for movies to avoid re-fetching

        // Enhanced skeleton utilities using CSS component classes
        const SkeletonUI = {
            showEditListSkeleton: () => {
                document.getElementById('listName').value = 'Loading...';
                document.getElementById('listName').disabled = true;
                document.getElementById('creatorName').innerHTML = '<div class="skeleton" style="width: 120px; height: 1em;"></div>';
                document.getElementById('listDescription').value = 'Loading description...';
                document.getElementById('listDescription').disabled = true;
                
                const container = document.getElementById('media-list-container');
                const skeletonHTML = Array(6).fill(0).map((_, index) => `
                    <div class="list-media-item draggable">
                        <div class="skeleton drag-handle"></div>
                        <span class="list-item-number">${index + 1}.</span>
                        <div class="skeleton list-item-poster"></div>
                        <div class="list-item-info">
                            <div class="skeleton" style="height: 1.2em; width: 70%; margin-bottom: var(--space-xs);"></div>
                            <div class="skeleton" style="height: 1em; width: 40%;"></div>
                        </div>
                        <div class="skeleton btn-remove-item"></div>
                    </div>
                `).join('');
                container.innerHTML = skeletonHTML;
            },
            hideEditListSkeleton: () => {
                document.getElementById('listName').disabled = false;
                document.getElementById('listDescription').disabled = false;
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            listId = urlParams.get('id');

            if (!listId) {
                document.getElementById('list-content').innerHTML = `
                    <div class="error-state">
                        <span class="icon icon-close icon-3xl"></span>
                        <h3>Error: No List ID provided</h3>
                        <p>Please check the URL and try again.</p>
                        <a href="lists.html" class="btn btn-lg btn-primary">
                            <span class="icon icon-back icon-lg"></span>
                            Back to Lists
                        </a>
                    </div>
                `;
                return;
            }

            auth.onAuthStateChanged(user => {
                currentUser = user;
                loadListData(listId);
                fetchAllMovies(); // Pre-fetch all movies for searching
            });

            document.getElementById('editListForm').addEventListener('submit', saveListChanges);
            
            const searchInput = document.getElementById('mediaSearchInput');
            const searchButton = document.getElementById('mediaSearchBtn');
            const resultsContainer = document.getElementById('searchResultsContainer');

            // Enhanced search function with better UX
            const performSearch = (query) => {
                const lowerCaseQuery = query.toLowerCase();
                resultsContainer.classList.add('active');

                let filteredMovies;
                if (lowerCaseQuery) {
                    filteredMovies = allMoviesCache.filter(movie =>
                        movie.title && movie.title.toLowerCase().includes(lowerCaseQuery)
                    ).slice(0, 10);
                } else {
                    filteredMovies = allMoviesCache.slice(0, 10);
                }

                if (filteredMovies.length === 0) {
                    resultsContainer.innerHTML = `
                        <div class="search-result-item-add disabled">
                            <span class="icon icon-search icon-sm"></span>
                            No results found
                        </div>
                    `;
                    return;
                }

                resultsContainer.innerHTML = filteredMovies.map(media => {
                    const isAlreadyInList = listData && listData.mediaIds.includes(media.id);
                    const clickAction = isAlreadyInList ? '' : `onclick="addMediaItem('${media.id}')"`;
                    
                    return `
                        <div class="search-result-item-add ${isAlreadyInList ? 'disabled' : ''}" ${clickAction}>
                            <div class="flex gap-sm">
                                <span class="badge badge-${media.type || 'movie'}">
                                    <span class="icon icon-${media.type || 'movie'} icon-sm"></span>
                                </span>
                                <span>${media.title} (${media.year || 'N/A'})</span>
                            </div>
                            ${isAlreadyInList ? '<span class="icon icon-confirm icon-sm"></span>' : '<span class="icon icon-add icon-sm"></span>'}
                        </div>
                    `;
                }).join('');
            };

            debouncedSearch = LibraryUtils.ui.debounce(performSearch, 200);

            searchInput.addEventListener('input', () => {
                debouncedSearch(searchInput.value.trim());
            });
            
            searchInput.addEventListener('focus', () => {
                performSearch(searchInput.value.trim());
            });

            searchButton.addEventListener('click', () => {
                searchInput.focus();
            });

            document.addEventListener('click', (e) => {
                if (!document.querySelector('.edit-list-search').contains(e.target)) {
                    resultsContainer.classList.remove('active');
                }
            });
        });

        // Function to fetch all movies once and cache them
        async function fetchAllMovies() {
            try {
                const moviesSnapshot = await db.collection('movies').get();
                allMoviesCache = moviesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            } catch (error) {
                console.error("Error fetching all movies for search:", error);
            }
        }

        async function loadListData(listId) {
            SkeletonUI.showEditListSkeleton();

            try {
                const [listDoc] = await Promise.all([
                    db.collection('lists').doc(listId).get(),
                    new Promise(resolve => setTimeout(resolve, 600))
                ]);
            
                if (!listDoc.exists) throw new Error("List not found.");
                
                listData = listDoc.data();

                if (!currentUser || currentUser.uid !== listData.creatorId) {
                    window.location.href = `view-list.html?id=${listId}`;
                    return;
                }

                SkeletonUI.hideEditListSkeleton();
                
                document.getElementById('listName').value = listData.listName;
                document.getElementById('creatorName').innerHTML = `by <a href="profile.html?id=${listData.creatorId}">${listData.creatorDisplayName || 'Anonymous'}</a>`;
                document.getElementById('listDescription').value = listData.description || '';

                await renderMediaItems(listData.mediaIds);
                initializeSortable();

            } catch (error) {
                console.error("Error loading list data:", error);
                document.getElementById('list-content').innerHTML = `
                    <div class="error-state">
                        <span class="icon icon-close icon-3xl"></span>
                        <h3>Error: ${error.message}</h3>
                        <p>Please try refreshing the page or check your connection.</p>
                        <a href="lists.html" class="btn btn-lg btn-primary">
                            <span class="icon icon-back icon-lg"></span>
                            Back to Lists
                        </a>
                    </div>
                `;
            }
        }

        async function renderMediaItems(mediaIds) {
            const container = document.getElementById('media-list-container');
            if (!mediaIds || mediaIds.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <span class="icon icon-list icon-3xl"></span>
                        <h3>This list is empty</h3>
                        <p>Search for media above to add items to your list.</p>
                    </div>
                `;
                return;
            }

            const mediaDataMap = new Map();
            if (mediaIds.length > 0) {
                const moviePromises = [];
                for (let i = 0; i < mediaIds.length; i += 10) {
                    const chunk = mediaIds.slice(i, i + 10);
                    moviePromises.push(db.collection('movies').where(firebase.firestore.FieldPath.documentId(), 'in', chunk).get());
                }

                const movieSnapshots = await Promise.all(moviePromises);
                movieSnapshots.forEach(snapshot => {
                    snapshot.forEach(doc => mediaDataMap.set(doc.id, doc.data()));
                });
            }

            container.innerHTML = mediaIds.map((id, index) => {
                const media = mediaDataMap.get(id);
                if (!media) return '';
                
                return `
                    <div class="list-media-item draggable" data-id="${id}">
                        <span class="drag-handle" title="Drag to reorder"></span>
                        <span class="list-item-number">${index + 1}.</span>
                        <img src="${media.posterUrl || 'https://placehold.co/50x75/2D194D/DEF0F7?text=N/A'}" 
                             class="list-item-poster" 
                             alt="Poster for ${media.title}"
                             loading="lazy">
                        <div class="list-item-info">
                            <span class="list-item-title">${media.title}</span>
                            <span class="list-item-year">(${media.year || 'N/A'})</span>
                        </div>
                        <button class="btn-remove-item" onclick="removeMediaItem('${id}')" title="Remove from list">
                            <span class="icon icon-delete"></span>
                        </button>
                    </div>
                `;
            }).join('');
        }

        function initializeSortable() {
            const container = document.getElementById('media-list-container');
            if (sortable) sortable.destroy();
            
            sortable = new Sortable(container, {
                animation: 150,
                handle: '.drag-handle',
                onEnd: (evt) => {
                    const items = container.querySelectorAll('.list-media-item');
                    const newMediaIds = Array.from(items).map(item => item.dataset.id);
                    listData.mediaIds = newMediaIds;
                    renderMediaItems(listData.mediaIds); 
                }
            });
        }

        async function saveListChanges(e) {
            e.preventDefault();
            const saveButton = document.querySelector('button[type="submit"]');
            saveButton.classList.add('saving');

            const newName = document.getElementById('listName').value.trim();
            const newDescription = document.getElementById('listDescription').value.trim();

            if (!newName) {
                const errorMessage = document.createElement('div');
                errorMessage.className = 'status-message status-error';
                errorMessage.innerHTML = '<span class="icon icon-close icon-md"></span>List name is required.';
                document.getElementById('editListForm').after(errorMessage);
                
                saveButton.classList.remove('saving');
                setTimeout(() => errorMessage.remove(), 3000);
                return;
            }

            try {
                await db.collection('lists').doc(listId).update({
                    listName: newName,
                    description: newDescription,
                    mediaIds: listData.mediaIds
                });
                
                // Show success message
                const successMessage = document.createElement('div');
                successMessage.className = 'status-message status-success';
                successMessage.innerHTML = '<span class="icon icon-confirm icon-md"></span>Changes saved successfully!';
                document.getElementById('editListForm').after(successMessage);
                
                setTimeout(() => {
                    saveButton.classList.remove('saving');
                    window.location.href = `view-list.html?id=${listId}`;
                }, 1000);

            } catch (error) {
                console.error("Error saving list:", error);
                
                const errorMessage = document.createElement('div');
                errorMessage.className = 'status-message status-error';
                errorMessage.innerHTML = '<span class="icon icon-close icon-md"></span>Could not save changes. Please try again.';
                document.getElementById('editListForm').after(errorMessage);
                
                saveButton.classList.remove('saving');
                setTimeout(() => errorMessage.remove(), 5000);
            }
        }
        
        async function addMediaItem(mediaId) {
            if (listData.mediaIds.includes(mediaId)) return;

            listData.mediaIds.push(mediaId);
            await renderMediaItems(listData.mediaIds);
            
            document.getElementById('mediaSearchInput').value = '';
            document.getElementById('searchResultsContainer').classList.remove('active');
            
            // Show brief feedback
            const successMessage = document.createElement('div');
            successMessage.className = 'status-message status-success';
            successMessage.innerHTML = '<span class="icon icon-confirm icon-md"></span>Media added to list!';
            successMessage.style.position = 'fixed';
            successMessage.style.top = 'var(--space-xl)';
            successMessage.style.right = 'var(--space-xl)';
            successMessage.style.zIndex = 'var(--z-modal)';
            document.body.appendChild(successMessage);
            
            setTimeout(() => successMessage.remove(), 2000);
        }

        function removeMediaItem(mediaId) {
            listData.mediaIds = listData.mediaIds.filter(id => id !== mediaId);
            renderMediaItems(listData.mediaIds);
            
            // Show brief feedback
            const infoMessage = document.createElement('div');
            infoMessage.className = 'status-message status-info';
            infoMessage.innerHTML = '<span class="icon icon-delete icon-md"></span>Media removed from list';
            infoMessage.style.position = 'fixed';
            infoMessage.style.top = 'var(--space-xl)';
            infoMessage.style.right = 'var(--space-xl)';
            infoMessage.style.zIndex = 'var(--z-modal)';
            document.body.appendChild(infoMessage);
            
            setTimeout(() => infoMessage.remove(), 2000);
        }

        function validatePhysicalEditionData(data) {
            // Handle missing or corrupted physical edition data
            if (!data || typeof data !== 'object') {
                return {
                    format: 'Unknown',
                    edition: 'Standard',
                    region: 'Unknown',
                    distributor: 'Unknown',
                    features: [],
                    barcode: ''
                };
            }
            
            // Ensure arrays are properly handled
            if (data.features && !Array.isArray(data.features)) {
                data.features = typeof data.features === 'string' 
                    ? data.features.split(',').map(f => f.trim()) 
                    : [];
            }
            
            return data;
        }
    </script>
    <footer id="footer-placeholder"></footer>
</body>
</html>